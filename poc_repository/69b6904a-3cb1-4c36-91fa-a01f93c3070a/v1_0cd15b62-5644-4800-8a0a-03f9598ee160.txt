#!/usr/bin/env python3
"""
ProxyShell (CVE-2021-34473) Exchange Server Scanner
Checks for vulnerable Microsoft Exchange servers
"""
import requests
import sys
import urllib3

urllib3.disable_warnings()

AUTODISCOVER_PATHS = [
    "/autodiscover/autodiscover.json?@test.com/mapi/nspi/?&Email=autodiscover/autodiscover.json%3F@test.com",
    "/autodiscover/autodiscover.json?@test.com/owa/?&Email=autodiscover/autodiscover.json%3F@test.com",
]

def check_proxyshell(target):
    """Check if Exchange server is vulnerable to ProxyShell"""
    results = []

    for path in AUTODISCOVER_PATHS:
        url = f"https://{target}{path}"
        try:
            response = requests.get(url, verify=False, timeout=10, allow_redirects=False)

            if response.status_code == 200:
                print(f"[+] Potential ProxyShell vulnerability: {path}")
                results.append({"path": path, "status": response.status_code, "vulnerable": True})
            elif response.status_code == 302:
                print(f"[?] Redirect detected (may be patched): {path}")
                results.append({"path": path, "status": response.status_code, "vulnerable": False})
            else:
                print(f"[-] Path returned {response.status_code}: {path}")

        except requests.exceptions.ConnectionError:
            print(f"[-] Connection failed to {target}")
            return None
        except Exception as e:
            print(f"[-] Error: {e}")

    return results

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <exchange_server>")
        sys.exit(1)

    target = sys.argv[1]
    print(f"[*] Checking {target} for ProxyShell vulnerabilities...")

    results = check_proxyshell(target)

    if results and any(r.get("vulnerable") for r in results):
        print("\n[!] Target appears VULNERABLE to ProxyShell!")
    else:
        print("\n[-] Target does not appear vulnerable")
