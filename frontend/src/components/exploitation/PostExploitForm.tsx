import React, { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';
import Button from '../ui/Button';
import {
  X,
  Database,
  UserCheck,
  Lock,
  ArrowRight,
  Network,
  AlertTriangle,
  Info,
  Server,
  Key,
  Shield,
} from 'lucide-react';
import { exploitationAPI } from '../../services/api';

type PostExploitType = 'credential_dump' | 'priv_esc' | 'persistence' | 'lateral_movement' | 'smb_relay';

interface PostExploitFormProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess?: () => void;
  onCampaignCreated?: (campaignId: string) => void;
  attackType: PostExploitType;
}

const ATTACK_INFO: Record<PostExploitType, {
  title: string;
  icon: React.ReactNode;
  description: string;
  modules: { value: string; label: string; description: string }[];
}> = {
  credential_dump: {
    title: 'Credential Dump',
    icon: <Database className="h-6 w-6 text-red-400" />,
    description: 'Extract credentials from memory, registry, or files on the target system.',
    modules: [
      { value: 'dump_sam', label: 'SAM Database', description: 'Extract local account hashes from SAM' },
      { value: 'dump_lsass', label: 'LSASS Memory', description: 'Dump credentials from LSASS process' },
      { value: 'browser_creds', label: 'Browser Credentials', description: 'Extract saved passwords from browsers' },
      { value: 'wifi_passwords', label: 'WiFi Passwords', description: 'Extract saved WiFi passwords' },
      { value: 'keepass', label: 'KeePass Databases', description: 'Find and extract KeePass databases' },
    ],
  },
  priv_esc: {
    title: 'Privilege Escalation',
    icon: <UserCheck className="h-6 w-6 text-yellow-400" />,
    description: 'Check for privilege escalation vectors on the target system.',
    modules: [
      { value: 'always_install_elevated', label: 'AlwaysInstallElevated', description: 'Check for AlwaysInstallElevated policy' },
      { value: 'unquoted_paths', label: 'Unquoted Service Paths', description: 'Find unquoted service paths' },
      { value: 'weak_service_perms', label: 'Weak Service Permissions', description: 'Check for modifiable services' },
      { value: 'se_impersonate', label: 'SeImpersonate', description: 'Check for token impersonation privileges' },
      { value: 'sudoers', label: 'Sudoers Check', description: 'Analyze sudo configuration (Linux)' },
      { value: 'suid_binaries', label: 'SUID Binaries', description: 'Find SUID/SGID binaries (Linux)' },
    ],
  },
  persistence: {
    title: 'Persistence',
    icon: <Lock className="h-6 w-6 text-purple-400" />,
    description: 'Establish persistent access mechanisms on the target system.',
    modules: [
      { value: 'scheduled_task', label: 'Scheduled Task', description: 'Create a scheduled task for persistence' },
      { value: 'registry_run', label: 'Registry Run Key', description: 'Add registry run key for startup' },
      { value: 'service', label: 'Windows Service', description: 'Create a Windows service' },
      { value: 'cron_job', label: 'Cron Job', description: 'Add cron job for persistence (Linux)' },
      { value: 'ssh_key', label: 'SSH Key', description: 'Add SSH authorized key (Linux)' },
    ],
  },
  lateral_movement: {
    title: 'Lateral Movement',
    icon: <ArrowRight className="h-6 w-6 text-blue-400" />,
    description: 'Move to other systems using various techniques.',
    modules: [
      { value: 'pass_the_hash', label: 'Pass-the-Hash', description: 'Authenticate using NTLM hash' },
      { value: 'pass_the_ticket', label: 'Pass-the-Ticket', description: 'Authenticate using Kerberos ticket' },
      { value: 'psexec', label: 'PsExec', description: 'Execute commands via PsExec' },
      { value: 'wmi_exec', label: 'WMI Exec', description: 'Execute commands via WMI' },
      { value: 'ssh_pivot', label: 'SSH Pivot', description: 'Pivot through SSH connections' },
    ],
  },
  smb_relay: {
    title: 'SMB Relay',
    icon: <Network className="h-6 w-6 text-orange-400" />,
    description: 'Relay NTLM authentication to other targets for credential theft or command execution.',
    modules: [
      { value: 'ntlm_relay', label: 'NTLM Relay', description: 'Relay NTLM auth to target SMB' },
      { value: 'ldap_relay', label: 'LDAP Relay', description: 'Relay to LDAP for account takeover' },
      { value: 'http_relay', label: 'HTTP Relay', description: 'Relay to HTTP endpoints' },
    ],
  },
};

const PostExploitForm: React.FC<PostExploitFormProps> = ({
  isOpen,
  onClose,
  onSuccess,
  onCampaignCreated,
  attackType,
}) => {
  const queryClient = useQueryClient();
  const [authorized, setAuthorized] = useState(false);
  const attackInfo = ATTACK_INFO[attackType];

  const [config, setConfig] = useState({
    name: '',
    target: '',
    module: attackInfo.modules[0]?.value || '',
    username: '',
    password: '',
    ntlm_hash: '',
    use_hash: false,
    options: {} as Record<string, string>,
  });

  const createCampaignMutation = useMutation({
    mutationFn: async () => {
      const response = await exploitationAPI.createCampaign({
        name: config.name || `${attackInfo.title} - ${new Date().toLocaleString()}`,
        attack_type: attackType,
        config: {
          module: config.module,
          username: config.username || null,
          password: config.use_hash ? null : config.password,
          ntlm_hash: config.use_hash ? config.ntlm_hash : null,
          options: config.options,
        },
        targets: [config.target],
      });
      return response.data;
    },
    onSuccess: async (data) => {
      if (authorized) {
        try {
          await exploitationAPI.startCampaign(data.id, true);
          toast.success(`${attackInfo.title} campaign started!`);
        } catch (e) {
          toast.success('Campaign created. Start manually to begin.');
        }
      } else {
        toast.success('Campaign created.');
      }
      queryClient.invalidateQueries({ queryKey: ['exploitation-campaigns'] });
      queryClient.invalidateQueries({ queryKey: ['exploitation-status'] });
      onSuccess?.();
      onCampaignCreated?.(data.id);
      onClose();
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.error || 'Failed to create campaign');
    },
  });

  if (!isOpen) return null;

  const selectedModule = attackInfo.modules.find(m => m.value === config.module);

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-dark-surface border border-dark-border rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="p-6 border-b border-dark-border">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              {attackInfo.icon}
              <div>
                <h2 className="text-xl font-bold text-white">{attackInfo.title}</h2>
                <p className="text-gray-400 text-sm">{attackInfo.description}</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-white p-2 rounded-lg hover:bg-dark-bg"
            >
              <X className="h-5 w-5" />
            </button>
          </div>
        </div>

        {/* Form */}
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          {/* Campaign Name */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Campaign Name (optional)
            </label>
            <input
              type="text"
              value={config.name}
              onChange={(e) => setConfig({ ...config, name: e.target.value })}
              placeholder={`${attackInfo.title} - ${new Date().toLocaleDateString()}`}
              className="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary"
            />
          </div>

          {/* Target */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Target <span className="text-red-400">*</span>
            </label>
            <input
              type="text"
              value={config.target}
              onChange={(e) => setConfig({ ...config, target: e.target.value })}
              placeholder="192.168.1.100 or hostname"
              className="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-primary"
            />
          </div>

          {/* Module Selection */}
          <div>
            <label className="block text-sm font-medium text-gray-300 mb-2">
              Module
            </label>
            <select
              value={config.module}
              onChange={(e) => setConfig({ ...config, module: e.target.value })}
              className="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg text-white focus:outline-none focus:border-primary"
            >
              {attackInfo.modules.map((module) => (
                <option key={module.value} value={module.value}>
                  {module.label}
                </option>
              ))}
            </select>
            {selectedModule && (
              <p className="mt-2 text-sm text-gray-400 flex items-center gap-2">
                <Info className="h-4 w-4" />
                {selectedModule.description}
              </p>
            )}
          </div>

          {/* Credentials (for lateral movement and SMB relay) */}
          {(attackType === 'lateral_movement' || attackType === 'smb_relay') && (
            <div className="space-y-4 p-4 bg-dark-bg rounded-lg border border-dark-border">
              <h4 className="text-white font-medium flex items-center gap-2">
                <Key className="h-4 w-4" />
                Credentials
              </h4>

              <div>
                <label className="block text-sm text-gray-400 mb-2">Username</label>
                <input
                  type="text"
                  value={config.username}
                  onChange={(e) => setConfig({ ...config, username: e.target.value })}
                  placeholder="DOMAIN\\username or username@domain"
                  className="w-full px-4 py-2 bg-dark-surface border border-dark-border rounded-lg text-white"
                />
              </div>

              <div className="flex items-center gap-4 mb-2">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    checked={!config.use_hash}
                    onChange={() => setConfig({ ...config, use_hash: false })}
                    className="text-primary"
                  />
                  <span className="text-gray-300">Password</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="radio"
                    checked={config.use_hash}
                    onChange={() => setConfig({ ...config, use_hash: true })}
                    className="text-primary"
                  />
                  <span className="text-gray-300">NTLM Hash</span>
                </label>
              </div>

              {config.use_hash ? (
                <input
                  type="text"
                  value={config.ntlm_hash}
                  onChange={(e) => setConfig({ ...config, ntlm_hash: e.target.value })}
                  placeholder="aad3b435b51404eeaad3b435b51404ee:hash"
                  className="w-full px-4 py-2 bg-dark-surface border border-dark-border rounded-lg text-white font-mono"
                />
              ) : (
                <input
                  type="password"
                  value={config.password}
                  onChange={(e) => setConfig({ ...config, password: e.target.value })}
                  placeholder="Password"
                  className="w-full px-4 py-2 bg-dark-surface border border-dark-border rounded-lg text-white"
                />
              )}
            </div>
          )}

          {/* Warning Banner */}
          <div className="flex items-start gap-3 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
            <AlertTriangle className="h-5 w-5 text-red-400 flex-shrink-0 mt-0.5" />
            <div>
              <p className="text-red-400 font-medium">Authorization Required</p>
              <p className="text-gray-400 text-sm mt-1">
                This action may modify system configuration, access sensitive data, or execute commands
                on target systems. Ensure you have explicit written authorization before proceeding.
              </p>
            </div>
          </div>

          {/* Authorization Checkbox */}
          <label className="flex items-start gap-3 p-4 bg-dark-bg border border-dark-border rounded-lg cursor-pointer hover:border-primary transition-colors">
            <input
              type="checkbox"
              checked={authorized}
              onChange={(e) => setAuthorized(e.target.checked)}
              className="mt-1 h-4 w-4 text-primary rounded border-gray-600"
            />
            <div>
              <p className="text-white font-medium">I am authorized to perform this test</p>
              <p className="text-gray-400 text-sm mt-1">
                I confirm that I have written authorization from the system owner to perform post-exploitation
                activities on the specified target(s). I understand that unauthorized access is illegal.
              </p>
            </div>
          </label>
        </div>

        {/* Footer */}
        <div className="p-6 border-t border-dark-border flex justify-end gap-3">
          <Button variant="secondary" onClick={onClose}>
            Cancel
          </Button>
          <Button
            variant="primary"
            onClick={() => createCampaignMutation.mutate()}
            disabled={!config.target || !authorized || createCampaignMutation.isPending}
          >
            {createCampaignMutation.isPending ? (
              <>
                <Shield className="h-4 w-4 mr-2 animate-spin" />
                Creating...
              </>
            ) : (
              <>
                {attackInfo.icon}
                <span className="ml-2">Create & Start Campaign</span>
              </>
            )}
          </Button>
        </div>
      </div>
    </div>
  );
};

export default PostExploitForm;
