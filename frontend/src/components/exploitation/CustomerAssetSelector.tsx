import React, { useState, useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Building2, Server, Briefcase, ChevronDown, AlertTriangle, CheckCircle } from 'lucide-react';
import { crmAPI, assetTagsAPI } from '../../services/api';
import type { Customer, Asset, Engagement } from '../../types';

interface CustomerAssetSelectorProps {
  customerId: string;
  assetIds: string[];
  engagementId?: string;
  onCustomerChange: (customerId: string) => void;
  onAssetChange: (assetIds: string[]) => void;
  onEngagementChange?: (engagementId: string) => void;
  onTargetsFromAssets?: (targets: string[]) => void;
  disabled?: boolean;
}

const CustomerAssetSelector: React.FC<CustomerAssetSelectorProps> = ({
  customerId,
  assetIds,
  engagementId,
  onCustomerChange,
  onAssetChange,
  onEngagementChange,
  onTargetsFromAssets,
  disabled = false,
}) => {
  const [showAssetDropdown, setShowAssetDropdown] = useState(false);

  // Fetch customers
  const { data: customers = [] } = useQuery<Customer[]>({
    queryKey: ['crm-customers-list'],
    queryFn: async () => {
      const response = await crmAPI.customers.getAll();
      return response.data || [];
    },
  });

  // Fetch assets for selected customer
  const { data: assets = [] } = useQuery<Asset[]>({
    queryKey: ['customer-assets', customerId],
    queryFn: async () => {
      if (!customerId) return [];
      // Get all assets - in a real implementation, would filter by customer
      const response = await assetTagsAPI.getAssets();
      return response.data || [];
    },
    enabled: !!customerId,
  });

  // Fetch engagements for selected customer
  const { data: engagements = [] } = useQuery<Engagement[]>({
    queryKey: ['customer-engagements', customerId],
    queryFn: async () => {
      if (!customerId) return [];
      const response = await crmAPI.engagements.getByCustomer(customerId);
      return response.data || [];
    },
    enabled: !!customerId,
  });

  // Update targets when assets change
  useEffect(() => {
    if (assetIds.length > 0 && assets.length > 0 && onTargetsFromAssets) {
      const selectedAssets = assets.filter(a => assetIds.includes(a.id));
      const targets = selectedAssets
        .map(a => a.ip_address || a.hostname)
        .filter(Boolean) as string[];
      if (targets.length > 0) {
        onTargetsFromAssets(targets);
      }
    }
  }, [assetIds, assets, onTargetsFromAssets]);

  const handleAssetToggle = (assetId: string) => {
    if (assetIds.includes(assetId)) {
      onAssetChange(assetIds.filter(id => id !== assetId));
    } else {
      onAssetChange([...assetIds, assetId]);
    }
  };

  const selectAllAssets = () => {
    onAssetChange(assets.map(a => a.id));
  };

  const clearAssets = () => {
    onAssetChange([]);
  };

  const selectedAssetCount = assetIds.length;
  const selectedAssetNames = assets
    .filter(a => assetIds.includes(a.id))
    .map(a => a.hostname || a.ip_address)
    .slice(0, 3)
    .join(', ');

  return (
    <div className="space-y-4 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
      <div className="flex items-center gap-2 mb-2">
        <AlertTriangle className="h-5 w-5 text-red-400" />
        <h4 className="text-red-400 font-medium">Authorization Scope (Required)</h4>
      </div>
      <p className="text-gray-400 text-sm mb-4">
        All exploitation campaigns must be tied to a specific customer and their assets.
        This ensures proper authorization and audit trails.
      </p>

      {/* Customer Selection */}
      <div>
        <label className="flex items-center gap-2 text-sm text-gray-400 mb-2">
          <Building2 className="h-4 w-4" />
          Customer
        </label>
        <select
          value={customerId}
          onChange={(e) => {
            onCustomerChange(e.target.value);
            onAssetChange([]); // Clear assets when customer changes
            onEngagementChange?.('');
          }}
          disabled={disabled}
          className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white disabled:opacity-50"
        >
          <option value="">Select a customer...</option>
          {customers.map((customer) => (
            <option key={customer.id} value={customer.id}>
              {customer.name} {customer.industry ? `(${customer.industry})` : ''}
            </option>
          ))}
        </select>
      </div>

      {/* Engagement Selection (Optional) */}
      {customerId && engagements.length > 0 && onEngagementChange && (
        <div>
          <label className="flex items-center gap-2 text-sm text-gray-400 mb-2">
            <Briefcase className="h-4 w-4" />
            Engagement (Optional)
          </label>
          <select
            value={engagementId || ''}
            onChange={(e) => onEngagementChange(e.target.value)}
            disabled={disabled}
            className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white disabled:opacity-50"
          >
            <option value="">No specific engagement</option>
            {engagements
              .filter(e => e.status === 'in_progress' || e.status === 'planning')
              .map((engagement) => (
                <option key={engagement.id} value={engagement.id}>
                  {engagement.name} ({engagement.engagement_type})
                </option>
              ))}
          </select>
        </div>
      )}

      {/* Asset Selection */}
      {customerId && (
        <div>
          <label className="flex items-center gap-2 text-sm text-gray-400 mb-2">
            <Server className="h-4 w-4" />
            Target Assets
          </label>

          <div className="relative">
            <button
              type="button"
              onClick={() => setShowAssetDropdown(!showAssetDropdown)}
              disabled={disabled || assets.length === 0}
              className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-left text-white disabled:opacity-50 flex items-center justify-between"
            >
              <span className={selectedAssetCount === 0 ? 'text-gray-500' : ''}>
                {selectedAssetCount === 0
                  ? 'Select assets...'
                  : `${selectedAssetCount} asset(s): ${selectedAssetNames}${selectedAssetCount > 3 ? '...' : ''}`}
              </span>
              <ChevronDown className={`h-4 w-4 transition-transform ${showAssetDropdown ? 'rotate-180' : ''}`} />
            </button>

            {showAssetDropdown && (
              <div className="absolute z-50 mt-1 w-full bg-dark-surface border border-dark-border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                {/* Quick actions */}
                <div className="flex items-center justify-between p-2 border-b border-dark-border">
                  <button
                    type="button"
                    onClick={selectAllAssets}
                    className="text-xs text-primary hover:underline"
                  >
                    Select All
                  </button>
                  <button
                    type="button"
                    onClick={clearAssets}
                    className="text-xs text-gray-400 hover:text-white"
                  >
                    Clear
                  </button>
                </div>

                {assets.length === 0 ? (
                  <div className="p-3 text-gray-400 text-sm text-center">
                    No assets found for this customer
                  </div>
                ) : (
                  assets.map((asset) => (
                    <label
                      key={asset.id}
                      className="flex items-center gap-3 p-3 hover:bg-dark-bg cursor-pointer border-b border-dark-border last:border-0"
                    >
                      <input
                        type="checkbox"
                        checked={assetIds.includes(asset.id)}
                        onChange={() => handleAssetToggle(asset.id)}
                        className="w-4 h-4 rounded border-dark-border bg-dark-bg text-primary"
                      />
                      <div className="flex-1 min-w-0">
                        <p className="text-white text-sm font-medium truncate">
                          {asset.hostname || asset.ip_address}
                        </p>
                        <div className="flex items-center gap-2 text-xs text-gray-400">
                          {asset.ip_address && <span>{asset.ip_address}</span>}
                          {asset.os_family && <span>{asset.os_family}</span>}
                        </div>
                      </div>
                      <span className={`text-xs px-2 py-0.5 rounded ${
                        asset.status === 'active'
                          ? 'bg-green-500/20 text-green-400'
                          : 'bg-gray-500/20 text-gray-400'
                      }`}>
                        {asset.status}
                      </span>
                    </label>
                  ))
                )}
              </div>
            )}
          </div>

          {/* Selected Assets Summary */}
          {selectedAssetCount > 0 && (
            <div className="mt-2 flex flex-wrap gap-1">
              {assets
                .filter(a => assetIds.includes(a.id))
                .map((asset) => (
                  <span
                    key={asset.id}
                    className="inline-flex items-center gap-1 px-2 py-1 bg-dark-bg rounded text-xs text-gray-300"
                  >
                    {asset.ip_address || asset.hostname}
                    <button
                      type="button"
                      onClick={() => handleAssetToggle(asset.id)}
                      className="text-gray-500 hover:text-red-400"
                    >
                      &times;
                    </button>
                  </span>
                ))}
            </div>
          )}
        </div>
      )}

      {/* Validation Status */}
      <div className={`flex items-center gap-2 p-2 rounded ${
        customerId && assetIds.length > 0
          ? 'bg-green-500/10 text-green-400'
          : 'bg-yellow-500/10 text-yellow-400'
      }`}>
        {customerId && assetIds.length > 0 ? (
          <>
            <CheckCircle className="h-4 w-4" />
            <span className="text-sm">Authorization scope defined</span>
          </>
        ) : (
          <>
            <AlertTriangle className="h-4 w-4" />
            <span className="text-sm">
              {!customerId
                ? 'Select a customer to continue'
                : 'Select at least one asset to target'}
            </span>
          </>
        )}
      </div>
    </div>
  );
};

export default CustomerAssetSelector;
