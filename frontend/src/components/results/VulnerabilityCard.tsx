import React, { useState } from 'react';
import { ExternalLink, Copy, ChevronDown, ChevronUp, Shield } from 'lucide-react';
import { Vulnerability, toSeverityBadgeType } from '../../types';
import Badge from '../ui/Badge';
import { toast } from 'react-toastify';

interface VulnerabilityCardProps {
  vulnerability: Vulnerability;
  compact?: boolean;
}

const VulnerabilityCard: React.FC<VulnerabilityCardProps> = ({ vulnerability, compact = false }) => {
  const [expanded, setExpanded] = useState(false);

  const handleCopyCVE = () => {
    if (vulnerability.cve_id) {
      navigator.clipboard.writeText(vulnerability.cve_id);
      toast.success('CVE ID copied to clipboard');
    }
  };

  const getCVELink = (cveId: string) => {
    return `https://nvd.nist.gov/vuln/detail/${cveId}`;
  };

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'Critical':
        return 'border-severity-critical bg-severity-critical/10';
      case 'High':
        return 'border-severity-high bg-severity-high/10';
      case 'Medium':
        return 'border-severity-medium bg-severity-medium/10';
      case 'Low':
        return 'border-severity-low bg-severity-low/10';
      default:
        return 'border-slate-600 bg-slate-600/10';
    }
  };

  return (
    <div className={`border-l-4 rounded-lg p-4 ${getSeverityColor(vulnerability.severity)}`}>
      <div className="flex items-start justify-between gap-3">
        <div className="flex-1 min-w-0">
          {/* Header */}
          <div className="flex items-center gap-2 mb-2">
            <Shield className="h-4 w-4 text-red-400 flex-shrink-0" />
            <h4 className="text-white font-semibold text-sm truncate">{vulnerability.title}</h4>
          </div>

          {/* CVE ID and Severity */}
          <div className="flex items-center gap-2 mb-2 flex-wrap">
            {vulnerability.cve_id && (
              <div className="flex items-center gap-1 bg-dark-surface px-2 py-1 rounded">
                <code className="text-xs text-primary font-mono">{vulnerability.cve_id}</code>
                <button
                  onClick={handleCopyCVE}
                  className="text-slate-400 hover:text-white transition-colors"
                  title="Copy CVE ID"
                >
                  <Copy className="h-3 w-3" />
                </button>
                <a
                  href={getCVELink(vulnerability.cve_id)}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-slate-400 hover:text-white transition-colors"
                  title="View on NVD"
                >
                  <ExternalLink className="h-3 w-3" />
                </a>
              </div>
            )}
            <Badge variant="severity" type={toSeverityBadgeType(vulnerability.severity)}>
              {vulnerability.severity}
            </Badge>
            {vulnerability.affected_service && (
              <span className="text-xs text-slate-400">
                Affects: <span className="text-slate-300 font-mono">{vulnerability.affected_service}</span>
              </span>
            )}
          </div>

          {/* Description - Expandable */}
          {!compact && vulnerability.description && (
            <>
              <div className={`text-sm text-slate-300 mt-2 ${expanded ? '' : 'line-clamp-2'}`}>
                {vulnerability.description}
              </div>
              {vulnerability.description.length > 100 && (
                <button
                  onClick={() => setExpanded(!expanded)}
                  className="flex items-center gap-1 text-xs text-primary hover:text-primary-light transition-colors mt-2"
                >
                  {expanded ? (
                    <>
                      Show less <ChevronUp className="h-3 w-3" />
                    </>
                  ) : (
                    <>
                      Show more <ChevronDown className="h-3 w-3" />
                    </>
                  )}
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityCard;
