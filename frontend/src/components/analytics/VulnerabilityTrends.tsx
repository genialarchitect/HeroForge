import React, { useState, useEffect } from 'react';
import {
  LineChart,
  Line,
  AreaChart,
  Area,
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts';
import {
  AlertTriangle,
  TrendingUp,
  TrendingDown,
  Minus,
  Calendar,
  Shield,
  Clock,
  CheckCircle,
  XCircle,
  Bug,
} from 'lucide-react';
import { analyticsAPI } from '../../services/api';
import type {
  VulnerabilityTrendsData,
  VulnerabilityTrendsSummary,
  RecurringVulnerability,
} from '../../types';
import Card from '../ui/Card';
import LoadingSpinner from '../ui/LoadingSpinner';

type DateRange = 7 | 30 | 90 | 180;

interface StatCardProps {
  title: string;
  value: number | string;
  subtitle?: string;
  icon: React.ReactNode;
  color: string;
  trend?: {
    value: number;
    isPositive: boolean;
  };
}

const StatCard: React.FC<StatCardProps> = ({
  title,
  value,
  subtitle,
  icon,
  color,
  trend,
}) => {
  return (
    <Card className="p-6">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <p className="text-slate-400 text-sm font-medium mb-1">{title}</p>
          <p className={`text-3xl font-bold ${color} mb-1`}>{value}</p>
          {subtitle && <p className="text-slate-500 text-xs">{subtitle}</p>}
          {trend && (
            <div
              className={`flex items-center gap-1 mt-2 text-xs ${
                trend.isPositive ? 'text-green-400' : 'text-red-400'
              }`}
            >
              <TrendingUp
                className={`h-3 w-3 ${!trend.isPositive && 'rotate-180'}`}
              />
              <span>
                {trend.isPositive ? '+' : ''}
                {trend.value.toFixed(1)}%
              </span>
            </div>
          )}
        </div>
        <div className={`${color.replace('text-', 'bg-')}/20 p-3 rounded-lg`}>
          {icon}
        </div>
      </div>
    </Card>
  );
};

// Skeleton loader for charts
const ChartSkeleton: React.FC<{ height?: number }> = ({ height = 300 }) => (
  <div className="animate-pulse" style={{ height }}>
    <div className="h-full bg-slate-700/50 rounded-lg" />
  </div>
);

// Severity colors matching the design system
const SEVERITY_COLORS = {
  critical: '#ef4444',
  high: '#f97316',
  medium: '#eab308',
  low: '#3b82f6',
};

const VulnerabilityTrends: React.FC = () => {
  const [dateRange, setDateRange] = useState<DateRange>(30);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [data, setData] = useState<VulnerabilityTrendsData | null>(null);

  useEffect(() => {
    loadData();
  }, [dateRange]);

  const loadData = async () => {
    setLoading(true);
    setError(null);

    try {
      const response = await analyticsAPI.getVulnerabilityTrendsDashboard(dateRange);
      setData(response.data);
    } catch (err: unknown) {
      const axiosError = err as { response?: { data?: { message?: string } } };
      console.error('Failed to load vulnerability trends:', err);
      setError(axiosError.response?.data?.message || 'Failed to load vulnerability trends');
    } finally {
      setLoading(false);
    }
  };

  const formatDate = (dateStr: string) => {
    // Handle week format (YYYY-Www)
    if (dateStr.includes('-W')) {
      const [year, week] = dateStr.split('-W');
      return `W${week}`;
    }
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  };

  const getTrendIcon = (direction: string) => {
    switch (direction) {
      case 'improving':
        return <TrendingDown className="h-5 w-5 text-green-400" />;
      case 'declining':
        return <TrendingUp className="h-5 w-5 text-red-400" />;
      default:
        return <Minus className="h-5 w-5 text-yellow-400" />;
    }
  };

  const getTrendColor = (direction: string) => {
    switch (direction) {
      case 'improving':
        return 'text-green-400';
      case 'declining':
        return 'text-red-400';
      default:
        return 'text-yellow-400';
    }
  };

  const getTrendLabel = (direction: string) => {
    switch (direction) {
      case 'improving':
        return 'Improving';
      case 'declining':
        return 'Declining';
      default:
        return 'Stable';
    }
  };

  if (loading) {
    return (
      <div className="space-y-6">
        {/* Header Skeleton */}
        <div className="flex items-center justify-between">
          <div>
            <div className="h-8 w-64 bg-slate-700 rounded animate-pulse mb-2" />
            <div className="h-4 w-48 bg-slate-700 rounded animate-pulse" />
          </div>
          <div className="h-10 w-72 bg-slate-700 rounded animate-pulse" />
        </div>

        {/* Summary Cards Skeleton */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {[1, 2, 3, 4].map((i) => (
            <Card key={i} className="p-6">
              <div className="animate-pulse">
                <div className="h-4 w-24 bg-slate-700 rounded mb-3" />
                <div className="h-8 w-16 bg-slate-700 rounded mb-2" />
                <div className="h-3 w-32 bg-slate-700 rounded" />
              </div>
            </Card>
          ))}
        </div>

        {/* Charts Skeleton */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {[1, 2, 3, 4].map((i) => (
            <Card key={i} className="p-6">
              <div className="h-6 w-48 bg-slate-700 rounded animate-pulse mb-4" />
              <ChartSkeleton />
            </Card>
          ))}
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <Card className="p-6">
        <div className="text-center">
          <AlertTriangle className="h-12 w-12 text-yellow-400 mx-auto mb-4" />
          <h3 className="text-lg font-semibold text-white mb-2">
            Failed to Load Vulnerability Trends
          </h3>
          <p className="text-slate-400 mb-4">{error}</p>
          <button
            onClick={loadData}
            className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-500 transition-colors"
          >
            Retry
          </button>
        </div>
      </Card>
    );
  }

  if (!data) {
    return null;
  }

  const { summary, daily_counts, severity_trends, remediation_rates, top_recurring } = data;

  // Calculate severity distribution for pie chart
  const severityDistribution = [
    { name: 'Critical', value: summary.critical_open, color: SEVERITY_COLORS.critical },
    { name: 'High', value: summary.high_open, color: SEVERITY_COLORS.high },
    { name: 'Medium', value: summary.current_open - summary.critical_open - summary.high_open, color: SEVERITY_COLORS.medium },
  ].filter(item => item.value > 0);

  return (
    <div className="space-y-6">
      {/* Header with Date Range Selector */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h2 className="text-2xl font-bold text-white mb-1">
            Vulnerability Trends
          </h2>
          <p className="text-slate-400">
            Historical analysis and remediation metrics
          </p>
        </div>
        <div className="flex items-center gap-2 bg-slate-800 border border-slate-700 rounded-lg p-1">
          {([7, 30, 90, 180] as DateRange[]).map((days) => (
            <button
              key={days}
              onClick={() => setDateRange(days)}
              className={`flex items-center gap-2 px-3 py-2 rounded transition-colors ${
                dateRange === days
                  ? 'bg-cyan-600 text-white'
                  : 'text-slate-400 hover:text-white hover:bg-slate-700'
              }`}
            >
              <Calendar className="h-4 w-4" />
              {days}d
            </button>
          ))}
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <StatCard
          title="Current Open"
          value={summary.current_open}
          subtitle={`${summary.critical_open} critical, ${summary.high_open} high`}
          icon={<Bug className="h-6 w-6 text-yellow-400" />}
          color="text-yellow-400"
        />
        <StatCard
          title="Remediation Rate"
          value={`${summary.remediation_rate.toFixed(1)}%`}
          subtitle={`${summary.total_resolved} of ${summary.total_found} resolved`}
          icon={<CheckCircle className="h-6 w-6 text-green-400" />}
          color="text-green-400"
        />
        <StatCard
          title="Avg. MTTR"
          value={`${summary.avg_mttr_days.toFixed(1)}`}
          subtitle="Days to remediate"
          icon={<Clock className="h-6 w-6 text-blue-400" />}
          color="text-blue-400"
        />
        <Card className="p-6">
          <div className="flex items-start justify-between">
            <div className="flex-1">
              <p className="text-slate-400 text-sm font-medium mb-1">Trend</p>
              <div className="flex items-center gap-2">
                {getTrendIcon(summary.trend_direction)}
                <span className={`text-2xl font-bold ${getTrendColor(summary.trend_direction)}`}>
                  {getTrendLabel(summary.trend_direction)}
                </span>
              </div>
              <p className="text-slate-500 text-xs mt-1">
                Compared to previous period
              </p>
            </div>
            <div className="bg-slate-700/50 p-3 rounded-lg">
              <Shield className="h-6 w-6 text-slate-400" />
            </div>
          </div>
        </Card>
      </div>

      {/* Critical/High Breakdown */}
      {(summary.critical_open > 0 || summary.high_open > 0) && (
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Critical Issues Requiring Attention
          </h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-red-500/10 border border-red-500/20 p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">Critical</span>
                <XCircle className="h-4 w-4 text-red-500" />
              </div>
              <p className="text-2xl font-bold text-red-500">
                {summary.critical_open}
              </p>
            </div>
            <div className="bg-orange-500/10 border border-orange-500/20 p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">High</span>
                <AlertTriangle className="h-4 w-4 text-orange-500" />
              </div>
              <p className="text-2xl font-bold text-orange-500">
                {summary.high_open}
              </p>
            </div>
            <div className="bg-slate-700/50 p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">Total Found</span>
                <Bug className="h-4 w-4 text-slate-400" />
              </div>
              <p className="text-2xl font-bold text-white">
                {summary.total_found}
              </p>
            </div>
            <div className="bg-green-500/10 border border-green-500/20 p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">Resolved</span>
                <CheckCircle className="h-4 w-4 text-green-500" />
              </div>
              <p className="text-2xl font-bold text-green-500">
                {summary.total_resolved}
              </p>
            </div>
          </div>
        </Card>
      )}

      {/* Charts Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Vulnerability Count Over Time */}
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Vulnerabilities Over Time
          </h3>
          {daily_counts.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={daily_counts}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis
                  dataKey="date"
                  tickFormatter={formatDate}
                  stroke="#94a3b8"
                  style={{ fontSize: '12px' }}
                />
                <YAxis stroke="#94a3b8" style={{ fontSize: '12px' }} />
                <Tooltip
                  contentStyle={{
                    backgroundColor: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    color: '#fff',
                  }}
                  labelFormatter={formatDate}
                />
                <Legend
                  verticalAlign="bottom"
                  height={36}
                  iconType="circle"
                  wrapperStyle={{ fontSize: '12px', color: '#cbd5e1' }}
                />
                <Line
                  type="monotone"
                  dataKey="open"
                  stroke="#f97316"
                  strokeWidth={2}
                  dot={{ fill: '#f97316', r: 3 }}
                  activeDot={{ r: 5 }}
                  name="Open"
                />
                <Line
                  type="monotone"
                  dataKey="new"
                  stroke="#ef4444"
                  strokeWidth={2}
                  dot={{ fill: '#ef4444', r: 3 }}
                  activeDot={{ r: 5 }}
                  name="New"
                />
                <Line
                  type="monotone"
                  dataKey="resolved"
                  stroke="#22c55e"
                  strokeWidth={2}
                  dot={{ fill: '#22c55e', r: 3 }}
                  activeDot={{ r: 5 }}
                  name="Resolved"
                />
              </LineChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-slate-400">
              <p>No data available</p>
            </div>
          )}
        </Card>

        {/* Severity Distribution Over Time */}
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Severity Distribution Over Time
          </h3>
          {severity_trends.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <AreaChart data={severity_trends}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis
                  dataKey="date"
                  tickFormatter={formatDate}
                  stroke="#94a3b8"
                  style={{ fontSize: '12px' }}
                />
                <YAxis stroke="#94a3b8" style={{ fontSize: '12px' }} />
                <Tooltip
                  contentStyle={{
                    backgroundColor: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    color: '#fff',
                  }}
                  labelFormatter={formatDate}
                />
                <Legend
                  verticalAlign="bottom"
                  height={36}
                  iconType="circle"
                  wrapperStyle={{ fontSize: '12px', color: '#cbd5e1' }}
                />
                <Area
                  type="monotone"
                  dataKey="critical"
                  stackId="1"
                  stroke={SEVERITY_COLORS.critical}
                  fill={SEVERITY_COLORS.critical}
                  fillOpacity={0.6}
                  name="Critical"
                />
                <Area
                  type="monotone"
                  dataKey="high"
                  stackId="1"
                  stroke={SEVERITY_COLORS.high}
                  fill={SEVERITY_COLORS.high}
                  fillOpacity={0.6}
                  name="High"
                />
                <Area
                  type="monotone"
                  dataKey="medium"
                  stackId="1"
                  stroke={SEVERITY_COLORS.medium}
                  fill={SEVERITY_COLORS.medium}
                  fillOpacity={0.6}
                  name="Medium"
                />
                <Area
                  type="monotone"
                  dataKey="low"
                  stackId="1"
                  stroke={SEVERITY_COLORS.low}
                  fill={SEVERITY_COLORS.low}
                  fillOpacity={0.6}
                  name="Low"
                />
              </AreaChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-slate-400">
              <p>No data available</p>
            </div>
          )}
        </Card>

        {/* Remediation Rate Over Time */}
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Remediation Rate Over Time
          </h3>
          {remediation_rates.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={remediation_rates}>
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis
                  dataKey="date"
                  tickFormatter={formatDate}
                  stroke="#94a3b8"
                  style={{ fontSize: '12px' }}
                />
                <YAxis
                  yAxisId="left"
                  stroke="#94a3b8"
                  style={{ fontSize: '12px' }}
                  domain={[0, 100]}
                  tickFormatter={(v) => `${v}%`}
                />
                <YAxis
                  yAxisId="right"
                  orientation="right"
                  stroke="#94a3b8"
                  style={{ fontSize: '12px' }}
                  tickFormatter={(v) => `${v}d`}
                />
                <Tooltip
                  contentStyle={{
                    backgroundColor: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    color: '#fff',
                  }}
                  labelFormatter={formatDate}
                  formatter={(value: number, name: string) => {
                    if (name === 'Remediation Rate') return [`${value.toFixed(1)}%`, name];
                    if (name === 'MTTR (days)') return [`${value.toFixed(1)} days`, name];
                    return [value, name];
                  }}
                />
                <Legend
                  verticalAlign="bottom"
                  height={36}
                  iconType="circle"
                  wrapperStyle={{ fontSize: '12px', color: '#cbd5e1' }}
                />
                <Line
                  yAxisId="left"
                  type="monotone"
                  dataKey="remediation_rate"
                  stroke="#22c55e"
                  strokeWidth={2}
                  dot={{ fill: '#22c55e', r: 3 }}
                  activeDot={{ r: 5 }}
                  name="Remediation Rate"
                />
                <Line
                  yAxisId="right"
                  type="monotone"
                  dataKey="mttr_days"
                  stroke="#06b6d4"
                  strokeWidth={2}
                  dot={{ fill: '#06b6d4', r: 3 }}
                  activeDot={{ r: 5 }}
                  name="MTTR (days)"
                />
              </LineChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-slate-400">
              <p>No data available</p>
            </div>
          )}
        </Card>

        {/* Top Recurring Vulnerabilities */}
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Top Recurring Vulnerabilities
          </h3>
          {top_recurring.length > 0 ? (
            <ResponsiveContainer width="100%" height={300}>
              <BarChart data={top_recurring} layout="vertical">
                <CartesianGrid strokeDasharray="3 3" stroke="#334155" />
                <XAxis type="number" stroke="#94a3b8" style={{ fontSize: '12px' }} />
                <YAxis
                  dataKey="title"
                  type="category"
                  stroke="#94a3b8"
                  style={{ fontSize: '11px' }}
                  width={140}
                  tickFormatter={(value: string) =>
                    value.length > 20 ? `${value.substring(0, 20)}...` : value
                  }
                />
                <Tooltip
                  contentStyle={{
                    backgroundColor: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    color: '#fff',
                  }}
                  content={({ active, payload }) => {
                    if (!active || !payload || !payload[0]) return null;
                    const data = payload[0].payload as RecurringVulnerability;
                    return (
                      <div className="bg-slate-800 border border-slate-700 rounded-lg p-3 text-white text-sm">
                        <div className="font-medium mb-2">{data.title}</div>
                        <div className="space-y-1 text-slate-300">
                          <div>Occurrences: {data.count}</div>
                          <div>Severity: {data.severity}</div>
                          <div>Affected Hosts: {data.affected_hosts}</div>
                          {data.avg_resolution_days !== null && (
                            <div>Avg Resolution: {data.avg_resolution_days.toFixed(1)} days</div>
                          )}
                        </div>
                      </div>
                    );
                  }}
                />
                <Bar
                  dataKey="count"
                  fill="#06b6d4"
                  radius={[0, 4, 4, 0]}
                  name="Occurrences"
                />
              </BarChart>
            </ResponsiveContainer>
          ) : (
            <div className="flex items-center justify-center h-64 text-slate-400">
              <p>No recurring vulnerabilities found</p>
            </div>
          )}
        </Card>
      </div>

      {/* Current Severity Distribution (Pie Chart) */}
      {severityDistribution.length > 0 && (
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Current Open Vulnerabilities by Severity
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <ResponsiveContainer width="100%" height={250}>
              <PieChart>
                <Pie
                  data={severityDistribution}
                  cx="50%"
                  cy="50%"
                  innerRadius={60}
                  outerRadius={100}
                  paddingAngle={2}
                  dataKey="value"
                  nameKey="name"
                  label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                  labelLine={false}
                >
                  {severityDistribution.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip
                  contentStyle={{
                    backgroundColor: '#1e293b',
                    border: '1px solid #334155',
                    borderRadius: '8px',
                    color: '#fff',
                  }}
                />
              </PieChart>
            </ResponsiveContainer>
            <div className="flex flex-col justify-center space-y-4">
              {severityDistribution.map((item) => (
                <div key={item.name} className="flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div
                      className="w-4 h-4 rounded"
                      style={{ backgroundColor: item.color }}
                    />
                    <span className="text-slate-300">{item.name}</span>
                  </div>
                  <span className="text-white font-semibold">{item.value}</span>
                </div>
              ))}
              <div className="border-t border-slate-700 pt-4 mt-4">
                <div className="flex items-center justify-between">
                  <span className="text-slate-300 font-medium">Total Open</span>
                  <span className="text-white font-bold text-lg">{summary.current_open}</span>
                </div>
              </div>
            </div>
          </div>
        </Card>
      )}

      {/* Top Recurring Vulnerabilities Table */}
      {top_recurring.length > 0 && (
        <Card className="p-6">
          <h3 className="text-lg font-semibold text-white mb-4">
            Recurring Vulnerability Details
          </h3>
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead>
                <tr className="border-b border-slate-700">
                  <th className="text-left py-3 px-4 text-slate-400 font-medium">Vulnerability</th>
                  <th className="text-left py-3 px-4 text-slate-400 font-medium">Severity</th>
                  <th className="text-center py-3 px-4 text-slate-400 font-medium">Occurrences</th>
                  <th className="text-center py-3 px-4 text-slate-400 font-medium">Affected Hosts</th>
                  <th className="text-center py-3 px-4 text-slate-400 font-medium">Avg. Resolution</th>
                </tr>
              </thead>
              <tbody>
                {top_recurring.map((vuln, index) => (
                  <tr key={index} className="border-b border-slate-700/50 hover:bg-slate-800/50">
                    <td className="py-3 px-4">
                      <span className="text-white font-medium">{vuln.title}</span>
                      <p className="text-xs text-slate-500 mt-1">{vuln.vulnerability_id}</p>
                    </td>
                    <td className="py-3 px-4">
                      <span
                        className={`inline-flex items-center px-2 py-1 rounded text-xs font-medium ${
                          vuln.severity === 'critical'
                            ? 'bg-red-500/20 text-red-400'
                            : vuln.severity === 'high'
                            ? 'bg-orange-500/20 text-orange-400'
                            : vuln.severity === 'medium'
                            ? 'bg-yellow-500/20 text-yellow-400'
                            : 'bg-blue-500/20 text-blue-400'
                        }`}
                      >
                        {vuln.severity}
                      </span>
                    </td>
                    <td className="py-3 px-4 text-center text-white">{vuln.count}</td>
                    <td className="py-3 px-4 text-center text-white">{vuln.affected_hosts}</td>
                    <td className="py-3 px-4 text-center text-white">
                      {vuln.avg_resolution_days !== null
                        ? `${vuln.avg_resolution_days.toFixed(1)} days`
                        : '-'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      )}
    </div>
  );
};

export default VulnerabilityTrends;
