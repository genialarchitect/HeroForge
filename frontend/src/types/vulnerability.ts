// ============================================================================
// Vulnerability Management Types
// ============================================================================

import type { User } from './auth';

export interface Vulnerability {
  cve_id: string | null;
  title: string;
  severity: 'Low' | 'Medium' | 'High' | 'Critical';
  description: string;
  affected_service: string | null;
}

export type VulnerabilityStatus = 'open' | 'in_progress' | 'resolved' | 'false_positive' | 'accepted_risk';

export interface VulnerabilityTracking {
  id: string;
  scan_id: string;
  host_ip: string;
  port: number | null;
  vulnerability_id: string;
  severity: string;
  status: string;
  assignee_id: string | null;
  notes: string | null;
  due_date: string | null;
  created_at: string;
  updated_at: string;
  resolved_at: string | null;
  resolved_by: string | null;
  jira_ticket_id: string | null;
  jira_ticket_key: string | null;
  jira_ticket_url?: string;
  // Remediation workflow fields
  priority: string | null;
  remediation_steps: string | null;
  estimated_effort: number | null;
  actual_effort: number | null;
  verification_scan_id: string | null;
  verified_at: string | null;
  verified_by: string | null;
  // Retest workflow fields
  retest_requested_at: string | null;
  retest_completed_at: string | null;
  retest_result: 'still_vulnerable' | 'remediated' | 'partially_remediated' | null;
  retest_scan_id: string | null;
  retest_requested_by: string | null;
}

export interface VulnerabilityComment {
  id: string;
  vulnerability_tracking_id: string;
  user_id: string;
  comment: string;
  created_at: string;
}

export interface VulnerabilityCommentWithUser {
  id: string;
  vulnerability_tracking_id: string;
  user_id: string;
  username: string;
  comment: string;
  created_at: string;
  updated_at: string | null;
}

export interface RemediationTimelineEvent {
  id: string;
  vulnerability_tracking_id: string;
  user_id: string;
  username: string;
  event_type: string;
  old_value: string | null;
  new_value: string | null;
  comment: string | null;
  created_at: string;
}

export interface VulnerabilityDetail {
  vulnerability: VulnerabilityTracking;
  comments: VulnerabilityCommentWithUser[];
  timeline: RemediationTimelineEvent[];
  assignee: User | null;
  resolved_by_user: User | null;
  verified_by_user: User | null;
}

export interface UpdateVulnerabilityRequest {
  status?: string;
  assignee_id?: string;
  notes?: string;
  due_date?: string;
  // Remediation workflow fields
  priority?: string;
  remediation_steps?: string;
  estimated_effort?: number;
  actual_effort?: number;
}

export interface AddVulnerabilityCommentRequest {
  comment: string;
}

export interface BulkUpdateVulnerabilitiesRequest {
  vulnerability_ids: string[];
  status?: string;
  assignee_id?: string;
  due_date?: string;
  priority?: string;
}

export interface BulkAssignVulnerabilitiesRequest {
  vulnerability_ids: string[];
  assignee_id: string;
  due_date?: string;
}

export interface BulkUpdateSeverityRequest {
  vulnerability_ids: string[];
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
}

export interface BulkDeleteVulnerabilitiesRequest {
  vulnerability_ids: string[];
}

export interface BulkAddTagsRequest {
  vulnerability_ids: string[];
  tags: string[];
}

export interface BulkOperationResponse {
  updated?: number;
  deleted?: number;
  failed: number;
  message: string;
}

export interface VerifyVulnerabilityRequest {
  scan_id?: string;
}

// Vulnerability Assignment Types
export interface VulnerabilityAssignmentWithUser {
  id: string;
  scan_id: string;
  host_ip: string;
  port: number | null;
  vulnerability_id: string;
  severity: string;
  status: string;
  assignee_id: string | null;
  assignee_username: string | null;
  assignee_email: string | null;
  notes: string | null;
  due_date: string | null;
  priority: string | null;
  created_at: string;
  updated_at: string;
  scan_name: string | null;
  is_overdue: boolean;
  days_until_due: number | null;
}

export interface UserAssignmentStats {
  total: number;
  open: number;
  in_progress: number;
  overdue: number;
  due_today: number;
  due_this_week: number;
  critical: number;
  high: number;
}

export interface MyAssignmentsResponse {
  stats: UserAssignmentStats;
  assignments: VulnerabilityAssignmentWithUser[];
}

export interface AssignVulnerabilityRequest {
  assignee_id: string;
  due_date?: string;
  priority?: string;
}

export interface UpdateAssignmentRequest {
  due_date?: string;
  priority?: string;
  status?: string;
}

// Retest workflow types
export interface RequestRetestRequest {
  notes?: string;
}

export interface BulkRetestRequest {
  vulnerability_ids: string[];
  notes?: string;
}

export interface CompleteRetestRequest {
  result: 'still_vulnerable' | 'remediated' | 'partially_remediated';
  scan_id?: string;
  notes?: string;
}

export interface VulnerabilityStats {
  total: number;
  open: number;
  in_progress: number;
  resolved: number;
  false_positive: number;
  accepted_risk: number;
  critical: number;
  high: number;
  medium: number;
  low: number;
}

// Vulnerability Trends Types

export interface DailyVulnerabilityCount {
  date: string;
  total: number;
  new: number;
  resolved: number;
  open: number;
}

export interface RemediationRatePoint {
  date: string;
  total_found: number;
  total_resolved: number;
  remediation_rate: number;
  mttr_days: number;
}

export interface RecurringVulnerability {
  vulnerability_id: string;
  title: string;
  severity: string;
  count: number;
  affected_hosts: number;
  avg_resolution_days: number | null;
}

export interface VulnerabilityTrendsSummary {
  total_found: number;
  total_resolved: number;
  current_open: number;
  avg_mttr_days: number;
  remediation_rate: number;
  trend_direction: 'improving' | 'stable' | 'declining';
  critical_open: number;
  high_open: number;
}

export interface VulnerabilityTrendsData {
  daily_counts: DailyVulnerabilityCount[];
  severity_trends: import('./scan').VulnerabilityTimeSeriesDataPoint[];
  remediation_rates: RemediationRatePoint[];
  top_recurring: RecurringVulnerability[];
  summary: VulnerabilityTrendsSummary;
}
