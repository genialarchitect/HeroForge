import React, { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';
import Layout from '../components/layout/Layout';
import Button from '../components/ui/Button';
import AttackSelector, { AttackType } from '../components/exploitation/AttackSelector';
import PasswordSprayForm from '../components/exploitation/PasswordSprayForm';
import KerberosAttackForm from '../components/exploitation/KerberosAttackForm';
import PostExploitForm from '../components/exploitation/PostExploitForm';
import {
  Crosshair,
  Key,
  Terminal,
  Layers,
  Play,
  Square,
  Trash2,
  Plus,
  Shield,
  Activity,
  AlertTriangle,
  CheckCircle,
  Clock,
  Copy,
  Download,
  RefreshCw,
  ChevronDown,
  ChevronRight,
  X,
  Eye,
  FileText,
} from 'lucide-react';
import { exploitationAPI } from '../services/api';

type TabType = 'dashboard' | 'campaigns' | 'shells' | 'modules';

interface Campaign {
  id: string;
  name: string;
  attack_type: string;
  status: string;
  targets: string[];
  results_count: number;
  successful_count: number;
  created_at: string;
  started_at?: string;
  completed_at?: string;
}

interface ShellTemplate {
  format: string;
  platform: string;
  name: string;
  description: string;
  requires_msfvenom: boolean;
}

interface PostExploitModule {
  module: string;
  name: string;
  description: string;
  category: string;
  platforms: string[];
}

interface ExploitationStatus {
  msfvenom_available: boolean;
  active_campaigns: number;
  total_campaigns: number;
  credentials_stored: number;
  payloads_generated: number;
}

const ExploitationPage: React.FC = () => {
  const { tab } = useParams<{ tab?: string }>();
  const navigate = useNavigate();
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<TabType>('dashboard');
  const [showShellGenerator, setShowShellGenerator] = useState(false);
  const [showAttackSelector, setShowAttackSelector] = useState(false);
  const [selectedAttack, setSelectedAttack] = useState<AttackType | null>(null);
  const [selectedCampaignId, setSelectedCampaignId] = useState<string | null>(null);

  // Handle URL-based navigation
  useEffect(() => {
    if (!tab) {
      setActiveTab('dashboard');
      return;
    }

    // Map URL paths to tabs or open specific forms
    switch (tab) {
      case 'password-spray':
        setSelectedAttack({
          id: 'password_spray',
          name: 'Password Spray',
          description: 'Test common passwords against multiple accounts',
          category: 'credential',
          icon: <Key className="h-6 w-6" />,
          difficulty: 'easy',
          risk: 'medium',
        });
        break;
      case 'kerberos':
        setSelectedAttack({
          id: 'kerberoast',
          name: 'Kerberoasting',
          description: 'Extract TGS tickets for offline cracking',
          category: 'credential',
          icon: <Shield className="h-6 w-6" />,
          difficulty: 'medium',
          risk: 'low',
        });
        break;
      case 'asrep-roast':
        setSelectedAttack({
          id: 'asrep_roast',
          name: 'AS-REP Roasting',
          description: 'Target accounts without Kerberos pre-authentication',
          category: 'credential',
          icon: <Key className="h-6 w-6" />,
          difficulty: 'medium',
          risk: 'low',
        });
        break;
      case 'smb-relay':
        setSelectedAttack({
          id: 'smb_relay',
          name: 'SMB Relay',
          description: 'Relay NTLM authentication to other targets',
          category: 'credential',
          icon: <Shield className="h-6 w-6" />,
          difficulty: 'hard',
          risk: 'high',
        });
        break;
      case 'shells':
        setActiveTab('shells');
        break;
      case 'credential-dump':
        setSelectedAttack({
          id: 'credential_dump',
          name: 'Credential Dump',
          description: 'Extract credentials from memory, registry, or files',
          category: 'post-exploit',
          icon: <Layers className="h-6 w-6" />,
          difficulty: 'medium',
          risk: 'high',
        });
        break;
      case 'priv-esc':
        setSelectedAttack({
          id: 'priv_esc',
          name: 'Privilege Escalation',
          description: 'Check for privilege escalation vectors',
          category: 'post-exploit',
          icon: <Layers className="h-6 w-6" />,
          difficulty: 'medium',
          risk: 'medium',
        });
        break;
      case 'persistence':
        setSelectedAttack({
          id: 'persistence',
          name: 'Persistence',
          description: 'Establish persistent access mechanisms',
          category: 'post-exploit',
          icon: <Layers className="h-6 w-6" />,
          difficulty: 'hard',
          risk: 'high',
        });
        break;
      case 'lateral-movement':
        setSelectedAttack({
          id: 'lateral_movement',
          name: 'Lateral Movement',
          description: 'Move to other systems using Pass-the-Hash, WMI, PsExec',
          category: 'post-exploit',
          icon: <Layers className="h-6 w-6" />,
          difficulty: 'hard',
          risk: 'high',
        });
        break;
      case 'post-exploit':
        setActiveTab('modules');
        break;
      case 'campaigns':
        setActiveTab('campaigns');
        break;
      default:
        setActiveTab('dashboard');
    }
  }, [tab]);

  // Shell generator state
  const [shellConfig, setShellConfig] = useState({
    shell_type: 'reverse_shell',
    platform: 'linux',
    format: 'bash',
    lhost: '',
    lport: 4444,
    encoding: 'none',
    obfuscation_level: 0,
    staged: false,
  });
  const [generatedShell, setGeneratedShell] = useState<any>(null);

  // Fetch status
  const { data: status } = useQuery<ExploitationStatus>({
    queryKey: ['exploitation-status'],
    queryFn: async () => {
      const response = await exploitationAPI.getStatus();
      return response.data;
    },
  });

  // Fetch campaigns
  const { data: campaigns = [] } = useQuery<Campaign[]>({
    queryKey: ['exploitation-campaigns'],
    queryFn: async () => {
      const response = await exploitationAPI.listCampaigns();
      return response.data;
    },
  });

  // Fetch shell templates
  const { data: shellTemplates = [] } = useQuery<ShellTemplate[]>({
    queryKey: ['shell-templates'],
    queryFn: async () => {
      const response = await exploitationAPI.listShellTemplates();
      return response.data;
    },
  });

  // Fetch post-exploit modules
  const { data: modules = [] } = useQuery<PostExploitModule[]>({
    queryKey: ['post-exploit-modules'],
    queryFn: async () => {
      const response = await exploitationAPI.listModules();
      return response.data;
    },
  });

  // Generate shell mutation
  const generateShellMutation = useMutation({
    mutationFn: async (config: any) => {
      const response = await exploitationAPI.generateShell(config);
      return response.data;
    },
    onSuccess: (data) => {
      setGeneratedShell(data);
      toast.success('Shell payload generated!');
      queryClient.invalidateQueries({ queryKey: ['exploitation-status'] });
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.message || 'Failed to generate shell');
    },
  });

  // Delete campaign mutation
  const deleteCampaignMutation = useMutation({
    mutationFn: async (id: string) => {
      await exploitationAPI.deleteCampaign(id);
    },
    onSuccess: () => {
      toast.success('Campaign deleted');
      queryClient.invalidateQueries({ queryKey: ['exploitation-campaigns'] });
    },
  });

  // Start campaign mutation
  const startCampaignMutation = useMutation({
    mutationFn: async ({ id, authorized }: { id: string; authorized: boolean }) => {
      await exploitationAPI.startCampaign(id, authorized);
    },
    onSuccess: () => {
      toast.success('Campaign started');
      queryClient.invalidateQueries({ queryKey: ['exploitation-campaigns'] });
      queryClient.invalidateQueries({ queryKey: ['exploitation-status'] });
    },
    onError: (error: any) => {
      toast.error(error.response?.data?.message || 'Failed to start campaign');
    },
  });

  // Stop campaign mutation
  const stopCampaignMutation = useMutation({
    mutationFn: async (id: string) => {
      await exploitationAPI.stopCampaign(id);
    },
    onSuccess: () => {
      toast.success('Campaign stopped');
      queryClient.invalidateQueries({ queryKey: ['exploitation-campaigns'] });
      queryClient.invalidateQueries({ queryKey: ['exploitation-status'] });
    },
  });

  // Handle attack selection from selector
  const handleAttackSelect = (attack: AttackType) => {
    setShowAttackSelector(false);

    // Route shell generation attacks to the shell generator
    if (['reverse_shell', 'bind_shell', 'web_shell', 'meterpreter'].includes(attack.id)) {
      // Map attack types to shell config
      const shellTypeMap: Record<string, string> = {
        'reverse_shell': 'reverse_shell',
        'bind_shell': 'bind_shell',
        'web_shell': 'web_shell',
        'meterpreter': 'reverse_shell', // Meterpreter uses reverse shell with meterpreter format
      };
      const formatMap: Record<string, string> = {
        'reverse_shell': 'bash',
        'bind_shell': 'bash',
        'web_shell': 'php',
        'meterpreter': 'meterpreter_exe',
      };
      setShellConfig({
        ...shellConfig,
        shell_type: shellTypeMap[attack.id] || 'reverse_shell',
        format: formatMap[attack.id] || 'bash',
      });
      setShowShellGenerator(true);
      return;
    }

    // For other attack types, show the form
    setSelectedAttack(attack);
  };

  // Handle campaign created from forms
  const handleCampaignCreated = (campaignId: string) => {
    setSelectedAttack(null);
    queryClient.invalidateQueries({ queryKey: ['exploitation-campaigns'] });
    queryClient.invalidateQueries({ queryKey: ['exploitation-status'] });
    setActiveTab('campaigns');
    navigate('/exploitation/campaigns');
    toast.success('Campaign created successfully!');
  };

  // Handle form close - navigate back to main exploitation page
  const handleFormClose = () => {
    setSelectedAttack(null);
    navigate('/exploitation');
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('Copied to clipboard!');
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'running':
        return 'text-yellow-400';
      case 'completed':
        return 'text-green-400';
      case 'failed':
        return 'text-red-400';
      case 'cancelled':
        return 'text-gray-400';
      default:
        return 'text-blue-400';
    }
  };

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'running':
        return <Activity className="h-4 w-4 animate-pulse" />;
      case 'completed':
        return <CheckCircle className="h-4 w-4" />;
      case 'failed':
        return <AlertTriangle className="h-4 w-4" />;
      case 'cancelled':
        return <Square className="h-4 w-4" />;
      default:
        return <Clock className="h-4 w-4" />;
    }
  };

  return (
    <Layout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center gap-3">
              <Crosshair className="h-7 w-7 text-red-500" />
              Exploitation Framework
            </h1>
            <p className="text-gray-400 mt-1">
              Password spraying, Kerberos attacks, shell generation, and post-exploitation
            </p>
          </div>
          <div className="flex gap-3">
            <Button
              variant="secondary"
              onClick={() => setShowShellGenerator(true)}
            >
              <Terminal className="h-4 w-4 mr-2" />
              Generate Shell
            </Button>
            <Button
              variant="primary"
              onClick={() => setShowAttackSelector(true)}
            >
              <Plus className="h-4 w-4 mr-2" />
              New Campaign
            </Button>
          </div>
        </div>

        {/* Status Cards */}
        <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-400 text-sm">Active Campaigns</span>
              <Activity className="h-5 w-5 text-yellow-400" />
            </div>
            <p className="text-2xl font-bold text-white mt-2">
              {status?.active_campaigns ?? 0}
            </p>
          </div>
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-400 text-sm">Total Campaigns</span>
              <Crosshair className="h-5 w-5 text-blue-400" />
            </div>
            <p className="text-2xl font-bold text-white mt-2">
              {status?.total_campaigns ?? 0}
            </p>
          </div>
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-400 text-sm">Credentials Found</span>
              <Key className="h-5 w-5 text-green-400" />
            </div>
            <p className="text-2xl font-bold text-white mt-2">
              {status?.credentials_stored ?? 0}
            </p>
          </div>
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-400 text-sm">Payloads Generated</span>
              <Terminal className="h-5 w-5 text-purple-400" />
            </div>
            <p className="text-2xl font-bold text-white mt-2">
              {status?.payloads_generated ?? 0}
            </p>
          </div>
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <div className="flex items-center justify-between">
              <span className="text-gray-400 text-sm">Msfvenom</span>
              {status?.msfvenom_available ? (
                <CheckCircle className="h-5 w-5 text-green-400" />
              ) : (
                <AlertTriangle className="h-5 w-5 text-yellow-400" />
              )}
            </div>
            <p className="text-sm font-medium text-white mt-2">
              {status?.msfvenom_available ? 'Available' : 'Not Found'}
            </p>
          </div>
        </div>

        {/* Tabs */}
        <div className="border-b border-dark-border">
          <nav className="flex gap-4">
            {(['dashboard', 'campaigns', 'shells', 'modules'] as TabType[]).map((tab) => (
              <button
                key={tab}
                onClick={() => setActiveTab(tab)}
                className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                  activeTab === tab
                    ? 'border-primary text-primary'
                    : 'border-transparent text-gray-400 hover:text-white'
                }`}
              >
                {tab.charAt(0).toUpperCase() + tab.slice(1)}
              </button>
            ))}
          </nav>
        </div>

        {/* Tab Content */}
        {activeTab === 'dashboard' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Recent Campaigns */}
            <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
              <h3 className="text-lg font-semibold text-white mb-4">Recent Campaigns</h3>
              {campaigns.length === 0 ? (
                <p className="text-gray-400 text-sm">No campaigns yet</p>
              ) : (
                <div className="space-y-3">
                  {campaigns.slice(0, 5).map((campaign) => (
                    <div
                      key={campaign.id}
                      className="flex items-center justify-between p-3 bg-dark-bg rounded-lg"
                    >
                      <div>
                        <p className="text-white font-medium">{campaign.name}</p>
                        <p className="text-gray-400 text-sm">{campaign.attack_type}</p>
                      </div>
                      <div className={`flex items-center gap-2 ${getStatusColor(campaign.status)}`}>
                        {getStatusIcon(campaign.status)}
                        <span className="text-sm capitalize">{campaign.status}</span>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Quick Actions */}
            <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
              <h3 className="text-lg font-semibold text-white mb-4">Quick Actions</h3>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setSelectedAttack({
                    id: 'password_spray',
                    name: 'Password Spray',
                    description: 'Test common passwords against multiple accounts',
                    category: 'credential',
                    icon: <Key className="h-6 w-6" />,
                    difficulty: 'easy',
                    risk: 'medium',
                  })}
                  className="p-4 bg-dark-bg rounded-lg border border-dark-border hover:border-primary transition-colors text-left"
                >
                  <Key className="h-6 w-6 text-blue-400 mb-2" />
                  <p className="text-white font-medium">Password Spray</p>
                  <p className="text-gray-400 text-sm">Credential testing</p>
                </button>
                <button
                  onClick={() => setSelectedAttack({
                    id: 'kerberoast',
                    name: 'Kerberoasting',
                    description: 'Extract TGS tickets for offline cracking',
                    category: 'credential',
                    icon: <Shield className="h-6 w-6" />,
                    difficulty: 'medium',
                    risk: 'low',
                  })}
                  className="p-4 bg-dark-bg rounded-lg border border-dark-border hover:border-primary transition-colors text-left"
                >
                  <Shield className="h-6 w-6 text-purple-400 mb-2" />
                  <p className="text-white font-medium">Kerberoast</p>
                  <p className="text-gray-400 text-sm">Extract TGS tickets</p>
                </button>
                <button
                  onClick={() => setShowShellGenerator(true)}
                  className="p-4 bg-dark-bg rounded-lg border border-dark-border hover:border-primary transition-colors text-left"
                >
                  <Terminal className="h-6 w-6 text-green-400 mb-2" />
                  <p className="text-white font-medium">Shell Generator</p>
                  <p className="text-gray-400 text-sm">Create payloads</p>
                </button>
                <button
                  onClick={() => setActiveTab('modules')}
                  className="p-4 bg-dark-bg rounded-lg border border-dark-border hover:border-primary transition-colors text-left"
                >
                  <Layers className="h-6 w-6 text-red-400 mb-2" />
                  <p className="text-white font-medium">Post-Exploit</p>
                  <p className="text-gray-400 text-sm">Modules & tools</p>
                </button>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'campaigns' && (
          <div className="bg-dark-surface border border-dark-border rounded-lg">
            <div className="p-4 border-b border-dark-border">
              <h3 className="text-lg font-semibold text-white">Campaigns</h3>
            </div>
            {campaigns.length === 0 ? (
              <div className="p-8 text-center">
                <Crosshair className="h-12 w-12 text-gray-600 mx-auto mb-4" />
                <p className="text-gray-400">No campaigns yet</p>
                <Button
                  variant="primary"
                  className="mt-4"
                  onClick={() => setShowAttackSelector(true)}
                >
                  Create First Campaign
                </Button>
              </div>
            ) : (
              <table className="w-full">
                <thead>
                  <tr className="text-left text-gray-400 text-sm border-b border-dark-border">
                    <th className="p-4">Name</th>
                    <th className="p-4">Type</th>
                    <th className="p-4">Status</th>
                    <th className="p-4">Targets</th>
                    <th className="p-4">Results</th>
                    <th className="p-4">Created</th>
                    <th className="p-4">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {campaigns.map((campaign) => (
                    <tr key={campaign.id} className="border-b border-dark-border hover:bg-dark-bg">
                      <td className="p-4 text-white font-medium">{campaign.name}</td>
                      <td className="p-4 text-gray-300">{campaign.attack_type}</td>
                      <td className="p-4">
                        <span className={`flex items-center gap-2 ${getStatusColor(campaign.status)}`}>
                          {getStatusIcon(campaign.status)}
                          <span className="capitalize">{campaign.status}</span>
                        </span>
                      </td>
                      <td className="p-4 text-gray-300">{campaign.targets.length}</td>
                      <td className="p-4">
                        <span className="text-green-400">{campaign.successful_count}</span>
                        <span className="text-gray-500"> / {campaign.results_count}</span>
                      </td>
                      <td className="p-4 text-gray-400 text-sm">
                        {new Date(campaign.created_at).toLocaleDateString()}
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-2">
                          {campaign.status === 'pending' && (
                            <button
                              onClick={() => startCampaignMutation.mutate({ id: campaign.id, authorized: true })}
                              className="text-green-400 hover:text-green-300 p-2"
                              title="Start Campaign"
                            >
                              <Play className="h-4 w-4" />
                            </button>
                          )}
                          {campaign.status === 'running' && (
                            <button
                              onClick={() => stopCampaignMutation.mutate(campaign.id)}
                              className="text-yellow-400 hover:text-yellow-300 p-2"
                              title="Stop Campaign"
                            >
                              <Square className="h-4 w-4" />
                            </button>
                          )}
                          <button
                            onClick={() => setSelectedCampaignId(campaign.id)}
                            className="text-blue-400 hover:text-blue-300 p-2"
                            title="View Results"
                          >
                            <Eye className="h-4 w-4" />
                          </button>
                          <button
                            onClick={() => deleteCampaignMutation.mutate(campaign.id)}
                            className="text-red-400 hover:text-red-300 p-2"
                            title="Delete Campaign"
                          >
                            <Trash2 className="h-4 w-4" />
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>
        )}

        {activeTab === 'shells' && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Shell Templates */}
            <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
              <h3 className="text-lg font-semibold text-white mb-4">Shell Templates</h3>
              <div className="space-y-3">
                {shellTemplates.map((template, idx) => (
                  <div
                    key={idx}
                    className="p-3 bg-dark-bg rounded-lg border border-dark-border hover:border-primary cursor-pointer transition-colors"
                    onClick={() => {
                      setShellConfig({
                        ...shellConfig,
                        format: template.format.toLowerCase(),
                        platform: template.platform.toLowerCase(),
                      });
                      setShowShellGenerator(true);
                    }}
                  >
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-white font-medium">{template.name}</p>
                        <p className="text-gray-400 text-sm">{template.description}</p>
                      </div>
                      {template.requires_msfvenom && (
                        <span className="text-xs bg-yellow-500/20 text-yellow-400 px-2 py-1 rounded">
                          msfvenom
                        </span>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Generated Shell Preview */}
            {generatedShell && (
              <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-semibold text-white">Generated Payload</h3>
                  <button
                    onClick={() => setGeneratedShell(null)}
                    className="text-gray-400 hover:text-white"
                  >
                    <X className="h-5 w-5" />
                  </button>
                </div>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Payload</label>
                    <div className="relative">
                      <pre className="bg-dark-bg p-3 rounded-lg text-green-400 text-sm overflow-x-auto max-h-48">
                        {generatedShell.payload}
                      </pre>
                      <button
                        onClick={() => copyToClipboard(generatedShell.payload)}
                        className="absolute top-2 right-2 text-gray-400 hover:text-white"
                      >
                        <Copy className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                  {generatedShell.one_liner && (
                    <div>
                      <label className="block text-sm text-gray-400 mb-2">One-Liner</label>
                      <div className="relative">
                        <pre className="bg-dark-bg p-3 rounded-lg text-blue-400 text-sm overflow-x-auto">
                          {generatedShell.one_liner}
                        </pre>
                        <button
                          onClick={() => copyToClipboard(generatedShell.one_liner)}
                          className="absolute top-2 right-2 text-gray-400 hover:text-white"
                        >
                          <Copy className="h-4 w-4" />
                        </button>
                      </div>
                    </div>
                  )}
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Listener Command</label>
                    <div className="relative">
                      <pre className="bg-dark-bg p-3 rounded-lg text-yellow-400 text-sm">
                        {generatedShell.listener_command}
                      </pre>
                      <button
                        onClick={() => copyToClipboard(generatedShell.listener_command)}
                        className="absolute top-2 right-2 text-gray-400 hover:text-white"
                      >
                        <Copy className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {activeTab === 'modules' && (
          <div className="bg-dark-surface border border-dark-border rounded-lg p-4">
            <h3 className="text-lg font-semibold text-white mb-4">Post-Exploitation Modules</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {modules.map((module, idx) => {
                // Map module categories to attack types
                const categoryToAttackType: Record<string, string> = {
                  'credential_harvesting': 'credential_dump',
                  'privilege_escalation': 'priv_esc',
                  'persistence': 'persistence',
                  'lateral_movement': 'lateral_movement',
                };
                const attackTypeId = categoryToAttackType[module.category] || 'credential_dump';

                return (
                  <div
                    key={idx}
                    onClick={() => setSelectedAttack({
                      id: attackTypeId,
                      name: module.name,
                      description: module.description,
                      category: 'post-exploit',
                      icon: <Layers className="h-6 w-6" />,
                      difficulty: 'medium',
                      risk: 'high',
                    })}
                    className="p-4 bg-dark-bg rounded-lg border border-dark-border hover:border-primary cursor-pointer transition-colors"
                  >
                    <div className="flex items-start justify-between">
                      <div>
                        <p className="text-white font-medium">{module.name}</p>
                        <p className="text-gray-400 text-sm mt-1">{module.description}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2 mt-3">
                      <span className="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded">
                        {module.category}
                      </span>
                      {module.platforms.map((platform) => (
                        <span
                          key={platform}
                          className="text-xs bg-gray-500/20 text-gray-400 px-2 py-1 rounded"
                        >
                          {platform}
                        </span>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {/* Shell Generator Modal */}
        {showShellGenerator && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div className="bg-dark-surface border border-dark-border rounded-lg p-6 w-full max-w-lg">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                  <Terminal className="h-5 w-5 text-green-400" />
                  Shell Generator
                </h2>
                <button
                  onClick={() => setShowShellGenerator(false)}
                  className="text-gray-400 hover:text-white"
                >
                  <X className="h-5 w-5" />
                </button>
              </div>

              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Shell Type</label>
                    <select
                      value={shellConfig.shell_type}
                      onChange={(e) => setShellConfig({ ...shellConfig, shell_type: e.target.value })}
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    >
                      <option value="reverse_shell">Reverse Shell</option>
                      <option value="bind_shell">Bind Shell</option>
                      <option value="web_shell">Web Shell</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Platform</label>
                    <select
                      value={shellConfig.platform}
                      onChange={(e) => setShellConfig({ ...shellConfig, platform: e.target.value })}
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    >
                      <option value="linux">Linux</option>
                      <option value="windows">Windows</option>
                      <option value="macos">macOS</option>
                      <option value="universal">Universal</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="block text-sm text-gray-400 mb-2">Format</label>
                  <select
                    value={shellConfig.format}
                    onChange={(e) => setShellConfig({ ...shellConfig, format: e.target.value })}
                    className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                  >
                    <option value="bash">Bash</option>
                    <option value="powershell">PowerShell</option>
                    <option value="python">Python</option>
                    <option value="perl">Perl</option>
                    <option value="php">PHP</option>
                    <option value="meterpreter_exe">Meterpreter EXE</option>
                    <option value="meterpreter_elf">Meterpreter ELF</option>
                    <option value="meterpreter_powershell">Meterpreter PowerShell</option>
                  </select>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">LHOST</label>
                    <input
                      type="text"
                      value={shellConfig.lhost}
                      onChange={(e) => setShellConfig({ ...shellConfig, lhost: e.target.value })}
                      placeholder="192.168.1.100"
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    />
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">LPORT</label>
                    <input
                      type="number"
                      value={shellConfig.lport}
                      onChange={(e) => setShellConfig({ ...shellConfig, lport: parseInt(e.target.value) || 4444 })}
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Encoding</label>
                    <select
                      value={shellConfig.encoding}
                      onChange={(e) => setShellConfig({ ...shellConfig, encoding: e.target.value })}
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    >
                      <option value="none">None</option>
                      <option value="base64">Base64</option>
                      <option value="hex">Hex</option>
                      <option value="xor">XOR</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-400 mb-2">Obfuscation</label>
                    <select
                      value={shellConfig.obfuscation_level}
                      onChange={(e) => setShellConfig({ ...shellConfig, obfuscation_level: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-white"
                    >
                      <option value={0}>None</option>
                      <option value={1}>Light</option>
                      <option value={2}>Medium</option>
                      <option value={3}>Heavy</option>
                    </select>
                  </div>
                </div>

                <div className="flex justify-end gap-3 pt-4 border-t border-dark-border">
                  <Button variant="secondary" onClick={() => setShowShellGenerator(false)}>
                    Cancel
                  </Button>
                  <Button
                    variant="primary"
                    onClick={() => {
                      generateShellMutation.mutate(shellConfig);
                      setShowShellGenerator(false);
                    }}
                    disabled={!shellConfig.lhost || generateShellMutation.isPending}
                  >
                    {generateShellMutation.isPending ? (
                      <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                    ) : (
                      <Terminal className="h-4 w-4 mr-2" />
                    )}
                    Generate
                  </Button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Attack Selector Modal */}
        <AttackSelector
          isOpen={showAttackSelector}
          onClose={() => setShowAttackSelector(false)}
          onSelect={handleAttackSelect}
          msfvenomAvailable={status?.msfvenom_available ?? false}
        />

        {/* Password Spray Form */}
        {selectedAttack?.id === 'password_spray' && (
          <PasswordSprayForm
            isOpen={true}
            onClose={handleFormClose}
            onCampaignCreated={handleCampaignCreated}
          />
        )}

        {/* Kerberos Attack Forms */}
        {(selectedAttack?.id === 'kerberoast' || selectedAttack?.id === 'asrep_roast') && (
          <KerberosAttackForm
            isOpen={true}
            onClose={handleFormClose}
            onCampaignCreated={handleCampaignCreated}
            attackType={selectedAttack.id as 'kerberoast' | 'asrep_roast'}
          />
        )}

        {/* Post-Exploitation Forms */}
        {(selectedAttack?.id === 'credential_dump' ||
          selectedAttack?.id === 'priv_esc' ||
          selectedAttack?.id === 'persistence' ||
          selectedAttack?.id === 'lateral_movement' ||
          selectedAttack?.id === 'smb_relay') && (
          <PostExploitForm
            isOpen={true}
            onClose={handleFormClose}
            onCampaignCreated={handleCampaignCreated}
            attackType={selectedAttack.id as 'credential_dump' | 'priv_esc' | 'persistence' | 'lateral_movement' | 'smb_relay'}
          />
        )}

        {/* Campaign Results Modal */}
        {selectedCampaignId && (
          <CampaignResultsModal
            campaignId={selectedCampaignId}
            onClose={() => setSelectedCampaignId(null)}
          />
        )}
      </div>
    </Layout>
  );
};

// Campaign Results Modal Component
const CampaignResultsModal: React.FC<{
  campaignId: string;
  onClose: () => void;
}> = ({ campaignId, onClose }) => {
  const { data: results = [], isLoading } = useQuery({
    queryKey: ['campaign-results', campaignId],
    queryFn: async () => {
      const response = await exploitationAPI.getCampaignResults(campaignId);
      return response.data;
    },
  });

  const exportResults = async (format: 'json' | 'csv') => {
    try {
      const response = await exploitationAPI.exportResults(campaignId, format);
      const blob = new Blob([response.data], {
        type: format === 'json' ? 'application/json' : 'text/csv'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campaign-${campaignId}.${format}`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast.success(`Results exported as ${format.toUpperCase()}`);
    } catch (error) {
      toast.error('Failed to export results');
    }
  };

  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
      <div className="bg-dark-surface border border-dark-border rounded-xl w-full max-w-4xl max-h-[80vh] overflow-hidden flex flex-col">
        <div className="p-6 border-b border-dark-border flex items-center justify-between">
          <h2 className="text-xl font-bold text-white">Campaign Results</h2>
          <div className="flex items-center gap-3">
            <Button variant="secondary" onClick={() => exportResults('json')}>
              <Download className="h-4 w-4 mr-2" />
              JSON
            </Button>
            <Button variant="secondary" onClick={() => exportResults('csv')}>
              <FileText className="h-4 w-4 mr-2" />
              CSV
            </Button>
            <button onClick={onClose} className="text-gray-400 hover:text-white">
              <X className="h-6 w-6" />
            </button>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6">
          {isLoading ? (
            <div className="flex items-center justify-center py-12">
              <RefreshCw className="h-8 w-8 text-primary animate-spin" />
            </div>
          ) : results.length === 0 ? (
            <div className="text-center py-12">
              <Eye className="h-12 w-12 text-gray-600 mx-auto mb-4" />
              <p className="text-gray-400">No results yet</p>
            </div>
          ) : (
            <div className="space-y-4">
              {results.map((result: any) => (
                <div
                  key={result.id}
                  className={`p-4 rounded-lg border ${
                    result.success
                      ? 'bg-green-500/10 border-green-500/30'
                      : 'bg-dark-bg border-dark-border'
                  }`}
                >
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-3">
                      {result.success ? (
                        <CheckCircle className="h-5 w-5 text-green-400" />
                      ) : (
                        <AlertTriangle className="h-5 w-5 text-gray-400" />
                      )}
                      <span className="text-white font-medium">{result.target}</span>
                    </div>
                    <span className="text-sm text-gray-400">
                      {new Date(result.created_at).toLocaleString()}
                    </span>
                  </div>
                  {result.result_type && (
                    <span className="inline-block text-xs bg-primary/20 text-primary px-2 py-1 rounded mb-2">
                      {result.result_type}
                    </span>
                  )}
                  {result.data && (
                    <pre className="mt-2 p-3 bg-dark-bg rounded text-sm text-gray-300 overflow-x-auto">
                      {typeof result.data === 'string'
                        ? result.data
                        : JSON.stringify(result.data, null, 2)}
                    </pre>
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ExploitationPage;
