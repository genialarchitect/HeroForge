import React, { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';
import {
  Database,
  Search,
  Code,
  FileText,
  Star,
  History,
  RefreshCw,
  Plus,
  Eye,
  Edit,
  Trash2,
  X,
  Download,
  ExternalLink,
  Shield,
  AlertTriangle,
  CheckCircle,
  Clock,
  Filter,
  Copy,
  Tag,
  Link2,
  Server,
  Folder,
  Play,
  Terminal,
  BookOpen,
  Layers,
  GitBranch,
} from 'lucide-react';
import Layout from '../components/layout/Layout';
import api from '../services/api';

type TabType = 'search' | 'cve-mapping' | 'pocs' | 'workspaces' | 'favorites' | 'history';

// ============================================================================
// Types
// ============================================================================

interface Exploit {
  id: string;
  exploit_id: string;
  title: string;
  description: string;
  source: string; // exploit_db, metasploit, packetstorm
  source_id: string;
  platform: string;
  exploit_type: string;
  cve_ids: string[];
  author?: string;
  publish_date?: string;
  verified: boolean;
  has_code: boolean;
  code_url?: string;
  reliability?: string;
  tags: string[];
  created_at: string;
}

interface ExploitSearchResult {
  exploits: Exploit[];
  total: number;
  page: number;
  per_page: number;
}

interface CveMapping {
  cve_id: string;
  cve_description?: string;
  exploits: Exploit[];
  total_exploits: number;
  last_updated: string;
  has_public_exploit: boolean;
  has_metasploit_module: boolean;
}

interface PocEntry {
  id: string;
  name: string;
  description?: string;
  cve_ids: string[];
  platform: string;
  language: string;
  status: string; // draft, testing, verified, broken
  reliability: string; // high, medium, low, untested
  author: string;
  version: string;
  code_hash: string;
  last_tested?: string;
  test_results?: PocTestResult[];
  tags: string[];
  created_at: string;
  updated_at: string;
}

interface PocTestResult {
  id: string;
  poc_id: string;
  tester_id: string;
  target_info: string;
  success: boolean;
  notes: string;
  tested_at: string;
}

interface ResearchWorkspace {
  id: string;
  name: string;
  description?: string;
  cve_id?: string;
  status: string; // active, completed, archived
  visibility: string; // private, team, public
  exploit_ids: string[];
  note_ids: string[];
  tags: string[];
  owner_id: string;
  created_at: string;
  updated_at: string;
}

interface ResearchNote {
  id: string;
  title: string;
  content: string;
  note_type: string; // analysis, poc_development, mitigation, reference
  cve_ids: string[];
  visibility: string;
  tags: string[];
  references: ExternalReference[];
  created_by: string;
  created_at: string;
  updated_at: string;
}

interface ExternalReference {
  title: string;
  url: string;
  reference_type: string;
}

interface SyncStatus {
  source: string;
  last_sync?: string;
  status: string;
  items_synced: number;
  errors: string[];
}

interface ExploitFavorite {
  id: string;
  exploit_id: string;
  exploit_title: string;
  exploit_source: string;
  added_at: string;
}

interface SearchHistoryEntry {
  id: string;
  query: string;
  filters?: string;
  results_count: number;
  searched_at: string;
}

// ============================================================================
// API Functions
// ============================================================================

const exploitAPI = {
  // Search exploits
  searchExploits: (params: Record<string, string | number | boolean | undefined>) =>
    api.get<ExploitSearchResult>('/exploit-research/exploits', { params }).then(r => r.data),

  getExploit: (id: string) =>
    api.get<Exploit>(`/exploit-research/exploits/${id}`).then(r => r.data),

  getExploitsForCve: (cveId: string) =>
    api.get<Exploit[]>(`/exploit-research/exploits/cve/${cveId}`).then(r => r.data),

  // CVE Mapping
  getCveMapping: (cveId: string) =>
    api.get<CveMapping>(`/exploit-research/cve-mapping/${cveId}`).then(r => r.data),

  getBatchCveMappings: (cveIds: string[]) =>
    api.post<CveMapping[]>('/exploit-research/cve-mapping/batch', { cve_ids: cveIds }).then(r => r.data),

  // Sync Status
  getSyncStatus: () =>
    api.get<SyncStatus[]>('/exploit-research/sync-status').then(r => r.data),

  triggerSync: (source: string) =>
    api.post<{ message: string }>(`/exploit-research/sync/${source}`).then(r => r.data),

  // PoC Repository
  listPocs: (params?: Record<string, string>) =>
    api.get<PocEntry[]>('/exploit-research/pocs', { params }).then(r => r.data),

  createPoc: (data: {
    name: string;
    description?: string;
    cve_ids: string[];
    platform: string;
    language: string;
    code: string;
    tags?: string[];
  }) => api.post<PocEntry>('/exploit-research/pocs', data).then(r => r.data),

  getPoc: (id: string) =>
    api.get<PocEntry>(`/exploit-research/pocs/${id}`).then(r => r.data),

  updatePoc: (id: string, data: Partial<PocEntry & { code?: string }>) =>
    api.put<PocEntry>(`/exploit-research/pocs/${id}`, data).then(r => r.data),

  deletePoc: (id: string) =>
    api.delete(`/exploit-research/pocs/${id}`),

  getPocCode: (id: string) =>
    api.get<{ code: string; language: string; version: string }>(`/exploit-research/pocs/${id}/code`).then(r => r.data),

  addPocTestResult: (id: string, data: { target_info: string; success: boolean; notes: string }) =>
    api.post<PocTestResult>(`/exploit-research/pocs/${id}/test`, data).then(r => r.data),

  // Research Notes
  listNotes: (params?: Record<string, string>) =>
    api.get<ResearchNote[]>('/exploit-research/notes', { params }).then(r => r.data),

  createNote: (data: {
    title: string;
    content: string;
    note_type: string;
    cve_ids?: string[];
    visibility?: string;
    tags?: string[];
    references?: ExternalReference[];
  }) => api.post<ResearchNote>('/exploit-research/notes', data).then(r => r.data),

  getNote: (id: string) =>
    api.get<ResearchNote>(`/exploit-research/notes/${id}`).then(r => r.data),

  updateNote: (id: string, data: Partial<ResearchNote>) =>
    api.put<ResearchNote>(`/exploit-research/notes/${id}`, data).then(r => r.data),

  deleteNote: (id: string) =>
    api.delete(`/exploit-research/notes/${id}`),

  // Workspaces
  listWorkspaces: (params?: Record<string, string>) =>
    api.get<ResearchWorkspace[]>('/exploit-research/workspaces', { params }).then(r => r.data),

  createWorkspace: (data: {
    name: string;
    description?: string;
    cve_id?: string;
    visibility?: string;
    tags?: string[];
  }) => api.post<ResearchWorkspace>('/exploit-research/workspaces', data).then(r => r.data),

  getWorkspace: (id: string) =>
    api.get<ResearchWorkspace>(`/exploit-research/workspaces/${id}`).then(r => r.data),

  updateWorkspace: (id: string, data: Partial<ResearchWorkspace>) =>
    api.put<ResearchWorkspace>(`/exploit-research/workspaces/${id}`, data).then(r => r.data),

  deleteWorkspace: (id: string) =>
    api.delete(`/exploit-research/workspaces/${id}`),

  exportWorkspace: (id: string) =>
    api.get<{ markdown: string }>(`/exploit-research/workspaces/${id}/export`).then(r => r.data),

  addExploitToWorkspace: (workspaceId: string, exploitId: string) =>
    api.post(`/exploit-research/workspaces/${workspaceId}/exploits/${exploitId}`),

  // Favorites
  listFavorites: () =>
    api.get<ExploitFavorite[]>('/exploit-research/favorites').then(r => r.data),

  addFavorite: (exploitId: string) =>
    api.post('/exploit-research/favorites', { exploit_id: exploitId }),

  removeFavorite: (exploitId: string) =>
    api.delete(`/exploit-research/favorites/${exploitId}`),

  // History
  getSearchHistory: () =>
    api.get<SearchHistoryEntry[]>('/exploit-research/history').then(r => r.data),
};

// ============================================================================
// Badge Components
// ============================================================================

const sourceColors: Record<string, { bg: string; text: string }> = {
  exploit_db: { bg: 'bg-red-500/20', text: 'text-red-400' },
  metasploit: { bg: 'bg-blue-500/20', text: 'text-blue-400' },
  packetstorm: { bg: 'bg-purple-500/20', text: 'text-purple-400' },
};

const statusColors: Record<string, { bg: string; text: string }> = {
  draft: { bg: 'bg-gray-500/20', text: 'text-gray-400' },
  testing: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
  verified: { bg: 'bg-green-500/20', text: 'text-green-400' },
  broken: { bg: 'bg-red-500/20', text: 'text-red-400' },
  active: { bg: 'bg-green-500/20', text: 'text-green-400' },
  completed: { bg: 'bg-cyan-500/20', text: 'text-cyan-400' },
  archived: { bg: 'bg-gray-500/20', text: 'text-gray-400' },
};

const reliabilityColors: Record<string, { bg: string; text: string }> = {
  high: { bg: 'bg-green-500/20', text: 'text-green-400' },
  medium: { bg: 'bg-yellow-500/20', text: 'text-yellow-400' },
  low: { bg: 'bg-orange-500/20', text: 'text-orange-400' },
  untested: { bg: 'bg-gray-500/20', text: 'text-gray-400' },
};

function SourceBadge({ source }: { source: string }) {
  const colors = sourceColors[source.toLowerCase()] || { bg: 'bg-gray-500/20', text: 'text-gray-400' };
  const displayName = source === 'exploit_db' ? 'Exploit-DB' :
                     source === 'metasploit' ? 'Metasploit' :
                     source === 'packetstorm' ? 'PacketStorm' : source;
  return (
    <span className={`px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text}`}>
      {displayName}
    </span>
  );
}

function StatusBadge({ status }: { status: string }) {
  const colors = statusColors[status.toLowerCase()] || statusColors.draft;
  return (
    <span className={`px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text}`}>
      {status.charAt(0).toUpperCase() + status.slice(1)}
    </span>
  );
}

function ReliabilityBadge({ reliability }: { reliability: string }) {
  const colors = reliabilityColors[reliability.toLowerCase()] || reliabilityColors.untested;
  return (
    <span className={`px-2 py-0.5 rounded text-xs font-medium ${colors.bg} ${colors.text}`}>
      {reliability.charAt(0).toUpperCase() + reliability.slice(1)}
    </span>
  );
}

// ============================================================================
// Modal Component
// ============================================================================

const Modal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  title: string;
  children: React.ReactNode;
  size?: 'sm' | 'md' | 'lg' | 'xl';
}> = ({ isOpen, onClose, title, children, size = 'md' }) => {
  if (!isOpen) return null;

  const sizeClasses = {
    sm: 'max-w-md',
    md: 'max-w-2xl',
    lg: 'max-w-4xl',
    xl: 'max-w-6xl',
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      <div className="absolute inset-0 bg-black/60" onClick={onClose} />
      <div className={`relative bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full ${sizeClasses[size]} max-h-[90vh] overflow-y-auto mx-4`}>
        <div className="flex items-center justify-between p-4 border-b border-gray-700 sticky top-0 bg-gray-800 z-10">
          <h2 className="text-lg font-semibold text-white">{title}</h2>
          <button onClick={onClose} className="p-1 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-white">
            <X className="w-5 h-5" />
          </button>
        </div>
        <div className="p-4">{children}</div>
      </div>
    </div>
  );
};

// ============================================================================
// Exploit Search Tab
// ============================================================================

const ExploitSearchTab: React.FC = () => {
  const [searchQuery, setSearchQuery] = useState('');
  const [filters, setFilters] = useState({
    source: '',
    platform: '',
    exploit_type: '',
    verified_only: false,
    has_code: false,
  });
  const [page, setPage] = useState(1);
  const [selectedExploit, setSelectedExploit] = useState<Exploit | null>(null);

  const queryClient = useQueryClient();

  const { data: searchResults, isLoading, refetch } = useQuery({
    queryKey: ['exploits', searchQuery, filters, page],
    queryFn: () => exploitAPI.searchExploits({
      query: searchQuery || undefined,
      source: filters.source || undefined,
      platform: filters.platform || undefined,
      exploit_type: filters.exploit_type || undefined,
      verified_only: filters.verified_only || undefined,
      has_code: filters.has_code || undefined,
      page,
      per_page: 20,
    }),
    enabled: true,
  });

  const { data: syncStatus } = useQuery({
    queryKey: ['exploit-sync-status'],
    queryFn: exploitAPI.getSyncStatus,
  });

  const syncMutation = useMutation({
    mutationFn: (source: string) => exploitAPI.triggerSync(source),
    onSuccess: (_, source) => {
      toast.success(`Sync started for ${source}`);
      queryClient.invalidateQueries({ queryKey: ['exploit-sync-status'] });
    },
    onError: () => toast.error('Failed to start sync'),
  });

  const addFavoriteMutation = useMutation({
    mutationFn: (exploitId: string) => exploitAPI.addFavorite(exploitId),
    onSuccess: () => {
      toast.success('Added to favorites');
      queryClient.invalidateQueries({ queryKey: ['exploit-favorites'] });
    },
    onError: () => toast.error('Failed to add favorite'),
  });

  const handleSearch = (e: React.FormEvent) => {
    e.preventDefault();
    setPage(1);
    refetch();
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('Copied to clipboard');
  };

  return (
    <div className="space-y-6">
      {/* Sync Status */}
      {syncStatus && (
        <div className="bg-gray-800 border border-gray-700 rounded-lg p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-medium text-gray-300">Database Sync Status</h3>
          </div>
          <div className="grid grid-cols-3 gap-4">
            {syncStatus.map((status) => (
              <div key={status.source} className="flex items-center justify-between p-3 bg-gray-900 rounded-lg">
                <div>
                  <SourceBadge source={status.source} />
                  <p className="text-xs text-gray-400 mt-1">
                    {status.items_synced} items
                  </p>
                  {status.last_sync && (
                    <p className="text-xs text-gray-500">
                      Last: {new Date(status.last_sync).toLocaleString()}
                    </p>
                  )}
                </div>
                <button
                  onClick={() => syncMutation.mutate(status.source)}
                  disabled={syncMutation.isPending}
                  className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-cyan-400"
                  title="Sync now"
                >
                  <RefreshCw className={`w-4 h-4 ${syncMutation.isPending ? 'animate-spin' : ''}`} />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Search Form */}
      <form onSubmit={handleSearch} className="bg-gray-800 border border-gray-700 rounded-lg p-4">
        <div className="flex gap-4 mb-4">
          <div className="flex-1 relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input
              type="text"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              placeholder="Search exploits by title, CVE, description..."
              className="w-full pl-10 pr-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500"
            />
          </div>
          <button
            type="submit"
            className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2"
          >
            <Search className="w-4 h-4" />
            Search
          </button>
        </div>

        <div className="flex flex-wrap gap-4">
          <select
            value={filters.source}
            onChange={(e) => setFilters({ ...filters, source: e.target.value })}
            className="px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">All Sources</option>
            <option value="exploit_db">Exploit-DB</option>
            <option value="metasploit">Metasploit</option>
            <option value="packetstorm">PacketStorm</option>
          </select>

          <select
            value={filters.platform}
            onChange={(e) => setFilters({ ...filters, platform: e.target.value })}
            className="px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">All Platforms</option>
            <option value="linux">Linux</option>
            <option value="windows">Windows</option>
            <option value="macos">macOS</option>
            <option value="multi">Multi-Platform</option>
            <option value="web">Web Application</option>
            <option value="android">Android</option>
            <option value="ios">iOS</option>
          </select>

          <select
            value={filters.exploit_type}
            onChange={(e) => setFilters({ ...filters, exploit_type: e.target.value })}
            className="px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white"
          >
            <option value="">All Types</option>
            <option value="remote">Remote</option>
            <option value="local">Local</option>
            <option value="webapps">Web Apps</option>
            <option value="dos">DoS</option>
            <option value="shellcode">Shellcode</option>
          </select>

          <label className="flex items-center gap-2 text-gray-300">
            <input
              type="checkbox"
              checked={filters.verified_only}
              onChange={(e) => setFilters({ ...filters, verified_only: e.target.checked })}
              className="rounded border-gray-700 bg-gray-900 text-cyan-600"
            />
            Verified Only
          </label>

          <label className="flex items-center gap-2 text-gray-300">
            <input
              type="checkbox"
              checked={filters.has_code}
              onChange={(e) => setFilters({ ...filters, has_code: e.target.checked })}
              className="rounded border-gray-700 bg-gray-900 text-cyan-600"
            />
            Has Code
          </label>
        </div>
      </form>

      {/* Results */}
      <div className="bg-gray-800 border border-gray-700 rounded-lg">
        {isLoading ? (
          <div className="p-8 text-center">
            <RefreshCw className="w-8 h-8 text-cyan-400 animate-spin mx-auto mb-2" />
            <p className="text-gray-400">Searching exploits...</p>
          </div>
        ) : searchResults?.exploits.length === 0 ? (
          <div className="p-8 text-center">
            <Database className="w-12 h-12 text-gray-600 mx-auto mb-3" />
            <p className="text-gray-400">No exploits found</p>
          </div>
        ) : (
          <>
            <div className="p-4 border-b border-gray-700 flex items-center justify-between">
              <p className="text-sm text-gray-400">
                Found {searchResults?.total || 0} exploits
              </p>
            </div>
            <div className="divide-y divide-gray-700">
              {searchResults?.exploits.map((exploit) => (
                <div key={exploit.id} className="p-4 hover:bg-gray-700/30">
                  <div className="flex items-start justify-between">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className="text-white font-medium truncate">{exploit.title}</h3>
                        {exploit.verified && (
                          <CheckCircle className="w-4 h-4 text-green-400 flex-shrink-0" />
                        )}
                      </div>
                      <p className="text-sm text-gray-400 line-clamp-2 mb-2">
                        {exploit.description}
                      </p>
                      <div className="flex flex-wrap items-center gap-2">
                        <SourceBadge source={exploit.source} />
                        <span className="text-xs text-gray-500">{exploit.platform}</span>
                        <span className="text-xs text-gray-500">{exploit.exploit_type}</span>
                        {exploit.cve_ids.length > 0 && (
                          <div className="flex gap-1">
                            {exploit.cve_ids.slice(0, 3).map((cve) => (
                              <span
                                key={cve}
                                className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs cursor-pointer hover:bg-cyan-500/30"
                                onClick={() => copyToClipboard(cve)}
                              >
                                {cve}
                              </span>
                            ))}
                            {exploit.cve_ids.length > 3 && (
                              <span className="text-xs text-gray-500">+{exploit.cve_ids.length - 3}</span>
                            )}
                          </div>
                        )}
                        {exploit.publish_date && (
                          <span className="text-xs text-gray-500">
                            <Clock className="w-3 h-3 inline mr-1" />
                            {new Date(exploit.publish_date).toLocaleDateString()}
                          </span>
                        )}
                      </div>
                    </div>
                    <div className="flex items-center gap-1 ml-4">
                      <button
                        onClick={() => setSelectedExploit(exploit)}
                        className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-white"
                        title="View details"
                      >
                        <Eye className="w-4 h-4" />
                      </button>
                      {exploit.code_url && (
                        <a
                          href={exploit.code_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-cyan-400"
                          title="View code"
                        >
                          <ExternalLink className="w-4 h-4" />
                        </a>
                      )}
                      <button
                        onClick={() => addFavoriteMutation.mutate(exploit.id)}
                        className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-yellow-400"
                        title="Add to favorites"
                      >
                        <Star className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
            {/* Pagination */}
            {searchResults && searchResults.total > 20 && (
              <div className="p-4 border-t border-gray-700 flex items-center justify-center gap-2">
                <button
                  onClick={() => setPage((p) => Math.max(1, p - 1))}
                  disabled={page === 1}
                  className="px-3 py-1 rounded-lg bg-gray-700 text-white disabled:opacity-50"
                >
                  Previous
                </button>
                <span className="text-gray-400">
                  Page {page} of {Math.ceil(searchResults.total / 20)}
                </span>
                <button
                  onClick={() => setPage((p) => p + 1)}
                  disabled={page * 20 >= searchResults.total}
                  className="px-3 py-1 rounded-lg bg-gray-700 text-white disabled:opacity-50"
                >
                  Next
                </button>
              </div>
            )}
          </>
        )}
      </div>

      {/* Exploit Detail Modal */}
      <Modal
        isOpen={!!selectedExploit}
        onClose={() => setSelectedExploit(null)}
        title={selectedExploit?.title || 'Exploit Details'}
        size="lg"
      >
        {selectedExploit && (
          <div className="space-y-4">
            <div className="flex flex-wrap gap-2">
              <SourceBadge source={selectedExploit.source} />
              {selectedExploit.verified && (
                <span className="px-2 py-0.5 bg-green-500/20 text-green-400 rounded text-xs font-medium flex items-center gap-1">
                  <CheckCircle className="w-3 h-3" /> Verified
                </span>
              )}
              {selectedExploit.reliability && (
                <ReliabilityBadge reliability={selectedExploit.reliability} />
              )}
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="text-sm text-gray-400">Platform</label>
                <p className="text-white">{selectedExploit.platform}</p>
              </div>
              <div>
                <label className="text-sm text-gray-400">Type</label>
                <p className="text-white">{selectedExploit.exploit_type}</p>
              </div>
              <div>
                <label className="text-sm text-gray-400">Author</label>
                <p className="text-white">{selectedExploit.author || 'Unknown'}</p>
              </div>
              <div>
                <label className="text-sm text-gray-400">Published</label>
                <p className="text-white">
                  {selectedExploit.publish_date
                    ? new Date(selectedExploit.publish_date).toLocaleDateString()
                    : 'Unknown'}
                </p>
              </div>
            </div>

            <div>
              <label className="text-sm text-gray-400">Description</label>
              <p className="text-white whitespace-pre-wrap">{selectedExploit.description}</p>
            </div>

            {selectedExploit.cve_ids.length > 0 && (
              <div>
                <label className="text-sm text-gray-400">CVE IDs</label>
                <div className="flex flex-wrap gap-2 mt-1">
                  {selectedExploit.cve_ids.map((cve) => (
                    <span
                      key={cve}
                      className="px-2 py-1 bg-cyan-500/20 text-cyan-400 rounded cursor-pointer hover:bg-cyan-500/30 flex items-center gap-1"
                      onClick={() => copyToClipboard(cve)}
                    >
                      {cve}
                      <Copy className="w-3 h-3" />
                    </span>
                  ))}
                </div>
              </div>
            )}

            {selectedExploit.tags.length > 0 && (
              <div>
                <label className="text-sm text-gray-400">Tags</label>
                <div className="flex flex-wrap gap-2 mt-1">
                  {selectedExploit.tags.map((tag) => (
                    <span key={tag} className="px-2 py-0.5 bg-gray-700 text-gray-300 rounded text-xs">
                      {tag}
                    </span>
                  ))}
                </div>
              </div>
            )}

            <div className="flex gap-2 pt-4 border-t border-gray-700">
              {selectedExploit.code_url && (
                <a
                  href={selectedExploit.code_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2"
                >
                  <Code className="w-4 h-4" />
                  View Code
                </a>
              )}
              <button
                onClick={() => addFavoriteMutation.mutate(selectedExploit.id)}
                className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600 flex items-center gap-2"
              >
                <Star className="w-4 h-4" />
                Add to Favorites
              </button>
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
};

// ============================================================================
// CVE Mapping Tab
// ============================================================================

const CveMappingTab: React.FC = () => {
  const [cveInput, setCveInput] = useState('');
  const [cveMapping, setCveMapping] = useState<CveMapping | null>(null);
  const [isSearching, setIsSearching] = useState(false);

  const handleLookup = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!cveInput.trim()) return;

    setIsSearching(true);
    try {
      const mapping = await exploitAPI.getCveMapping(cveInput.trim().toUpperCase());
      setCveMapping(mapping);
    } catch {
      toast.error('Failed to lookup CVE mapping');
    }
    setIsSearching(false);
  };

  return (
    <div className="space-y-6">
      {/* CVE Lookup */}
      <div className="bg-gray-800 border border-gray-700 rounded-lg p-4">
        <h3 className="text-lg font-semibold text-white mb-4">CVE to Exploit Mapping</h3>
        <form onSubmit={handleLookup} className="flex gap-4">
          <div className="flex-1 relative">
            <Shield className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input
              type="text"
              value={cveInput}
              onChange={(e) => setCveInput(e.target.value)}
              placeholder="Enter CVE ID (e.g., CVE-2021-44228)"
              className="w-full pl-10 pr-4 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:ring-2 focus:ring-cyan-500"
            />
          </div>
          <button
            type="submit"
            disabled={isSearching}
            className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2 disabled:opacity-50"
          >
            {isSearching ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Search className="w-4 h-4" />}
            Lookup
          </button>
        </form>
      </div>

      {/* Mapping Results */}
      {cveMapping && (
        <div className="bg-gray-800 border border-gray-700 rounded-lg p-4">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h3 className="text-xl font-semibold text-white">{cveMapping.cve_id}</h3>
              {cveMapping.cve_description && (
                <p className="text-gray-400 mt-1">{cveMapping.cve_description}</p>
              )}
            </div>
            <div className="flex gap-2">
              {cveMapping.has_public_exploit && (
                <span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs font-medium flex items-center gap-1">
                  <AlertTriangle className="w-3 h-3" />
                  Public Exploit
                </span>
              )}
              {cveMapping.has_metasploit_module && (
                <span className="px-2 py-1 bg-blue-500/20 text-blue-400 rounded text-xs font-medium flex items-center gap-1">
                  <Terminal className="w-3 h-3" />
                  Metasploit
                </span>
              )}
            </div>
          </div>

          <div className="mb-4">
            <p className="text-sm text-gray-400">
              {cveMapping.total_exploits} exploit(s) found | Last updated:{' '}
              {new Date(cveMapping.last_updated).toLocaleString()}
            </p>
          </div>

          <div className="divide-y divide-gray-700">
            {cveMapping.exploits.map((exploit) => (
              <div key={exploit.id} className="py-3 flex items-center justify-between">
                <div>
                  <p className="text-white font-medium">{exploit.title}</p>
                  <div className="flex items-center gap-2 mt-1">
                    <SourceBadge source={exploit.source} />
                    <span className="text-xs text-gray-500">{exploit.platform}</span>
                    {exploit.verified && (
                      <CheckCircle className="w-3 h-3 text-green-400" />
                    )}
                  </div>
                </div>
                {exploit.code_url && (
                  <a
                    href={exploit.code_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-cyan-400"
                  >
                    <ExternalLink className="w-4 h-4" />
                  </a>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// ============================================================================
// PoC Repository Tab
// ============================================================================

const PocRepositoryTab: React.FC = () => {
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedPoc, setSelectedPoc] = useState<PocEntry | null>(null);
  const [pocCode, setPocCode] = useState<{ code: string; language: string } | null>(null);

  const queryClient = useQueryClient();

  const { data: pocs, isLoading } = useQuery({
    queryKey: ['pocs'],
    queryFn: () => exploitAPI.listPocs(),
  });

  const createMutation = useMutation({
    mutationFn: exploitAPI.createPoc,
    onSuccess: () => {
      toast.success('PoC created');
      setShowCreateModal(false);
      queryClient.invalidateQueries({ queryKey: ['pocs'] });
    },
    onError: () => toast.error('Failed to create PoC'),
  });

  const deleteMutation = useMutation({
    mutationFn: exploitAPI.deletePoc,
    onSuccess: () => {
      toast.success('PoC deleted');
      queryClient.invalidateQueries({ queryKey: ['pocs'] });
    },
    onError: () => toast.error('Failed to delete PoC'),
  });

  const handleViewCode = async (poc: PocEntry) => {
    try {
      const code = await exploitAPI.getPocCode(poc.id);
      setPocCode(code);
      setSelectedPoc(poc);
    } catch {
      toast.error('Failed to load PoC code');
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-white">Proof of Concept Repository</h3>
        <button
          onClick={() => setShowCreateModal(true)}
          className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2"
        >
          <Plus className="w-4 h-4" />
          New PoC
        </button>
      </div>

      {/* PoC List */}
      <div className="bg-gray-800 border border-gray-700 rounded-lg">
        {isLoading ? (
          <div className="p-8 text-center">
            <RefreshCw className="w-8 h-8 text-cyan-400 animate-spin mx-auto" />
          </div>
        ) : pocs?.length === 0 ? (
          <div className="p-8 text-center">
            <Code className="w-12 h-12 text-gray-600 mx-auto mb-3" />
            <p className="text-gray-400">No PoCs yet. Create your first one!</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-700">
            {pocs?.map((poc) => (
              <div key={poc.id} className="p-4 hover:bg-gray-700/30">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      <h4 className="text-white font-medium">{poc.name}</h4>
                      <StatusBadge status={poc.status} />
                      <ReliabilityBadge reliability={poc.reliability} />
                    </div>
                    {poc.description && (
                      <p className="text-sm text-gray-400 mb-2">{poc.description}</p>
                    )}
                    <div className="flex flex-wrap items-center gap-2">
                      <span className="text-xs text-gray-500">
                        <Terminal className="w-3 h-3 inline mr-1" />
                        {poc.language}
                      </span>
                      <span className="text-xs text-gray-500">
                        <Server className="w-3 h-3 inline mr-1" />
                        {poc.platform}
                      </span>
                      <span className="text-xs text-gray-500">v{poc.version}</span>
                      {poc.cve_ids.map((cve) => (
                        <span key={cve} className="px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs">
                          {cve}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div className="flex items-center gap-1 ml-4">
                    <button
                      onClick={() => handleViewCode(poc)}
                      className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-cyan-400"
                      title="View code"
                    >
                      <Code className="w-4 h-4" />
                    </button>
                    <button
                      onClick={() => deleteMutation.mutate(poc.id)}
                      className="p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-red-400"
                      title="Delete"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* Create PoC Modal */}
      <Modal isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} title="Create New PoC" size="lg">
        <CreatePocForm
          onSubmit={(data) => createMutation.mutate(data)}
          onCancel={() => setShowCreateModal(false)}
          isLoading={createMutation.isPending}
        />
      </Modal>

      {/* View Code Modal */}
      <Modal
        isOpen={!!selectedPoc && !!pocCode}
        onClose={() => {
          setSelectedPoc(null);
          setPocCode(null);
        }}
        title={selectedPoc?.name || 'PoC Code'}
        size="xl"
      >
        {pocCode && (
          <div className="space-y-4">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-400">Language: {pocCode.language}</span>
              <button
                onClick={() => {
                  navigator.clipboard.writeText(pocCode.code);
                  toast.success('Code copied to clipboard');
                }}
                className="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-600 flex items-center gap-2"
              >
                <Copy className="w-4 h-4" />
                Copy
              </button>
            </div>
            <pre className="bg-gray-900 border border-gray-700 rounded-lg p-4 overflow-x-auto text-sm text-gray-300">
              <code>{pocCode.code}</code>
            </pre>
          </div>
        )}
      </Modal>
    </div>
  );
};

// ============================================================================
// Create PoC Form
// ============================================================================

const CreatePocForm: React.FC<{
  onSubmit: (data: {
    name: string;
    description?: string;
    cve_ids: string[];
    platform: string;
    language: string;
    code: string;
    tags?: string[];
  }) => void;
  onCancel: () => void;
  isLoading?: boolean;
}> = ({ onSubmit, onCancel, isLoading }) => {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    cve_ids: '',
    platform: 'linux',
    language: 'python',
    code: '',
    tags: '',
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSubmit({
      name: formData.name,
      description: formData.description || undefined,
      cve_ids: formData.cve_ids ? formData.cve_ids.split(',').map((s) => s.trim()) : [],
      platform: formData.platform,
      language: formData.language,
      code: formData.code,
      tags: formData.tags ? formData.tags.split(',').map((s) => s.trim()) : [],
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Name *</label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          required
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          placeholder="CVE-2021-44228 Log4j RCE PoC"
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Description</label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          rows={2}
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          placeholder="Describe the exploit and usage..."
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">CVE IDs</label>
          <input
            type="text"
            value={formData.cve_ids}
            onChange={(e) => setFormData({ ...formData, cve_ids: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
            placeholder="CVE-2021-44228, CVE-2021-45046"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">Tags</label>
          <input
            type="text"
            value={formData.tags}
            onChange={(e) => setFormData({ ...formData, tags: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
            placeholder="rce, log4j, java"
          />
        </div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">Platform</label>
          <select
            value={formData.platform}
            onChange={(e) => setFormData({ ...formData, platform: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          >
            <option value="linux">Linux</option>
            <option value="windows">Windows</option>
            <option value="macos">macOS</option>
            <option value="multi">Multi-Platform</option>
            <option value="web">Web Application</option>
          </select>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">Language</label>
          <select
            value={formData.language}
            onChange={(e) => setFormData({ ...formData, language: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          >
            <option value="python">Python</option>
            <option value="ruby">Ruby</option>
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="go">Go</option>
            <option value="rust">Rust</option>
            <option value="javascript">JavaScript</option>
            <option value="bash">Bash</option>
            <option value="powershell">PowerShell</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Code *</label>
        <textarea
          value={formData.code}
          onChange={(e) => setFormData({ ...formData, code: e.target.value })}
          required
          rows={10}
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white font-mono text-sm focus:ring-2 focus:ring-cyan-500"
          placeholder="#!/usr/bin/env python3..."
        />
      </div>

      <div className="flex justify-end gap-2 pt-4 border-t border-gray-700">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600"
        >
          Cancel
        </button>
        <button
          type="submit"
          disabled={isLoading}
          className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2 disabled:opacity-50"
        >
          {isLoading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Plus className="w-4 h-4" />}
          Create PoC
        </button>
      </div>
    </form>
  );
};

// ============================================================================
// Workspaces Tab
// ============================================================================

const WorkspacesTab: React.FC = () => {
  const [showCreateModal, setShowCreateModal] = useState(false);

  const queryClient = useQueryClient();

  const { data: workspaces, isLoading } = useQuery({
    queryKey: ['research-workspaces'],
    queryFn: () => exploitAPI.listWorkspaces(),
  });

  const createMutation = useMutation({
    mutationFn: exploitAPI.createWorkspace,
    onSuccess: () => {
      toast.success('Workspace created');
      setShowCreateModal(false);
      queryClient.invalidateQueries({ queryKey: ['research-workspaces'] });
    },
    onError: () => toast.error('Failed to create workspace'),
  });

  const deleteMutation = useMutation({
    mutationFn: exploitAPI.deleteWorkspace,
    onSuccess: () => {
      toast.success('Workspace deleted');
      queryClient.invalidateQueries({ queryKey: ['research-workspaces'] });
    },
    onError: () => toast.error('Failed to delete workspace'),
  });

  const handleExport = async (id: string, name: string) => {
    try {
      const result = await exploitAPI.exportWorkspace(id);
      const blob = new Blob([result.markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${name.replace(/\s+/g, '_')}_research.md`;
      a.click();
      URL.revokeObjectURL(url);
      toast.success('Workspace exported');
    } catch {
      toast.error('Failed to export workspace');
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-white">Research Workspaces</h3>
        <button
          onClick={() => setShowCreateModal(true)}
          className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2"
        >
          <Plus className="w-4 h-4" />
          New Workspace
        </button>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {isLoading ? (
          <div className="col-span-full p-8 text-center">
            <RefreshCw className="w-8 h-8 text-cyan-400 animate-spin mx-auto" />
          </div>
        ) : workspaces?.length === 0 ? (
          <div className="col-span-full p-8 text-center bg-gray-800 border border-gray-700 rounded-lg">
            <Folder className="w-12 h-12 text-gray-600 mx-auto mb-3" />
            <p className="text-gray-400">No workspaces yet. Create one to start researching!</p>
          </div>
        ) : (
          workspaces?.map((workspace) => (
            <div
              key={workspace.id}
              className="bg-gray-800 border border-gray-700 rounded-lg p-4 hover:border-gray-600"
            >
              <div className="flex items-start justify-between mb-2">
                <h4 className="text-white font-medium">{workspace.name}</h4>
                <StatusBadge status={workspace.status} />
              </div>
              {workspace.cve_id && (
                <span className="inline-block px-2 py-0.5 bg-cyan-500/20 text-cyan-400 rounded text-xs mb-2">
                  {workspace.cve_id}
                </span>
              )}
              {workspace.description && (
                <p className="text-sm text-gray-400 mb-3 line-clamp-2">{workspace.description}</p>
              )}
              <div className="flex items-center justify-between text-xs text-gray-500">
                <span>{workspace.exploit_ids.length} exploits</span>
                <span>{workspace.note_ids.length} notes</span>
              </div>
              <div className="flex items-center gap-1 mt-3 pt-3 border-t border-gray-700">
                <button
                  onClick={() => handleExport(workspace.id, workspace.name)}
                  className="flex-1 p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-cyan-400 flex items-center justify-center gap-1"
                  title="Export"
                >
                  <Download className="w-4 h-4" />
                </button>
                <button
                  onClick={() => deleteMutation.mutate(workspace.id)}
                  className="flex-1 p-2 rounded-lg hover:bg-gray-700 text-gray-400 hover:text-red-400 flex items-center justify-center gap-1"
                  title="Delete"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            </div>
          ))
        )}
      </div>

      {/* Create Workspace Modal */}
      <Modal isOpen={showCreateModal} onClose={() => setShowCreateModal(false)} title="Create Research Workspace">
        <CreateWorkspaceForm
          onSubmit={(data) => createMutation.mutate(data)}
          onCancel={() => setShowCreateModal(false)}
          isLoading={createMutation.isPending}
        />
      </Modal>
    </div>
  );
};

// ============================================================================
// Create Workspace Form
// ============================================================================

const CreateWorkspaceForm: React.FC<{
  onSubmit: (data: {
    name: string;
    description?: string;
    cve_id?: string;
    visibility?: string;
    tags?: string[];
  }) => void;
  onCancel: () => void;
  isLoading?: boolean;
}> = ({ onSubmit, onCancel, isLoading }) => {
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    cve_id: '',
    visibility: 'private',
    tags: '',
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSubmit({
      name: formData.name,
      description: formData.description || undefined,
      cve_id: formData.cve_id || undefined,
      visibility: formData.visibility,
      tags: formData.tags ? formData.tags.split(',').map((s) => s.trim()) : [],
    });
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Name *</label>
        <input
          type="text"
          value={formData.name}
          onChange={(e) => setFormData({ ...formData, name: e.target.value })}
          required
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          placeholder="Log4j Research"
        />
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Description</label>
        <textarea
          value={formData.description}
          onChange={(e) => setFormData({ ...formData, description: e.target.value })}
          rows={2}
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">CVE ID (optional)</label>
          <input
            type="text"
            value={formData.cve_id}
            onChange={(e) => setFormData({ ...formData, cve_id: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
            placeholder="CVE-2021-44228"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-300 mb-1">Visibility</label>
          <select
            value={formData.visibility}
            onChange={(e) => setFormData({ ...formData, visibility: e.target.value })}
            className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          >
            <option value="private">Private</option>
            <option value="team">Team</option>
            <option value="public">Public</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-300 mb-1">Tags</label>
        <input
          type="text"
          value={formData.tags}
          onChange={(e) => setFormData({ ...formData, tags: e.target.value })}
          className="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-lg text-white focus:ring-2 focus:ring-cyan-500"
          placeholder="log4j, rce, java"
        />
      </div>

      <div className="flex justify-end gap-2 pt-4 border-t border-gray-700">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600"
        >
          Cancel
        </button>
        <button
          type="submit"
          disabled={isLoading}
          className="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700 flex items-center gap-2 disabled:opacity-50"
        >
          {isLoading ? <RefreshCw className="w-4 h-4 animate-spin" /> : <Plus className="w-4 h-4" />}
          Create
        </button>
      </div>
    </form>
  );
};

// ============================================================================
// Favorites Tab
// ============================================================================

const FavoritesTab: React.FC = () => {
  const queryClient = useQueryClient();

  const { data: favorites, isLoading } = useQuery({
    queryKey: ['exploit-favorites'],
    queryFn: exploitAPI.listFavorites,
  });

  const removeMutation = useMutation({
    mutationFn: exploitAPI.removeFavorite,
    onSuccess: () => {
      toast.success('Removed from favorites');
      queryClient.invalidateQueries({ queryKey: ['exploit-favorites'] });
    },
    onError: () => toast.error('Failed to remove favorite'),
  });

  return (
    <div className="space-y-6">
      <h3 className="text-lg font-semibold text-white">Favorite Exploits</h3>

      <div className="bg-gray-800 border border-gray-700 rounded-lg">
        {isLoading ? (
          <div className="p-8 text-center">
            <RefreshCw className="w-8 h-8 text-cyan-400 animate-spin mx-auto" />
          </div>
        ) : favorites?.length === 0 ? (
          <div className="p-8 text-center">
            <Star className="w-12 h-12 text-gray-600 mx-auto mb-3" />
            <p className="text-gray-400">No favorites yet. Star exploits to save them here!</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-700">
            {favorites?.map((fav) => (
              <div key={fav.id} className="p-4 flex items-center justify-between hover:bg-gray-700/30">
                <div>
                  <p className="text-white font-medium">{fav.exploit_title}</p>
                  <div className="flex items-center gap-2 mt-1">
                    <SourceBadge source={fav.exploit_source} />
                    <span className="text-xs text-gray-500">
                      Added {new Date(fav.added_at).toLocaleDateString()}
                    </span>
                  </div>
                </div>
                <button
                  onClick={() => removeMutation.mutate(fav.exploit_id)}
                  className="p-2 rounded-lg hover:bg-gray-700 text-yellow-400 hover:text-gray-400"
                  title="Remove from favorites"
                >
                  <Star className="w-4 h-4 fill-current" />
                </button>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// ============================================================================
// History Tab
// ============================================================================

const HistoryTab: React.FC = () => {
  const { data: history, isLoading } = useQuery({
    queryKey: ['exploit-search-history'],
    queryFn: exploitAPI.getSearchHistory,
  });

  return (
    <div className="space-y-6">
      <h3 className="text-lg font-semibold text-white">Search History</h3>

      <div className="bg-gray-800 border border-gray-700 rounded-lg">
        {isLoading ? (
          <div className="p-8 text-center">
            <RefreshCw className="w-8 h-8 text-cyan-400 animate-spin mx-auto" />
          </div>
        ) : history?.length === 0 ? (
          <div className="p-8 text-center">
            <History className="w-12 h-12 text-gray-600 mx-auto mb-3" />
            <p className="text-gray-400">No search history yet.</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-700">
            {history?.map((entry) => (
              <div key={entry.id} className="p-4 flex items-center justify-between hover:bg-gray-700/30">
                <div>
                  <p className="text-white font-medium">{entry.query}</p>
                  <div className="flex items-center gap-2 mt-1">
                    <span className="text-xs text-gray-500">
                      {entry.results_count} results
                    </span>
                    <span className="text-xs text-gray-500">
                      {new Date(entry.searched_at).toLocaleString()}
                    </span>
                  </div>
                </div>
                <Search className="w-4 h-4 text-gray-500" />
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

// ============================================================================
// Main Page Component
// ============================================================================

const ExploitDatabasePage: React.FC = () => {
  const [activeTab, setActiveTab] = useState<TabType>('search');

  const tabs = [
    { id: 'search' as TabType, label: 'Search', icon: Search },
    { id: 'cve-mapping' as TabType, label: 'CVE Mapping', icon: Link2 },
    { id: 'pocs' as TabType, label: 'PoC Repository', icon: Code },
    { id: 'workspaces' as TabType, label: 'Workspaces', icon: Folder },
    { id: 'favorites' as TabType, label: 'Favorites', icon: Star },
    { id: 'history' as TabType, label: 'History', icon: History },
  ];

  return (
    <Layout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center gap-2">
              <Database className="w-6 h-6 text-cyan-400" />
              Exploit Database
            </h1>
            <p className="text-gray-400 mt-1">
              Search exploits, manage PoCs, and organize your vulnerability research
            </p>
          </div>
        </div>

        {/* Tabs */}
        <div className="border-b border-gray-700">
          <nav className="flex gap-1">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`px-4 py-3 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${
                  activeTab === tab.id
                    ? 'text-cyan-400 border-cyan-400'
                    : 'text-gray-400 border-transparent hover:text-white hover:border-gray-600'
                }`}
              >
                <tab.icon className="w-4 h-4" />
                {tab.label}
              </button>
            ))}
          </nav>
        </div>

        {/* Tab Content */}
        <div className="mt-6">
          {activeTab === 'search' && <ExploitSearchTab />}
          {activeTab === 'cve-mapping' && <CveMappingTab />}
          {activeTab === 'pocs' && <PocRepositoryTab />}
          {activeTab === 'workspaces' && <WorkspacesTab />}
          {activeTab === 'favorites' && <FavoritesTab />}
          {activeTab === 'history' && <HistoryTab />}
        </div>
      </div>
    </Layout>
  );
};

export default ExploitDatabasePage;
