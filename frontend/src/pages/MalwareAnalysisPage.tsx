import React, { useState, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'react-toastify';
import {
  Bug,
  Upload,
  Search,
  Trash2,
  RefreshCw,
  FileCode,
  Shield,
  AlertTriangle,
  Eye,
  Download,
  Tag,
  Plus,
  XCircle,
  Loader2,
  Binary,
  Database,
  Network,
  Key,
  Globe,
  Mail,
  Hash,
  Clock,
  ChevronRight,
  Copy,
  Filter,
  BarChart3,
  FileText,
  Code,
  Zap,
  CheckCircle,
  X,
} from 'lucide-react';
import { malwareAnalysisAPI, MalwareSample, MalwareStats, YaraRule, MalwareIoc } from '../services/api';
import Layout from '../components/layout/Layout';

// Stats Card Component
const StatsCard: React.FC<{ title: string; value: string | number; icon: React.ReactNode; color: string }> = ({
  title, value, icon, color
}) => (
  <div className="bg-gray-800 rounded-lg p-4 border border-gray-700">
    <div className="flex items-center justify-between">
      <div>
        <p className="text-gray-400 text-sm">{title}</p>
        <p className="text-2xl font-bold text-white mt-1">{value}</p>
      </div>
      <div className={`p-3 rounded-lg ${color}`}>
        {icon}
      </div>
    </div>
  </div>
);

// Get threat score color
const getThreatScoreColor = (score?: number) => {
  if (!score) return 'text-gray-400';
  if (score >= 80) return 'text-red-400';
  if (score >= 60) return 'text-orange-400';
  if (score >= 40) return 'text-yellow-400';
  if (score >= 20) return 'text-blue-400';
  return 'text-green-400';
};

// Get threat score badge
const getThreatScoreBadge = (score?: number) => {
  if (!score) return 'bg-gray-500/20 text-gray-400';
  if (score >= 80) return 'bg-red-500/20 text-red-400';
  if (score >= 60) return 'bg-orange-500/20 text-orange-400';
  if (score >= 40) return 'bg-yellow-500/20 text-yellow-400';
  if (score >= 20) return 'bg-blue-500/20 text-blue-400';
  return 'bg-green-500/20 text-green-400';
};

// Get file type icon
const getFileTypeIcon = (type: string) => {
  switch (type.toLowerCase()) {
    case 'pe': return <Binary className="w-5 h-5" />;
    case 'elf': return <FileCode className="w-5 h-5" />;
    case 'script': return <Code className="w-5 h-5" />;
    case 'pdf': return <FileText className="w-5 h-5" />;
    case 'apk': return <Shield className="w-5 h-5" />;
    default: return <Bug className="w-5 h-5" />;
  }
};

// Get IOC type icon
const getIocTypeIcon = (type: string) => {
  switch (type.toLowerCase()) {
    case 'ip': return <Network className="w-4 h-4" />;
    case 'domain': return <Globe className="w-4 h-4" />;
    case 'url': return <Globe className="w-4 h-4" />;
    case 'email': return <Mail className="w-4 h-4" />;
    case 'hash': return <Hash className="w-4 h-4" />;
    case 'bitcoin': return <Key className="w-4 h-4" />;
    default: return <Database className="w-4 h-4" />;
  }
};

// Format file size
const formatFileSize = (bytes: number) => {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
};

// Format date
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr);
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
};

// Sample Row Component
const SampleRow: React.FC<{
  sample: MalwareSample;
  onSelect: () => void;
  onAnalyze: () => void;
  onDelete: () => void;
}> = ({ sample, onSelect, onAnalyze, onDelete }) => (
  <tr
    className="border-b border-gray-700 hover:bg-gray-800/50 cursor-pointer transition-colors"
    onClick={onSelect}
  >
    <td className="px-4 py-3">
      <div className="flex items-center space-x-3">
        <div className="text-cyan-500">
          {getFileTypeIcon(sample.file_type)}
        </div>
        <div>
          <p className="text-white font-medium truncate max-w-xs">{sample.original_filename}</p>
          <p className="text-gray-500 text-xs font-mono">{sample.sha256.substring(0, 16)}...</p>
        </div>
      </div>
    </td>
    <td className="px-4 py-3">
      <span className="px-2 py-1 rounded text-xs bg-gray-700 text-gray-300">
        {sample.file_type.toUpperCase()}
      </span>
    </td>
    <td className="px-4 py-3 text-gray-300">{formatFileSize(sample.file_size)}</td>
    <td className="px-4 py-3">
      <span className={`px-2 py-1 rounded text-xs font-bold ${getThreatScoreBadge(sample.threat_score)}`}>
        {sample.threat_score ?? '-'}
      </span>
    </td>
    <td className="px-4 py-3">
      {sample.classification ? (
        <span className="text-sm text-gray-300">{sample.classification}</span>
      ) : (
        <span className="text-sm text-gray-500">-</span>
      )}
    </td>
    <td className="px-4 py-3">
      {sample.is_malicious === true && (
        <span className="px-2 py-1 rounded text-xs bg-red-500/20 text-red-400">Malicious</span>
      )}
      {sample.is_malicious === false && (
        <span className="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">Clean</span>
      )}
      {sample.is_malicious === undefined && (
        <span className="px-2 py-1 rounded text-xs bg-gray-500/20 text-gray-400">Unknown</span>
      )}
    </td>
    <td className="px-4 py-3 text-gray-400 text-sm">
      {new Date(sample.created_at).toLocaleDateString()}
    </td>
    <td className="px-4 py-3">
      <div className="flex items-center space-x-2" onClick={(e) => e.stopPropagation()}>
        <button
          onClick={onAnalyze}
          className="p-1.5 text-cyan-400 hover:bg-cyan-500/20 rounded transition-colors"
          title="Analyze"
        >
          <Zap className="w-4 h-4" />
        </button>
        <button
          onClick={onDelete}
          className="p-1.5 text-red-400 hover:bg-red-500/20 rounded transition-colors"
          title="Delete"
        >
          <Trash2 className="w-4 h-4" />
        </button>
      </div>
    </td>
  </tr>
);

// Upload Modal Component
const UploadModal: React.FC<{
  isOpen: boolean;
  onClose: () => void;
  onUpload: (file: File, tags: string[], notes: string) => void;
  isUploading: boolean;
}> = ({ isOpen, onClose, onUpload, isUploading }) => {
  const [file, setFile] = useState<File | null>(null);
  const [tags, setTags] = useState('');
  const [notes, setNotes] = useState('');
  const [dragActive, setDragActive] = useState(false);

  const handleDrag = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    if (e.type === 'dragenter' || e.type === 'dragover') {
      setDragActive(true);
    } else if (e.type === 'dragleave') {
      setDragActive(false);
    }
  }, []);

  const handleDrop = useCallback((e: React.DragEvent) => {
    e.preventDefault();
    e.stopPropagation();
    setDragActive(false);
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      setFile(e.dataTransfer.files[0]);
    }
  }, []);

  const handleSubmit = () => {
    if (file) {
      const tagList = tags.split(',').map(t => t.trim()).filter(t => t);
      onUpload(file, tagList, notes);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-800 rounded-lg w-full max-w-lg p-6 border border-gray-700">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold text-white flex items-center">
            <Upload className="w-5 h-5 mr-2 text-cyan-500" />
            Upload Sample
          </h2>
          <button onClick={onClose} className="text-gray-400 hover:text-white">
            <X className="w-5 h-5" />
          </button>
        </div>

        <div
          className={`border-2 border-dashed rounded-lg p-8 text-center mb-4 transition-colors ${
            dragActive ? 'border-cyan-500 bg-cyan-500/10' : 'border-gray-600 hover:border-gray-500'
          }`}
          onDragEnter={handleDrag}
          onDragLeave={handleDrag}
          onDragOver={handleDrag}
          onDrop={handleDrop}
        >
          {file ? (
            <div className="flex items-center justify-center space-x-2">
              <FileCode className="w-8 h-8 text-cyan-500" />
              <div>
                <p className="text-white font-medium">{file.name}</p>
                <p className="text-gray-400 text-sm">{formatFileSize(file.size)}</p>
              </div>
              <button onClick={() => setFile(null)} className="text-gray-400 hover:text-white">
                <XCircle className="w-5 h-5" />
              </button>
            </div>
          ) : (
            <>
              <Upload className="w-12 h-12 text-gray-500 mx-auto mb-2" />
              <p className="text-gray-300">Drag and drop a file here, or</p>
              <label className="mt-2 inline-block">
                <input
                  type="file"
                  className="hidden"
                  onChange={(e) => e.target.files && setFile(e.target.files[0])}
                />
                <span className="px-4 py-2 bg-cyan-600 text-white rounded cursor-pointer hover:bg-cyan-500 transition-colors">
                  Browse Files
                </span>
              </label>
            </>
          )}
        </div>

        <div className="space-y-4">
          <div>
            <label className="block text-sm text-gray-400 mb-1">Tags (comma-separated)</label>
            <input
              type="text"
              value={tags}
              onChange={(e) => setTags(e.target.value)}
              placeholder="e.g., ransomware, suspicious, campaign-123"
              className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white"
            />
          </div>
          <div>
            <label className="block text-sm text-gray-400 mb-1">Notes</label>
            <textarea
              value={notes}
              onChange={(e) => setNotes(e.target.value)}
              placeholder="Optional notes about this sample..."
              className="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white h-20"
            />
          </div>
        </div>

        <div className="flex justify-end space-x-3 mt-6">
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-300 hover:text-white transition-colors"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            disabled={!file || isUploading}
            className="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center"
          >
            {isUploading ? (
              <>
                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                Uploading...
              </>
            ) : (
              <>
                <Upload className="w-4 h-4 mr-2" />
                Upload & Analyze
              </>
            )}
          </button>
        </div>
      </div>
    </div>
  );
};

// Sample Detail Modal
const SampleDetailModal: React.FC<{
  sample: MalwareSample | null;
  isOpen: boolean;
  onClose: () => void;
  onAnalyze: () => void;
}> = ({ sample, isOpen, onClose, onAnalyze }) => {
  const [activeTab, setActiveTab] = useState<'overview' | 'strings' | 'imports' | 'iocs' | 'yara'>('overview');

  const { data: strings } = useQuery({
    queryKey: ['sample-strings', sample?.id],
    queryFn: () => sample?.id ? malwareAnalysisAPI.getSampleStrings(sample.id).then(r => r.data) : Promise.resolve([]),
    enabled: isOpen && !!sample?.id && activeTab === 'strings',
  });

  const { data: imports } = useQuery({
    queryKey: ['sample-imports', sample?.id],
    queryFn: () => sample?.id ? malwareAnalysisAPI.getSampleImports(sample.id).then(r => r.data) : Promise.resolve([]),
    enabled: isOpen && !!sample?.id && activeTab === 'imports',
  });

  const { data: iocs } = useQuery({
    queryKey: ['sample-iocs', sample?.id],
    queryFn: () => sample?.id ? malwareAnalysisAPI.getSampleIocs(sample.id).then(r => r.data) : Promise.resolve([]),
    enabled: isOpen && !!sample?.id && activeTab === 'iocs',
  });

  const { data: yaraMatches } = useQuery({
    queryKey: ['sample-yara', sample?.id],
    queryFn: () => sample?.id ? malwareAnalysisAPI.getYaraMatches(sample.id).then(r => r.data) : Promise.resolve([]),
    enabled: isOpen && !!sample?.id && activeTab === 'yara',
  });

  if (!isOpen || !sample) return null;

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('Copied to clipboard');
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-gray-800 rounded-lg w-full max-w-4xl max-h-[90vh] overflow-hidden border border-gray-700">
        <div className="flex justify-between items-center p-4 border-b border-gray-700">
          <div className="flex items-center space-x-3">
            <div className="text-cyan-500">{getFileTypeIcon(sample.file_type)}</div>
            <div>
              <h2 className="text-xl font-bold text-white">{sample.original_filename}</h2>
              <p className="text-gray-400 text-sm font-mono">{sample.sha256.substring(0, 32)}...</p>
            </div>
          </div>
          <div className="flex items-center space-x-2">
            <span className={`px-3 py-1 rounded font-bold ${getThreatScoreBadge(sample.threat_score)}`}>
              Threat Score: {sample.threat_score ?? 'N/A'}
            </span>
            <button onClick={onClose} className="text-gray-400 hover:text-white">
              <X className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* Tabs */}
        <div className="flex border-b border-gray-700">
          {(['overview', 'strings', 'imports', 'iocs', 'yara'] as const).map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-4 py-2 text-sm font-medium transition-colors ${
                activeTab === tab
                  ? 'text-cyan-400 border-b-2 border-cyan-400'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </button>
          ))}
        </div>

        <div className="p-4 overflow-y-auto max-h-[60vh]">
          {activeTab === 'overview' && (
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-3">
                <h3 className="text-lg font-semibold text-white">File Info</h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-gray-400">File Type:</span>
                    <span className="text-white">{sample.file_type.toUpperCase()}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">File Size:</span>
                    <span className="text-white">{formatFileSize(sample.file_size)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Entropy:</span>
                    <span className={`text-white ${sample.entropy > 7.5 ? 'text-red-400' : ''}`}>
                      {sample.entropy.toFixed(4)}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Source:</span>
                    <span className="text-white">{sample.source}</span>
                  </div>
                </div>

                <h3 className="text-lg font-semibold text-white mt-4">Hashes</h3>
                <div className="space-y-2">
                  <div className="flex items-center justify-between bg-gray-900 p-2 rounded">
                    <span className="text-gray-400 text-sm">MD5:</span>
                    <div className="flex items-center space-x-2">
                      <span className="text-white font-mono text-sm">{sample.md5}</span>
                      <button onClick={() => copyToClipboard(sample.md5)} className="text-gray-400 hover:text-white">
                        <Copy className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                  <div className="flex items-center justify-between bg-gray-900 p-2 rounded">
                    <span className="text-gray-400 text-sm">SHA256:</span>
                    <div className="flex items-center space-x-2">
                      <span className="text-white font-mono text-sm truncate max-w-xs">{sample.sha256}</span>
                      <button onClick={() => copyToClipboard(sample.sha256)} className="text-gray-400 hover:text-white">
                        <Copy className="w-4 h-4" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div className="space-y-3">
                <h3 className="text-lg font-semibold text-white">Classification</h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-gray-400">Classification:</span>
                    <span className="text-white">{sample.classification || 'Unknown'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Family:</span>
                    <span className="text-white">{sample.family || 'Unknown'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Status:</span>
                    {sample.is_malicious === true && (
                      <span className="px-2 py-1 rounded text-xs bg-red-500/20 text-red-400">Malicious</span>
                    )}
                    {sample.is_malicious === false && (
                      <span className="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">Clean</span>
                    )}
                    {sample.is_malicious === undefined && (
                      <span className="px-2 py-1 rounded text-xs bg-gray-500/20 text-gray-400">Unknown</span>
                    )}
                  </div>
                </div>

                <h3 className="text-lg font-semibold text-white mt-4">Timeline</h3>
                <div className="space-y-2">
                  <div className="flex justify-between">
                    <span className="text-gray-400">First Seen:</span>
                    <span className="text-white">{formatDate(sample.first_seen)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Last Analyzed:</span>
                    <span className="text-white">{sample.last_analyzed ? formatDate(sample.last_analyzed) : 'Never'}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Analysis Count:</span>
                    <span className="text-white">{sample.analysis_count}</span>
                  </div>
                </div>

                {sample.tags && sample.tags.length > 0 && (
                  <>
                    <h3 className="text-lg font-semibold text-white mt-4">Tags</h3>
                    <div className="flex flex-wrap gap-2">
                      {sample.tags.map((tag, i) => (
                        <span key={i} className="px-2 py-1 bg-gray-700 rounded text-sm text-gray-300">
                          {tag}
                        </span>
                      ))}
                    </div>
                  </>
                )}
              </div>
            </div>
          )}

          {activeTab === 'strings' && (
            <div className="space-y-2">
              {strings && strings.length > 0 ? (
                <div className="space-y-1 font-mono text-sm">
                  {(strings as { value: string; category: string }[]).slice(0, 100).map((s, i) => (
                    <div key={i} className="flex items-start space-x-2 p-2 bg-gray-900 rounded">
                      <span className="px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-400">{s.category}</span>
                      <span className="text-white break-all">{s.value}</span>
                    </div>
                  ))}
                </div>
              ) : (
                <p className="text-gray-400">No interesting strings found.</p>
              )}
            </div>
          )}

          {activeTab === 'imports' && (
            <div className="space-y-4">
              {imports && imports.length > 0 ? (
                (imports as { library: string; functions: string[] }[]).map((imp, i) => (
                  <div key={i} className="bg-gray-900 rounded p-3">
                    <h4 className="text-cyan-400 font-medium mb-2">{imp.library}</h4>
                    <div className="flex flex-wrap gap-1">
                      {imp.functions.map((fn, j) => (
                        <span key={j} className="px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-300 font-mono">
                          {fn}
                        </span>
                      ))}
                    </div>
                  </div>
                ))
              ) : (
                <p className="text-gray-400">No imports found.</p>
              )}
            </div>
          )}

          {activeTab === 'iocs' && (
            <div className="space-y-2">
              {iocs && iocs.length > 0 ? (
                iocs.map((ioc, i) => (
                  <div key={i} className="flex items-center justify-between bg-gray-900 rounded p-3">
                    <div className="flex items-center space-x-3">
                      <div className="text-cyan-500">{getIocTypeIcon(ioc.ioc_type)}</div>
                      <div>
                        <span className="text-white font-mono">{ioc.value}</span>
                        <span className="ml-2 px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-400">
                          {ioc.ioc_type}
                        </span>
                      </div>
                    </div>
                    <span className="text-gray-400 text-sm">
                      {(ioc.confidence * 100).toFixed(0)}% confidence
                    </span>
                  </div>
                ))
              ) : (
                <p className="text-gray-400">No IOCs extracted.</p>
              )}
            </div>
          )}

          {activeTab === 'yara' && (
            <div className="space-y-2">
              {yaraMatches && yaraMatches.length > 0 ? (
                (yaraMatches as { rule_name: string; tags: string[]; matched_at: string }[]).map((match, i) => (
                  <div key={i} className="flex items-center justify-between bg-gray-900 rounded p-3">
                    <div className="flex items-center space-x-3">
                      <Shield className="w-5 h-5 text-orange-400" />
                      <div>
                        <span className="text-white font-medium">{match.rule_name}</span>
                        <div className="flex gap-1 mt-1">
                          {match.tags?.map((tag, j) => (
                            <span key={j} className="px-2 py-0.5 bg-orange-500/20 rounded text-xs text-orange-400">
                              {tag}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>
                    <span className="text-gray-400 text-sm">{formatDate(match.matched_at)}</span>
                  </div>
                ))
              ) : (
                <p className="text-gray-400">No YARA matches.</p>
              )}
            </div>
          )}
        </div>

        <div className="flex justify-between items-center p-4 border-t border-gray-700">
          <button
            onClick={onAnalyze}
            className="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-500 transition-colors flex items-center"
          >
            <Zap className="w-4 h-4 mr-2" />
            Re-analyze
          </button>
          <button
            onClick={onClose}
            className="px-4 py-2 text-gray-300 hover:text-white transition-colors"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Main Page Component
const MalwareAnalysisPage: React.FC = () => {
  const queryClient = useQueryClient();
  const [activeTab, setActiveTab] = useState<'samples' | 'yara' | 'iocs' | 'queue'>('samples');
  const [showUploadModal, setShowUploadModal] = useState(false);
  const [selectedSample, setSelectedSample] = useState<MalwareSample | null>(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [fileTypeFilter, setFileTypeFilter] = useState<string>('');

  // Queries
  const { data: stats, isLoading: statsLoading } = useQuery({
    queryKey: ['malware-stats'],
    queryFn: () => malwareAnalysisAPI.getStats().then(r => r.data),
  });

  const { data: samples, isLoading: samplesLoading, refetch: refetchSamples } = useQuery({
    queryKey: ['malware-samples', searchQuery, fileTypeFilter],
    queryFn: () => malwareAnalysisAPI.listSamples({
      search: searchQuery || undefined,
      file_type: fileTypeFilter || undefined,
      limit: 100,
    }).then(r => r.data),
  });

  const { data: yaraRules, isLoading: yaraLoading } = useQuery({
    queryKey: ['yara-rules'],
    queryFn: () => malwareAnalysisAPI.listYaraRules({ include_builtin: true }).then(r => r.data),
    enabled: activeTab === 'yara',
  });

  const { data: iocs, isLoading: iocsLoading } = useQuery({
    queryKey: ['malware-iocs'],
    queryFn: () => malwareAnalysisAPI.listIocs({ limit: 100 }).then(r => r.data),
    enabled: activeTab === 'iocs',
  });

  const { data: queue, isLoading: queueLoading } = useQuery({
    queryKey: ['malware-queue'],
    queryFn: () => malwareAnalysisAPI.listQueue().then(r => r.data),
    enabled: activeTab === 'queue',
  });

  // Mutations
  const uploadMutation = useMutation({
    mutationFn: (data: { file: File; tags: string[]; notes: string }) => {
      const formData = new FormData();
      formData.append('file', data.file);
      formData.append('tags', data.tags.join(','));
      formData.append('notes', data.notes);
      return malwareAnalysisAPI.uploadSample(formData);
    },
    onSuccess: () => {
      toast.success('Sample uploaded and queued for analysis');
      setShowUploadModal(false);
      queryClient.invalidateQueries({ queryKey: ['malware-samples'] });
      queryClient.invalidateQueries({ queryKey: ['malware-stats'] });
      queryClient.invalidateQueries({ queryKey: ['malware-queue'] });
    },
    onError: (error: Error & { response?: { data?: { error?: string } } }) => {
      toast.error(error.response?.data?.error || 'Failed to upload sample');
    },
  });

  const analyzeMutation = useMutation({
    mutationFn: (id: string) => malwareAnalysisAPI.analyzeSample(id),
    onSuccess: (response) => {
      toast.success(`Analysis complete. Threat score: ${response.data.threat_score}`);
      queryClient.invalidateQueries({ queryKey: ['malware-samples'] });
      queryClient.invalidateQueries({ queryKey: ['malware-stats'] });
      if (selectedSample) {
        setSelectedSample(null);
      }
    },
    onError: () => {
      toast.error('Failed to analyze sample');
    },
  });

  const deleteMutation = useMutation({
    mutationFn: (id: string) => malwareAnalysisAPI.deleteSample(id),
    onSuccess: () => {
      toast.success('Sample deleted');
      queryClient.invalidateQueries({ queryKey: ['malware-samples'] });
      queryClient.invalidateQueries({ queryKey: ['malware-stats'] });
    },
    onError: () => {
      toast.error('Failed to delete sample');
    },
  });

  return (
    <Layout>
      <div className="p-6 space-y-6">
        {/* Header */}
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-bold text-white flex items-center">
              <Bug className="w-7 h-7 mr-2 text-red-500" />
              Malware Analysis
            </h1>
            <p className="text-gray-400 mt-1">Upload and analyze malware samples with static analysis and YARA matching</p>
          </div>
          <button
            onClick={() => setShowUploadModal(true)}
            className="px-4 py-2 bg-cyan-600 text-white rounded hover:bg-cyan-500 transition-colors flex items-center"
          >
            <Upload className="w-4 h-4 mr-2" />
            Upload Sample
          </button>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <StatsCard
            title="Total Samples"
            value={stats?.total_samples ?? 0}
            icon={<Database className="w-6 h-6 text-white" />}
            color="bg-cyan-500/20"
          />
          <StatsCard
            title="Malicious"
            value={stats?.samples_malicious ?? 0}
            icon={<AlertTriangle className="w-6 h-6 text-white" />}
            color="bg-red-500/20"
          />
          <StatsCard
            title="YARA Rules"
            value={stats?.total_yara_rules ?? 0}
            icon={<Shield className="w-6 h-6 text-white" />}
            color="bg-orange-500/20"
          />
          <StatsCard
            title="IOCs Extracted"
            value={stats?.total_iocs ?? 0}
            icon={<Network className="w-6 h-6 text-white" />}
            color="bg-purple-500/20"
          />
        </div>

        {/* Tabs */}
        <div className="flex border-b border-gray-700">
          {(['samples', 'yara', 'iocs', 'queue'] as const).map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`px-6 py-3 text-sm font-medium transition-colors ${
                activeTab === tab
                  ? 'text-cyan-400 border-b-2 border-cyan-400'
                  : 'text-gray-400 hover:text-white'
              }`}
            >
              {tab === 'samples' && 'Samples'}
              {tab === 'yara' && 'YARA Rules'}
              {tab === 'iocs' && 'IOCs'}
              {tab === 'queue' && 'Analysis Queue'}
            </button>
          ))}
        </div>

        {/* Samples Tab */}
        {activeTab === 'samples' && (
          <div className="space-y-4">
            {/* Search & Filter */}
            <div className="flex space-x-4">
              <div className="flex-1 relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  type="text"
                  placeholder="Search by filename, hash, or notes..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="w-full bg-gray-800 border border-gray-700 rounded pl-10 pr-4 py-2 text-white"
                />
              </div>
              <select
                value={fileTypeFilter}
                onChange={(e) => setFileTypeFilter(e.target.value)}
                className="bg-gray-800 border border-gray-700 rounded px-4 py-2 text-white"
              >
                <option value="">All File Types</option>
                <option value="pe">PE</option>
                <option value="elf">ELF</option>
                <option value="script">Script</option>
                <option value="pdf">PDF</option>
                <option value="apk">APK</option>
              </select>
              <button
                onClick={() => refetchSamples()}
                className="px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 transition-colors"
              >
                <RefreshCw className="w-4 h-4" />
              </button>
            </div>

            {/* Samples Table */}
            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-900">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Sample</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Type</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Size</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Threat</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Classification</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Date</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {samplesLoading ? (
                    <tr>
                      <td colSpan={8} className="px-4 py-8 text-center text-gray-400">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto" />
                      </td>
                    </tr>
                  ) : samples && samples.length > 0 ? (
                    samples.map((sample) => (
                      <SampleRow
                        key={sample.id}
                        sample={sample}
                        onSelect={() => setSelectedSample(sample)}
                        onAnalyze={() => analyzeMutation.mutate(sample.id)}
                        onDelete={() => {
                          if (confirm('Are you sure you want to delete this sample?')) {
                            deleteMutation.mutate(sample.id);
                          }
                        }}
                      />
                    ))
                  ) : (
                    <tr>
                      <td colSpan={8} className="px-4 py-8 text-center text-gray-400">
                        No samples found. Upload a sample to get started.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* YARA Rules Tab */}
        {activeTab === 'yara' && (
          <div className="space-y-4">
            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-900">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Rule Name</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Category</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Severity</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Type</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Matches</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {yaraLoading ? (
                    <tr>
                      <td colSpan={6} className="px-4 py-8 text-center text-gray-400">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto" />
                      </td>
                    </tr>
                  ) : yaraRules && yaraRules.length > 0 ? (
                    yaraRules.map((rule) => (
                      <tr key={rule.id} className="border-b border-gray-700 hover:bg-gray-800/50">
                        <td className="px-4 py-3">
                          <div className="flex items-center space-x-2">
                            <Shield className="w-4 h-4 text-orange-400" />
                            <span className="text-white font-medium">{rule.name}</span>
                          </div>
                        </td>
                        <td className="px-4 py-3 text-gray-300">{rule.category}</td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded text-xs ${
                            rule.severity === 'critical' ? 'bg-red-500/20 text-red-400' :
                            rule.severity === 'high' ? 'bg-orange-500/20 text-orange-400' :
                            rule.severity === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                            'bg-gray-500/20 text-gray-400'
                          }`}>
                            {rule.severity}
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded text-xs ${
                            rule.is_builtin ? 'bg-blue-500/20 text-blue-400' : 'bg-green-500/20 text-green-400'
                          }`}>
                            {rule.is_builtin ? 'Built-in' : 'Custom'}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-gray-300">{rule.match_count}</td>
                        <td className="px-4 py-3">
                          {rule.is_enabled ? (
                            <span className="px-2 py-1 rounded text-xs bg-green-500/20 text-green-400">Enabled</span>
                          ) : (
                            <span className="px-2 py-1 rounded text-xs bg-gray-500/20 text-gray-400">Disabled</span>
                          )}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan={6} className="px-4 py-8 text-center text-gray-400">
                        No YARA rules found.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* IOCs Tab */}
        {activeTab === 'iocs' && (
          <div className="space-y-4">
            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-900">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">IOC Type</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Value</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Sample</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Confidence</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Date</th>
                  </tr>
                </thead>
                <tbody>
                  {iocsLoading ? (
                    <tr>
                      <td colSpan={5} className="px-4 py-8 text-center text-gray-400">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto" />
                      </td>
                    </tr>
                  ) : iocs && iocs.length > 0 ? (
                    iocs.map((ioc) => (
                      <tr key={ioc.id} className="border-b border-gray-700 hover:bg-gray-800/50">
                        <td className="px-4 py-3">
                          <div className="flex items-center space-x-2">
                            {getIocTypeIcon(ioc.ioc_type)}
                            <span className="text-gray-300">{ioc.ioc_type}</span>
                          </div>
                        </td>
                        <td className="px-4 py-3 text-white font-mono text-sm">{ioc.value}</td>
                        <td className="px-4 py-3 text-gray-300 text-sm">
                          {ioc.sample_filename || ioc.sample_sha256?.substring(0, 16) + '...'}
                        </td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded text-xs ${
                            ioc.confidence >= 0.8 ? 'bg-green-500/20 text-green-400' :
                            ioc.confidence >= 0.5 ? 'bg-yellow-500/20 text-yellow-400' :
                            'bg-gray-500/20 text-gray-400'
                          }`}>
                            {(ioc.confidence * 100).toFixed(0)}%
                          </span>
                        </td>
                        <td className="px-4 py-3 text-gray-400 text-sm">
                          {new Date(ioc.created_at).toLocaleDateString()}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan={5} className="px-4 py-8 text-center text-gray-400">
                        No IOCs extracted yet.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {/* Queue Tab */}
        {activeTab === 'queue' && (
          <div className="space-y-4">
            <div className="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-900">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Sample</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Analysis Types</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Priority</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Status</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Attempts</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-400">Created</th>
                  </tr>
                </thead>
                <tbody>
                  {queueLoading ? (
                    <tr>
                      <td colSpan={6} className="px-4 py-8 text-center text-gray-400">
                        <Loader2 className="w-6 h-6 animate-spin mx-auto" />
                      </td>
                    </tr>
                  ) : queue && queue.length > 0 ? (
                    queue.map((item) => (
                      <tr key={item.id} className="border-b border-gray-700 hover:bg-gray-800/50">
                        <td className="px-4 py-3">
                          <div>
                            <p className="text-white font-medium">{item.sample_filename}</p>
                            <p className="text-gray-500 text-xs font-mono">{item.sample_sha256.substring(0, 16)}...</p>
                          </div>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex flex-wrap gap-1">
                            {item.analysis_types.split(',').map((type, i) => (
                              <span key={i} className="px-2 py-0.5 bg-gray-700 rounded text-xs text-gray-300">
                                {type.trim()}
                              </span>
                            ))}
                          </div>
                        </td>
                        <td className="px-4 py-3 text-gray-300">{item.priority}</td>
                        <td className="px-4 py-3">
                          <span className={`px-2 py-1 rounded text-xs ${
                            item.status === 'pending' ? 'bg-yellow-500/20 text-yellow-400' :
                            item.status === 'running' ? 'bg-blue-500/20 text-blue-400' :
                            item.status === 'completed' ? 'bg-green-500/20 text-green-400' :
                            'bg-red-500/20 text-red-400'
                          }`}>
                            {item.status}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-gray-300">{item.attempts}</td>
                        <td className="px-4 py-3 text-gray-400 text-sm">
                          {new Date(item.created_at).toLocaleDateString()}
                        </td>
                      </tr>
                    ))
                  ) : (
                    <tr>
                      <td colSpan={6} className="px-4 py-8 text-center text-gray-400">
                        No items in queue.
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>
        )}
      </div>

      {/* Modals */}
      <UploadModal
        isOpen={showUploadModal}
        onClose={() => setShowUploadModal(false)}
        onUpload={(file, tags, notes) => uploadMutation.mutate({ file, tags, notes })}
        isUploading={uploadMutation.isPending}
      />

      <SampleDetailModal
        sample={selectedSample}
        isOpen={!!selectedSample}
        onClose={() => setSelectedSample(null)}
        onAnalyze={() => {
          if (selectedSample) {
            analyzeMutation.mutate(selectedSample.id);
          }
        }}
      />
    </Layout>
  );
};

export default MalwareAnalysisPage;
