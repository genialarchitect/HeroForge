import { useState, useEffect } from 'react';
import { Link, useSearchParams } from 'react-router-dom';
import { PortalLayout } from '../../components/portal/PortalLayout';
import { portalVulnerabilitiesAPI, portalEngagementsAPI } from '../../services/portalApi';
import type { PortalVulnerabilitiesResponse, PortalEngagement } from '../../types';

const severityColors: Record<string, string> = {
  critical: 'bg-red-600 text-white',
  high: 'bg-orange-600 text-white',
  medium: 'bg-yellow-600 text-white',
  low: 'bg-green-600 text-white',
  info: 'bg-blue-600 text-white',
};

const statusColors: Record<string, string> = {
  open: 'bg-red-900/50 text-red-200',
  in_progress: 'bg-blue-900/50 text-blue-200',
  pending_verification: 'bg-yellow-900/50 text-yellow-200',
  resolved: 'bg-green-900/50 text-green-200',
  accepted_risk: 'bg-purple-900/50 text-purple-200',
};

export default function PortalVulnerabilityList() {
  const [searchParams, setSearchParams] = useSearchParams();
  const [data, setData] = useState<PortalVulnerabilitiesResponse | null>(null);
  const [engagements, setEngagements] = useState<PortalEngagement[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  const severity = searchParams.get('severity') || '';
  const status = searchParams.get('status') || '';
  const engagementId = searchParams.get('engagement_id') || '';
  const page = parseInt(searchParams.get('page') || '1', 10);
  const limit = 20;

  useEffect(() => {
    loadEngagements();
  }, []);

  useEffect(() => {
    loadVulnerabilities();
  }, [severity, status, engagementId, page]);

  const loadEngagements = async () => {
    try {
      const response = await portalEngagementsAPI.getAll();
      setEngagements(response.data);
    } catch (err) {
      console.error('Failed to load engagements:', err);
    }
  };

  const loadVulnerabilities = async () => {
    setLoading(true);
    try {
      const response = await portalVulnerabilitiesAPI.getAll({
        severity: severity || undefined,
        status: status || undefined,
        engagement_id: engagementId || undefined,
        limit,
        offset: (page - 1) * limit,
      });
      setData(response.data);
    } catch (err) {
      setError('Failed to load vulnerabilities');
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const updateFilter = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams);
    if (value) {
      params.set(key, value);
    } else {
      params.delete(key);
    }
    params.delete('page');
    setSearchParams(params);
  };

  const totalPages = data ? Math.ceil(data.stats.total / limit) : 0;

  return (
    <PortalLayout>
      <div className="space-y-6">
        <h1 className="text-2xl font-bold text-white">Vulnerabilities</h1>

        {data && (
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-gray-800 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-white">{data.stats.total}</p>
              <p className="text-sm text-gray-400">Total</p>
            </div>
            <div className="bg-red-900/30 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-red-400">{data.stats.critical}</p>
              <p className="text-sm text-gray-400">Critical</p>
            </div>
            <div className="bg-orange-900/30 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-orange-400">{data.stats.high}</p>
              <p className="text-sm text-gray-400">High</p>
            </div>
            <div className="bg-blue-900/30 rounded-lg p-4 text-center">
              <p className="text-2xl font-bold text-blue-400">{data.stats.open}</p>
              <p className="text-sm text-gray-400">Open</p>
            </div>
          </div>
        )}

        <div className="flex flex-wrap gap-4">
          <select
            value={severity}
            onChange={(e) => updateFilter('severity', e.target.value)}
            className="bg-gray-700 text-white px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-500"
          >
            <option value="">All Severities</option>
            <option value="critical">Critical</option>
            <option value="high">High</option>
            <option value="medium">Medium</option>
            <option value="low">Low</option>
          </select>

          <select
            value={status}
            onChange={(e) => updateFilter('status', e.target.value)}
            className="bg-gray-700 text-white px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-500"
          >
            <option value="">All Statuses</option>
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="pending_verification">Pending Verification</option>
            <option value="resolved">Resolved</option>
            <option value="accepted_risk">Accepted Risk</option>
          </select>

          <select
            value={engagementId}
            onChange={(e) => updateFilter('engagement_id', e.target.value)}
            className="bg-gray-700 text-white px-4 py-2 rounded-lg border-0 focus:ring-2 focus:ring-blue-500"
          >
            <option value="">All Engagements</option>
            {engagements.map(e => (
              <option key={e.id} value={e.id}>{e.name}</option>
            ))}
          </select>
        </div>

        {error && (
          <div className="bg-red-900/50 text-red-200 p-4 rounded-lg">{error}</div>
        )}

        {loading ? (
          <div className="flex items-center justify-center h-32">
            <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin" />
          </div>
        ) : data?.vulnerabilities.length === 0 ? (
          <div className="bg-gray-800 rounded-lg p-8 text-center">
            <p className="text-gray-400">No vulnerabilities found</p>
          </div>
        ) : (
          <div className="bg-gray-800 rounded-lg overflow-hidden">
            <table className="w-full">
              <thead className="bg-gray-700">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Title</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Severity</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Status</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">Host</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase">CVSS</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-700">
                {data?.vulnerabilities.map(vuln => (
                  <tr key={vuln.id} className="hover:bg-gray-750">
                    <td className="px-4 py-4">
                      <Link to={`/portal/vulnerabilities/${vuln.id}`} className="text-blue-400 hover:text-blue-300">
                        {vuln.title}
                      </Link>
                      {vuln.cve_ids && (
                        <p className="text-xs text-gray-500 mt-1">{vuln.cve_ids}</p>
                      )}
                    </td>
                    <td className="px-4 py-4">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${severityColors[vuln.severity] || 'bg-gray-600 text-gray-200'}`}>
                        {vuln.severity}
                      </span>
                    </td>
                    <td className="px-4 py-4">
                      <span className={`px-2 py-1 rounded text-xs font-medium ${statusColors[vuln.status] || 'bg-gray-700 text-gray-300'}`}>
                        {vuln.status.replace('_', ' ')}
                      </span>
                    </td>
                    <td className="px-4 py-4 text-gray-300 text-sm">
                      {vuln.host}{vuln.port ? `:${vuln.port}` : ''}
                    </td>
                    <td className="px-4 py-4 text-gray-300 text-sm">
                      {vuln.cvss_score?.toFixed(1) || '-'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}

        {totalPages > 1 && (
          <div className="flex justify-center gap-2">
            <button
              onClick={() => setSearchParams(prev => { prev.set('page', String(page - 1)); return prev; })}
              disabled={page <= 1}
              className="px-4 py-2 bg-gray-700 text-white rounded-lg disabled:opacity-50"
            >
              Previous
            </button>
            <span className="px-4 py-2 text-gray-400">
              Page {page} of {totalPages}
            </span>
            <button
              onClick={() => setSearchParams(prev => { prev.set('page', String(page + 1)); return prev; })}
              disabled={page >= totalPages}
              className="px-4 py-2 bg-gray-700 text-white rounded-lg disabled:opacity-50"
            >
              Next
            </button>
          </div>
        )}
      </div>
    </PortalLayout>
  );
}
