import { useEffect, useRef, useState, useCallback } from 'react';

export interface ExploitationProgress {
  type: string;
  campaign_id?: string;
  attack_type?: string;
  total_targets?: number;
  target?: string;
  index?: number;
  total?: number;
  username?: string;
  success?: boolean;
  credential_type?: string;
  hash_type?: string;
  payload_id?: string;
  format?: string;
  module?: string;
  findings_count?: number;
  progress_percent?: number;
  message?: string;
  total_results?: number;
  successful?: number;
  duration_ms?: number;
}

interface UseExploitationWebSocketOptions {
  campaignId: string;
  enabled?: boolean;
  onProgress?: (progress: ExploitationProgress) => void;
  onComplete?: (result: ExploitationProgress) => void;
  onError?: (error: string) => void;
}

export function useExploitationWebSocket({
  campaignId,
  enabled = true,
  onProgress,
  onComplete,
  onError,
}: UseExploitationWebSocketOptions) {
  const ws = useRef<WebSocket | null>(null);
  const [connected, setConnected] = useState(false);
  const [progress, setProgress] = useState<ExploitationProgress[]>([]);
  const [lastMessage, setLastMessage] = useState<ExploitationProgress | null>(null);
  const reconnectAttempts = useRef(0);
  const maxReconnectAttempts = 3;

  const connect = useCallback(() => {
    if (!enabled || !campaignId) return;

    const token = localStorage.getItem('token');
    if (!token) {
      onError?.('No authentication token');
      return;
    }

    // Close existing connection
    if (ws.current) {
      ws.current.close();
    }

    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/api/ws/exploitation/${campaignId}?token=${token}`;

    console.log('[ExploitationWS] Connecting to:', wsUrl);
    ws.current = new WebSocket(wsUrl);

    ws.current.onopen = () => {
      console.log('[ExploitationWS] Connected to campaign:', campaignId);
      setConnected(true);
      reconnectAttempts.current = 0;
    };

    ws.current.onmessage = (event) => {
      try {
        const data: ExploitationProgress = JSON.parse(event.data);
        console.log('[ExploitationWS] Received:', data.type, data);

        setLastMessage(data);
        setProgress(prev => [...prev, data]);

        onProgress?.(data);

        // Handle completion
        if (data.type === 'campaignCompleted' || data.type === 'campaign_completed') {
          onComplete?.(data);
        }

        // Handle errors
        if (data.type === 'error') {
          onError?.(data.message || 'Unknown error');
        }
      } catch (e) {
        console.error('[ExploitationWS] Failed to parse message:', e);
      }
    };

    ws.current.onclose = (event) => {
      console.log('[ExploitationWS] Connection closed:', event.code, event.reason);
      setConnected(false);

      // Attempt to reconnect if not a normal close
      if (event.code !== 1000 && reconnectAttempts.current < maxReconnectAttempts) {
        reconnectAttempts.current++;
        console.log(`[ExploitationWS] Reconnecting... attempt ${reconnectAttempts.current}`);
        setTimeout(connect, 2000 * reconnectAttempts.current);
      }
    };

    ws.current.onerror = (error) => {
      console.error('[ExploitationWS] Error:', error);
      onError?.('WebSocket connection error');
    };
  }, [campaignId, enabled, onProgress, onComplete, onError]);

  const disconnect = useCallback(() => {
    if (ws.current) {
      ws.current.close(1000, 'User disconnected');
      ws.current = null;
    }
    setConnected(false);
  }, []);

  const clearProgress = useCallback(() => {
    setProgress([]);
    setLastMessage(null);
  }, []);

  useEffect(() => {
    if (enabled && campaignId) {
      connect();
    }

    return () => {
      disconnect();
    };
  }, [campaignId, enabled, connect, disconnect]);

  return {
    connected,
    progress,
    lastMessage,
    connect,
    disconnect,
    clearProgress,
  };
}

export default useExploitationWebSocket;
