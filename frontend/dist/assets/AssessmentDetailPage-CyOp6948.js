import{j as e}from"./vendor-state-BXNPjUwt.js";import{r as c,R as Oe,i as Ue,e as ze,u as Me}from"./vendor-react-5KxtEOLM.js";import{F as H,at as pe,ad as ue,ap as Be,O as qe,h as te,X as ie,z as Ve,B as O,l as ve,_ as be,bB as ae,C as We,a2 as Ne,bq as de,a6 as fe,$ as Ce,ab as Ee,bp as Ge,bC as we,bD as ce,q as He,u as Ke,aE as Je,aq as Xe,aJ as Ye,ag as Ze,g as ye,bE as Ae,aT as je,A as ge,b2 as De,aQ as Fe,i as ke,ac as Qe,k as ea,aM as aa,p as sa}from"./vendor-ui-PizTOSgB.js";import{I as Z,B as N,P as A,S as J,R as Se}from"./index-DgePDh_X.js";import{L as re}from"./Layout-CeExTnzB.js";import{C as $}from"./Card-D4UbjXYP.js";import{L as ta}from"./LoadingSpinner-p-Ub3czh.js";import{B as se}from"./Badge-B0_IBqp5.js";import{C as ra}from"./ConfirmationDialog-CE4JJxRj.js";import"./vendor-utils-DfRopTPV.js";import"./Header-Dw99lsG2.js";import"./vendor-markdown-RN55YrVy.js";const la=3e4,ee=[{value:"compliant",label:"Compliant",color:"text-green-400"},{value:"partial",label:"Partially Compliant",color:"text-yellow-400"},{value:"non_compliant",label:"Non-Compliant",color:"text-red-400"},{value:"not_applicable",label:"Not Applicable",color:"text-slate-400"}],Re={0:"bg-slate-600 border-slate-500",1:"bg-red-600 border-red-500",2:"bg-orange-600 border-orange-500",3:"bg-yellow-600 border-yellow-500",4:"bg-green-600 border-green-500",5:"bg-emerald-600 border-emerald-500"},xe=(s,a)=>`heroforge_assessment_draft_${s}_${a||"new"}`,le=s=>s?s.split("T")[0]:new Date().toISOString().split("T")[0],na=(s,a,h)=>{if(s.size===0||a.length===0)return 0;let g=0,t=0;return a.forEach(n=>{const i=s.get(n.id);i&&i.rating>0&&(g+=n.weight,t+=i.rating/h*n.weight)}),g===0?0:Math.round(t/g*100)},ia=s=>s>=80?"compliant":s>=50?"partial":"non_compliant",da=({completed:s,total:a})=>{const h=a>0?Math.round(s/a*100):0;return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"flex-1 h-2 bg-dark-border rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full transition-all duration-300 ${h===100?"bg-green-500":h>=50?"bg-yellow-500":"bg-blue-500"}`,style:{width:`${h}%`}})}),e.jsxs("span",{className:"text-sm text-slate-400 whitespace-nowrap",children:[s," / ",a," (",h,"%)"]})]})},ca=({levels:s,selectedValue:a,onChange:h,disabled:g=!1})=>e.jsx("div",{className:"flex flex-wrap gap-2",children:s.map(t=>{const n=a===t.value,i=Re[t.value]||Re[0];return e.jsx("button",{type:"button",onClick:()=>h(t.value),disabled:g,className:`
              px-3 py-2 rounded-lg border-2 transition-all text-sm font-medium
              ${n?`${i} text-white shadow-lg ring-2 ring-offset-2 ring-offset-dark-bg ring-white/20`:"bg-dark-surface border-dark-border text-slate-300 hover:border-slate-500"}
              ${g?"opacity-50 cursor-not-allowed":"cursor-pointer"}
            `,title:t.description,children:t.label},t.value)})}),oa=({criterion:s,response:a,ratingLevels:h,isExpanded:g,onToggleExpand:t,onRatingChange:n,onNotesChange:i})=>{var m;const o=a&&a.rating>0,p=a&&a.evidence_ids.length>0;return e.jsxs("div",{className:`border rounded-lg overflow-hidden transition-all ${o?"border-green-500/30 bg-green-500/5":"border-dark-border bg-dark-surface"}`,children:[e.jsxs("div",{onClick:t,className:"flex items-center justify-between p-4 cursor-pointer hover:bg-dark-hover/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[g?e.jsx(ve,{className:"h-5 w-5 text-slate-400 flex-shrink-0"}):e.jsx(be,{className:"h-5 w-5 text-slate-400 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[o?e.jsx(ue,{className:"h-4 w-4 text-green-400 flex-shrink-0"}):e.jsx(te,{className:"h-4 w-4 text-slate-500 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium text-white truncate",children:s.question})]}),e.jsx("p",{className:"text-xs text-slate-400 truncate",children:s.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0 ml-3",children:[p&&e.jsxs(se,{variant:"status",type:"completed",className:"text-xs",children:[e.jsx(ae,{className:"h-3 w-3 mr-1"}),a==null?void 0:a.evidence_ids.length]}),e.jsxs("span",{className:"text-xs text-slate-500 bg-dark-bg px-2 py-1 rounded",children:["Weight: ",s.weight]}),o&&e.jsx(se,{variant:"status",type:a.rating>=4?"completed":a.rating>=2?"running":"failed",children:((m=h.find(k=>k.value===(a==null?void 0:a.rating)))==null?void 0:m.label)||"N/A"})]})]}),g&&e.jsxs("div",{className:"p-4 border-t border-dark-border bg-dark-bg space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(We,{className:"h-4 w-4 text-primary mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-slate-200",children:s.question}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:s.description})]})]}),s.guidance&&e.jsx("div",{className:"p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-blue-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-blue-300 mb-1",children:"Guidance"}),e.jsx("p",{className:"text-sm text-blue-100",children:s.guidance})]})]})}),s.evidence_hint&&e.jsx("div",{className:"p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(ae,{className:"h-4 w-4 text-purple-400 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-purple-300 mb-1",children:"Evidence Hint"}),e.jsx("p",{className:"text-sm text-purple-100",children:s.evidence_hint})]})]})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:["Rating ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx(ca,{levels:h,selectedValue:(a==null?void 0:a.rating)||0,onChange:n})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Notes / Justification"}),e.jsx("textarea",{value:(a==null?void 0:a.notes)||"",onChange:k=>i(k.target.value),className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-transparent resize-none",rows:3,placeholder:"Provide justification for this rating..."})]}),p&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-400",children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsxs("span",{children:[a==null?void 0:a.evidence_ids.length," evidence item(s) attached"]})]})]})]})},ma=({rubric:s,existingAssessment:a,onSubmit:h,onCancel:g})=>{var W,w,u,R;const[t,n]=c.useState(()=>{const r=xe(s.id,a==null?void 0:a.id),x=localStorage.getItem(r);if(x)try{const j=JSON.parse(x);return{assessmentPeriodStart:j.assessmentPeriodStart||le(a==null?void 0:a.assessment_period_start),assessmentPeriodEnd:j.assessmentPeriodEnd||le(a==null?void 0:a.assessment_period_end),criteriaResponses:new Map(Object.entries(j.criteriaResponses||{})),overallRating:j.overallRating||(a==null?void 0:a.overall_rating)||"non_compliant",overallRatingOverride:j.overallRatingOverride||!1,evidenceSummary:j.evidenceSummary||(a==null?void 0:a.evidence_summary)||"",findings:j.findings||(a==null?void 0:a.findings)||"",recommendations:j.recommendations||(a==null?void 0:a.recommendations)||""}}catch(j){console.warn("Failed to parse saved draft:",j)}const _=new Map;return a!=null&&a.criteria_responses&&a.criteria_responses.forEach(j=>{_.set(j.criterion_id,j)}),{assessmentPeriodStart:le(a==null?void 0:a.assessment_period_start),assessmentPeriodEnd:le(a==null?void 0:a.assessment_period_end),criteriaResponses:_,overallRating:(a==null?void 0:a.overall_rating)||"non_compliant",overallRatingOverride:!1,evidenceSummary:(a==null?void 0:a.evidence_summary)||"",findings:(a==null?void 0:a.findings)||"",recommendations:(a==null?void 0:a.recommendations)||""}}),[i,o]=c.useState(new Set),[p,m]=c.useState(!1),[k,v]=c.useState(!1),[P,M]=c.useState([]),[S,B]=c.useState(null),U=c.useMemo(()=>Math.max(...s.rating_scale.levels.map(r=>r.value)),[s.rating_scale.levels]),F=c.useMemo(()=>na(t.criteriaResponses,s.assessment_criteria,U),[t.criteriaResponses,s.assessment_criteria,U]),q=c.useMemo(()=>ia(F),[F]),E=c.useMemo(()=>Array.from(t.criteriaResponses.values()).filter(r=>r.rating>0).length,[t.criteriaResponses]),z=t.overallRatingOverride?t.overallRating:q;c.useEffect(()=>{if(!p)return;const r=setInterval(()=>{const x=xe(s.id,a==null?void 0:a.id),_={...t,criteriaResponses:Object.fromEntries(t.criteriaResponses)};localStorage.setItem(x,JSON.stringify(_)),B(new Date)},la);return()=>clearInterval(r)},[p,t,s.id,a==null?void 0:a.id]),c.useEffect(()=>{const r=x=>{p&&(x.preventDefault(),x.returnValue="")};return window.addEventListener("beforeunload",r),()=>window.removeEventListener("beforeunload",r)},[p]);const V=c.useCallback((r,x)=>{n(_=>{const j=new Map(_.criteriaResponses),C=j.get(r);return j.set(r,{criterion_id:r,rating:x,notes:(C==null?void 0:C.notes)||"",evidence_ids:(C==null?void 0:C.evidence_ids)||[]}),{..._,criteriaResponses:j}}),m(!0)},[]),l=c.useCallback((r,x)=>{n(_=>{const j=new Map(_.criteriaResponses),C=j.get(r);return j.set(r,{criterion_id:r,rating:(C==null?void 0:C.rating)||0,notes:x,evidence_ids:(C==null?void 0:C.evidence_ids)||[]}),{..._,criteriaResponses:j}}),m(!0)},[]),y=c.useCallback(r=>{o(x=>{const _=new Set(x);return _.has(r)?_.delete(r):_.add(r),_})},[]),L=c.useCallback(()=>{o(new Set(s.assessment_criteria.map(r=>r.id)))},[s.assessment_criteria]),D=c.useCallback(()=>{o(new Set)},[]),I=c.useCallback(()=>{const r=[];t.assessmentPeriodStart||r.push("Assessment period start date is required"),t.assessmentPeriodEnd||r.push("Assessment period end date is required"),t.assessmentPeriodStart&&t.assessmentPeriodEnd&&new Date(t.assessmentPeriodStart)>new Date(t.assessmentPeriodEnd)&&r.push("Assessment period start date must be before end date");const x=s.assessment_criteria.filter(_=>{const j=t.criteriaResponses.get(_.id);return!j||j.rating===0});return x.length>0&&r.push(`${x.length} criterion/criteria still need ratings`),M(r),r.length===0},[t,s.assessment_criteria]),K=async r=>{var x,_;if(r.preventDefault(),!I()){O.error("Please fix validation errors before submitting");return}v(!0);try{const j={rubric_id:s.id,framework_id:s.framework_id,control_id:s.control_id,assessment_period_start:t.assessmentPeriodStart,assessment_period_end:t.assessmentPeriodEnd,overall_rating:z,rating_score:F,criteria_responses:Array.from(t.criteriaResponses.values()),evidence_summary:t.evidenceSummary||void 0,findings:t.findings||void 0,recommendations:t.recommendations||void 0};let C;a?C=(await A.update(a.id,j)).data:C=(await A.create(j)).data;const Q=xe(s.id,a==null?void 0:a.id);localStorage.removeItem(Q),m(!1),O.success(a?"Assessment updated successfully":"Assessment created successfully"),h(C)}catch(j){const C=j;O.error(((_=(x=C.response)==null?void 0:x.data)==null?void 0:_.error)||"Failed to save assessment")}finally{v(!1)}},X=()=>{p&&!window.confirm("You have unsaved changes. Are you sure you want to cancel?")||g()};return e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[e.jsxs($,{className:"!p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(H,{className:"h-5 w-5 text-primary"}),a?"Edit Assessment":"New Assessment"]}),e.jsxs("p",{className:"text-sm text-slate-400 mt-1",children:[s.name," - ",s.control_id]})]}),S&&e.jsxs("div",{className:"text-xs text-slate-500",children:["Draft saved: ",S.toLocaleTimeString()]})]}),s.description&&e.jsx("p",{className:"text-sm text-slate-300 mb-4",children:s.description}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Assessment Progress"}),e.jsx(da,{completed:E,total:s.assessment_criteria.length})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("div",{children:e.jsx(Z,{label:"Assessment Period Start",type:"date",required:!0,value:t.assessmentPeriodStart,onChange:r=>{n(x=>({...x,assessmentPeriodStart:r.target.value})),m(!0)},icon:e.jsx(pe,{className:"h-4 w-4"})})}),e.jsx("div",{children:e.jsx(Z,{label:"Assessment Period End",type:"date",required:!0,value:t.assessmentPeriodEnd,onChange:r=>{n(x=>({...x,assessmentPeriodEnd:r.target.value})),m(!0)},icon:e.jsx(pe,{className:"h-4 w-4"})})})]})]}),e.jsxs($,{className:"!p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2",children:[e.jsx(ue,{className:"h-5 w-5 text-primary"}),"Assessment Criteria"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:L,children:"Expand All"}),e.jsx(N,{type:"button",variant:"ghost",size:"sm",onClick:D,children:"Collapse All"})]})]}),e.jsx("div",{className:"space-y-3",children:s.assessment_criteria.map(r=>e.jsx(oa,{criterion:r,response:t.criteriaResponses.get(r.id),ratingLevels:s.rating_scale.levels,isExpanded:i.has(r.id),onToggleExpand:()=>y(r.id),onRatingChange:x=>V(r.id,x),onNotesChange:x=>l(r.id,x)},r.id))})]}),e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(Be,{className:"h-5 w-5 text-primary"}),"Overall Rating"]}),e.jsx("div",{className:"p-4 bg-dark-bg rounded-lg border border-dark-border mb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-400",children:"Calculated Score"}),e.jsxs("p",{className:`text-3xl font-bold ${F>=80?"text-green-400":F>=50?"text-yellow-400":"text-red-400"}`,children:[F,"%"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-slate-400",children:"Suggested Rating"}),e.jsx("p",{className:`text-lg font-semibold ${((W=ee.find(r=>r.value===q))==null?void 0:W.color)||"text-slate-400"}`,children:((w=ee.find(r=>r.value===q))==null?void 0:w.label)||"N/A"})]})]})}),e.jsx("div",{className:"flex items-center gap-3 mb-4",children:e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:t.overallRatingOverride,onChange:r=>{n(x=>({...x,overallRatingOverride:r.target.checked})),m(!0)},className:"sr-only"}),e.jsx("div",{className:`w-10 h-6 rounded-full p-1 transition-colors ${t.overallRatingOverride?"bg-primary":"bg-dark-border"}`,children:e.jsx("div",{className:`w-4 h-4 rounded-full bg-white transition-transform ${t.overallRatingOverride?"translate-x-4":""}`})}),e.jsx("span",{className:"ml-2 text-sm text-slate-300",children:"Override calculated rating"})]})}),t.overallRatingOverride&&e.jsxs("div",{className:"mb-4 animate-in fade-in duration-200",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Manual Overall Rating"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:ee.map(r=>e.jsx("button",{type:"button",onClick:()=>{n(x=>({...x,overallRating:r.value})),m(!0)},className:`
                    px-4 py-2 rounded-lg border-2 transition-all text-sm font-medium
                    ${t.overallRating===r.value?`bg-dark-hover border-primary ${r.color}`:"bg-dark-surface border-dark-border text-slate-300 hover:border-slate-500"}
                  `,children:r.label},r.value))})]}),e.jsx("div",{className:"p-3 bg-primary/10 border border-primary/30 rounded-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-4 w-4 text-primary"}),e.jsxs("span",{className:"text-sm font-medium text-white",children:["Final Rating:"," ",e.jsx("span",{className:((u=ee.find(r=>r.value===z))==null?void 0:u.color)||"text-slate-400",children:((R=ee.find(r=>r.value===z))==null?void 0:R.label)||"N/A"})]})]})})]}),e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(H,{className:"h-5 w-5 text-primary"}),"Evidence & Findings"]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Evidence Summary"}),e.jsx("textarea",{value:t.evidenceSummary,onChange:r=>{n(x=>({...x,evidenceSummary:r.target.value})),m(!0)},className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-transparent resize-none",rows:4,placeholder:"Summarize the evidence collected for this assessment..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Findings"}),e.jsx("textarea",{value:t.findings,onChange:r=>{n(x=>({...x,findings:r.target.value})),m(!0)},className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-transparent resize-none",rows:4,placeholder:"Document any issues, gaps, or areas of concern identified..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"Recommendations"}),e.jsx("textarea",{value:t.recommendations,onChange:r=>{n(x=>({...x,recommendations:r.target.value})),m(!0)},className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-transparent resize-none",rows:4,placeholder:"Provide recommendations for improvement or remediation..."})]})]})]}),P.length>0&&e.jsx($,{className:"!p-4 border-red-500/30 bg-red-500/10",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(qe,{className:"h-5 w-5 text-red-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-red-300",children:"Please fix the following errors:"}),e.jsx("ul",{className:"mt-2 space-y-1",children:P.map((r,x)=>e.jsx("li",{className:"text-sm text-red-200",children:r},x))})]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-slate-400",children:p&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(te,{className:"h-4 w-4 text-yellow-400"}),"Unsaved changes"]})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(N,{type:"button",variant:"secondary",onClick:X,children:[e.jsx(ie,{className:"h-4 w-4 mr-2"}),"Cancel"]}),e.jsxs(N,{type:"submit",loading:k,loadingText:"Saving...",disabled:!p&&!!a,children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),a?"Update Assessment":"Save Assessment"]})]})]})]})},xa=({evidence:s,onDelete:a,onPreview:h,onDownload:g})=>{const[t,n]=c.useState(!1),i=v=>{switch(v){case"file":return e.jsx(H,{className:"h-5 w-5 text-blue-400"});case"link":return e.jsx(ce,{className:"h-5 w-5 text-green-400"});case"screenshot":return e.jsx(de,{className:"h-5 w-5 text-purple-400"});case"note":return e.jsx(we,{className:"h-5 w-5 text-yellow-400"});default:return e.jsx(Ge,{className:"h-5 w-5 text-slate-400"})}},o=v=>v==null?"":v<1024?`${v} B`:v<1024*1024?`${(v/1024).toFixed(1)} KB`:`${(v/(1024*1024)).toFixed(1)} MB`,p=v=>new Date(v).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),m=()=>s.evidence_type==="screenshot"?!0:s.evidence_type==="file"&&s.mime_type?s.mime_type.startsWith("image/")||s.mime_type==="application/pdf":!1,k=()=>{switch(s.evidence_type){case"link":return e.jsxs("a",{href:s.external_url||"#",target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:text-primary-dark flex items-center gap-1 text-sm break-all",children:[s.external_url,e.jsx(Ce,{className:"h-3.5 w-3.5 flex-shrink-0"})]});case"note":return e.jsxs("div",{className:"mt-2",children:[e.jsx("button",{onClick:()=>n(!t),className:"flex items-center gap-1 text-sm text-slate-400 hover:text-slate-300 transition-colors",children:t?e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"h-4 w-4"}),"Hide note"]}):e.jsxs(e.Fragment,{children:[e.jsx(ve,{className:"h-4 w-4"}),"Show note"]})}),t&&e.jsx("div",{className:"mt-2 p-3 bg-dark-bg rounded-lg border border-dark-border",children:e.jsx("p",{className:"text-sm text-slate-300 whitespace-pre-wrap",children:s.content})})]});case"file":case"screenshot":return e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mt-1",children:[s.file_size&&e.jsx("span",{children:o(s.file_size)}),s.mime_type&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-dark-border",children:"|"}),e.jsx("span",{children:s.mime_type})]})]});default:return null}};return e.jsx("div",{className:"p-4 bg-dark-surface border border-dark-border rounded-lg hover:border-dark-hover transition-colors",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 p-2 bg-dark-bg rounded-lg",children:i(s.evidence_type)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-white truncate",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-slate-400 mt-0.5 line-clamp-2",children:s.description})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[m()&&h&&e.jsx(N,{variant:"ghost",size:"sm",onClick:h,"aria-label":"Preview evidence",className:"p-1.5",children:e.jsx(de,{className:"h-4 w-4"})}),(s.evidence_type==="file"||s.evidence_type==="screenshot")&&g&&e.jsx(N,{variant:"ghost",size:"sm",onClick:g,"aria-label":"Download evidence",className:"p-1.5",children:e.jsx(fe,{className:"h-4 w-4"})}),s.evidence_type==="link"&&s.external_url&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>window.open(s.external_url,"_blank"),"aria-label":"Open link in new tab",className:"p-1.5",children:e.jsx(Ce,{className:"h-4 w-4"})}),a&&e.jsx(N,{variant:"ghost",size:"sm",onClick:a,"aria-label":"Delete evidence",className:"p-1.5 text-red-400 hover:text-red-300 hover:bg-red-500/10",children:e.jsx(Ee,{className:"h-4 w-4"})})]})]}),k(),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-slate-500 mt-2",children:[e.jsx(pe,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:p(s.created_at)})]})]})]})})},ha=({assessmentId:s,evidence:a,onDelete:h,readOnly:g=!1})=>{var V;const[t,n]=c.useState("grid"),[i,o]=c.useState(null),[p,m]=c.useState(null),[k,v]=c.useState(!1),[P,M]=c.useState(null),S=async()=>{if(p){v(!0);try{await J.delete(p.id),h(p.id),m(null)}catch(l){console.error("Failed to delete evidence:",l)}finally{v(!1)}}},B=async l=>{M(l.id);try{const y=await J.download(l.id),L=window.URL.createObjectURL(y),D=document.createElement("a");D.href=L,D.download=l.title||"evidence",document.body.appendChild(D),D.click(),window.URL.revokeObjectURL(L),document.body.removeChild(D)}catch(y){console.error("Failed to download evidence:",y)}finally{M(null)}},U=l=>{switch(l){case"file":return e.jsx(H,{className:"h-5 w-5 text-blue-400"});case"link":return e.jsx(ce,{className:"h-5 w-5 text-green-400"});case"screenshot":return e.jsx(de,{className:"h-5 w-5 text-purple-400"});case"note":return e.jsx(we,{className:"h-5 w-5 text-yellow-400"});default:return e.jsx(H,{className:"h-5 w-5 text-slate-400"})}},F=l=>l==null?"":l<1024?`${l} B`:l<1024*1024?`${(l/1024).toFixed(1)} KB`:`${(l/(1024*1024)).toFixed(1)} MB`,q=l=>{if(!i)return;const y=a.filter(I=>I.evidence_type==="screenshot"||I.evidence_type==="file"&&I.mime_type&&(I.mime_type.startsWith("image/")||I.mime_type==="application/pdf")),L=y.findIndex(I=>I.id===i.id),D=l==="prev"?(L-1+y.length)%y.length:(L+1)%y.length;o(y[D])};if(a.length===0)return e.jsxs("div",{className:"bg-dark-surface border border-dark-border rounded-lg p-8 text-center",children:[e.jsx(Ke,{className:"h-12 w-12 text-slate-500 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-medium text-slate-300 mb-1",children:"No Evidence Attached"}),e.jsx("p",{className:"text-sm text-slate-500",children:g?"No evidence has been added to this assessment.":"Upload files, add links, or paste screenshots to document your assessment."})]});const E=()=>e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(l=>{var y,L;return e.jsxs("div",{className:"bg-dark-bg border border-dark-border rounded-lg p-4 hover:border-dark-hover transition-colors",children:[(l.evidence_type==="screenshot"||l.evidence_type==="file"&&((y=l.mime_type)==null?void 0:y.startsWith("image/")))&&e.jsxs("div",{className:"aspect-video bg-dark-surface rounded-lg mb-3 flex items-center justify-center overflow-hidden cursor-pointer group relative",onClick:()=>o(l),children:[e.jsx("img",{src:`/api/compliance/evidence/${l.id}/thumbnail`,alt:l.title,className:"max-w-full max-h-full object-contain",onError:D=>{D.target.style.display="none"}}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center",children:e.jsx(Ze,{className:"h-8 w-8 text-white"})})]}),l.evidence_type==="file"&&l.mime_type==="application/pdf"&&e.jsx("div",{className:"aspect-video bg-dark-surface rounded-lg mb-3 flex items-center justify-center cursor-pointer hover:bg-dark-hover transition-colors",onClick:()=>o(l),children:e.jsx(H,{className:"h-12 w-12 text-red-400"})}),(l.evidence_type==="note"||l.evidence_type==="link"||l.evidence_type==="file"&&!((L=l.mime_type)!=null&&L.startsWith("image/"))&&l.mime_type!=="application/pdf")&&e.jsx("div",{className:"aspect-video bg-dark-surface rounded-lg mb-3 flex items-center justify-center",children:U(l.evidence_type)}),e.jsx("h4",{className:"font-medium text-white truncate mb-1",children:l.title}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-slate-500 mb-3",children:[U(l.evidence_type),e.jsx("span",{className:"capitalize",children:l.evidence_type}),l.file_size&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-dark-border",children:"|"}),e.jsx("span",{children:F(l.file_size)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[(l.evidence_type==="file"||l.evidence_type==="screenshot")&&e.jsxs(N,{variant:"secondary",size:"sm",onClick:()=>B(l),loading:P===l.id,loadingText:"",className:"flex-1",children:[e.jsx(fe,{className:"h-4 w-4 mr-1"}),"Download"]}),l.evidence_type==="link"&&e.jsxs(N,{variant:"secondary",size:"sm",onClick:()=>window.open(l.external_url,"_blank"),className:"flex-1",children:[e.jsx(ce,{className:"h-4 w-4 mr-1"}),"Open Link"]}),!g&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>m(l),className:"text-red-400 hover:text-red-300 hover:bg-red-500/10",children:e.jsx(Ee,{className:"h-4 w-4"})})]})]},l.id)})}),z=()=>e.jsx("div",{className:"space-y-3",children:a.map(l=>e.jsx(xa,{evidence:l,onDelete:g?void 0:()=>m(l),onPreview:l.evidence_type==="screenshot"||l.evidence_type==="file"&&l.mime_type&&(l.mime_type.startsWith("image/")||l.mime_type==="application/pdf")?()=>o(l):void 0,onDownload:l.evidence_type==="file"||l.evidence_type==="screenshot"?()=>B(l):void 0},l.id))});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white",children:["Evidence (",a.length,")"]}),e.jsxs("div",{className:"flex items-center gap-1 bg-dark-bg border border-dark-border rounded-lg p-1",children:[e.jsx("button",{onClick:()=>n("grid"),className:`p-2 rounded transition-colors ${t==="grid"?"bg-primary text-white":"text-slate-400 hover:text-slate-200"}`,"aria-label":"Grid view",children:e.jsx(Je,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>n("list"),className:`p-2 rounded transition-colors ${t==="list"?"bg-primary text-white":"text-slate-400 hover:text-slate-200"}`,"aria-label":"List view",children:e.jsx(Xe,{className:"h-4 w-4"})})]})]}),t==="grid"?E():z(),i&&e.jsx("div",{className:"fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4",onClick:()=>o(null),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh] w-full",onClick:l=>l.stopPropagation(),children:[e.jsx("button",{onClick:()=>o(null),className:"absolute -top-10 right-0 text-white hover:text-slate-300 p-2",children:e.jsx(ie,{className:"h-6 w-6"})}),e.jsx("button",{onClick:()=>q("prev"),className:"absolute left-0 top-1/2 -translate-y-1/2 -translate-x-12 text-white hover:text-slate-300 p-2",children:e.jsx(Ye,{className:"h-8 w-8"})}),e.jsx("button",{onClick:()=>q("next"),className:"absolute right-0 top-1/2 -translate-y-1/2 translate-x-12 text-white hover:text-slate-300 p-2",children:e.jsx(be,{className:"h-8 w-8"})}),e.jsxs("div",{className:"bg-dark-surface rounded-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-dark-border",children:[e.jsx("h4",{className:"font-medium text-white",children:i.title}),i.description&&e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:i.description})]}),e.jsx("div",{className:"p-4 max-h-[70vh] overflow-auto flex items-center justify-center bg-dark-bg",children:(V=i.mime_type)!=null&&V.startsWith("image/")||i.evidence_type==="screenshot"?e.jsx("img",{src:`/api/compliance/evidence/${i.id}/download`,alt:i.title,className:"max-w-full max-h-[60vh] object-contain"}):i.mime_type==="application/pdf"?e.jsx("iframe",{src:`/api/compliance/evidence/${i.id}/download`,className:"w-full h-[60vh]",title:i.title}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(H,{className:"h-16 w-16 text-slate-500 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-400",children:"Preview not available for this file type"})]})}),e.jsx("div",{className:"p-4 border-t border-dark-border flex justify-end gap-2",children:e.jsxs(N,{variant:"secondary",onClick:()=>B(i),loading:P===i.id,children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Download"]})})]})]})}),e.jsx(ra,{isOpen:!!p,onClose:()=>m(null),onConfirm:S,title:"Delete Evidence",message:`Are you sure you want to delete "${p==null?void 0:p.title}"? This action cannot be undone.`,confirmLabel:"Delete",cancelLabel:"Cancel",variant:"danger",loading:k})]})},pa=[{id:"file",label:"File Upload",icon:e.jsx(je,{className:"h-4 w-4"})},{id:"link",label:"Link",icon:e.jsx(ce,{className:"h-4 w-4"})},{id:"screenshot",label:"Screenshot",icon:e.jsx(de,{className:"h-4 w-4"})},{id:"note",label:"Note",icon:e.jsx(we,{className:"h-4 w-4"})}],ua=["application/pdf","image/png","image/jpeg","image/gif","image/webp","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","text/csv"],ne=[".pdf",".png",".jpg",".jpeg",".gif",".webp",".doc",".docx",".xls",".xlsx",".txt",".csv"],he=10*1024*1024,fa=({assessmentId:s,onEvidenceAdded:a})=>{const[h,g]=c.useState("file"),[t,n]=c.useState(!1),[i,o]=c.useState(0),[p,m]=c.useState(null),[k,v]=c.useState(null),[P,M]=c.useState(!1),[S,B]=c.useState(null),U=c.useRef(null),[F,q]=c.useState(""),[E,z]=c.useState(""),[V,l]=c.useState(""),[y,L]=c.useState(null),[D,I]=c.useState(""),[K,X]=c.useState(""),[W,w]=c.useState(""),u=c.useCallback(()=>{setTimeout(()=>{m(null),v(null)},5e3)},[]),R=d=>{var b;if(!ua.includes(d.type)){const f=(b=d.name.split(".").pop())==null?void 0:b.toLowerCase();if(!f||!ne.includes(`.${f}`))return`File type not allowed. Accepted types: ${ne.join(", ")}`}return d.size>he?`File size exceeds ${he/(1024*1024)}MB limit`:null},r=d=>{const b=R(d);if(b){m(b),u();return}B(d),m(null)},x=d=>{var f;const b=(f=d.target.files)==null?void 0:f[0];b&&r(b)},_=d=>{d.preventDefault(),M(!0)},j=d=>{d.preventDefault(),M(!1)},C=d=>{var f;d.preventDefault(),M(!1);const b=(f=d.dataTransfer.files)==null?void 0:f[0];b&&r(b)},Q=c.useCallback(d=>{var f;if(h!=="screenshot")return;const b=(f=d.clipboardData)==null?void 0:f.items;if(b){for(let T=0;T<b.length;T++)if(b[T].type.startsWith("image/")){const Y=b[T].getAsFile();if(Y){const G=new FileReader;G.onload=me=>{var _e;L((_e=me.target)==null?void 0:_e.result)},G.readAsDataURL(Y)}break}}},[h]);Oe.useEffect(()=>(document.addEventListener("paste",Q),()=>{document.removeEventListener("paste",Q)}),[Q]);const oe=async()=>{var d,b;if(S){n(!0),o(0),m(null);try{const f=new FormData;f.append("file",S),f.append("title",S.name),f.append("evidence_type","file");const T=setInterval(()=>{o(G=>Math.min(G+10,90))},100),Y=await J.upload(s,f);clearInterval(T),o(100),a(Y.data),B(null),v("File uploaded successfully"),u()}catch(f){m(((b=(d=f.response)==null?void 0:d.data)==null?void 0:b.error)||"Failed to upload file"),u()}finally{n(!1),o(0)}}},Le=async()=>{var d,b;if(!E.trim()||!F.trim()){m("Please provide both title and URL"),u();return}try{new URL(E)}catch{m("Please enter a valid URL"),u();return}n(!0),m(null);try{const f=await J.addLink(s,F.trim(),E.trim(),V.trim()||void 0);a(f.data),q(""),z(""),l(""),v("Link added successfully"),u()}catch(f){m(((b=(d=f.response)==null?void 0:d.data)==null?void 0:b.error)||"Failed to add link"),u()}finally{n(!1)}},Pe=async()=>{var d,b;if(!y||!D.trim()){m("Please paste a screenshot and provide a title"),u();return}n(!0),m(null);try{const T=await(await fetch(y)).blob(),Y=new File([T],`screenshot-${Date.now()}.png`,{type:"image/png"}),G=new FormData;G.append("file",Y),G.append("title",D.trim()),G.append("evidence_type","screenshot");const me=await J.upload(s,G);a(me.data),L(null),I(""),v("Screenshot uploaded successfully"),u()}catch(f){m(((b=(d=f.response)==null?void 0:d.data)==null?void 0:b.error)||"Failed to upload screenshot"),u()}finally{n(!1)}},Ie=async()=>{var d,b;if(!K.trim()||!W.trim()){m("Please provide both title and content for the note"),u();return}n(!0),m(null);try{const f=new FormData;f.append("title",K.trim()),f.append("content",W.trim()),f.append("evidence_type","note");const T=await J.upload(s,f);a(T.data),X(""),w(""),v("Note added successfully"),u()}catch(f){m(((b=(d=f.response)==null?void 0:d.data)==null?void 0:b.error)||"Failed to add note"),u()}finally{n(!1)}},Te=d=>d<1024?`${d} B`:d<1024*1024?`${(d/1024).toFixed(1)} KB`:`${(d/(1024*1024)).toFixed(1)} MB`,$e=()=>{switch(h){case"file":return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${P?"border-primary bg-primary/10":"border-dark-border hover:border-primary/50"}`,onDragOver:_,onDragLeave:j,onDrop:C,onClick:()=>{var d;return(d=U.current)==null?void 0:d.click()},children:[e.jsx("input",{ref:U,type:"file",accept:ne.join(","),onChange:x,className:"hidden"}),e.jsx(je,{className:"h-10 w-10 text-slate-500 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Drag and drop a file here, or click to browse"}),e.jsxs("p",{className:"text-sm text-slate-500",children:["Accepted types: ",ne.join(", ")]}),e.jsxs("p",{className:"text-sm text-slate-500",children:["Max size: ",he/(1024*1024),"MB"]})]}),S&&e.jsxs("div",{className:"flex items-center justify-between p-3 bg-dark-bg rounded-lg border border-dark-border",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx(je,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm text-white truncate",children:S.name}),e.jsx("p",{className:"text-xs text-slate-500",children:Te(S.size)})]})]}),e.jsx("button",{onClick:()=>B(null),className:"text-slate-500 hover:text-slate-300 p-1",children:e.jsx(ie,{className:"h-4 w-4"})})]}),t&&i>0&&e.jsx("div",{className:"w-full bg-dark-border rounded-full h-2",children:e.jsx("div",{className:"bg-primary h-2 rounded-full transition-all",style:{width:`${i}%`}})}),e.jsx(N,{onClick:oe,disabled:!S||t,loading:t,loadingText:"Uploading...",className:"w-full",children:"Upload File"})]});case"link":return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{label:"Title",placeholder:"Enter a descriptive title",value:F,onChange:d=>q(d.target.value),required:!0}),e.jsx(Z,{label:"URL",type:"url",placeholder:"https://example.com/document",value:E,onChange:d=>z(d.target.value),required:!0}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:"Description (optional)"}),e.jsx("textarea",{className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 transition-colors focus-ring hover:border-dark-hover focus:border-primary",rows:3,placeholder:"Add a brief description of the link",value:V,onChange:d=>l(d.target.value)})]}),e.jsx(N,{onClick:Le,disabled:!E.trim()||!F.trim()||t,loading:t,loadingText:"Adding...",className:"w-full",children:"Add Link"})]});case"screenshot":return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{label:"Title",placeholder:"Enter a title for this screenshot",value:D,onChange:d=>I(d.target.value),required:!0}),e.jsx("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors ${y?"border-green-500/50 bg-green-500/5":"border-dark-border"}`,children:y?e.jsxs("div",{className:"relative",children:[e.jsx("img",{src:y,alt:"Screenshot preview",className:"max-h-48 mx-auto rounded-lg"}),e.jsx("button",{onClick:()=>L(null),className:"absolute top-2 right-2 p-1 bg-dark-bg rounded-full text-slate-400 hover:text-slate-200",children:e.jsx(ie,{className:"h-4 w-4"})})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ae,{className:"h-10 w-10 text-slate-500 mx-auto mb-3"}),e.jsx("p",{className:"text-slate-300 mb-1",children:"Paste a screenshot from clipboard"}),e.jsx("p",{className:"text-sm text-slate-500",children:"Use Ctrl+V (or Cmd+V on Mac) to paste"})]})}),e.jsx(N,{onClick:Pe,disabled:!y||!D.trim()||t,loading:t,loadingText:"Uploading...",className:"w-full",children:"Upload Screenshot"})]});case"note":return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{label:"Title",placeholder:"Enter a title for this note",value:K,onChange:d=>X(d.target.value),required:!0}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:["Content ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{className:"w-full px-3 py-2 bg-dark-surface border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 transition-colors focus-ring hover:border-dark-hover focus:border-primary",rows:6,placeholder:"Enter your notes, observations, or documentation...",value:W,onChange:d=>w(d.target.value)})]}),e.jsx(N,{onClick:Ie,disabled:!K.trim()||!W.trim()||t,loading:t,loadingText:"Adding...",className:"w-full",children:"Add Note"})]});default:return null}};return e.jsxs("div",{className:"bg-dark-surface border border-dark-border rounded-lg p-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white mb-4",children:"Add Evidence"}),p&&e.jsxs("div",{className:"mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg flex items-center gap-2 text-red-400",children:[e.jsx(te,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:p})]}),k&&e.jsxs("div",{className:"mb-4 p-3 bg-green-500/10 border border-green-500/30 rounded-lg flex items-center gap-2 text-green-400",children:[e.jsx(ye,{className:"h-4 w-4 flex-shrink-0"}),e.jsx("span",{className:"text-sm",children:k})]}),e.jsx("div",{className:"flex flex-wrap gap-1 mb-4 border-b border-dark-border pb-4",children:pa.map(d=>e.jsxs("button",{onClick:()=>g(d.id),className:`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${h===d.id?"bg-primary text-white":"text-slate-400 hover:text-slate-200 hover:bg-dark-hover"}`,children:[d.icon,d.label]},d.id))}),$e()]})},ja={draft:{type:"pending",label:"Draft"},pending_review:{type:"running",label:"Pending Review"},approved:{type:"completed",label:"Approved"},rejected:{type:"failed",label:"Rejected"}},ga={compliant:{label:"Compliant",color:"text-green-400"},partial:{label:"Partially Compliant",color:"text-yellow-400"},non_compliant:{label:"Non-Compliant",color:"text-red-400"},not_applicable:{label:"Not Applicable",color:"text-slate-400"}},va=({assessment:s,rubric:a,onBack:h,onEdit:g,onSubmit:t,onApprove:n,onReject:i,isEditing:o,isSubmitting:p})=>{const m=ja[s.review_status],k=s.review_status==="draft"||s.review_status==="rejected",v=s.review_status==="draft",P=s.review_status==="pending_review";return e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(N,{variant:"ghost",onClick:h,className:"mt-1",children:e.jsx(ge,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-1",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:a.control_id}),e.jsx(se,{variant:"status",type:m.type,children:m.label})]}),e.jsx("p",{className:"text-slate-400",children:a.name}),e.jsxs("p",{className:"text-sm text-slate-500",children:[a.framework_id," - Assessment Period:"," ",new Date(s.assessment_period_start).toLocaleDateString()," to"," ",new Date(s.assessment_period_end).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!o&&k&&e.jsxs(N,{variant:"secondary",onClick:g,children:[e.jsx(De,{className:"h-4 w-4 mr-2"}),"Edit"]}),!o&&v&&e.jsxs(N,{onClick:t,loading:p,loadingText:"Submitting...",children:[e.jsx(Fe,{className:"h-4 w-4 mr-2"}),"Submit for Review"]}),!o&&P&&e.jsxs(e.Fragment,{children:[e.jsxs(N,{variant:"danger",onClick:i,loading:p,loadingText:"Rejecting...",children:[e.jsx(ke,{className:"h-4 w-4 mr-2"}),"Reject"]}),e.jsxs(N,{onClick:n,loading:p,loadingText:"Approving...",children:[e.jsx(ye,{className:"h-4 w-4 mr-2"}),"Approve"]})]})]})]})},ba=({assessment:s,rubric:a})=>{const[h,g]=c.useState(new Set),t=ga[s.overall_rating]||{label:s.overall_rating,color:"text-slate-400"},n=i=>{g(o=>{const p=new Set(o);return p.has(i)?p.delete(i):p.add(i),p})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(Qe,{className:"h-5 w-5 text-primary"}),"Assessment Summary"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"p-4 bg-dark-bg rounded-lg border border-dark-border",children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Overall Score"}),e.jsx("p",{className:`text-3xl font-bold ${s.rating_score!==null&&s.rating_score>=80?"text-green-400":s.rating_score!==null&&s.rating_score>=50?"text-yellow-400":"text-red-400"}`,children:s.rating_score!==null?`${s.rating_score}%`:"N/A"})]}),e.jsxs("div",{className:"p-4 bg-dark-bg rounded-lg border border-dark-border",children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Overall Rating"}),e.jsx("p",{className:`text-xl font-semibold ${t.color}`,children:t.label})]}),e.jsxs("div",{className:"p-4 bg-dark-bg rounded-lg border border-dark-border",children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Criteria Assessed"}),e.jsxs("p",{className:"text-xl font-semibold text-white",children:[s.criteria_responses.filter(i=>i.rating>0).length," /"," ",a.assessment_criteria.length]})]})]})]}),e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(H,{className:"h-5 w-5 text-primary"}),"Criteria Responses"]}),e.jsx("div",{className:"space-y-3",children:a.assessment_criteria.map(i=>{const o=s.criteria_responses.find(k=>k.criterion_id===i.id),p=a.rating_scale.levels.find(k=>k.value===(o==null?void 0:o.rating)),m=h.has(i.id);return e.jsxs("div",{className:"border border-dark-border rounded-lg overflow-hidden",children:[e.jsxs("div",{onClick:()=>n(i.id),className:"flex items-center justify-between p-4 cursor-pointer hover:bg-dark-hover/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[m?e.jsx(ve,{className:"h-5 w-5 text-slate-400 flex-shrink-0"}):e.jsx(be,{className:"h-5 w-5 text-slate-400 flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium text-white truncate",children:i.question})})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0 ml-3",children:[e.jsxs("span",{className:"text-xs text-slate-500 bg-dark-bg px-2 py-1 rounded",children:["Weight: ",i.weight]}),p?e.jsx(se,{variant:"status",type:o.rating>=4?"completed":o.rating>=2?"running":"failed",children:p.label}):e.jsx(se,{variant:"status",type:"pending",children:"Not Rated"})]})]}),m&&e.jsxs("div",{className:"p-4 border-t border-dark-border bg-dark-bg space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Description"}),e.jsx("p",{className:"text-sm text-slate-300",children:i.description})]}),i.guidance&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Guidance"}),e.jsx("p",{className:"text-sm text-slate-300",children:i.guidance})]}),(o==null?void 0:o.notes)&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-400 mb-1",children:"Notes"}),e.jsx("p",{className:"text-sm text-slate-300",children:o.notes})]})]})]},i.id)})})]}),s.evidence_summary&&e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(ae,{className:"h-5 w-5 text-primary"}),"Evidence Summary"]}),e.jsx("p",{className:"text-slate-300 whitespace-pre-wrap",children:s.evidence_summary})]}),s.findings&&e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(te,{className:"h-5 w-5 text-yellow-400"}),"Findings"]}),e.jsx("p",{className:"text-slate-300 whitespace-pre-wrap",children:s.findings})]}),s.recommendations&&e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(Ne,{className:"h-5 w-5 text-blue-400"}),"Recommendations"]}),e.jsx("p",{className:"text-slate-300 whitespace-pre-wrap",children:s.recommendations})]}),s.reviewer_notes&&e.jsxs($,{className:"!p-6 border-yellow-500/30 bg-yellow-500/5",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(ea,{className:"h-5 w-5 text-yellow-400"}),"Reviewer Notes"]}),e.jsx("p",{className:"text-slate-300 whitespace-pre-wrap",children:s.reviewer_notes})]})]})},Na=({assessment:s})=>{const a=[{id:"1",type:"created",timestamp:s.created_at}];s.updated_at!==s.created_at&&a.push({id:"2",type:"updated",timestamp:s.updated_at}),s.review_status==="pending_review"&&a.push({id:"3",type:"submitted",timestamp:s.updated_at}),s.review_status==="approved"&&a.push({id:"4",type:"approved",timestamp:s.updated_at}),s.review_status==="rejected"&&a.push({id:"5",type:"rejected",timestamp:s.updated_at,notes:s.reviewer_notes||void 0});const h=t=>{switch(t){case"created":return e.jsx(H,{className:"h-4 w-4 text-blue-400"});case"updated":return e.jsx(De,{className:"h-4 w-4 text-slate-400"});case"submitted":return e.jsx(Fe,{className:"h-4 w-4 text-yellow-400"});case"approved":return e.jsx(ye,{className:"h-4 w-4 text-green-400"});case"rejected":return e.jsx(ke,{className:"h-4 w-4 text-red-400"});default:return e.jsx(sa,{className:"h-4 w-4 text-slate-400"})}},g=t=>{switch(t){case"created":return"Assessment created";case"updated":return"Assessment updated";case"submitted":return"Submitted for review";case"approved":return"Assessment approved";case"rejected":return"Assessment rejected";default:return t}};return e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(aa,{className:"h-5 w-5 text-primary"}),"History"]}),e.jsx("div",{className:"space-y-4",children:a.map((t,n)=>e.jsxs("div",{className:"flex gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"p-2 bg-dark-bg border border-dark-border rounded-full",children:h(t.type)}),n<a.length-1&&e.jsx("div",{className:"flex-1 w-px bg-dark-border my-1"})]}),e.jsxs("div",{className:"flex-1 pb-4",children:[e.jsx("p",{className:"text-sm font-medium text-white",children:g(t.type)}),e.jsx("p",{className:"text-xs text-slate-500",children:new Date(t.timestamp).toLocaleString()}),t.notes&&e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:t.notes})]})]},t.id))})]})},wa=({isOpen:s,onClose:a,onConfirm:h,isSubmitting:g})=>{const[t,n]=c.useState("");if(!s)return null;const i=()=>{if(!t.trim()){O.error("Please provide a reason for rejection");return}h(t.trim())};return e.jsx("div",{className:"fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-dark-surface border border-dark-border rounded-lg w-full max-w-lg",children:[e.jsx("div",{className:"p-4 border-b border-dark-border",children:e.jsxs("h2",{className:"text-xl font-bold text-white flex items-center gap-2",children:[e.jsx(ke,{className:"h-5 w-5 text-red-400"}),"Reject Assessment"]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsx("p",{className:"text-sm text-slate-400",children:"Please provide feedback for the assessor explaining why this assessment is being rejected."}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-slate-300 mb-1",children:["Rejection Notes ",e.jsx("span",{className:"text-red-400",children:"*"})]}),e.jsx("textarea",{className:"w-full px-3 py-2 bg-dark-bg border border-dark-border rounded-lg text-slate-100 placeholder-slate-500 focus:ring-2 focus:ring-primary focus:border-transparent resize-none",rows:4,placeholder:"Explain what needs to be corrected...",value:t,onChange:o=>n(o.target.value)})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx(N,{variant:"secondary",onClick:a,className:"flex-1",children:"Cancel"}),e.jsx(N,{variant:"danger",onClick:i,loading:g,loadingText:"Rejecting...",className:"flex-1",children:"Reject Assessment"})]})]})]})})},Ta=()=>{const{assessmentId:s}=Ue(),[a]=ze(),h=Me(),[g,t]=c.useState(!0),[n,i]=c.useState(null),[o,p]=c.useState(null),[m,k]=c.useState([]),[v,P]=c.useState(a.get("edit")==="true"),[M,S]=c.useState(!1),[B,U]=c.useState(!1),[F,q]=c.useState(!1),E=s==="new",z=a.get("rubricId");c.useEffect(()=>{E&&z?V(z):s&&!E?l(s):h("/manual-assessments")},[s,z,E,h]);const V=async w=>{t(!0);try{const u=await Se.getById(w);p(u.data),P(!0)}catch{O.error("Failed to load rubric"),h("/manual-assessments")}finally{t(!1)}},l=async w=>{t(!0);try{const[u,R]=await Promise.all([A.getById(w),J.getAll(w)]);i(u.data),k(R.data);const r=await Se.getById(u.data.rubric_id);p(r.data)}catch{O.error("Failed to load assessment"),h("/manual-assessments")}finally{t(!1)}},y=w=>{i(w),P(!1),E&&h(`/manual-assessments/${w.id}`,{replace:!0}),O.success("Assessment saved successfully")},L=()=>{E?h("/manual-assessments"):P(!1)},D=async()=>{var w,u;if(n){S(!0);try{const R=await A.submit(n.id);i(R.data),O.success("Assessment submitted for review")}catch(R){const r=R;O.error(((u=(w=r.response)==null?void 0:w.data)==null?void 0:u.error)||"Failed to submit assessment")}finally{S(!1)}}},I=async()=>{var w,u;if(n){S(!0);try{const R=await A.approve(n.id);i(R.data),O.success("Assessment approved")}catch(R){const r=R;O.error(((u=(w=r.response)==null?void 0:w.data)==null?void 0:u.error)||"Failed to approve assessment")}finally{S(!1)}}},K=async w=>{var u,R;if(n){S(!0);try{const r=await A.reject(n.id,w);i(r.data),U(!1),O.success("Assessment rejected")}catch(r){const x=r;O.error(((R=(u=x.response)==null?void 0:u.data)==null?void 0:R.error)||"Failed to reject assessment")}finally{S(!1)}}},X=w=>{k(u=>[...u,w])},W=w=>{k(u=>u.filter(R=>R.id!==w))};return g?e.jsx(re,{children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ta,{})})}):o?E||v&&o?e.jsx(re,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(N,{variant:"ghost",onClick:L,children:e.jsx(ge,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:E?"New Assessment":"Edit Assessment"}),e.jsxs("p",{className:"text-slate-400",children:[o.framework_id," - ",o.control_id]})]})]}),e.jsx(ma,{rubric:o,existingAssessment:E?void 0:n||void 0,onSubmit:y,onCancel:L})]})}):e.jsxs(re,{children:[e.jsxs("div",{className:"space-y-6",children:[n&&e.jsx(va,{assessment:n,rubric:o,onBack:()=>h("/manual-assessments"),onEdit:()=>P(!0),onSubmit:D,onApprove:I,onReject:()=>U(!0),isEditing:v,isSubmitting:M}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:n&&e.jsx(ba,{assessment:n,rubric:o})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs($,{className:"!p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-primary"}),"Evidence"]}),(n==null?void 0:n.review_status)==="draft"&&e.jsx(N,{variant:"ghost",size:"sm",onClick:()=>q(!F),children:F?"Hide Uploader":"Add Evidence"})]}),F&&n&&e.jsx("div",{className:"mb-4",children:e.jsx(fa,{assessmentId:n.id,onEvidenceAdded:X})}),n&&e.jsx(ha,{assessmentId:n.id,evidence:m,onDelete:W,readOnly:n.review_status!=="draft"})]}),n&&e.jsx(Na,{assessment:n}),e.jsxs($,{className:"!p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white flex items-center gap-2 mb-4",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Details"]}),e.jsxs("dl",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-slate-400",children:"Framework"}),e.jsx("dd",{className:"text-white font-medium",children:o.framework_id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-slate-400",children:"Control"}),e.jsx("dd",{className:"text-white font-medium",children:o.control_id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-slate-400",children:"Rating Scale"}),e.jsx("dd",{className:"text-white font-medium capitalize",children:o.rating_scale.scale_type.replace("_"," ")})]}),n&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-slate-400",children:"Created"}),e.jsx("dd",{className:"text-white",children:new Date(n.created_at).toLocaleDateString()})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-slate-400",children:"Last Updated"}),e.jsx("dd",{className:"text-white",children:new Date(n.updated_at).toLocaleDateString()})]})]})]})]})]})]})]}),e.jsx(wa,{isOpen:B,onClose:()=>U(!1),onConfirm:K,isSubmitting:M})]}):e.jsx(re,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(te,{className:"h-12 w-12 text-red-400 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-white mb-2",children:"Assessment Not Found"}),e.jsx("p",{className:"text-slate-400 mb-4",children:"The requested assessment could not be loaded."}),e.jsxs(N,{onClick:()=>h("/manual-assessments"),children:[e.jsx(ge,{className:"h-4 w-4 mr-2"}),"Back to Assessments"]})]})})};export{Ta as default};
