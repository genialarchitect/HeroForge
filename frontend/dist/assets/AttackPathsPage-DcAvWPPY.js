import{j as e}from"./vendor-state-BjT_zREg.js";import{i as K,u as X,r as c}from"./vendor-react-5KxtEOLM.js";import{B as z,af as C,v as B,_ as M,O as D,A as J,a9 as Q,b6 as I,Z as ee,S as F,a2 as G}from"./vendor-ui-C4nf_tR6.js";import{L as R}from"./Layout-DQwy8A8G.js";import{u as se,E as te}from"./useRequireEngagement-BnpzaIEh.js";import{b as V,Z as O,B as b}from"./index-RI0GBk2h.js";import{C as o}from"./Card-CV6m9jT5.js";import{L as E}from"./LoadingSpinner-CV5u9ki8.js";import{B as Z}from"./Badge-Bi3Nk-Vg.js";import"./vendor-markdown-BGP8SuZQ.js";import"./vendor-utils-DfRopTPV.js";const ae=({nodes:a,edges:h,onNodeClick:j})=>{const v=c.useMemo(()=>{if(a.length===0)return[];const s=a.filter(l=>l.node_type==="entry"),r=a.filter(l=>l.node_type==="pivot"),n=a.filter(l=>l.node_type==="target"),m=60,p=(800-m*2)/3;return a.map(l=>{let i=m,u=0,d=1,N=0;return l.node_type==="entry"?(i=m,d=s.length,N=s.indexOf(l)):l.node_type==="pivot"?(i=m+p,d=r.length,N=r.indexOf(l)):(i=m+p*2,d=n.length,N=n.indexOf(l)),u=d>1?(N-(d-1)/2)*80:0,{...l,x:l.position_x!==0?l.position_x+m:i,y:l.position_y!==0?l.position_y+200:200+u}})},[a]),g=s=>{switch(s){case"entry":return"#22c55e";case"target":return"#ef4444";case"pivot":default:return"#f59e0b"}},k=s=>v.find(r=>r.id===s);return e.jsxs("svg",{viewBox:"0 0 800 400",className:"w-full h-full",style:{minHeight:"300px"},children:[e.jsx("defs",{children:e.jsx("marker",{id:"arrowhead",markerWidth:"10",markerHeight:"7",refX:"9",refY:"3.5",orient:"auto",children:e.jsx("polygon",{points:"0 0, 10 3.5, 0 7",fill:"#64748b"})})}),h.map(s=>{const r=k(s.source_node_id),n=k(s.target_node_id);return!r||!n?null:e.jsxs("g",{children:[e.jsx("line",{x1:r.x+30,y1:r.y,x2:n.x-30,y2:n.y,stroke:"#64748b",strokeWidth:"2",markerEnd:"url(#arrowhead)"}),s.attack_technique&&e.jsx("text",{x:(r.x+n.x)/2,y:(r.y+n.y)/2-10,fill:"#94a3b8",fontSize:"10",textAnchor:"middle",children:s.technique_id||s.attack_technique.slice(0,20)})]},s.id)}),v.map(s=>{var r;return e.jsxs("g",{className:"cursor-pointer",onClick:()=>j==null?void 0:j(s),children:[e.jsx("circle",{cx:s.x,cy:s.y,r:30,fill:g(s.node_type),fillOpacity:"0.2",stroke:g(s.node_type),strokeWidth:"2"}),e.jsx("text",{x:s.x,y:s.y-5,fill:"white",fontSize:"11",textAnchor:"middle",fontWeight:"bold",children:s.service||((r=s.host_ip)==null?void 0:r.split(".").slice(-1)[0])||"?"}),e.jsx("text",{x:s.x,y:s.y+10,fill:"#94a3b8",fontSize:"9",textAnchor:"middle",children:s.port?`:${s.port}`:s.node_type}),s.vulnerability_ids.length>0&&e.jsx("circle",{cx:s.x+30-5,cy:s.y-30+5,r:"10",fill:"#ef4444"}),s.vulnerability_ids.length>0&&e.jsx("text",{x:s.x+30-5,y:s.y-30+9,fill:"white",fontSize:"9",textAnchor:"middle",children:s.vulnerability_ids.length})]},s.id)}),e.jsxs("g",{transform:"translate(680, 20)",children:[e.jsx("circle",{cx:"10",cy:"10",r:"8",fill:"#22c55e",fillOpacity:"0.3",stroke:"#22c55e"}),e.jsx("text",{x:"25",y:"14",fill:"#94a3b8",fontSize:"10",children:"Entry"}),e.jsx("circle",{cx:"10",cy:"30",r:"8",fill:"#f59e0b",fillOpacity:"0.3",stroke:"#f59e0b"}),e.jsx("text",{x:"25",y:"34",fill:"#94a3b8",fontSize:"10",children:"Pivot"}),e.jsx("circle",{cx:"10",cy:"50",r:"8",fill:"#ef4444",fillOpacity:"0.3",stroke:"#ef4444"}),e.jsx("text",{x:"25",y:"54",fill:"#94a3b8",fontSize:"10",children:"Target"})]})]})},U=({level:a})=>{const h={critical:"critical",high:"high",medium:"medium",low:"low"};return e.jsx(Z,{type:h[a],children:a.toUpperCase()})},le=({path:a,isSelected:h,onClick:j})=>e.jsxs("div",{className:`p-4 rounded-lg border cursor-pointer transition-all ${h?"border-primary bg-primary/10":"border-dark-border bg-dark-card hover:border-slate-600"}`,onClick:j,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-4 w-4 text-slate-400"}),e.jsx("span",{className:"text-white font-medium",children:a.name||`Path ${a.id.slice(0,8)}`})]}),e.jsx(U,{level:a.risk_level})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"Length:"})," ",e.jsxs("span",{className:"text-white",children:[a.path_length," nodes"]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"CVSS:"})," ",e.jsx("span",{className:"text-white",children:a.total_cvss.toFixed(1)})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"Probability:"})," ",e.jsxs("span",{className:"text-white",children:[(a.probability*100).toFixed(0),"%"]})]})]})]}),ge=()=>{var q;const{scanId:a}=K(),h=X(),{hasEngagement:j}=se(),[L,w]=c.useState(!0),[y,v]=c.useState(!1),[g,k]=c.useState(null),[s,r]=c.useState([]),[n,m]=c.useState([]),[p,l]=c.useState(null),[i,u]=c.useState(null),[d,N]=c.useState(null),[A,Y]=c.useState(!1),[S,T]=c.useState(!1),H=c.useCallback(async()=>{if(w(!0),!a){try{const x=((await V.getAll()).data||[]).filter(_=>_.status==="completed");r(x)}catch(t){z.error("Failed to load scans"),console.error(t)}finally{w(!1)}return}try{const t=await V.getById(a);k(t.data);try{const x=await O.getByScan(a);m(x.data.paths),l(x.data.stats),T(x.data.paths.length>0),x.data.paths.length>0&&u(x.data.paths[0])}catch{m([]),l(null),T(!1)}}catch(t){z.error("Failed to load scan data"),console.error(t)}finally{w(!1)}},[a]);c.useEffect(()=>{H()},[H]);const W=async(t=!1)=>{var x,_;if(a){v(!0);try{const P=await O.analyze(a,{force:t});z.success(P.data.message);const f=await O.getByScan(a);m(f.data.paths),l(f.data.stats),T(!0),f.data.paths.length>0&&u(f.data.paths[0])}catch(P){const f=P;z.error(((_=(x=f.response)==null?void 0:x.data)==null?void 0:_.error)||"Analysis failed"),console.error(P)}finally{v(!1)}}},$=c.useMemo(()=>A?n.filter(t=>t.risk_level==="critical"||t.risk_level==="high"):n,[n,A]);return L?e.jsx(R,{children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(E,{})})}):a?g?e.jsx(R,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(b,{variant:"secondary",onClick:()=>h(`/dashboard/${a}`),children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Back to Scan"]}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-white flex items-center gap-2",children:[e.jsx(C,{className:"h-6 w-6 text-primary"}),"Attack Path Analysis"]}),e.jsxs("p",{className:"text-slate-400",children:["Scan: ",g.name]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[S&&e.jsx(b,{variant:"secondary",onClick:()=>Y(!A),children:A?"Show All":"Critical Only"}),e.jsx(b,{onClick:()=>W(S),disabled:y||g.status!=="completed"||!j,children:y?e.jsxs(e.Fragment,{children:[e.jsx(E,{}),e.jsx("span",{className:"ml-2",children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),S?"Re-analyze":"Analyze"]})})]})]}),p&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-5 gap-4",children:[e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-500/20 rounded-lg",children:e.jsx(I,{className:"h-5 w-5 text-blue-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:p.total_paths}),e.jsx("p",{className:"text-xs text-slate-400",children:"Total Paths"})]})]})}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-500/20 rounded-lg",children:e.jsx(D,{className:"h-5 w-5 text-red-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:p.critical_paths}),e.jsx("p",{className:"text-xs text-slate-400",children:"Critical Paths"})]})]})}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-orange-500/20 rounded-lg",children:e.jsx(ee,{className:"h-5 w-5 text-orange-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:p.high_paths}),e.jsx("p",{className:"text-xs text-slate-400",children:"High Risk Paths"})]})]})}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-500/20 rounded-lg",children:e.jsx(B,{className:"h-5 w-5 text-purple-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:p.total_nodes}),e.jsx("p",{className:"text-xs text-slate-400",children:"Total Nodes"})]})]})}),e.jsx(o,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-500/20 rounded-lg",children:e.jsx(F,{className:"h-5 w-5 text-green-400"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold text-white",children:((q=p.avg_path_length)==null?void 0:q.toFixed(1))||"N/A"}),e.jsx("p",{className:"text-xs text-slate-400",children:"Avg Path Length"})]})]})})]}),S?n.length===0?e.jsxs(o,{className:"p-8 text-center",children:[e.jsx(F,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"No Attack Paths Found"}),e.jsx("p",{className:"text-slate-400 max-w-md mx-auto",children:"The analysis did not identify any significant attack paths. This could mean the network is well-segmented or there are no vulnerable services that could be chained together."})]}):e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 space-y-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-3",children:["Attack Paths (",$.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[600px] overflow-y-auto pr-2",children:$.map(t=>e.jsx(le,{path:t,isSelected:(i==null?void 0:i.id)===t.id,onClick:()=>{u(t),N(null)}},t.id))})]}),e.jsx("div",{className:"lg:col-span-2",children:i?e.jsxs(o,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:i.name||`Path ${i.id.slice(0,8)}`}),e.jsx(U,{level:i.risk_level})]}),e.jsx("div",{className:"bg-dark-bg rounded-lg border border-dark-border p-4 mb-4",children:e.jsx(ae,{nodes:i.nodes,edges:i.edges,onNodeClick:N})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{className:"bg-dark-bg rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Path Length"}),e.jsxs("p",{className:"text-lg font-semibold text-white",children:[i.path_length," nodes"]})]}),e.jsxs("div",{className:"bg-dark-bg rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Total CVSS"}),e.jsx("p",{className:"text-lg font-semibold text-white",children:i.total_cvss.toFixed(1)})]}),e.jsxs("div",{className:"bg-dark-bg rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Probability"}),e.jsxs("p",{className:"text-lg font-semibold text-white",children:[(i.probability*100).toFixed(0),"%"]})]}),e.jsxs("div",{className:"bg-dark-bg rounded-lg p-3",children:[e.jsx("p",{className:"text-xs text-slate-400 mb-1",children:"Nodes"}),e.jsx("p",{className:"text-lg font-semibold text-white",children:i.nodes.length})]})]}),d&&e.jsxs("div",{className:"bg-dark-bg rounded-lg p-4 mb-4 border border-dark-border",children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-2 flex items-center gap-2",children:[e.jsx(G,{className:"h-4 w-4"}),"Node Details"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"IP:"})," ",e.jsx("span",{className:"text-white",children:d.host_ip||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"Port:"})," ",e.jsx("span",{className:"text-white",children:d.port||"N/A"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"Service:"})," ",e.jsx("span",{className:"text-white",children:d.service||"Unknown"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-slate-400",children:"Type:"})," ",e.jsx("span",{className:"text-white capitalize",children:d.node_type})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-slate-400",children:"Vulnerabilities:"})," ",e.jsx("span",{className:"text-white",children:d.vulnerability_ids.length>0?d.vulnerability_ids.join(", "):"None"})]})]})]}),i.mitigation_steps.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-semibold text-white mb-2 flex items-center gap-2",children:[e.jsx(F,{className:"h-4 w-4 text-green-400"}),"Recommended Mitigations"]}),e.jsx("ul",{className:"space-y-2",children:i.mitigation_steps.map((t,x)=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-slate-300",children:[e.jsx(M,{className:"h-4 w-4 text-primary mt-0.5 flex-shrink-0"}),t]},x))})]})]}):e.jsx(o,{className:"p-8 text-center",children:e.jsx("p",{className:"text-slate-400",children:"Select an attack path from the list to view details"})})})]}):e.jsxs(o,{className:"p-8 text-center",children:[e.jsx(C,{className:"h-16 w-16 text-slate-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"No Attack Paths Analyzed"}),e.jsx("p",{className:"text-slate-400 mb-6 max-w-md mx-auto",children:'Click the "Analyze" button to identify potential attack paths in your scan results. The analysis will build a graph of hosts and vulnerabilities to find possible attack chains.'}),g.status!=="completed"&&e.jsx("p",{className:"text-yellow-500 text-sm mb-4",children:"Note: The scan must be completed before analysis."}),e.jsx(b,{onClick:()=>W(!1),disabled:y||g.status!=="completed"||!j,className:"mx-auto",children:y?e.jsxs(e.Fragment,{children:[e.jsx(E,{}),e.jsx("span",{className:"ml-2",children:"Analyzing..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"h-4 w-4 mr-2"}),"Analyze Attack Paths"]})})]}),e.jsx(o,{className:"bg-blue-500/10 border-blue-500/30",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsx(G,{className:"h-6 w-6 text-blue-400 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-blue-400 mb-2",children:"About Attack Path Analysis"}),e.jsx("p",{className:"text-sm text-slate-300 mb-2",children:"Attack path analysis identifies potential chains of vulnerabilities and misconfigurations that an attacker could exploit to move through your network. The analysis:"}),e.jsxs("ul",{className:"text-sm text-slate-300 space-y-1 list-disc list-inside ml-4",children:[e.jsx("li",{children:"Builds a graph from discovered hosts, services, and vulnerabilities"}),e.jsx("li",{children:"Identifies entry points, pivot points, and target systems"}),e.jsx("li",{children:"Calculates risk scores based on CVSS, exploitability, and impact"}),e.jsx("li",{children:"Maps techniques to MITRE ATT&CK framework where applicable"}),e.jsx("li",{children:"Provides prioritized mitigation recommendations"})]})]})]})})]})}):e.jsx(R,{children:e.jsxs("div",{className:"text-center py-12",children:[e.jsx(D,{className:"h-12 w-12 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"Scan Not Found"}),e.jsx("p",{className:"text-slate-400 mb-4",children:"The requested scan could not be found."}),e.jsx(b,{onClick:()=>h("/dashboard"),children:"Go to Dashboard"})]})}):e.jsx(R,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-white flex items-center gap-2",children:[e.jsx(C,{className:"h-6 w-6 text-primary"}),"Attack Path Analysis"]}),e.jsx("p",{className:"text-slate-400 mt-1",children:"Select a completed scan to analyze attack paths"})]}),e.jsx(te,{toolName:"Attack Path Analysis",className:"mb-6"}),s.length===0?e.jsxs(o,{className:"p-8 text-center",children:[e.jsx(C,{className:"h-16 w-16 text-slate-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-bold text-white mb-2",children:"No Completed Scans Available"}),e.jsx("p",{className:"text-slate-400 mb-6 max-w-md mx-auto",children:"You need to complete a network scan first before you can analyze attack paths. Run a scan with vulnerability detection enabled to get started."}),e.jsxs(b,{onClick:()=>h("/scan"),children:[e.jsx(B,{className:"h-4 w-4 mr-2"}),"Start New Scan"]})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(t=>e.jsxs(o,{className:"cursor-pointer hover:border-primary transition-all",onClick:()=>h(`/attack-paths/${t.id}`),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-medium text-white",children:t.name})]}),e.jsx(Z,{type:t.status==="completed"?"low":"medium",children:t.status})]}),e.jsxs("div",{className:"text-sm text-slate-400 space-y-1",children:[e.jsxs("p",{children:["Targets: ",t.targets||"N/A"]}),e.jsxs("p",{children:["Created: ",new Date(t.created_at).toLocaleDateString()]}),t.total_hosts!==void 0&&e.jsxs("p",{children:["Hosts: ",t.total_hosts]})]}),e.jsxs("div",{className:"mt-3 flex items-center text-primary text-sm",children:[e.jsx("span",{children:"Analyze Attack Paths"}),e.jsx(M,{className:"h-4 w-4 ml-1"})]})]},t.id))})]})})};export{ge as default};
