import{j as e}from"./vendor-state-BjT_zREg.js";import{r as t}from"./vendor-react-5KxtEOLM.js";import{L as Ge}from"./Layout-KYMPsh8G.js";import{B as o,L as se,a_ as Ke,k as Qe,d as Xe,X as Ye,aM as Ue,ab as es,f as ss,l as ts,h as be,bB as _e,$ as as,au as he,g as rs,O as ls,C as is,bC as ns,bD as ds}from"./vendor-ui-CaTPr3iI.js";import{n as os,m as k,A as te,B as cs,O as xs,P as ms,Q as V,z as us,b as gs}from"./index-BwCSAD78.js";import{L as Ce}from"./LoadingSpinner-DiN0bg1Z.js";import{W as bs,a as hs}from"./WorkflowHistory-BlM6L7ok.js";import"./vendor-markdown-BGP8SuZQ.js";import"./vendor-utils-DfRopTPV.js";const fs=({scanId:h,onVulnerabilityClick:S})=>{const[a,p]=t.useState([]),[n,D]=t.useState(!0),[y,$]=t.useState(null),[u,j]=t.useState(!1),[m,_]=t.useState(new Set),[T,B]=t.useState([]),[b,f]=t.useState(!1),[P,A]=t.useState(!1),[g,v]=t.useState(""),[c,E]=t.useState(""),G=[{id:"open",title:"Open",color:"bg-red-900/20 border-red-700"},{id:"in_progress",title:"In Progress",color:"bg-yellow-900/20 border-yellow-700"},{id:"pending_verification",title:"Pending Verification",color:"bg-blue-900/20 border-blue-700"},{id:"resolved",title:"Resolved",color:"bg-green-900/20 border-green-700"}];t.useEffect(()=>{L(),X()},[h]);const X=async()=>{try{const l=await os.getUsers();B(l.data)}catch(l){console.debug("Could not load users list:",l)}},L=async()=>{try{if(D(!0),!h){p([]);return}const l=await k.list({scan_id:h});p(l.data)}catch(l){console.error("Failed to load vulnerabilities:",l)}finally{D(!1)}},K=(l,i)=>{$(i),l.dataTransfer.effectAllowed="move"},M=l=>{l.preventDefault(),l.dataTransfer.dropEffect="move"},Q=async(l,i)=>{if(l.preventDefault(),!(!y||y.status===i||u))try{j(!0),await k.update(y.id,{status:i}),await L(),$(null)}catch(R){console.error("Failed to update vulnerability status:",R)}finally{j(!1)}},x=()=>{$(null)},N=(l,i)=>{i.stopPropagation();const R=new Set(m);R.has(l)?R.delete(l):R.add(l),_(R)},w=async l=>{if(m.size!==0)try{j(!0),await k.bulkUpdate({vulnerability_ids:Array.from(m),status:l}),o.success(`Updated ${m.size} vulnerabilities to ${l.replace(/_/g," ")}`),_(new Set),await L()}catch(i){console.error("Failed to bulk update status:",i),o.error("Failed to update vulnerabilities")}finally{j(!1)}},C=async()=>{if(m.size!==0)try{j(!0),await k.bulkUpdate({vulnerability_ids:Array.from(m),assignee_id:g||void 0}),o.success(`Assigned ${m.size} vulnerabilities`),_(new Set),f(!1),v(""),await L()}catch(l){console.error("Failed to bulk assign:",l),o.error("Failed to assign vulnerabilities")}finally{j(!1)}},F=async()=>{if(!(m.size===0||!c))try{j(!0),await k.bulkUpdate({vulnerability_ids:Array.from(m),due_date:`${c}T00:00:00Z`}),o.success(`Updated due date for ${m.size} vulnerabilities`),_(new Set),A(!1),E(""),await L()}catch(l){console.error("Failed to bulk update due date:",l),o.error("Failed to update due dates")}finally{j(!1)}},z=()=>{_(new Set)},I=l=>a.filter(i=>i.status===l),Y=l=>{switch(l.toLowerCase()){case"critical":return"border-l-4 border-red-500";case"high":return"border-l-4 border-orange-500";case"medium":return"border-l-4 border-yellow-500";case"low":return"border-l-4 border-blue-500";default:return"border-l-4 border-gray-500"}},U=l=>{if(!l)return null;const i={critical:"bg-red-600 text-white",high:"bg-orange-600 text-white",medium:"bg-yellow-600 text-white",low:"bg-blue-600 text-white"};return e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${i[l.toLowerCase()]||"bg-gray-600 text-white"}`,children:l.charAt(0).toUpperCase()})};return n?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):h?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Remediation Board"}),e.jsxs("div",{className:"flex gap-2",children:[m.size>0&&e.jsxs("span",{className:"px-3 py-1 text-sm bg-blue-600 text-white rounded",children:[m.size," selected"]}),e.jsx("button",{onClick:L,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600",children:"Refresh"})]})]}),m.size>0&&e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"text-gray-400 text-sm mr-2",children:"Bulk Actions:"}),e.jsx("button",{onClick:()=>w("in_progress"),disabled:u,className:"px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:bg-gray-600",children:"Mark In Progress"}),e.jsx("button",{onClick:()=>w("pending_verification"),disabled:u,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-600",children:"Mark Pending Verification"}),e.jsx("button",{onClick:()=>w("resolved"),disabled:u,className:"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-600",children:"Mark Resolved"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:()=>f(!0),disabled:u,className:"px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 disabled:bg-gray-600",children:"Assign"}),e.jsx("button",{onClick:()=>A(!0),disabled:u,className:"px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-gray-600",children:"Set Due Date"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:z,className:"px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-500",children:"Clear Selection"})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:G.map(l=>e.jsxs("div",{className:`rounded-lg border-2 ${l.color} p-4 min-h-[400px] transition-colors ${y&&y.status!==l.id?"ring-2 ring-blue-500/50":""}`,onDragOver:M,onDrop:i=>Q(i,l.id),children:[e.jsxs("h3",{className:"font-semibold text-lg mb-4 text-white flex justify-between items-center",children:[e.jsx("span",{children:l.title}),e.jsx("span",{className:"text-sm font-normal text-gray-400 bg-gray-800 px-2 py-0.5 rounded",children:I(l.id).length})]}),e.jsxs("div",{className:"space-y-2",children:[I(l.id).map(i=>e.jsxs("div",{draggable:!u&&!m.has(i.id),onDragStart:R=>K(R,i),onDragEnd:x,onClick:()=>S==null?void 0:S(i.id),className:`bg-gray-800 p-3 rounded shadow cursor-move hover:shadow-lg hover:bg-gray-750 transition-all ${Y(i.severity)} ${(y==null?void 0:y.id)===i.id?"opacity-50":""} ${u?"cursor-not-allowed":""} ${m.has(i.id)?"ring-2 ring-blue-500":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("input",{type:"checkbox",checked:m.has(i.id),onClick:R=>N(i.id,R),onChange:()=>{},className:"rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700"}),e.jsx("div",{className:"font-medium text-sm text-white truncate",children:i.vulnerability_id})]}),U(i.priority)]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1 ml-6",children:i.host_ip}),i.port&&e.jsxs("div",{className:"text-xs text-gray-500 ml-6",children:["Port: ",i.port]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 ml-6",children:[e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${i.severity==="critical"?"bg-red-900/50 text-red-300":i.severity==="high"?"bg-orange-900/50 text-orange-300":i.severity==="medium"?"bg-yellow-900/50 text-yellow-300":"bg-blue-900/50 text-blue-300"}`,children:i.severity}),i.assignee_id&&e.jsx("span",{className:"text-xs text-gray-500",children:"Assigned"})]}),i.due_date&&e.jsxs("div",{className:`text-xs mt-1 ml-6 ${new Date(i.due_date)<new Date?"text-red-400":"text-gray-500"}`,children:["Due: ",new Date(i.due_date).toLocaleDateString()]}),i.estimated_effort&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 ml-6",children:["Est: ",i.estimated_effort,"h",i.actual_effort?` / Actual: ${i.actual_effort}h`:""]})]},i.id)),I(l.id).length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 text-sm",children:"No vulnerabilities"})]})]},l.id))}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-400 pt-4 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"Critical"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"High"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded"}),e.jsx("span",{children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded"}),e.jsx("span",{children:"Low"})]})]}),b&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Assign ",m.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Select Assignee"}),e.jsxs("select",{value:g,onChange:l=>v(l.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),T.map(l=>e.jsxs("option",{value:l.id,children:[l.username," (",l.email,")"]},l.id))]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{f(!1),v("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:u,children:"Cancel"}),e.jsx("button",{onClick:C,disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:u?"Assigning...":"Assign"})]})]})}),P&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Set Due Date for ",m.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Due Date"}),e.jsx("input",{type:"date",value:c,onChange:l=>E(l.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",min:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{A(!1),E("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:u,children:"Cancel"}),e.jsx("button",{onClick:F,disabled:u||!c,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:u?"Updating...":"Set Due Date"})]})]})})]}):e.jsx("div",{className:"text-center py-12 text-gray-400",children:"Select a scan to view the remediation board"})},ys=({vulnerabilityId:h,currentUserId:S,onCommentsChange:a,initialComments:p})=>{const[n,D]=t.useState(p||[]),[y,$]=t.useState(!p),[u,j]=t.useState(""),[m,_]=t.useState(!1),[T,B]=t.useState(null),[b,f]=t.useState(null),[P,A]=t.useState(""),[g,v]=t.useState(!1),c=t.useCallback(async()=>{try{$(!0);const x=await k.getComments(h);D(x.data)}catch(x){console.error("Failed to load comments:",x),o.error("Failed to load comments")}finally{$(!1)}},[h]);t.useEffect(()=>{p||c()},[c,p]),t.useEffect(()=>{p&&D(p)},[p]);const E=async x=>{if(x.preventDefault(),!!u.trim())try{_(!0),await k.addComment(h,u.trim()),j(""),o.success("Comment added"),await c(),a==null||a()}catch(N){console.error("Failed to add comment:",N),o.error("Failed to add comment")}finally{_(!1)}},G=async x=>{var N,w;try{B(x),await k.deleteComment(h,x),o.success("Comment deleted"),await c(),a==null||a()}catch(C){console.error("Failed to delete comment:",C);const F=C;o.error(((w=(N=F.response)==null?void 0:N.data)==null?void 0:w.error)||"Failed to delete comment")}finally{B(null)}},X=x=>{f(x.id),A(x.comment)},L=()=>{f(null),A("")},K=async x=>{var N,w;if(!P.trim()){o.error("Comment cannot be empty");return}try{v(!0),await k.updateComment(h,x,P.trim()),o.success("Comment updated"),f(null),A(""),await c(),a==null||a()}catch(C){console.error("Failed to update comment:",C);const F=C;o.error(((w=(N=F.response)==null?void 0:N.data)==null?void 0:w.error)||"Failed to update comment")}finally{v(!1)}},M=x=>new Date(x).toLocaleString(),Q=x=>{const N=new Date(x),C=new Date().getTime()-N.getTime(),F=Math.floor(C/6e4),z=Math.floor(F/60),I=Math.floor(z/24);return F<1?"just now":F<60?`${F}m ago`:z<24?`${z}h ago`:I<7?`${I}d ago`:N.toLocaleDateString()};return y?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(se,{className:"h-6 w-6 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-gray-400",children:"Loading comments..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("form",{onSubmit:E,className:"space-y-3",children:e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:u,onChange:x=>j(x.target.value),rows:3,className:"block w-full rounded-lg bg-gray-800 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none pr-12",placeholder:"Add a comment...",disabled:m}),e.jsx("button",{type:"submit",disabled:m||!u.trim(),className:"absolute bottom-3 right-3 p-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",title:"Send comment",children:m?e.jsx(se,{className:"h-4 w-4 animate-spin"}):e.jsx(Ke,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"space-y-3",children:n.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Qe,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No comments yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Be the first to add a comment"})]}):n.map(x=>{const N=S===x.user_id,w=T===x.id,C=b===x.id;return e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-sm font-semibold",children:x.username.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:x.username}),e.jsxs("div",{className:"text-xs text-gray-500",title:M(x.created_at),children:[Q(x.created_at),x.updated_at&&e.jsx("span",{className:"ml-1 text-gray-600",title:`Edited: ${M(x.updated_at)}`,children:"(edited)"})]})]})]}),C?e.jsxs("div",{className:"mt-2",children:[e.jsx("textarea",{value:P,onChange:F=>A(F.target.value),rows:3,className:"block w-full rounded-lg bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none",disabled:g,autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("button",{onClick:()=>K(x.id),disabled:g||!P.trim(),className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-cyan-600 text-white text-sm hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",children:[g?e.jsx(se,{className:"h-3 w-3 animate-spin"}):e.jsx(Xe,{className:"h-3 w-3"}),"Save"]}),e.jsxs("button",{onClick:L,disabled:g,className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-gray-600 text-gray-300 text-sm hover:bg-gray-500 disabled:opacity-50 transition-colors",children:[e.jsx(Ye,{className:"h-3 w-3"}),"Cancel"]})]})]}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap break-words",children:x.comment})]}),N&&!C&&e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>X(x),disabled:w,className:"p-2 rounded-lg text-gray-500 hover:text-cyan-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Edit comment",children:e.jsx(Ue,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>G(x.id),disabled:w,className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Delete comment",children:w?e.jsx(se,{className:"h-4 w-4 animate-spin"}):e.jsx(es,{className:"h-4 w-4"})})]})]})},x.id)})}),n.length>0&&e.jsxs("div",{className:"text-sm text-gray-500 text-center pt-2",children:[n.length," ",n.length===1?"comment":"comments"]})]})},ps=({vulnerabilityId:h,onTicketCreated:S})=>{const[a,p]=t.useState(!1),[n,D]=t.useState(!1),[y,$]=t.useState([]),[u,j]=t.useState(!1),[m,_]=t.useState(null),T=t.useRef(null);t.useEffect(()=>{B(),b()},[h]),t.useEffect(()=>{const g=v=>{T.current&&!T.current.contains(v.target)&&p(!1)};return document.addEventListener("mousedown",g),()=>document.removeEventListener("mousedown",g)},[]);const B=async()=>{var g;try{await te.getSettings(),_(!0)}catch(v){((g=v.response)==null?void 0:g.status)===404&&_(!1)}},b=async()=>{j(!0);try{const g=await te.getTicketsForVulnerability(h);$(g.data)}catch(g){console.error("Failed to load ServiceNow tickets:",g)}finally{j(!1)}},f=async()=>{var g,v;if(!m){o.error("ServiceNow is not configured. Please configure it in Settings."),p(!1);return}D(!0);try{const c=await te.createIncident(h);o.success(`Incident ${c.data.ticket_number} created successfully`),p(!1),await b(),S==null||S()}catch(c){const E=c;console.error("Failed to create ServiceNow incident:",c),o.error(((v=(g=E.response)==null?void 0:g.data)==null?void 0:v.error)||"Failed to create incident")}finally{D(!1)}},P=async()=>{var g,v;if(!m){o.error("ServiceNow is not configured. Please configure it in Settings."),p(!1);return}D(!0);try{const c=await te.createChange(h);o.success(`Change Request ${c.data.ticket_number} created successfully`),p(!1),await b(),S==null||S()}catch(c){const E=c;console.error("Failed to create ServiceNow change request:",c),o.error(((v=(g=E.response)==null?void 0:g.data)==null?void 0:v.error)||"Failed to create change request")}finally{D(!1)}},A=g=>g==="incident"?e.jsx(be,{className:"h-4 w-4 text-red-400"}):e.jsx(_e,{className:"h-4 w-4 text-blue-400"});return m===null?null:e.jsxs("div",{className:"relative",ref:T,children:[e.jsxs(cs,{variant:"secondary",onClick:()=>p(!a),disabled:n,className:"flex items-center gap-2",children:[n?e.jsx(Ce,{className:"h-4 w-4"}):e.jsx(ss,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{children:"ServiceNow"}),e.jsx(ts,{className:`h-4 w-4 transition-transform ${a?"rotate-180":""}`})]}),a&&e.jsx("div",{className:"absolute right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50",children:m?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 border-b border-gray-700",children:[e.jsx("p",{className:"text-xs text-gray-500 px-2 py-1",children:"Create Ticket"}),e.jsxs("button",{onClick:f,disabled:n,className:"w-full flex items-center gap-3 px-3 py-2 text-left text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[e.jsx(be,{className:"h-5 w-5 text-red-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create Incident"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Report an issue for investigation"})]})]}),e.jsxs("button",{onClick:P,disabled:n,className:"w-full flex items-center gap-3 px-3 py-2 text-left text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[e.jsx(_e,{className:"h-5 w-5 text-blue-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create Change Request"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Request remediation changes"})]})]})]}),e.jsxs("div",{className:"p-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 px-2 py-1",children:["Linked Tickets ",u&&e.jsx(Ce,{className:"h-3 w-3 inline ml-1"})]}),y.length===0?e.jsx("p",{className:"px-3 py-2 text-sm text-gray-500",children:"No tickets linked yet"}):e.jsx("div",{className:"max-h-48 overflow-y-auto",children:y.map(g=>e.jsxs("a",{href:g.ticket_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[A(g.ticket_type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-cyan-400 truncate",children:g.ticket_number}),e.jsxs("div",{className:"text-xs text-gray-500 capitalize",children:[g.ticket_type," ",g.status&&`- ${g.status}`]})]}),e.jsx(as,{className:"h-4 w-4 text-gray-500 flex-shrink-0"})]},g.id))})]})]}):e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(be,{className:"h-8 w-8 text-yellow-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-300 mb-2",children:"ServiceNow not configured"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Go to Settings > ServiceNow to configure the integration."})]})})]})},js=({vulnerabilityId:h,onClose:S,onUpdate:a})=>{const{user:p}=xs(),[n,D]=t.useState(null),[y,$]=t.useState(!0),[u,j]=t.useState(!1),[m,_]=t.useState("info"),[T,B]=t.useState([]),[b,f]=t.useState(null),[P,A]=t.useState(!1),[g,v]=t.useState(!1),[c,E]=t.useState(null),[G,X]=t.useState([]),[L,K]=t.useState(!1),[M,Q]=t.useState(""),[x,N]=t.useState(!1),[w,C]=t.useState(""),[F,z]=t.useState(""),[I,Y]=t.useState(""),[U,l]=t.useState(""),[i,R]=t.useState(""),[ae,re]=t.useState(""),[le,ie]=t.useState(""),[ne,de]=t.useState(""),[W,q]=t.useState(!1),[fe,ye]=t.useState(!1),[oe,ee]=t.useState(""),[Fe,ce]=t.useState(!1),[xe,me]=t.useState("still_vulnerable");t.useEffect(()=>{O(),De(),H(),Ae(),pe()},[h]);const pe=async()=>{try{A(!0);const s=await k.getFPPrediction(h);f(s.data)}catch(s){console.debug("Could not load FP prediction:",s),f(null)}finally{A(!1)}},je=async s=>{try{v(!0),await k.submitFPFeedback(h,{is_false_positive:s}),o.success("Thank you for your feedback! This helps improve our predictions."),await pe()}catch(r){console.error("Failed to submit FP feedback:",r),o.error("Failed to submit feedback")}finally{v(!1)}},De=async()=>{try{const s=await ms.list();B(s.data)}catch(s){console.debug("Could not load users list:",s)}},H=async()=>{try{K(!0);const s=await V.getForVulnerability(h);E(s.data)}catch{E(null)}finally{K(!1)}},Ae=async()=>{try{const s=await V.templates.list();X(s.data.filter(r=>r.is_active)),s.data.length>0&&Q(s.data[0].id)}catch(s){console.debug("Could not load workflow templates:",s)}},Pe=async()=>{var s,r;if(!M){o.error("Please select a workflow template");return}try{N(!0),await V.instances.start(h,{template_id:M}),o.success("Workflow started successfully"),await H(),a==null||a()}catch(Z){console.error("Failed to start workflow:",Z);const ge=Z;o.error(((r=(s=ge.response)==null?void 0:s.data)==null?void 0:r.error)||"Failed to start workflow")}finally{N(!1)}},Re=async s=>{c&&(await V.stages.approve(c.id,{comment:s}),o.success("Stage approved"),await H(),a==null||a())},$e=async(s,r)=>{c&&(await V.stages.reject(c.id,{comment:s,restart_from_stage:r}),o.success("Stage rejected"),await H(),a==null||a())},Ee=async s=>{c&&(await V.stages.advance(c.id,s),o.success("Advanced to next stage"),await H(),a==null||a())},Te=async s=>{c&&(await V.instances.hold(c.id,s),o.success("Workflow put on hold"),await H(),a==null||a())},Le=async()=>{c&&(await V.instances.resume(c.id),o.success("Workflow resumed"),await H(),a==null||a())},We=async s=>{c&&(await V.instances.cancel(c.id,s),o.success("Workflow cancelled"),await H(),a==null||a())},O=async()=>{var s;try{$(!0);const r=await k.get(h);D(r.data),C(r.data.vulnerability.status),z(r.data.vulnerability.priority||"medium"),Y(r.data.vulnerability.notes||""),l(r.data.vulnerability.assignee_id||""),R(((s=r.data.vulnerability.due_date)==null?void 0:s.split("T")[0])||""),re(r.data.vulnerability.remediation_steps||""),ie(r.data.vulnerability.estimated_effort||""),de(r.data.vulnerability.actual_effort||"")}catch(r){console.error("Failed to load vulnerability detail:",r)}finally{$(!1)}},ve=async()=>{var s;if(n)try{q(!0),await k.update(h,{status:w!==n.vulnerability.status?w:void 0,priority:F!==(n.vulnerability.priority||"medium")?F:void 0,notes:I!==(n.vulnerability.notes||"")?I:void 0,assignee_id:U!==(n.vulnerability.assignee_id||"")&&U||void 0,due_date:i!==(((s=n.vulnerability.due_date)==null?void 0:s.split("T")[0])||"")&&i?`${i}T00:00:00Z`:void 0,remediation_steps:ae!==(n.vulnerability.remediation_steps||"")?ae:void 0,estimated_effort:typeof le=="number"?le:void 0,actual_effort:typeof ne=="number"?ne:void 0}),o.success("Vulnerability updated successfully"),await O(),j(!1),a==null||a()}catch(r){console.error("Failed to update vulnerability:",r),o.error("Failed to update vulnerability")}finally{q(!1)}},Be=async()=>{try{q(!0),await k.markForVerification(h,{}),o.success("Vulnerability marked for verification"),await O(),a==null||a()}catch(s){console.error("Failed to mark for verification:",s),o.error("Failed to mark for verification")}finally{q(!1)}},Ie=async()=>{await O()},Me=async()=>{var s,r;if(n){ye(!0);try{const Z=await us.createTicket(h);o.success(`JIRA ticket ${Z.data.jira_ticket_key} created successfully!`),await O(),a==null||a()}catch(Z){console.error("Failed to create JIRA ticket:",Z);const ge=Z;o.error(((r=(s=ge.response)==null?void 0:s.data)==null?void 0:r.error)||"Failed to create JIRA ticket")}finally{ye(!1)}}},ze=async()=>{try{q(!0),await k.requestRetest(h,{notes:oe||void 0}),o.success("Retest requested successfully"),ee(""),await O(),a==null||a()}catch(s){console.error("Failed to request retest:",s),o.error("Failed to request retest")}finally{q(!1)}},Ve=async()=>{try{q(!0),await k.completeRetest(h,{result:xe,notes:oe||void 0}),o.success(`Retest completed: ${xe.replace(/_/g," ")}`),ce(!1),ee(""),me("still_vulnerable"),await O(),a==null||a()}catch(s){console.error("Failed to complete retest:",s),o.error("Failed to complete retest")}finally{q(!1)}},we=()=>{var s;n&&(j(!1),C(n.vulnerability.status),z(n.vulnerability.priority||"medium"),Y(n.vulnerability.notes||""),l(n.vulnerability.assignee_id||""),R(((s=n.vulnerability.due_date)==null?void 0:s.split("T")[0])||""),re(n.vulnerability.remediation_steps||""),ie(n.vulnerability.estimated_effort||""),de(n.vulnerability.actual_effort||""))},qe=s=>{const r="px-3 py-1 text-sm font-semibold rounded-full";switch(s.toLowerCase()){case"critical":return`${r} bg-red-900/50 text-red-300`;case"high":return`${r} bg-orange-900/50 text-orange-300`;case"medium":return`${r} bg-yellow-900/50 text-yellow-300`;case"low":return`${r} bg-blue-900/50 text-blue-300`;default:return`${r} bg-gray-700 text-gray-300`}},He=s=>{const r="px-3 py-1 text-sm font-semibold rounded-full";switch(s){case"open":return`${r} bg-red-900/50 text-red-300`;case"in_progress":return`${r} bg-yellow-900/50 text-yellow-300`;case"pending_verification":return`${r} bg-blue-900/50 text-blue-300`;case"resolved":return`${r} bg-green-900/50 text-green-300`;case"false_positive":return`${r} bg-gray-700 text-gray-300`;case"accepted_risk":return`${r} bg-purple-900/50 text-purple-300`;default:return`${r} bg-gray-700 text-gray-300`}},Ne=s=>s.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()),Oe=s=>{const r="px-3 py-1 text-sm font-semibold rounded-full";switch(s){case"remediated":return`${r} bg-green-900/50 text-green-300`;case"partially_remediated":return`${r} bg-yellow-900/50 text-yellow-300`;case"still_vulnerable":return`${r} bg-red-900/50 text-red-300`;default:return`${r} bg-blue-900/50 text-blue-300`}},J=s=>new Date(s).toLocaleString(),Je=s=>s.replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()),Ze=()=>!n||!n.timeline||n.timeline.length===0?e.jsx("p",{className:"text-gray-400 text-center py-8",children:"No timeline events"}):e.jsx("div",{className:"space-y-4",children:n.timeline.map(s=>e.jsxs("div",{className:"border-l-2 border-blue-600 pl-4 pb-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("div",{className:"font-medium text-white",children:s.username}),e.jsx("div",{className:"text-xs text-gray-400",children:J(s.created_at)})]}),e.jsx("div",{className:"text-sm text-blue-400 mb-1",children:Je(s.event_type)}),s.old_value&&s.new_value&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Changed from"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:s.old_value})," ","to"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:s.new_value})]}),s.comment&&e.jsx("div",{className:"text-sm text-gray-300 mt-1",children:s.comment})]},s.id))});if(y)return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-gray-800 rounded-lg p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})})});if(!n)return null;const{vulnerability:d,comments:ue,resolved_by_user:ke,verified_by_user:Se}=n;return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-900 border-b border-gray-700 px-6 py-4 z-10",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:d.vulnerability_id}),e.jsx("button",{onClick:S,className:"text-gray-400 hover:text-white text-2xl leading-none",children:"×"})]}),e.jsx("div",{className:"flex gap-4 mt-4 overflow-x-auto",children:[{id:"info",label:"Information"},{id:"ai_analysis",label:"AI Analysis",icon:he},{id:"remediation",label:"Remediation"},{id:"workflow",label:`Workflow${c?" *":""}`},{id:"timeline",label:"Timeline"},{id:"comments",label:`Comments${ue.length>0?` (${ue.length})`:""}`}].map(s=>e.jsxs("button",{onClick:()=>_(s.id),className:`pb-2 px-1 border-b-2 transition-colors flex items-center gap-1 whitespace-nowrap ${m===s.id?"border-blue-500 text-blue-400 font-semibold":"border-transparent text-gray-400 hover:text-gray-200"}`,children:["icon"in s&&s.icon&&e.jsx(s.icon,{className:"h-4 w-4 text-purple-400"}),s.label]},s.id))})]}),e.jsxs("div",{className:"p-6",children:[m==="info"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Host"}),e.jsx("div",{className:"text-white",children:d.host_ip})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Port"}),e.jsx("div",{className:"text-white",children:d.port||"N/A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Severity"}),e.jsx("div",{children:e.jsx("span",{className:qe(d.severity),children:d.severity.toUpperCase()})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Status"}),u?e.jsxs("select",{value:w,onChange:s=>C(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"pending_verification",children:"Pending Verification"}),e.jsx("option",{value:"resolved",children:"Resolved"}),e.jsx("option",{value:"false_positive",children:"False Positive"}),e.jsx("option",{value:"accepted_risk",children:"Accepted Risk"})]}):e.jsx("span",{className:He(d.status),children:Ne(d.status)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Priority"}),u?e.jsxs("select",{value:F,onChange:s=>z(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"critical",children:"Critical"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"low",children:"Low"})]}):e.jsx("div",{className:"text-white",children:(d.priority||"medium").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Assignee"}),u?e.jsxs("select",{value:U,onChange:s=>l(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),T.map(s=>e.jsxs("option",{value:s.id,children:[s.username," (",s.email,")"]},s.id))]}):e.jsx("div",{className:"text-white",children:n!=null&&n.assignee?n.assignee.username:"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Due Date"}),u?e.jsx("input",{type:"date",value:i,onChange:s=>R(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"}):e.jsx("div",{className:`text-white ${d.due_date&&new Date(d.due_date)<new Date?"text-red-400":""}`,children:d.due_date?new Date(d.due_date).toLocaleDateString():"Not set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Created"}),e.jsx("div",{className:"text-gray-300",children:J(d.created_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Updated"}),e.jsx("div",{className:"text-gray-300",children:J(d.updated_at)})]}),d.resolved_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved At"}),e.jsx("div",{className:"text-gray-300",children:J(d.resolved_at)})]}),ke&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved By"}),e.jsx("div",{className:"text-gray-300",children:ke.username})]})]}),d.verified_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified At"}),e.jsx("div",{className:"text-gray-300",children:J(d.verified_at)})]}),Se&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified By"}),e.jsx("div",{className:"text-gray-300",children:Se.username})]})]})]}),d.retest_requested_at&&e.jsxs("div",{className:"bg-indigo-900/30 border border-indigo-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-200 mb-3",children:"Retest Status"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Requested At"}),e.jsx("div",{className:"text-indigo-200",children:J(d.retest_requested_at)})]}),d.retest_completed_at?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Completed At"}),e.jsx("div",{className:"text-indigo-200",children:J(d.retest_completed_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Result"}),e.jsx("span",{className:Oe(d.retest_result),children:Ne(d.retest_result||"")})]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Status"}),e.jsx("span",{className:"px-3 py-1 text-sm font-semibold rounded-full bg-yellow-900/50 text-yellow-300",children:"Pending Retest"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes"}),u?e.jsx("textarea",{value:I,onChange:s=>Y(s.target.value),rows:4,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about this vulnerability..."}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap bg-gray-800 p-3 rounded-md",children:d.notes||"No notes"})]}),(d.jira_ticket_id||d.jira_ticket_key)&&e.jsx("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-300 mb-1",children:"JIRA Ticket"}),e.jsx("div",{className:"text-blue-200 font-semibold",children:d.jira_ticket_key})]}),d.jira_ticket_url&&e.jsxs("a",{href:d.jira_ticket_url,target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 inline-flex items-center gap-2",children:["View in JIRA",e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})]})]})}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:u?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ve,disabled:W,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:W?"Saving...":"Save Changes"}),e.jsx("button",{onClick:we,disabled:W,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit"}),d.status==="in_progress"&&e.jsx("button",{onClick:Be,disabled:W,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-600",children:"Mark for Verification"}),!d.jira_ticket_id&&e.jsx("button",{onClick:Me,disabled:fe,className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-600 inline-flex items-center gap-2",children:fe?"Creating...":"Create JIRA Ticket"}),e.jsx(ps,{vulnerabilityId:d.id,onTicketCreated:()=>{O(),a==null||a()}}),!d.retest_requested_at&&d.status!=="resolved"&&e.jsx("button",{onClick:ze,disabled:W,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-600",children:"Request Retest"}),d.retest_requested_at&&!d.retest_completed_at&&e.jsx("button",{onClick:()=>ce(!0),disabled:W,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:"Complete Retest"})]})})]}),m==="ai_analysis"&&e.jsx("div",{className:"space-y-6",children:P?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-purple-500"})}):b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`rounded-lg p-6 border ${b.prediction==="LikelyFP"?"bg-purple-900/30 border-purple-700":b.prediction==="PossibleFP"?"bg-yellow-900/30 border-yellow-700":b.prediction==="TruePositive"?"bg-green-900/30 border-green-700":"bg-gray-800 border-gray-700"}`,children:e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-3 rounded-full ${b.prediction==="LikelyFP"?"bg-purple-500/30":b.prediction==="PossibleFP"?"bg-yellow-500/30":b.prediction==="TruePositive"?"bg-green-500/30":"bg-gray-500/30"}`,children:b.prediction==="TruePositive"?e.jsx(rs,{className:"h-6 w-6 text-green-400"}):b.prediction==="LikelyFP"||b.prediction==="PossibleFP"?e.jsx(ls,{className:"h-6 w-6 text-yellow-400"}):e.jsx(is,{className:"h-6 w-6 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:b.prediction==="TruePositive"?"True Positive":b.prediction==="LikelyFP"?"Likely False Positive":b.prediction==="PossibleFP"?"Possible False Positive":"Uncertain"}),e.jsxs("p",{className:"text-sm text-gray-400",children:[Math.round(b.fp_probability*100),"% FP probability • ",Math.round(b.confidence*100),"% confidence"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm text-gray-400 mr-2",children:"Is this accurate?"}),e.jsxs("button",{onClick:()=>je(!0),disabled:g,className:"flex items-center gap-1 px-3 py-1.5 rounded-md bg-green-600/20 text-green-400 hover:bg-green-600/30 transition-colors disabled:opacity-50",title:"Yes, this is a false positive",children:[e.jsx(ns,{className:"h-4 w-4"}),"FP"]}),e.jsxs("button",{onClick:()=>je(!1),disabled:g,className:"flex items-center gap-1 px-3 py-1.5 rounded-md bg-red-600/20 text-red-400 hover:bg-red-600/30 transition-colors disabled:opacity-50",title:"No, this is a true positive",children:[e.jsx(ds,{className:"h-4 w-4"}),"TP"]})]})]})}),b.factors&&b.factors.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsxs("h4",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(he,{className:"h-5 w-5 text-purple-400"}),"Contributing Factors"]}),e.jsx("div",{className:"space-y-3",children:b.factors.map((s,r)=>e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-300",children:s.name}),e.jsxs("span",{className:`text-sm font-semibold ${s.contribution>.3?"text-red-400":s.contribution>.15?"text-yellow-400":"text-green-400"}`,children:[Math.round(s.contribution*100),"%"]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:s.description}),e.jsx("div",{className:"mt-1 h-1.5 bg-gray-700 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full ${s.contribution>.3?"bg-red-500":s.contribution>.15?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.round(s.contribution*100)}%`}})})]})},r))})]}),b.recommendations&&b.recommendations.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"Recommendations"}),e.jsx("ul",{className:"space-y-2",children:b.recommendations.map((s,r)=>e.jsxs("li",{className:"flex items-start gap-2 text-sm text-gray-300",children:[e.jsx("span",{className:"text-purple-400 mt-0.5",children:"•"}),s]},r))})]}),b.similar_findings&&b.similar_findings.length>0&&e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 border border-gray-700",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"Similar Historical Findings"}),e.jsx("div",{className:"space-y-3",children:b.similar_findings.map((s,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-900 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-gray-300",children:s.title}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Similarity: ",Math.round(s.similarity_score*100),"%",s.resolution&&` • Resolution: ${s.resolution}`]})]}),e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${s.was_false_positive?"bg-purple-500/20 text-purple-400":"bg-green-500/20 text-green-400"}`,children:s.was_false_positive?"False Positive":"True Positive"})]},r))})]}),e.jsxs("div",{className:"text-xs text-gray-500 text-center",children:["Analysis generated at ",new Date(b.predicted_at).toLocaleString()]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx(he,{className:"h-12 w-12 text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-400 mb-2",children:"No AI Analysis Available"}),e.jsx("p",{className:"text-sm text-gray-500",children:"False positive prediction is not available for this vulnerability."})]})}),m==="remediation"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Estimated Effort (hours)"}),u?e.jsx("input",{type:"number",value:le,onChange:s=>ie(s.target.value?parseInt(s.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:d.estimated_effort?`${d.estimated_effort} hours`:"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Actual Effort (hours)"}),u?e.jsx("input",{type:"number",value:ne,onChange:s=>de(s.target.value?parseInt(s.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:d.actual_effort?`${d.actual_effort} hours`:"Not set"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Remediation Steps"}),u?e.jsx("textarea",{value:ae,onChange:s=>re(s.target.value),rows:10,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm",placeholder:"Enter detailed remediation steps (markdown supported)..."}):e.jsx("div",{className:"bg-gray-800 p-4 rounded-md whitespace-pre-wrap text-gray-300",children:d.remediation_steps||"No remediation steps defined"})]}),u&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:ve,disabled:W,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:W?"Saving...":"Save Changes"}),e.jsx("button",{onClick:we,disabled:W,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}),!u&&e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit Remediation"})]}),m==="workflow"&&e.jsx("div",{className:"space-y-6",children:L?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):c?e.jsxs("div",{className:"space-y-6",children:[e.jsx(bs,{instance:c,onApprove:Re,onReject:$e,onAdvance:Ee,onHold:Te,onResume:Le,onCancel:We,isLoading:L}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-medium text-white mb-4",children:"Workflow History"}),e.jsx(hs,{transitions:c.transitions,stageNames:c.stage_instances.reduce((s,r)=>(s[r.stage_id]=r.stage.name,s),{})})]})]}):e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Start Remediation Workflow"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Start a workflow to track the remediation process through configurable approval stages."}),G.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Select Workflow Template"}),e.jsx("select",{value:M,onChange:s=>Q(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:G.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.description?` - ${s.description}`:""]},s.id))})]}),e.jsx("button",{onClick:Pe,disabled:x||!M,className:"px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 disabled:bg-gray-600",children:x?"Starting...":"Start Workflow"})]}):e.jsx("p",{className:"text-yellow-400",children:"No workflow templates available. Please configure templates in the Workflows page."})]})}),m==="timeline"&&Ze(),m==="comments"&&e.jsx("div",{className:"space-y-6",children:e.jsx(ys,{vulnerabilityId:h,currentUserId:p==null?void 0:p.id,onCommentsChange:Ie,initialComments:ue})})]})]}),Fe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Complete Retest"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Retest Result"}),e.jsxs("select",{value:xe,onChange:s=>me(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"still_vulnerable",children:"Still Vulnerable"}),e.jsx("option",{value:"remediated",children:"Remediated"}),e.jsx("option",{value:"partially_remediated",children:"Partially Remediated"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:oe,onChange:s=>ee(s.target.value),rows:3,className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about the retest result..."})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{onClick:()=>{ce(!1),ee(""),me("still_vulnerable")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",children:"Cancel"}),e.jsx("button",{onClick:Ve,disabled:W,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:W?"Completing...":"Complete Retest"})]})]})})]})},As=()=>{const[h,S]=t.useState([]),[a,p]=t.useState(),[n,D]=t.useState(null),[y,$]=t.useState(null),[u,j]=t.useState(!0);t.useEffect(()=>{m()},[]),t.useEffect(()=>{a&&_()},[a]);const m=async()=>{try{j(!0);const P=(await gs.getAll()).data.filter(A=>A.status==="completed");S(P),P.length>0&&!a&&p(P[0].id)}catch(f){console.error("Failed to load scans:",f)}finally{j(!1)}},_=async()=>{if(a)try{const f=await k.getStats(a);$(f.data)}catch(f){console.error("Failed to load stats:",f)}},T=f=>{D(f)},B=()=>{D(null)},b=()=>{_()};return e.jsxs(Ge,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Remediation Workflow"}),e.jsx("p",{className:"mt-2 text-slate-400",children:"Track and manage vulnerability remediation progress with a Kanban-style board"})]}),e.jsxs("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-2",children:"Select Scan"}),e.jsxs("select",{value:a||"",onChange:f=>p(f.target.value||void 0),className:"w-full md:w-96 rounded-md bg-dark-bg border-dark-border text-white shadow-sm focus:border-primary focus:ring-primary",disabled:u,children:[e.jsx("option",{value:"",children:"Select a scan..."}),h.map(f=>e.jsxs("option",{value:f.id,children:[f.name," - ",new Date(f.created_at).toLocaleDateString()]},f.id))]})]}),y&&e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"bg-dark-bg rounded-lg px-4 py-2 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:y.total}),e.jsx("div",{className:"text-xs text-slate-400",children:"Total"})]}),e.jsxs("div",{className:"bg-severity-critical/20 rounded-lg px-4 py-2 text-center border border-severity-critical/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-critical",children:y.open}),e.jsx("div",{className:"text-xs text-slate-400",children:"Open"})]}),e.jsxs("div",{className:"bg-severity-medium/20 rounded-lg px-4 py-2 text-center border border-severity-medium/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-medium",children:y.in_progress}),e.jsx("div",{className:"text-xs text-slate-400",children:"In Progress"})]}),e.jsxs("div",{className:"bg-status-completed/20 rounded-lg px-4 py-2 text-center border border-status-completed/50",children:[e.jsx("div",{className:"text-2xl font-bold text-status-completed",children:y.resolved}),e.jsx("div",{className:"text-xs text-slate-400",children:"Resolved"})]})]})]}),y&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-border",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"By Severity"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-critical"}),e.jsxs("span",{className:"text-slate-300",children:["Critical: ",y.critical]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-high"}),e.jsxs("span",{className:"text-slate-300",children:["High: ",y.high]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-medium"}),e.jsxs("span",{className:"text-slate-300",children:["Medium: ",y.medium]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-low"}),e.jsxs("span",{className:"text-slate-300",children:["Low: ",y.low]})]})]})]})]}),e.jsx("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:u?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):h.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx("p",{className:"text-lg mb-2",children:"No completed scans found"}),e.jsx("p",{className:"text-sm",children:"Run a scan with vulnerability detection enabled to see results here"})]}):e.jsx(fs,{scanId:a,onVulnerabilityClick:T})})]}),n&&e.jsx(js,{vulnerabilityId:n,onClose:B,onUpdate:b})]})};export{As as default};
