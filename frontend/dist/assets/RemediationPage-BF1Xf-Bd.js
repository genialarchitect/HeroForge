import{j as e}from"./vendor-state-CmPn7D-C.js";import{r as a}from"./vendor-react-Da1CiaFS.js";import{a as Be,H as A,o as se,B as Me,L as fe,J as Ve,K as ze,M as V,l as qe,q as He,d as Je}from"./index-1jRzuKaK.js";import{B as c,L as te,aT as Oe,ao as Ke,s as Ze,X as Ge,aK as Xe,af as Ye,f as Qe,b as Ue,aY as oe,bd as ye,a5 as es}from"./vendor-ui-Co93spXs.js";import{W as ss,a as ts}from"./WorkflowHistory-CnR4BMWI.js";import"./vendor-charts-D04Aj3Lx.js";const as=({scanId:g,onVulnerabilityClick:S})=>{const[t,p]=a.useState([]),[d,D]=a.useState(!0),[f,F]=a.useState(null),[u,j]=a.useState(!1),[x,_]=a.useState(new Set),[W,I]=a.useState([]),[h,b]=a.useState(!1),[R,$]=a.useState(!1),[m,v]=a.useState(""),[y,L]=a.useState(""),X=[{id:"open",title:"Open",color:"bg-red-900/20 border-red-700"},{id:"in_progress",title:"In Progress",color:"bg-yellow-900/20 border-yellow-700"},{id:"pending_verification",title:"Pending Verification",color:"bg-blue-900/20 border-blue-700"},{id:"resolved",title:"Resolved",color:"bg-green-900/20 border-green-700"}];a.useEffect(()=>{T(),Y()},[g]);const Y=async()=>{try{const r=await Be.getUsers();I(r.data)}catch(r){console.debug("Could not load users list:",r)}},T=async()=>{try{if(D(!0),!g){p([]);return}const r=await A.list({scan_id:g});p(r.data)}catch(r){console.error("Failed to load vulnerabilities:",r)}finally{D(!1)}},O=(r,i)=>{F(i),r.dataTransfer.effectAllowed="move"},z=r=>{r.preventDefault(),r.dataTransfer.dropEffect="move"},K=async(r,i)=>{if(r.preventDefault(),!(!f||f.status===i||u))try{j(!0),await A.update(f.id,{status:i}),await T(),F(null)}catch(E){console.error("Failed to update vulnerability status:",E)}finally{j(!1)}},o=()=>{F(null)},w=(r,i)=>{i.stopPropagation();const E=new Set(x);E.has(r)?E.delete(r):E.add(r),_(E)},N=async r=>{if(x.size!==0)try{j(!0),await A.bulkUpdate({vulnerability_ids:Array.from(x),status:r}),c.success(`Updated ${x.size} vulnerabilities to ${r.replace(/_/g," ")}`),_(new Set),await T()}catch(i){console.error("Failed to bulk update status:",i),c.error("Failed to update vulnerabilities")}finally{j(!1)}},C=async()=>{if(x.size!==0)try{j(!0),await A.bulkUpdate({vulnerability_ids:Array.from(x),assignee_id:m||void 0}),c.success(`Assigned ${x.size} vulnerabilities`),_(new Set),b(!1),v(""),await T()}catch(r){console.error("Failed to bulk assign:",r),c.error("Failed to assign vulnerabilities")}finally{j(!1)}},k=async()=>{if(!(x.size===0||!y))try{j(!0),await A.bulkUpdate({vulnerability_ids:Array.from(x),due_date:`${y}T00:00:00Z`}),c.success(`Updated due date for ${x.size} vulnerabilities`),_(new Set),$(!1),L(""),await T()}catch(r){console.error("Failed to bulk update due date:",r),c.error("Failed to update due dates")}finally{j(!1)}},M=()=>{_(new Set)},B=r=>t.filter(i=>i.status===r),Q=r=>{switch(r.toLowerCase()){case"critical":return"border-l-4 border-red-500";case"high":return"border-l-4 border-orange-500";case"medium":return"border-l-4 border-yellow-500";case"low":return"border-l-4 border-blue-500";default:return"border-l-4 border-gray-500"}},U=r=>{if(!r)return null;const i={critical:"bg-red-600 text-white",high:"bg-orange-600 text-white",medium:"bg-yellow-600 text-white",low:"bg-blue-600 text-white"};return e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${i[r.toLowerCase()]||"bg-gray-600 text-white"}`,children:r.charAt(0).toUpperCase()})};return d?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):g?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Remediation Board"}),e.jsxs("div",{className:"flex gap-2",children:[x.size>0&&e.jsxs("span",{className:"px-3 py-1 text-sm bg-blue-600 text-white rounded",children:[x.size," selected"]}),e.jsx("button",{onClick:T,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600",children:"Refresh"})]})]}),x.size>0&&e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"text-gray-400 text-sm mr-2",children:"Bulk Actions:"}),e.jsx("button",{onClick:()=>N("in_progress"),disabled:u,className:"px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:bg-gray-600",children:"Mark In Progress"}),e.jsx("button",{onClick:()=>N("pending_verification"),disabled:u,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-600",children:"Mark Pending Verification"}),e.jsx("button",{onClick:()=>N("resolved"),disabled:u,className:"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-600",children:"Mark Resolved"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:()=>b(!0),disabled:u,className:"px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 disabled:bg-gray-600",children:"Assign"}),e.jsx("button",{onClick:()=>$(!0),disabled:u,className:"px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-gray-600",children:"Set Due Date"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:M,className:"px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-500",children:"Clear Selection"})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:X.map(r=>e.jsxs("div",{className:`rounded-lg border-2 ${r.color} p-4 min-h-[400px] transition-colors ${f&&f.status!==r.id?"ring-2 ring-blue-500/50":""}`,onDragOver:z,onDrop:i=>K(i,r.id),children:[e.jsxs("h3",{className:"font-semibold text-lg mb-4 text-white flex justify-between items-center",children:[e.jsx("span",{children:r.title}),e.jsx("span",{className:"text-sm font-normal text-gray-400 bg-gray-800 px-2 py-0.5 rounded",children:B(r.id).length})]}),e.jsxs("div",{className:"space-y-2",children:[B(r.id).map(i=>e.jsxs("div",{draggable:!u&&!x.has(i.id),onDragStart:E=>O(E,i),onDragEnd:o,onClick:()=>S==null?void 0:S(i.id),className:`bg-gray-800 p-3 rounded shadow cursor-move hover:shadow-lg hover:bg-gray-750 transition-all ${Q(i.severity)} ${(f==null?void 0:f.id)===i.id?"opacity-50":""} ${u?"cursor-not-allowed":""} ${x.has(i.id)?"ring-2 ring-blue-500":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("input",{type:"checkbox",checked:x.has(i.id),onClick:E=>w(i.id,E),onChange:()=>{},className:"rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700"}),e.jsx("div",{className:"font-medium text-sm text-white truncate",children:i.vulnerability_id})]}),U(i.priority)]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1 ml-6",children:i.host_ip}),i.port&&e.jsxs("div",{className:"text-xs text-gray-500 ml-6",children:["Port: ",i.port]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 ml-6",children:[e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${i.severity==="critical"?"bg-red-900/50 text-red-300":i.severity==="high"?"bg-orange-900/50 text-orange-300":i.severity==="medium"?"bg-yellow-900/50 text-yellow-300":"bg-blue-900/50 text-blue-300"}`,children:i.severity}),i.assignee_id&&e.jsx("span",{className:"text-xs text-gray-500",children:"Assigned"})]}),i.due_date&&e.jsxs("div",{className:`text-xs mt-1 ml-6 ${new Date(i.due_date)<new Date?"text-red-400":"text-gray-500"}`,children:["Due: ",new Date(i.due_date).toLocaleDateString()]}),i.estimated_effort&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 ml-6",children:["Est: ",i.estimated_effort,"h",i.actual_effort?` / Actual: ${i.actual_effort}h`:""]})]},i.id)),B(r.id).length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 text-sm",children:"No vulnerabilities"})]})]},r.id))}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-400 pt-4 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"Critical"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"High"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded"}),e.jsx("span",{children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded"}),e.jsx("span",{children:"Low"})]})]}),h&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Assign ",x.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Select Assignee"}),e.jsxs("select",{value:m,onChange:r=>v(r.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),W.map(r=>e.jsxs("option",{value:r.id,children:[r.username," (",r.email,")"]},r.id))]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{b(!1),v("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:u,children:"Cancel"}),e.jsx("button",{onClick:C,disabled:u,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:u?"Assigning...":"Assign"})]})]})}),R&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Set Due Date for ",x.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Due Date"}),e.jsx("input",{type:"date",value:y,onChange:r=>L(r.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",min:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{$(!1),L("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:u,children:"Cancel"}),e.jsx("button",{onClick:k,disabled:u||!y,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:u?"Updating...":"Set Due Date"})]})]})})]}):e.jsx("div",{className:"text-center py-12 text-gray-400",children:"Select a scan to view the remediation board"})},rs=({vulnerabilityId:g,currentUserId:S,onCommentsChange:t,initialComments:p})=>{const[d,D]=a.useState(p||[]),[f,F]=a.useState(!p),[u,j]=a.useState(""),[x,_]=a.useState(!1),[W,I]=a.useState(null),[h,b]=a.useState(null),[R,$]=a.useState(""),[m,v]=a.useState(!1),y=a.useCallback(async()=>{try{F(!0);const o=await A.getComments(g);D(o.data)}catch(o){console.error("Failed to load comments:",o),c.error("Failed to load comments")}finally{F(!1)}},[g]);a.useEffect(()=>{p||y()},[y,p]),a.useEffect(()=>{p&&D(p)},[p]);const L=async o=>{if(o.preventDefault(),!!u.trim())try{_(!0),await A.addComment(g,u.trim()),j(""),c.success("Comment added"),await y(),t==null||t()}catch(w){console.error("Failed to add comment:",w),c.error("Failed to add comment")}finally{_(!1)}},X=async o=>{var w,N;try{I(o),await A.deleteComment(g,o),c.success("Comment deleted"),await y(),t==null||t()}catch(C){console.error("Failed to delete comment:",C);const k=C;c.error(((N=(w=k.response)==null?void 0:w.data)==null?void 0:N.error)||"Failed to delete comment")}finally{I(null)}},Y=o=>{b(o.id),$(o.comment)},T=()=>{b(null),$("")},O=async o=>{var w,N;if(!R.trim()){c.error("Comment cannot be empty");return}try{v(!0),await A.updateComment(g,o,R.trim()),c.success("Comment updated"),b(null),$(""),await y(),t==null||t()}catch(C){console.error("Failed to update comment:",C);const k=C;c.error(((N=(w=k.response)==null?void 0:w.data)==null?void 0:N.error)||"Failed to update comment")}finally{v(!1)}},z=o=>new Date(o).toLocaleString(),K=o=>{const w=new Date(o),C=new Date().getTime()-w.getTime(),k=Math.floor(C/6e4),M=Math.floor(k/60),B=Math.floor(M/24);return k<1?"just now":k<60?`${k}m ago`:M<24?`${M}h ago`:B<7?`${B}d ago`:w.toLocaleDateString()};return f?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(te,{className:"h-6 w-6 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-gray-400",children:"Loading comments..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("form",{onSubmit:L,className:"space-y-3",children:e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:u,onChange:o=>j(o.target.value),rows:3,className:"block w-full rounded-lg bg-gray-800 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none pr-12",placeholder:"Add a comment...",disabled:x}),e.jsx("button",{type:"submit",disabled:x||!u.trim(),className:"absolute bottom-3 right-3 p-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",title:"Send comment",children:x?e.jsx(te,{className:"h-4 w-4 animate-spin"}):e.jsx(Oe,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"space-y-3",children:d.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ke,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No comments yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Be the first to add a comment"})]}):d.map(o=>{const w=S===o.user_id,N=W===o.id,C=h===o.id;return e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-sm font-semibold",children:o.username.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:o.username}),e.jsxs("div",{className:"text-xs text-gray-500",title:z(o.created_at),children:[K(o.created_at),o.updated_at&&e.jsx("span",{className:"ml-1 text-gray-600",title:`Edited: ${z(o.updated_at)}`,children:"(edited)"})]})]})]}),C?e.jsxs("div",{className:"mt-2",children:[e.jsx("textarea",{value:R,onChange:k=>$(k.target.value),rows:3,className:"block w-full rounded-lg bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none",disabled:m,autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("button",{onClick:()=>O(o.id),disabled:m||!R.trim(),className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-cyan-600 text-white text-sm hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",children:[m?e.jsx(te,{className:"h-3 w-3 animate-spin"}):e.jsx(Ze,{className:"h-3 w-3"}),"Save"]}),e.jsxs("button",{onClick:T,disabled:m,className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-gray-600 text-gray-300 text-sm hover:bg-gray-500 disabled:opacity-50 transition-colors",children:[e.jsx(Ge,{className:"h-3 w-3"}),"Cancel"]})]})]}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap break-words",children:o.comment})]}),w&&!C&&e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>Y(o),disabled:N,className:"p-2 rounded-lg text-gray-500 hover:text-cyan-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Edit comment",children:e.jsx(Xe,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>X(o.id),disabled:N,className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Delete comment",children:N?e.jsx(te,{className:"h-4 w-4 animate-spin"}):e.jsx(Ye,{className:"h-4 w-4"})})]})]})},o.id)})}),d.length>0&&e.jsxs("div",{className:"text-sm text-gray-500 text-center pt-2",children:[d.length," ",d.length===1?"comment":"comments"]})]})},ls=({vulnerabilityId:g,onTicketCreated:S})=>{const[t,p]=a.useState(!1),[d,D]=a.useState(!1),[f,F]=a.useState([]),[u,j]=a.useState(!1),[x,_]=a.useState(null),W=a.useRef(null);a.useEffect(()=>{I(),h()},[g]),a.useEffect(()=>{const m=v=>{W.current&&!W.current.contains(v.target)&&p(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[]);const I=async()=>{var m;try{await se.getSettings(),_(!0)}catch(v){((m=v.response)==null?void 0:m.status)===404&&_(!1)}},h=async()=>{j(!0);try{const m=await se.getTicketsForVulnerability(g);F(m.data)}catch(m){console.error("Failed to load ServiceNow tickets:",m)}finally{j(!1)}},b=async()=>{var m,v;if(!x){c.error("ServiceNow is not configured. Please configure it in Settings."),p(!1);return}D(!0);try{const y=await se.createIncident(g);c.success(`Incident ${y.data.ticket_number} created successfully`),p(!1),await h(),S==null||S()}catch(y){const L=y;console.error("Failed to create ServiceNow incident:",y),c.error(((v=(m=L.response)==null?void 0:m.data)==null?void 0:v.error)||"Failed to create incident")}finally{D(!1)}},R=async()=>{var m,v;if(!x){c.error("ServiceNow is not configured. Please configure it in Settings."),p(!1);return}D(!0);try{const y=await se.createChange(g);c.success(`Change Request ${y.data.ticket_number} created successfully`),p(!1),await h(),S==null||S()}catch(y){const L=y;console.error("Failed to create ServiceNow change request:",y),c.error(((v=(m=L.response)==null?void 0:m.data)==null?void 0:v.error)||"Failed to create change request")}finally{D(!1)}},$=m=>m==="incident"?e.jsx(oe,{className:"h-4 w-4 text-red-400"}):e.jsx(ye,{className:"h-4 w-4 text-blue-400"});return x===null?null:e.jsxs("div",{className:"relative",ref:W,children:[e.jsxs(Me,{variant:"secondary",onClick:()=>p(!t),disabled:d,className:"flex items-center gap-2",children:[d?e.jsx(fe,{className:"h-4 w-4"}):e.jsx(Qe,{className:"h-4 w-4 text-green-400"}),e.jsx("span",{children:"ServiceNow"}),e.jsx(Ue,{className:`h-4 w-4 transition-transform ${t?"rotate-180":""}`})]}),t&&e.jsx("div",{className:"absolute right-0 mt-2 w-72 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50",children:x?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-2 border-b border-gray-700",children:[e.jsx("p",{className:"text-xs text-gray-500 px-2 py-1",children:"Create Ticket"}),e.jsxs("button",{onClick:b,disabled:d,className:"w-full flex items-center gap-3 px-3 py-2 text-left text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[e.jsx(oe,{className:"h-5 w-5 text-red-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create Incident"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Report an issue for investigation"})]})]}),e.jsxs("button",{onClick:R,disabled:d,className:"w-full flex items-center gap-3 px-3 py-2 text-left text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[e.jsx(ye,{className:"h-5 w-5 text-blue-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:"Create Change Request"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Request remediation changes"})]})]})]}),e.jsxs("div",{className:"p-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 px-2 py-1",children:["Linked Tickets ",u&&e.jsx(fe,{className:"h-3 w-3 inline ml-1"})]}),f.length===0?e.jsx("p",{className:"px-3 py-2 text-sm text-gray-500",children:"No tickets linked yet"}):e.jsx("div",{className:"max-h-48 overflow-y-auto",children:f.map(m=>e.jsxs("a",{href:m.ticket_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-gray-700 rounded-md transition-colors",children:[$(m.ticket_type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-cyan-400 truncate",children:m.ticket_number}),e.jsxs("div",{className:"text-xs text-gray-500 capitalize",children:[m.ticket_type," ",m.status&&`- ${m.status}`]})]}),e.jsx(es,{className:"h-4 w-4 text-gray-500 flex-shrink-0"})]},m.id))})]})]}):e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(oe,{className:"h-8 w-8 text-yellow-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-300 mb-2",children:"ServiceNow not configured"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Go to Settings > ServiceNow to configure the integration."})]})})]})},is=({vulnerabilityId:g,onClose:S,onUpdate:t})=>{const{user:p}=Ve(),[d,D]=a.useState(null),[f,F]=a.useState(!0),[u,j]=a.useState(!1),[x,_]=a.useState("info"),[W,I]=a.useState([]),[h,b]=a.useState(null),[R,$]=a.useState([]),[m,v]=a.useState(!1),[y,L]=a.useState(""),[X,Y]=a.useState(!1),[T,O]=a.useState(""),[z,K]=a.useState(""),[o,w]=a.useState(""),[N,C]=a.useState(""),[k,M]=a.useState(""),[B,Q]=a.useState(""),[U,r]=a.useState(""),[i,E]=a.useState(""),[P,q]=a.useState(!1),[ce,ue]=a.useState(!1),[ae,ee]=a.useState(""),[pe,re]=a.useState(!1),[le,ie]=a.useState("still_vulnerable");a.useEffect(()=>{J(),je(),H(),ve()},[g]);const je=async()=>{try{const s=await ze.list();I(s.data)}catch(s){console.debug("Could not load users list:",s)}},H=async()=>{try{v(!0);const s=await V.getForVulnerability(g);b(s.data)}catch{b(null)}finally{v(!1)}},ve=async()=>{try{const s=await V.templates.list();$(s.data.filter(l=>l.is_active)),s.data.length>0&&L(s.data[0].id)}catch(s){console.debug("Could not load workflow templates:",s)}},we=async()=>{var s,l;if(!y){c.error("Please select a workflow template");return}try{Y(!0),await V.instances.start(g,{template_id:y}),c.success("Workflow started successfully"),await H(),t==null||t()}catch(G){console.error("Failed to start workflow:",G);const ne=G;c.error(((l=(s=ne.response)==null?void 0:s.data)==null?void 0:l.error)||"Failed to start workflow")}finally{Y(!1)}},Ne=async s=>{h&&(await V.stages.approve(h.id,{comment:s}),c.success("Stage approved"),await H(),t==null||t())},ke=async(s,l)=>{h&&(await V.stages.reject(h.id,{comment:s,restart_from_stage:l}),c.success("Stage rejected"),await H(),t==null||t())},Se=async s=>{h&&(await V.stages.advance(h.id,s),c.success("Advanced to next stage"),await H(),t==null||t())},_e=async s=>{h&&(await V.instances.hold(h.id,s),c.success("Workflow put on hold"),await H(),t==null||t())},Ce=async()=>{h&&(await V.instances.resume(h.id),c.success("Workflow resumed"),await H(),t==null||t())},De=async s=>{h&&(await V.instances.cancel(h.id,s),c.success("Workflow cancelled"),await H(),t==null||t())},J=async()=>{var s;try{F(!0);const l=await A.get(g);D(l.data),O(l.data.vulnerability.status),K(l.data.vulnerability.priority||"medium"),w(l.data.vulnerability.notes||""),C(l.data.vulnerability.assignee_id||""),M(((s=l.data.vulnerability.due_date)==null?void 0:s.split("T")[0])||""),Q(l.data.vulnerability.remediation_steps||""),r(l.data.vulnerability.estimated_effort||""),E(l.data.vulnerability.actual_effort||"")}catch(l){console.error("Failed to load vulnerability detail:",l)}finally{F(!1)}},xe=async()=>{var s;if(d)try{q(!0),await A.update(g,{status:T!==d.vulnerability.status?T:void 0,priority:z!==(d.vulnerability.priority||"medium")?z:void 0,notes:o!==(d.vulnerability.notes||"")?o:void 0,assignee_id:N!==(d.vulnerability.assignee_id||"")&&N||void 0,due_date:k!==(((s=d.vulnerability.due_date)==null?void 0:s.split("T")[0])||"")&&k?`${k}T00:00:00Z`:void 0,remediation_steps:B!==(d.vulnerability.remediation_steps||"")?B:void 0,estimated_effort:typeof U=="number"?U:void 0,actual_effort:typeof i=="number"?i:void 0}),c.success("Vulnerability updated successfully"),await J(),j(!1),t==null||t()}catch(l){console.error("Failed to update vulnerability:",l),c.error("Failed to update vulnerability")}finally{q(!1)}},Re=async()=>{try{q(!0),await A.markForVerification(g,{}),c.success("Vulnerability marked for verification"),await J(),t==null||t()}catch(s){console.error("Failed to mark for verification:",s),c.error("Failed to mark for verification")}finally{q(!1)}},Ae=async()=>{await J()},$e=async()=>{var s,l;if(d){ue(!0);try{const G=await qe.createTicket(g);c.success(`JIRA ticket ${G.data.jira_ticket_key} created successfully!`),await J(),t==null||t()}catch(G){console.error("Failed to create JIRA ticket:",G);const ne=G;c.error(((l=(s=ne.response)==null?void 0:s.data)==null?void 0:l.error)||"Failed to create JIRA ticket")}finally{ue(!1)}}},Ee=async()=>{try{q(!0),await A.requestRetest(g,{notes:ae||void 0}),c.success("Retest requested successfully"),ee(""),await J(),t==null||t()}catch(s){console.error("Failed to request retest:",s),c.error("Failed to request retest")}finally{q(!1)}},Fe=async()=>{try{q(!0),await A.completeRetest(g,{result:le,notes:ae||void 0}),c.success(`Retest completed: ${le.replace(/_/g," ")}`),re(!1),ee(""),ie("still_vulnerable"),await J(),t==null||t()}catch(s){console.error("Failed to complete retest:",s),c.error("Failed to complete retest")}finally{q(!1)}},me=()=>{var s;d&&(j(!1),O(d.vulnerability.status),K(d.vulnerability.priority||"medium"),w(d.vulnerability.notes||""),C(d.vulnerability.assignee_id||""),M(((s=d.vulnerability.due_date)==null?void 0:s.split("T")[0])||""),Q(d.vulnerability.remediation_steps||""),r(d.vulnerability.estimated_effort||""),E(d.vulnerability.actual_effort||""))},Le=s=>{const l="px-3 py-1 text-sm font-semibold rounded-full";switch(s.toLowerCase()){case"critical":return`${l} bg-red-900/50 text-red-300`;case"high":return`${l} bg-orange-900/50 text-orange-300`;case"medium":return`${l} bg-yellow-900/50 text-yellow-300`;case"low":return`${l} bg-blue-900/50 text-blue-300`;default:return`${l} bg-gray-700 text-gray-300`}},Te=s=>{const l="px-3 py-1 text-sm font-semibold rounded-full";switch(s){case"open":return`${l} bg-red-900/50 text-red-300`;case"in_progress":return`${l} bg-yellow-900/50 text-yellow-300`;case"pending_verification":return`${l} bg-blue-900/50 text-blue-300`;case"resolved":return`${l} bg-green-900/50 text-green-300`;case"false_positive":return`${l} bg-gray-700 text-gray-300`;case"accepted_risk":return`${l} bg-purple-900/50 text-purple-300`;default:return`${l} bg-gray-700 text-gray-300`}},ge=s=>s.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),We=s=>{const l="px-3 py-1 text-sm font-semibold rounded-full";switch(s){case"remediated":return`${l} bg-green-900/50 text-green-300`;case"partially_remediated":return`${l} bg-yellow-900/50 text-yellow-300`;case"still_vulnerable":return`${l} bg-red-900/50 text-red-300`;default:return`${l} bg-blue-900/50 text-blue-300`}},Z=s=>new Date(s).toLocaleString(),Pe=s=>s.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),Ie=()=>!d||!d.timeline||d.timeline.length===0?e.jsx("p",{className:"text-gray-400 text-center py-8",children:"No timeline events"}):e.jsx("div",{className:"space-y-4",children:d.timeline.map(s=>e.jsxs("div",{className:"border-l-2 border-blue-600 pl-4 pb-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("div",{className:"font-medium text-white",children:s.username}),e.jsx("div",{className:"text-xs text-gray-400",children:Z(s.created_at)})]}),e.jsx("div",{className:"text-sm text-blue-400 mb-1",children:Pe(s.event_type)}),s.old_value&&s.new_value&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Changed from"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:s.old_value})," ","to"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:s.new_value})]}),s.comment&&e.jsx("div",{className:"text-sm text-gray-300 mt-1",children:s.comment})]},s.id))});if(f)return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-gray-800 rounded-lg p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})})});if(!d)return null;const{vulnerability:n,comments:de,resolved_by_user:be,verified_by_user:he}=d;return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-900 border-b border-gray-700 px-6 py-4 z-10",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:n.vulnerability_id}),e.jsx("button",{onClick:S,className:"text-gray-400 hover:text-white text-2xl leading-none",children:"Ã—"})]}),e.jsx("div",{className:"flex gap-4 mt-4",children:[{id:"info",label:"Information"},{id:"remediation",label:"Remediation"},{id:"workflow",label:`Workflow${h?" *":""}`},{id:"timeline",label:"Timeline"},{id:"comments",label:`Comments${de.length>0?` (${de.length})`:""}`}].map(s=>e.jsx("button",{onClick:()=>_(s.id),className:`pb-2 px-1 border-b-2 transition-colors ${x===s.id?"border-blue-500 text-blue-400 font-semibold":"border-transparent text-gray-400 hover:text-gray-200"}`,children:s.label},s.id))})]}),e.jsxs("div",{className:"p-6",children:[x==="info"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Host"}),e.jsx("div",{className:"text-white",children:n.host_ip})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Port"}),e.jsx("div",{className:"text-white",children:n.port||"N/A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Severity"}),e.jsx("div",{children:e.jsx("span",{className:Le(n.severity),children:n.severity.toUpperCase()})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Status"}),u?e.jsxs("select",{value:T,onChange:s=>O(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"pending_verification",children:"Pending Verification"}),e.jsx("option",{value:"resolved",children:"Resolved"}),e.jsx("option",{value:"false_positive",children:"False Positive"}),e.jsx("option",{value:"accepted_risk",children:"Accepted Risk"})]}):e.jsx("span",{className:Te(n.status),children:ge(n.status)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Priority"}),u?e.jsxs("select",{value:z,onChange:s=>K(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"critical",children:"Critical"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"low",children:"Low"})]}):e.jsx("div",{className:"text-white",children:(n.priority||"medium").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Assignee"}),u?e.jsxs("select",{value:N,onChange:s=>C(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),W.map(s=>e.jsxs("option",{value:s.id,children:[s.username," (",s.email,")"]},s.id))]}):e.jsx("div",{className:"text-white",children:d!=null&&d.assignee?d.assignee.username:"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Due Date"}),u?e.jsx("input",{type:"date",value:k,onChange:s=>M(s.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"}):e.jsx("div",{className:`text-white ${n.due_date&&new Date(n.due_date)<new Date?"text-red-400":""}`,children:n.due_date?new Date(n.due_date).toLocaleDateString():"Not set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Created"}),e.jsx("div",{className:"text-gray-300",children:Z(n.created_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Updated"}),e.jsx("div",{className:"text-gray-300",children:Z(n.updated_at)})]}),n.resolved_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved At"}),e.jsx("div",{className:"text-gray-300",children:Z(n.resolved_at)})]}),be&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved By"}),e.jsx("div",{className:"text-gray-300",children:be.username})]})]}),n.verified_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified At"}),e.jsx("div",{className:"text-gray-300",children:Z(n.verified_at)})]}),he&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified By"}),e.jsx("div",{className:"text-gray-300",children:he.username})]})]})]}),n.retest_requested_at&&e.jsxs("div",{className:"bg-indigo-900/30 border border-indigo-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-200 mb-3",children:"Retest Status"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Requested At"}),e.jsx("div",{className:"text-indigo-200",children:Z(n.retest_requested_at)})]}),n.retest_completed_at?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Completed At"}),e.jsx("div",{className:"text-indigo-200",children:Z(n.retest_completed_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Result"}),e.jsx("span",{className:We(n.retest_result),children:ge(n.retest_result||"")})]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Status"}),e.jsx("span",{className:"px-3 py-1 text-sm font-semibold rounded-full bg-yellow-900/50 text-yellow-300",children:"Pending Retest"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes"}),u?e.jsx("textarea",{value:o,onChange:s=>w(s.target.value),rows:4,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about this vulnerability..."}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap bg-gray-800 p-3 rounded-md",children:n.notes||"No notes"})]}),(n.jira_ticket_id||n.jira_ticket_key)&&e.jsx("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-300 mb-1",children:"JIRA Ticket"}),e.jsx("div",{className:"text-blue-200 font-semibold",children:n.jira_ticket_key})]}),n.jira_ticket_url&&e.jsxs("a",{href:n.jira_ticket_url,target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 inline-flex items-center gap-2",children:["View in JIRA",e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})]})]})}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:u?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:xe,disabled:P,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:P?"Saving...":"Save Changes"}),e.jsx("button",{onClick:me,disabled:P,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit"}),n.status==="in_progress"&&e.jsx("button",{onClick:Re,disabled:P,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-600",children:"Mark for Verification"}),!n.jira_ticket_id&&e.jsx("button",{onClick:$e,disabled:ce,className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-600 inline-flex items-center gap-2",children:ce?"Creating...":"Create JIRA Ticket"}),e.jsx(ls,{vulnerabilityId:n.id,onTicketCreated:()=>{J(),t==null||t()}}),!n.retest_requested_at&&n.status!=="resolved"&&e.jsx("button",{onClick:Ee,disabled:P,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-600",children:"Request Retest"}),n.retest_requested_at&&!n.retest_completed_at&&e.jsx("button",{onClick:()=>re(!0),disabled:P,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:"Complete Retest"})]})})]}),x==="remediation"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Estimated Effort (hours)"}),u?e.jsx("input",{type:"number",value:U,onChange:s=>r(s.target.value?parseInt(s.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:n.estimated_effort?`${n.estimated_effort} hours`:"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Actual Effort (hours)"}),u?e.jsx("input",{type:"number",value:i,onChange:s=>E(s.target.value?parseInt(s.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:n.actual_effort?`${n.actual_effort} hours`:"Not set"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Remediation Steps"}),u?e.jsx("textarea",{value:B,onChange:s=>Q(s.target.value),rows:10,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm",placeholder:"Enter detailed remediation steps (markdown supported)..."}):e.jsx("div",{className:"bg-gray-800 p-4 rounded-md whitespace-pre-wrap text-gray-300",children:n.remediation_steps||"No remediation steps defined"})]}),u&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:xe,disabled:P,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:P?"Saving...":"Save Changes"}),e.jsx("button",{onClick:me,disabled:P,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}),!u&&e.jsx("button",{onClick:()=>j(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit Remediation"})]}),x==="workflow"&&e.jsx("div",{className:"space-y-6",children:m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):h?e.jsxs("div",{className:"space-y-6",children:[e.jsx(ss,{instance:h,onApprove:Ne,onReject:ke,onAdvance:Se,onHold:_e,onResume:Ce,onCancel:De,isLoading:m}),e.jsxs("div",{className:"bg-gray-800 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-medium text-white mb-4",children:"Workflow History"}),e.jsx(ts,{transitions:h.transitions,stageNames:h.stage_instances.reduce((s,l)=>(s[l.stage_id]=l.stage.name,s),{})})]})]}):e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6",children:[e.jsx("h3",{className:"text-lg font-medium text-white mb-4",children:"Start Remediation Workflow"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Start a workflow to track the remediation process through configurable approval stages."}),R.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Select Workflow Template"}),e.jsx("select",{value:y,onChange:s=>L(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:R.map(s=>e.jsxs("option",{value:s.id,children:[s.name,s.description?` - ${s.description}`:""]},s.id))})]}),e.jsx("button",{onClick:we,disabled:X||!y,className:"px-4 py-2 bg-cyan-600 text-white rounded-md hover:bg-cyan-700 disabled:bg-gray-600",children:X?"Starting...":"Start Workflow"})]}):e.jsx("p",{className:"text-yellow-400",children:"No workflow templates available. Please configure templates in the Workflows page."})]})}),x==="timeline"&&Ie(),x==="comments"&&e.jsx("div",{className:"space-y-6",children:e.jsx(rs,{vulnerabilityId:g,currentUserId:p==null?void 0:p.id,onCommentsChange:Ae,initialComments:de})})]})]}),pe&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Complete Retest"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Retest Result"}),e.jsxs("select",{value:le,onChange:s=>ie(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"still_vulnerable",children:"Still Vulnerable"}),e.jsx("option",{value:"remediated",children:"Remediated"}),e.jsx("option",{value:"partially_remediated",children:"Partially Remediated"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:ae,onChange:s=>ee(s.target.value),rows:3,className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about the retest result..."})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{onClick:()=>{re(!1),ee(""),ie("still_vulnerable")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",children:"Cancel"}),e.jsx("button",{onClick:Fe,disabled:P,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:P?"Completing...":"Complete Retest"})]})]})})]})},ms=()=>{const[g,S]=a.useState([]),[t,p]=a.useState(),[d,D]=a.useState(null),[f,F]=a.useState(null),[u,j]=a.useState(!0);a.useEffect(()=>{x()},[]),a.useEffect(()=>{t&&_()},[t]);const x=async()=>{try{j(!0);const R=(await He.getAll()).data.filter($=>$.status==="completed");S(R),R.length>0&&!t&&p(R[0].id)}catch(b){console.error("Failed to load scans:",b)}finally{j(!1)}},_=async()=>{if(t)try{const b=await A.getStats(t);F(b.data)}catch(b){console.error("Failed to load stats:",b)}},W=b=>{D(b)},I=()=>{D(null)},h=()=>{_()};return e.jsxs(Je,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Remediation Workflow"}),e.jsx("p",{className:"mt-2 text-slate-400",children:"Track and manage vulnerability remediation progress with a Kanban-style board"})]}),e.jsxs("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-2",children:"Select Scan"}),e.jsxs("select",{value:t||"",onChange:b=>p(b.target.value||void 0),className:"w-full md:w-96 rounded-md bg-dark-bg border-dark-border text-white shadow-sm focus:border-primary focus:ring-primary",disabled:u,children:[e.jsx("option",{value:"",children:"Select a scan..."}),g.map(b=>e.jsxs("option",{value:b.id,children:[b.name," - ",new Date(b.created_at).toLocaleDateString()]},b.id))]})]}),f&&e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"bg-dark-bg rounded-lg px-4 py-2 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:f.total}),e.jsx("div",{className:"text-xs text-slate-400",children:"Total"})]}),e.jsxs("div",{className:"bg-severity-critical/20 rounded-lg px-4 py-2 text-center border border-severity-critical/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-critical",children:f.open}),e.jsx("div",{className:"text-xs text-slate-400",children:"Open"})]}),e.jsxs("div",{className:"bg-severity-medium/20 rounded-lg px-4 py-2 text-center border border-severity-medium/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-medium",children:f.in_progress}),e.jsx("div",{className:"text-xs text-slate-400",children:"In Progress"})]}),e.jsxs("div",{className:"bg-status-completed/20 rounded-lg px-4 py-2 text-center border border-status-completed/50",children:[e.jsx("div",{className:"text-2xl font-bold text-status-completed",children:f.resolved}),e.jsx("div",{className:"text-xs text-slate-400",children:"Resolved"})]})]})]}),f&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-border",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"By Severity"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-critical"}),e.jsxs("span",{className:"text-slate-300",children:["Critical: ",f.critical]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-high"}),e.jsxs("span",{className:"text-slate-300",children:["High: ",f.high]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-medium"}),e.jsxs("span",{className:"text-slate-300",children:["Medium: ",f.medium]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-low"}),e.jsxs("span",{className:"text-slate-300",children:["Low: ",f.low]})]})]})]})]}),e.jsx("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:u?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):g.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx("p",{className:"text-lg mb-2",children:"No completed scans found"}),e.jsx("p",{className:"text-sm",children:"Run a scan with vulnerability detection enabled to see results here"})]}):e.jsx(as,{scanId:t,onVulnerabilityClick:W})})]}),d&&e.jsx(is,{vulnerabilityId:d,onClose:I,onUpdate:h})]})};export{ms as default};
