import{j as e}from"./vendor-state-DrZ0R9WI.js";import{r as a}from"./vendor-react-HUtzaQ-y.js";import{a as ge,A as N,D as he,E as ye,l as pe,p as fe,d as je}from"./index-B50-Dbv4.js";import{B as b,L as U,aJ as ve,aK as Ne,q as we,X as ke,ay as _e,a9 as Se}from"./vendor-ui-MCXOk1Y_.js";import"./vendor-charts-DGjHbZ-f.js";const Ce=({scanId:h,onVulnerabilityClick:T})=>{const[o,j]=a.useState([]),[n,$]=a.useState(!0),[g,R]=a.useState(null),[c,p]=a.useState(!1),[u,C]=a.useState(new Set),[V,P]=a.useState([]),[L,x]=a.useState(!1),[w,k]=a.useState(!1),[A,E]=a.useState(""),[_,B]=a.useState(""),M=[{id:"open",title:"Open",color:"bg-red-900/20 border-red-700"},{id:"in_progress",title:"In Progress",color:"bg-yellow-900/20 border-yellow-700"},{id:"pending_verification",title:"Pending Verification",color:"bg-blue-900/20 border-blue-700"},{id:"resolved",title:"Resolved",color:"bg-green-900/20 border-green-700"}];a.useEffect(()=>{D(),q()},[h]);const q=async()=>{try{const s=await ge.getUsers();P(s.data)}catch(s){console.debug("Could not load users list:",s)}},D=async()=>{try{if($(!0),!h){j([]);return}const s=await N.list({scan_id:h});j(s.data)}catch(s){console.error("Failed to load vulnerabilities:",s)}finally{$(!1)}},J=(s,r)=>{R(r),s.dataTransfer.effectAllowed="move"},z=s=>{s.preventDefault(),s.dataTransfer.dropEffect="move"},H=async(s,r)=>{if(s.preventDefault(),!(!g||g.status===r||c))try{p(!0),await N.update(g.id,{status:r}),await D(),R(null)}catch(S){console.error("Failed to update vulnerability status:",S)}finally{p(!1)}},i=()=>{R(null)},f=(s,r)=>{r.stopPropagation();const S=new Set(u);S.has(s)?S.delete(s):S.add(s),C(S)},m=async s=>{if(u.size!==0)try{p(!0),await N.bulkUpdate({vulnerability_ids:Array.from(u),status:s}),b.success(`Updated ${u.size} vulnerabilities to ${s.replace(/_/g," ")}`),C(new Set),await D()}catch(r){console.error("Failed to bulk update status:",r),b.error("Failed to update vulnerabilities")}finally{p(!1)}},y=async()=>{if(u.size!==0)try{p(!0),await N.bulkUpdate({vulnerability_ids:Array.from(u),assignee_id:A||void 0}),b.success(`Assigned ${u.size} vulnerabilities`),C(new Set),x(!1),E(""),await D()}catch(s){console.error("Failed to bulk assign:",s),b.error("Failed to assign vulnerabilities")}finally{p(!1)}},v=async()=>{if(!(u.size===0||!_))try{p(!0),await N.bulkUpdate({vulnerability_ids:Array.from(u),due_date:`${_}T00:00:00Z`}),b.success(`Updated due date for ${u.size} vulnerabilities`),C(new Set),k(!1),B(""),await D()}catch(s){console.error("Failed to bulk update due date:",s),b.error("Failed to update due dates")}finally{p(!1)}},I=()=>{C(new Set)},F=s=>o.filter(r=>r.status===s),W=s=>{switch(s.toLowerCase()){case"critical":return"border-l-4 border-red-500";case"high":return"border-l-4 border-orange-500";case"medium":return"border-l-4 border-yellow-500";case"low":return"border-l-4 border-blue-500";default:return"border-l-4 border-gray-500"}},X=s=>{if(!s)return null;const r={critical:"bg-red-600 text-white",high:"bg-orange-600 text-white",medium:"bg-yellow-600 text-white",low:"bg-blue-600 text-white"};return e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${r[s.toLowerCase()]||"bg-gray-600 text-white"}`,children:s.charAt(0).toUpperCase()})};return n?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):h?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Remediation Board"}),e.jsxs("div",{className:"flex gap-2",children:[u.size>0&&e.jsxs("span",{className:"px-3 py-1 text-sm bg-blue-600 text-white rounded",children:[u.size," selected"]}),e.jsx("button",{onClick:D,className:"px-3 py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600",children:"Refresh"})]})]}),u.size>0&&e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700",children:e.jsxs("div",{className:"flex flex-wrap gap-2 items-center",children:[e.jsx("span",{className:"text-gray-400 text-sm mr-2",children:"Bulk Actions:"}),e.jsx("button",{onClick:()=>m("in_progress"),disabled:c,className:"px-3 py-1 text-sm bg-yellow-600 text-white rounded hover:bg-yellow-700 disabled:bg-gray-600",children:"Mark In Progress"}),e.jsx("button",{onClick:()=>m("pending_verification"),disabled:c,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-600",children:"Mark Pending Verification"}),e.jsx("button",{onClick:()=>m("resolved"),disabled:c,className:"px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-600",children:"Mark Resolved"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:()=>x(!0),disabled:c,className:"px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700 disabled:bg-gray-600",children:"Assign"}),e.jsx("button",{onClick:()=>k(!0),disabled:c,className:"px-3 py-1 text-sm bg-indigo-600 text-white rounded hover:bg-indigo-700 disabled:bg-gray-600",children:"Set Due Date"}),e.jsx("div",{className:"border-l border-gray-600 mx-2 h-6"}),e.jsx("button",{onClick:I,className:"px-3 py-1 text-sm bg-gray-600 text-white rounded hover:bg-gray-500",children:"Clear Selection"})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:M.map(s=>e.jsxs("div",{className:`rounded-lg border-2 ${s.color} p-4 min-h-[400px] transition-colors ${g&&g.status!==s.id?"ring-2 ring-blue-500/50":""}`,onDragOver:z,onDrop:r=>H(r,s.id),children:[e.jsxs("h3",{className:"font-semibold text-lg mb-4 text-white flex justify-between items-center",children:[e.jsx("span",{children:s.title}),e.jsx("span",{className:"text-sm font-normal text-gray-400 bg-gray-800 px-2 py-0.5 rounded",children:F(s.id).length})]}),e.jsxs("div",{className:"space-y-2",children:[F(s.id).map(r=>e.jsxs("div",{draggable:!c&&!u.has(r.id),onDragStart:S=>J(S,r),onDragEnd:i,onClick:()=>T==null?void 0:T(r.id),className:`bg-gray-800 p-3 rounded shadow cursor-move hover:shadow-lg hover:bg-gray-750 transition-all ${W(r.severity)} ${(g==null?void 0:g.id)===r.id?"opacity-50":""} ${c?"cursor-not-allowed":""} ${u.has(r.id)?"ring-2 ring-blue-500":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("input",{type:"checkbox",checked:u.has(r.id),onClick:S=>f(r.id,S),onChange:()=>{},className:"rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-700"}),e.jsx("div",{className:"font-medium text-sm text-white truncate",children:r.vulnerability_id})]}),X(r.priority)]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1 ml-6",children:r.host_ip}),r.port&&e.jsxs("div",{className:"text-xs text-gray-500 ml-6",children:["Port: ",r.port]}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 ml-6",children:[e.jsx("span",{className:`text-xs px-1.5 py-0.5 rounded ${r.severity==="critical"?"bg-red-900/50 text-red-300":r.severity==="high"?"bg-orange-900/50 text-orange-300":r.severity==="medium"?"bg-yellow-900/50 text-yellow-300":"bg-blue-900/50 text-blue-300"}`,children:r.severity}),r.assignee_id&&e.jsx("span",{className:"text-xs text-gray-500",children:"Assigned"})]}),r.due_date&&e.jsxs("div",{className:`text-xs mt-1 ml-6 ${new Date(r.due_date)<new Date?"text-red-400":"text-gray-500"}`,children:["Due: ",new Date(r.due_date).toLocaleDateString()]}),r.estimated_effort&&e.jsxs("div",{className:"text-xs text-gray-500 mt-1 ml-6",children:["Est: ",r.estimated_effort,"h",r.actual_effort?` / Actual: ${r.actual_effort}h`:""]})]},r.id)),F(s.id).length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500 text-sm",children:"No vulnerabilities"})]})]},s.id))}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-gray-400 pt-4 border-t border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-red-500 rounded"}),e.jsx("span",{children:"Critical"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded"}),e.jsx("span",{children:"High"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-yellow-500 rounded"}),e.jsx("span",{children:"Medium"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded"}),e.jsx("span",{children:"Low"})]})]}),L&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Assign ",u.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Select Assignee"}),e.jsxs("select",{value:A,onChange:s=>E(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),V.map(s=>e.jsxs("option",{value:s.id,children:[s.username," (",s.email,")"]},s.id))]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{x(!1),E("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:c,children:"Cancel"}),e.jsx("button",{onClick:y,disabled:c,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:c?"Assigning...":"Assign"})]})]})}),w&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl",children:[e.jsxs("h3",{className:"text-lg font-bold text-white mb-4",children:["Set Due Date for ",u.size," Vulnerabilities"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Due Date"}),e.jsx("input",{type:"date",value:_,onChange:s=>B(s.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",min:new Date().toISOString().split("T")[0]})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{k(!1),B("")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",disabled:c,children:"Cancel"}),e.jsx("button",{onClick:v,disabled:c||!_,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:c?"Updating...":"Set Due Date"})]})]})})]}):e.jsx("div",{className:"text-center py-12 text-gray-400",children:"Select a scan to view the remediation board"})},De=({vulnerabilityId:h,currentUserId:T,onCommentsChange:o,initialComments:j})=>{const[n,$]=a.useState(j||[]),[g,R]=a.useState(!j),[c,p]=a.useState(""),[u,C]=a.useState(!1),[V,P]=a.useState(null),[L,x]=a.useState(null),[w,k]=a.useState(""),[A,E]=a.useState(!1),_=a.useCallback(async()=>{try{R(!0);const i=await N.getComments(h);$(i.data)}catch(i){console.error("Failed to load comments:",i),b.error("Failed to load comments")}finally{R(!1)}},[h]);a.useEffect(()=>{j||_()},[_,j]),a.useEffect(()=>{j&&$(j)},[j]);const B=async i=>{if(i.preventDefault(),!!c.trim())try{C(!0),await N.addComment(h,c.trim()),p(""),b.success("Comment added"),await _(),o==null||o()}catch(f){console.error("Failed to add comment:",f),b.error("Failed to add comment")}finally{C(!1)}},M=async i=>{var f,m;try{P(i),await N.deleteComment(h,i),b.success("Comment deleted"),await _(),o==null||o()}catch(y){console.error("Failed to delete comment:",y);const v=y;b.error(((m=(f=v.response)==null?void 0:f.data)==null?void 0:m.error)||"Failed to delete comment")}finally{P(null)}},q=i=>{x(i.id),k(i.comment)},D=()=>{x(null),k("")},J=async i=>{var f,m;if(!w.trim()){b.error("Comment cannot be empty");return}try{E(!0),await N.updateComment(h,i,w.trim()),b.success("Comment updated"),x(null),k(""),await _(),o==null||o()}catch(y){console.error("Failed to update comment:",y);const v=y;b.error(((m=(f=v.response)==null?void 0:f.data)==null?void 0:m.error)||"Failed to update comment")}finally{E(!1)}},z=i=>new Date(i).toLocaleString(),H=i=>{const f=new Date(i),y=new Date().getTime()-f.getTime(),v=Math.floor(y/6e4),I=Math.floor(v/60),F=Math.floor(I/24);return v<1?"just now":v<60?`${v}m ago`:I<24?`${I}h ago`:F<7?`${F}d ago`:f.toLocaleDateString()};return g?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(U,{className:"h-6 w-6 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-gray-400",children:"Loading comments..."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("form",{onSubmit:B,className:"space-y-3",children:e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{value:c,onChange:i=>p(i.target.value),rows:3,className:"block w-full rounded-lg bg-gray-800 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none pr-12",placeholder:"Add a comment...",disabled:u}),e.jsx("button",{type:"submit",disabled:u||!c.trim(),className:"absolute bottom-3 right-3 p-2 rounded-lg bg-cyan-600 text-white hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",title:"Send comment",children:u?e.jsx(U,{className:"h-4 w-4 animate-spin"}):e.jsx(ve,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"space-y-3",children:n.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(Ne,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No comments yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Be the first to add a comment"})]}):n.map(i=>{const f=T===i.user_id,m=V===i.id,y=L===i.id;return e.jsx("div",{className:"bg-gray-800 rounded-lg p-4 border border-gray-700 hover:border-gray-600 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start gap-4",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white text-sm font-semibold",children:i.username.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:i.username}),e.jsxs("div",{className:"text-xs text-gray-500",title:z(i.created_at),children:[H(i.created_at),i.updated_at&&e.jsx("span",{className:"ml-1 text-gray-600",title:`Edited: ${z(i.updated_at)}`,children:"(edited)"})]})]})]}),y?e.jsxs("div",{className:"mt-2",children:[e.jsx("textarea",{value:w,onChange:v=>k(v.target.value),rows:3,className:"block w-full rounded-lg bg-gray-700 border border-gray-600 text-white shadow-sm focus:border-cyan-500 focus:ring-cyan-500 placeholder-gray-500 resize-none",disabled:A,autoFocus:!0}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("button",{onClick:()=>J(i.id),disabled:A||!w.trim(),className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-cyan-600 text-white text-sm hover:bg-cyan-700 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors",children:[A?e.jsx(U,{className:"h-3 w-3 animate-spin"}):e.jsx(we,{className:"h-3 w-3"}),"Save"]}),e.jsxs("button",{onClick:D,disabled:A,className:"inline-flex items-center gap-1 px-3 py-1 rounded-lg bg-gray-600 text-gray-300 text-sm hover:bg-gray-500 disabled:opacity-50 transition-colors",children:[e.jsx(ke,{className:"h-3 w-3"}),"Cancel"]})]})]}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap break-words",children:i.comment})]}),f&&!y&&e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>q(i),disabled:m,className:"p-2 rounded-lg text-gray-500 hover:text-cyan-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Edit comment",children:e.jsx(_e,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>M(i.id),disabled:m,className:"p-2 rounded-lg text-gray-500 hover:text-red-400 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Delete comment",children:m?e.jsx(U,{className:"h-4 w-4 animate-spin"}):e.jsx(Se,{className:"h-4 w-4"})})]})]})},i.id)})}),n.length>0&&e.jsxs("div",{className:"text-sm text-gray-500 text-center pt-2",children:[n.length," ",n.length===1?"comment":"comments"]})]})},Re=({vulnerabilityId:h,onClose:T,onUpdate:o})=>{const{user:j}=he(),[n,$]=a.useState(null),[g,R]=a.useState(!0),[c,p]=a.useState(!1),[u,C]=a.useState("info"),[V,P]=a.useState([]),[L,x]=a.useState(""),[w,k]=a.useState(""),[A,E]=a.useState(""),[_,B]=a.useState(""),[M,q]=a.useState(""),[D,J]=a.useState(""),[z,H]=a.useState(""),[i,f]=a.useState(""),[m,y]=a.useState(!1),[v,I]=a.useState(!1),[F,W]=a.useState(""),[X,s]=a.useState(!1),[r,S]=a.useState("still_vulnerable");a.useEffect(()=>{O(),ae()},[h]);const ae=async()=>{try{const t=await ye.list();P(t.data)}catch(t){console.debug("Could not load users list:",t)}},O=async()=>{var t;try{R(!0);const d=await N.get(h);$(d.data),x(d.data.vulnerability.status),k(d.data.vulnerability.priority||"medium"),E(d.data.vulnerability.notes||""),B(d.data.vulnerability.assignee_id||""),q(((t=d.data.vulnerability.due_date)==null?void 0:t.split("T")[0])||""),J(d.data.vulnerability.remediation_steps||""),H(d.data.vulnerability.estimated_effort||""),f(d.data.vulnerability.actual_effort||"")}catch(d){console.error("Failed to load vulnerability detail:",d)}finally{R(!1)}},Q=async()=>{var t;if(n)try{y(!0),await N.update(h,{status:L!==n.vulnerability.status?L:void 0,priority:w!==(n.vulnerability.priority||"medium")?w:void 0,notes:A!==(n.vulnerability.notes||"")?A:void 0,assignee_id:_!==(n.vulnerability.assignee_id||"")&&_||void 0,due_date:M!==(((t=n.vulnerability.due_date)==null?void 0:t.split("T")[0])||"")&&M?`${M}T00:00:00Z`:void 0,remediation_steps:D!==(n.vulnerability.remediation_steps||"")?D:void 0,estimated_effort:typeof z=="number"?z:void 0,actual_effort:typeof i=="number"?i:void 0}),b.success("Vulnerability updated successfully"),await O(),p(!1),o==null||o()}catch(d){console.error("Failed to update vulnerability:",d),b.error("Failed to update vulnerability")}finally{y(!1)}},re=async()=>{try{y(!0),await N.markForVerification(h,{}),b.success("Vulnerability marked for verification"),await O(),o==null||o()}catch(t){console.error("Failed to mark for verification:",t),b.error("Failed to mark for verification")}finally{y(!1)}},le=async()=>{await O()},ie=async()=>{var t,d;if(n){I(!0);try{const Z=await pe.createTicket(h);b.success(`JIRA ticket ${Z.data.jira_ticket_key} created successfully!`),await O(),o==null||o()}catch(Z){console.error("Failed to create JIRA ticket:",Z);const be=Z;b.error(((d=(t=be.response)==null?void 0:t.data)==null?void 0:d.error)||"Failed to create JIRA ticket")}finally{I(!1)}}},de=async()=>{try{y(!0),await N.requestRetest(h,{notes:F||void 0}),b.success("Retest requested successfully"),W(""),await O(),o==null||o()}catch(t){console.error("Failed to request retest:",t),b.error("Failed to request retest")}finally{y(!1)}},ne=async()=>{try{y(!0),await N.completeRetest(h,{result:r,notes:F||void 0}),b.success(`Retest completed: ${r.replace(/_/g," ")}`),s(!1),W(""),S("still_vulnerable"),await O(),o==null||o()}catch(t){console.error("Failed to complete retest:",t),b.error("Failed to complete retest")}finally{y(!1)}},Y=()=>{var t;n&&(p(!1),x(n.vulnerability.status),k(n.vulnerability.priority||"medium"),E(n.vulnerability.notes||""),B(n.vulnerability.assignee_id||""),q(((t=n.vulnerability.due_date)==null?void 0:t.split("T")[0])||""),J(n.vulnerability.remediation_steps||""),H(n.vulnerability.estimated_effort||""),f(n.vulnerability.actual_effort||""))},oe=t=>{const d="px-3 py-1 text-sm font-semibold rounded-full";switch(t.toLowerCase()){case"critical":return`${d} bg-red-900/50 text-red-300`;case"high":return`${d} bg-orange-900/50 text-orange-300`;case"medium":return`${d} bg-yellow-900/50 text-yellow-300`;case"low":return`${d} bg-blue-900/50 text-blue-300`;default:return`${d} bg-gray-700 text-gray-300`}},ce=t=>{const d="px-3 py-1 text-sm font-semibold rounded-full";switch(t){case"open":return`${d} bg-red-900/50 text-red-300`;case"in_progress":return`${d} bg-yellow-900/50 text-yellow-300`;case"pending_verification":return`${d} bg-blue-900/50 text-blue-300`;case"resolved":return`${d} bg-green-900/50 text-green-300`;case"false_positive":return`${d} bg-gray-700 text-gray-300`;case"accepted_risk":return`${d} bg-purple-900/50 text-purple-300`;default:return`${d} bg-gray-700 text-gray-300`}},ee=t=>t.replace(/_/g," ").replace(/\b\w/g,d=>d.toUpperCase()),ue=t=>{const d="px-3 py-1 text-sm font-semibold rounded-full";switch(t){case"remediated":return`${d} bg-green-900/50 text-green-300`;case"partially_remediated":return`${d} bg-yellow-900/50 text-yellow-300`;case"still_vulnerable":return`${d} bg-red-900/50 text-red-300`;default:return`${d} bg-blue-900/50 text-blue-300`}},K=t=>new Date(t).toLocaleString(),xe=t=>t.replace(/_/g," ").replace(/\b\w/g,d=>d.toUpperCase()),me=()=>!n||!n.timeline||n.timeline.length===0?e.jsx("p",{className:"text-gray-400 text-center py-8",children:"No timeline events"}):e.jsx("div",{className:"space-y-4",children:n.timeline.map(t=>e.jsxs("div",{className:"border-l-2 border-blue-600 pl-4 pb-4",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("div",{className:"font-medium text-white",children:t.username}),e.jsx("div",{className:"text-xs text-gray-400",children:K(t.created_at)})]}),e.jsx("div",{className:"text-sm text-blue-400 mb-1",children:xe(t.event_type)}),t.old_value&&t.new_value&&e.jsxs("div",{className:"text-xs text-gray-400",children:["Changed from"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:t.old_value})," ","to"," ",e.jsx("span",{className:"font-mono bg-gray-800 px-1 rounded",children:t.new_value})]}),t.comment&&e.jsx("div",{className:"text-sm text-gray-300 mt-1",children:t.comment})]},t.id))});if(g)return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50",children:e.jsx("div",{className:"bg-gray-800 rounded-lg p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})})});if(!n)return null;const{vulnerability:l,comments:G,resolved_by_user:te,verified_by_user:se}=n;return e.jsxs("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4",children:[e.jsxs("div",{className:"bg-gray-900 rounded-lg max-w-5xl w-full max-h-[90vh] overflow-y-auto border border-gray-700",children:[e.jsxs("div",{className:"sticky top-0 bg-gray-900 border-b border-gray-700 px-6 py-4 z-10",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:l.vulnerability_id}),e.jsx("button",{onClick:T,className:"text-gray-400 hover:text-white text-2xl leading-none",children:"Ã—"})]}),e.jsx("div",{className:"flex gap-4 mt-4",children:[{id:"info",label:"Information"},{id:"remediation",label:"Remediation"},{id:"timeline",label:"Timeline"},{id:"comments",label:`Comments${G.length>0?` (${G.length})`:""}`}].map(t=>e.jsx("button",{onClick:()=>C(t.id),className:`pb-2 px-1 border-b-2 transition-colors ${u===t.id?"border-blue-500 text-blue-400 font-semibold":"border-transparent text-gray-400 hover:text-gray-200"}`,children:t.label},t.id))})]}),e.jsxs("div",{className:"p-6",children:[u==="info"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Host"}),e.jsx("div",{className:"text-white",children:l.host_ip})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Port"}),e.jsx("div",{className:"text-white",children:l.port||"N/A"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Severity"}),e.jsx("div",{children:e.jsx("span",{className:oe(l.severity),children:l.severity.toUpperCase()})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Status"}),c?e.jsxs("select",{value:L,onChange:t=>x(t.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"open",children:"Open"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"pending_verification",children:"Pending Verification"}),e.jsx("option",{value:"resolved",children:"Resolved"}),e.jsx("option",{value:"false_positive",children:"False Positive"}),e.jsx("option",{value:"accepted_risk",children:"Accepted Risk"})]}):e.jsx("span",{className:ce(l.status),children:ee(l.status)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Priority"}),c?e.jsxs("select",{value:w,onChange:t=>k(t.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"critical",children:"Critical"}),e.jsx("option",{value:"high",children:"High"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"low",children:"Low"})]}):e.jsx("div",{className:"text-white",children:(l.priority||"medium").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Assignee"}),c?e.jsxs("select",{value:_,onChange:t=>B(t.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Unassigned"}),V.map(t=>e.jsxs("option",{value:t.id,children:[t.username," (",t.email,")"]},t.id))]}):e.jsx("div",{className:"text-white",children:n!=null&&n.assignee?n.assignee.username:"Unassigned"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Due Date"}),c?e.jsx("input",{type:"date",value:M,onChange:t=>q(t.target.value),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500"}):e.jsx("div",{className:`text-white ${l.due_date&&new Date(l.due_date)<new Date?"text-red-400":""}`,children:l.due_date?new Date(l.due_date).toLocaleDateString():"Not set"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Created"}),e.jsx("div",{className:"text-gray-300",children:K(l.created_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Updated"}),e.jsx("div",{className:"text-gray-300",children:K(l.updated_at)})]}),l.resolved_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved At"}),e.jsx("div",{className:"text-gray-300",children:K(l.resolved_at)})]}),te&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Resolved By"}),e.jsx("div",{className:"text-gray-300",children:te.username})]})]}),l.verified_at&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified At"}),e.jsx("div",{className:"text-gray-300",children:K(l.verified_at)})]}),se&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-gray-500 mb-1",children:"Verified By"}),e.jsx("div",{className:"text-gray-300",children:se.username})]})]})]}),l.retest_requested_at&&e.jsxs("div",{className:"bg-indigo-900/30 border border-indigo-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-indigo-200 mb-3",children:"Retest Status"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Requested At"}),e.jsx("div",{className:"text-indigo-200",children:K(l.retest_requested_at)})]}),l.retest_completed_at?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Completed At"}),e.jsx("div",{className:"text-indigo-200",children:K(l.retest_completed_at)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Result"}),e.jsx("span",{className:ue(l.retest_result),children:ee(l.retest_result||"")})]})]}):e.jsxs("div",{children:[e.jsx("label",{className:"block text-indigo-400 mb-1",children:"Status"}),e.jsx("span",{className:"px-3 py-1 text-sm font-semibold rounded-full bg-yellow-900/50 text-yellow-300",children:"Pending Retest"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes"}),c?e.jsx("textarea",{value:A,onChange:t=>E(t.target.value),rows:4,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about this vulnerability..."}):e.jsx("div",{className:"text-gray-300 whitespace-pre-wrap bg-gray-800 p-3 rounded-md",children:l.notes||"No notes"})]}),(l.jira_ticket_id||l.jira_ticket_key)&&e.jsx("div",{className:"bg-blue-900/30 border border-blue-700 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-300 mb-1",children:"JIRA Ticket"}),e.jsx("div",{className:"text-blue-200 font-semibold",children:l.jira_ticket_key})]}),l.jira_ticket_url&&e.jsxs("a",{href:l.jira_ticket_url,target:"_blank",rel:"noopener noreferrer",className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 inline-flex items-center gap-2",children:["View in JIRA",e.jsx("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"})})]})]})}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:c?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Q,disabled:m,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:m?"Saving...":"Save Changes"}),e.jsx("button",{onClick:Y,disabled:m,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>p(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit"}),l.status==="in_progress"&&e.jsx("button",{onClick:re,disabled:m,className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-600",children:"Mark for Verification"}),!l.jira_ticket_id&&e.jsx("button",{onClick:ie,disabled:v,className:"px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:bg-gray-600 inline-flex items-center gap-2",children:v?"Creating...":"Create JIRA Ticket"}),!l.retest_requested_at&&l.status!=="resolved"&&e.jsx("button",{onClick:de,disabled:m,className:"px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:bg-gray-600",children:"Request Retest"}),l.retest_requested_at&&!l.retest_completed_at&&e.jsx("button",{onClick:()=>s(!0),disabled:m,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:"Complete Retest"})]})})]}),u==="remediation"&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Estimated Effort (hours)"}),c?e.jsx("input",{type:"number",value:z,onChange:t=>H(t.target.value?parseInt(t.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:l.estimated_effort?`${l.estimated_effort} hours`:"Not set"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-1",children:"Actual Effort (hours)"}),c?e.jsx("input",{type:"number",value:i,onChange:t=>f(t.target.value?parseInt(t.target.value):""),className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Hours",min:"0"}):e.jsx("div",{className:"text-white",children:l.actual_effort?`${l.actual_effort} hours`:"Not set"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Remediation Steps"}),c?e.jsx("textarea",{value:D,onChange:t=>J(t.target.value),rows:10,className:"block w-full rounded-md bg-gray-800 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500 font-mono text-sm",placeholder:"Enter detailed remediation steps (markdown supported)..."}):e.jsx("div",{className:"bg-gray-800 p-4 rounded-md whitespace-pre-wrap text-gray-300",children:l.remediation_steps||"No remediation steps defined"})]}),c&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:Q,disabled:m,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-600",children:m?"Saving...":"Save Changes"}),e.jsx("button",{onClick:Y,disabled:m,className:"px-4 py-2 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600",children:"Cancel"})]}),!c&&e.jsx("button",{onClick:()=>p(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Edit Remediation"})]}),u==="timeline"&&me(),u==="comments"&&e.jsx("div",{className:"space-y-6",children:e.jsx(De,{vulnerabilityId:h,currentUserId:j==null?void 0:j.id,onCommentsChange:le,initialComments:G})})]})]}),X&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60]",children:e.jsxs("div",{className:"bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white mb-4",children:"Complete Retest"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Retest Result"}),e.jsxs("select",{value:r,onChange:t=>S(t.target.value),className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",children:[e.jsx("option",{value:"still_vulnerable",children:"Still Vulnerable"}),e.jsx("option",{value:"remediated",children:"Remediated"}),e.jsx("option",{value:"partially_remediated",children:"Partially Remediated"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-400 mb-2",children:"Notes (optional)"}),e.jsx("textarea",{value:F,onChange:t=>W(t.target.value),rows:3,className:"block w-full rounded-md bg-gray-700 border-gray-600 text-white shadow-sm focus:border-blue-500 focus:ring-blue-500",placeholder:"Add notes about the retest result..."})]})]}),e.jsxs("div",{className:"flex gap-2 mt-6 justify-end",children:[e.jsx("button",{onClick:()=>{s(!1),W(""),S("still_vulnerable")},className:"px-4 py-2 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500",children:"Cancel"}),e.jsx("button",{onClick:ne,disabled:m,className:"px-4 py-2 bg-teal-600 text-white rounded-md hover:bg-teal-700 disabled:bg-gray-600",children:m?"Completing...":"Complete Retest"})]})]})})]})},Le=()=>{const[h,T]=a.useState([]),[o,j]=a.useState(),[n,$]=a.useState(null),[g,R]=a.useState(null),[c,p]=a.useState(!0);a.useEffect(()=>{u()},[]),a.useEffect(()=>{o&&C()},[o]);const u=async()=>{try{p(!0);const w=(await fe.getAll()).data.filter(k=>k.status==="completed");T(w),w.length>0&&!o&&j(w[0].id)}catch(x){console.error("Failed to load scans:",x)}finally{p(!1)}},C=async()=>{if(o)try{const x=await N.getStats(o);R(x.data)}catch(x){console.error("Failed to load stats:",x)}},V=x=>{$(x)},P=()=>{$(null)},L=()=>{C()};return e.jsxs(je,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Remediation Workflow"}),e.jsx("p",{className:"mt-2 text-slate-400",children:"Track and manage vulnerability remediation progress with a Kanban-style board"})]}),e.jsxs("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-400 mb-2",children:"Select Scan"}),e.jsxs("select",{value:o||"",onChange:x=>j(x.target.value||void 0),className:"w-full md:w-96 rounded-md bg-dark-bg border-dark-border text-white shadow-sm focus:border-primary focus:ring-primary",disabled:c,children:[e.jsx("option",{value:"",children:"Select a scan..."}),h.map(x=>e.jsxs("option",{value:x.id,children:[x.name," - ",new Date(x.created_at).toLocaleDateString()]},x.id))]})]}),g&&e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs("div",{className:"bg-dark-bg rounded-lg px-4 py-2 text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:g.total}),e.jsx("div",{className:"text-xs text-slate-400",children:"Total"})]}),e.jsxs("div",{className:"bg-severity-critical/20 rounded-lg px-4 py-2 text-center border border-severity-critical/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-critical",children:g.open}),e.jsx("div",{className:"text-xs text-slate-400",children:"Open"})]}),e.jsxs("div",{className:"bg-severity-medium/20 rounded-lg px-4 py-2 text-center border border-severity-medium/50",children:[e.jsx("div",{className:"text-2xl font-bold text-severity-medium",children:g.in_progress}),e.jsx("div",{className:"text-xs text-slate-400",children:"In Progress"})]}),e.jsxs("div",{className:"bg-status-completed/20 rounded-lg px-4 py-2 text-center border border-status-completed/50",children:[e.jsx("div",{className:"text-2xl font-bold text-status-completed",children:g.resolved}),e.jsx("div",{className:"text-xs text-slate-400",children:"Resolved"})]})]})]}),g&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-dark-border",children:[e.jsx("div",{className:"text-sm text-slate-400 mb-2",children:"By Severity"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-critical"}),e.jsxs("span",{className:"text-slate-300",children:["Critical: ",g.critical]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-high"}),e.jsxs("span",{className:"text-slate-300",children:["High: ",g.high]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-medium"}),e.jsxs("span",{className:"text-slate-300",children:["Medium: ",g.medium]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"w-3 h-3 rounded bg-severity-low"}),e.jsxs("span",{className:"text-slate-300",children:["Low: ",g.low]})]})]})]})]}),e.jsx("div",{className:"bg-dark-surface rounded-lg p-6 border border-dark-border",children:c?e.jsx("div",{className:"flex justify-center items-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):h.length===0?e.jsxs("div",{className:"text-center py-12 text-slate-400",children:[e.jsx("p",{className:"text-lg mb-2",children:"No completed scans found"}),e.jsx("p",{className:"text-sm",children:"Run a scan with vulnerability detection enabled to see results here"})]}):e.jsx(Ce,{scanId:o,onVulnerabilityClick:V})})]}),n&&e.jsx(Re,{vulnerabilityId:n,onClose:P,onUpdate:L})]})};export{Le as default};
