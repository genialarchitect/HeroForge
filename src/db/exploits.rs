//! Exploit Database Functions
//!
//! Provides database operations for exploit storage, retrieval, and searching.
//! Supports local caching of exploits from external sources.

use anyhow::Result;
use chrono::{NaiveDate, Utc};
use sqlx::SqlitePool;
use serde::{Deserialize, Serialize};

/// Exploit record for database storage
#[derive(Debug, Clone, Serialize, Deserialize, sqlx::FromRow)]
pub struct ExploitRecord {
    pub id: String,
    pub exploit_db_id: Option<String>,
    pub metasploit_module: Option<String>,
    pub cve_ids: String,  // JSON array
    pub title: String,
    pub description: Option<String>,
    pub platform: String,
    pub architecture: String,
    pub exploit_type: String,
    pub author: Option<String>,
    pub source_url: Option<String>,
    pub source: String,
    pub code: Option<String>,
    pub language: Option<String>,
    pub verified: i32,
    pub reliability: String,
    pub tags: String,  // JSON array
    pub published_date: Option<String>,
    pub created_at: String,
    pub updated_at: String,
}

/// Insert or update an exploit in the database
pub async fn upsert_exploit(pool: &SqlitePool, exploit: &ExploitRecord) -> Result<()> {
    sqlx::query(r#"
        INSERT INTO exploits (
            id, exploit_db_id, metasploit_module, cve_ids, title, description,
            platform, architecture, exploit_type, author, source_url, source,
            code, language, verified, reliability, tags, published_date,
            created_at, updated_at
        ) VALUES (?1, ?2, ?3, ?4, ?5, ?6, ?7, ?8, ?9, ?10, ?11, ?12, ?13, ?14, ?15, ?16, ?17, ?18, ?19, ?20)
        ON CONFLICT(id) DO UPDATE SET
            exploit_db_id = excluded.exploit_db_id,
            metasploit_module = excluded.metasploit_module,
            cve_ids = excluded.cve_ids,
            title = excluded.title,
            description = excluded.description,
            platform = excluded.platform,
            architecture = excluded.architecture,
            exploit_type = excluded.exploit_type,
            author = excluded.author,
            source_url = excluded.source_url,
            source = excluded.source,
            code = excluded.code,
            language = excluded.language,
            verified = excluded.verified,
            reliability = excluded.reliability,
            tags = excluded.tags,
            published_date = excluded.published_date,
            updated_at = excluded.updated_at
    "#)
    .bind(&exploit.id)
    .bind(&exploit.exploit_db_id)
    .bind(&exploit.metasploit_module)
    .bind(&exploit.cve_ids)
    .bind(&exploit.title)
    .bind(&exploit.description)
    .bind(&exploit.platform)
    .bind(&exploit.architecture)
    .bind(&exploit.exploit_type)
    .bind(&exploit.author)
    .bind(&exploit.source_url)
    .bind(&exploit.source)
    .bind(&exploit.code)
    .bind(&exploit.language)
    .bind(exploit.verified)
    .bind(&exploit.reliability)
    .bind(&exploit.tags)
    .bind(&exploit.published_date)
    .bind(&exploit.created_at)
    .bind(&exploit.updated_at)
    .execute(pool)
    .await?;

    Ok(())
}

/// Search exploits in the local database
pub async fn search_exploits(
    pool: &SqlitePool,
    query: Option<&str>,
    cve_id: Option<&str>,
    platform: Option<&str>,
    exploit_type: Option<&str>,
    source: Option<&str>,
    verified_only: bool,
    page: u32,
    per_page: u32,
) -> Result<(Vec<ExploitRecord>, i64)> {
    let offset = (page.saturating_sub(1) * per_page) as i64;
    let limit = per_page as i64;

    // Build WHERE clause dynamically
    let mut conditions = vec!["1=1".to_string()];

    if let Some(q) = query {
        conditions.push(format!(
            "(title LIKE '%{}%' OR description LIKE '%{}%' OR cve_ids LIKE '%{}%')",
            q.replace("'", "''"), q.replace("'", "''"), q.replace("'", "''")
        ));
    }

    if let Some(cve) = cve_id {
        conditions.push(format!("cve_ids LIKE '%{}%'", cve.replace("'", "''")));
    }

    if let Some(p) = platform {
        conditions.push(format!("platform = '{}'", p.replace("'", "''")));
    }

    if let Some(t) = exploit_type {
        conditions.push(format!("exploit_type = '{}'", t.replace("'", "''")));
    }

    if let Some(s) = source {
        conditions.push(format!("source = '{}'", s.replace("'", "''")));
    }

    if verified_only {
        conditions.push("verified = 1".to_string());
    }

    let where_clause = conditions.join(" AND ");

    // Get total count
    let count_query = format!("SELECT COUNT(*) as count FROM exploits WHERE {}", where_clause);
    let total: i64 = sqlx::query_scalar(&count_query)
        .fetch_one(pool)
        .await
        .unwrap_or(0);

    // Get results
    let select_query = format!(
        "SELECT * FROM exploits WHERE {} ORDER BY published_date DESC NULLS LAST, created_at DESC LIMIT {} OFFSET {}",
        where_clause, limit, offset
    );

    let exploits = sqlx::query_as::<_, ExploitRecord>(&select_query)
        .fetch_all(pool)
        .await?;

    Ok((exploits, total))
}

/// Get exploit by ID
pub async fn get_exploit_by_id(pool: &SqlitePool, id: &str) -> Result<Option<ExploitRecord>> {
    let exploit = sqlx::query_as::<_, ExploitRecord>(
        "SELECT * FROM exploits WHERE id = ?1"
    )
    .bind(id)
    .fetch_optional(pool)
    .await?;

    Ok(exploit)
}

/// Get exploit by Exploit-DB ID
pub async fn get_exploit_by_edb_id(pool: &SqlitePool, edb_id: &str) -> Result<Option<ExploitRecord>> {
    let exploit = sqlx::query_as::<_, ExploitRecord>(
        "SELECT * FROM exploits WHERE exploit_db_id = ?1"
    )
    .bind(edb_id)
    .fetch_optional(pool)
    .await?;

    Ok(exploit)
}

/// Get exploits by CVE ID
pub async fn get_exploits_by_cve(pool: &SqlitePool, cve_id: &str) -> Result<Vec<ExploitRecord>> {
    let exploits = sqlx::query_as::<_, ExploitRecord>(
        "SELECT * FROM exploits WHERE cve_ids LIKE ?1 ORDER BY reliability DESC, published_date DESC"
    )
    .bind(format!("%{}%", cve_id))
    .fetch_all(pool)
    .await?;

    Ok(exploits)
}

/// Get exploit count by source
pub async fn get_exploit_count_by_source(pool: &SqlitePool) -> Result<Vec<(String, i64)>> {
    let counts = sqlx::query_as::<_, (String, i64)>(
        "SELECT source, COUNT(*) as count FROM exploits GROUP BY source ORDER BY count DESC"
    )
    .fetch_all(pool)
    .await?;

    Ok(counts)
}

/// Get total exploit count
pub async fn get_exploit_count(pool: &SqlitePool) -> Result<i64> {
    let count: i64 = sqlx::query_scalar("SELECT COUNT(*) FROM exploits")
        .fetch_one(pool)
        .await?;

    Ok(count)
}

/// Delete all exploits from a specific source
pub async fn delete_exploits_by_source(pool: &SqlitePool, source: &str) -> Result<u64> {
    let result = sqlx::query("DELETE FROM exploits WHERE source = ?1")
        .bind(source)
        .execute(pool)
        .await?;

    Ok(result.rows_affected())
}

/// Update sync status
pub async fn update_sync_status(
    pool: &SqlitePool,
    source: &str,
    total_exploits: i64,
    new_exploits: i64,
    error: Option<&str>,
) -> Result<()> {
    let now = Utc::now().to_rfc3339();

    sqlx::query(r#"
        INSERT INTO exploit_sync_status (id, source, last_sync_at, total_exploits, new_since_last_sync, sync_in_progress, last_error)
        VALUES (?1, ?2, ?3, ?4, ?5, 0, ?6)
        ON CONFLICT(source) DO UPDATE SET
            last_sync_at = excluded.last_sync_at,
            total_exploits = excluded.total_exploits,
            new_since_last_sync = excluded.new_since_last_sync,
            sync_in_progress = 0,
            last_error = excluded.last_error
    "#)
    .bind(uuid::Uuid::new_v4().to_string())
    .bind(source)
    .bind(&now)
    .bind(total_exploits)
    .bind(new_exploits)
    .bind(error)
    .execute(pool)
    .await?;

    Ok(())
}

/// Get sync status for a source
pub async fn get_sync_status(pool: &SqlitePool, source: &str) -> Result<Option<SyncStatus>> {
    let status = sqlx::query_as::<_, SyncStatus>(
        "SELECT * FROM exploit_sync_status WHERE source = ?1"
    )
    .bind(source)
    .fetch_optional(pool)
    .await?;

    Ok(status)
}

#[derive(Debug, Clone, sqlx::FromRow)]
pub struct SyncStatus {
    pub id: String,
    pub source: String,
    pub last_sync_at: Option<String>,
    pub total_exploits: i64,
    pub new_since_last_sync: i64,
    pub sync_in_progress: i32,
    pub last_error: Option<String>,
}

/// Seed the database with common exploits
/// This provides a baseline of well-known exploits for offline use
pub async fn seed_common_exploits(pool: &SqlitePool) -> Result<u64> {
    let now = Utc::now().to_rfc3339();
    let mut count = 0u64;

    // Check if we already have exploits
    let existing: i64 = sqlx::query_scalar("SELECT COUNT(*) FROM exploits")
        .fetch_one(pool)
        .await
        .unwrap_or(0);

    if existing > 0 {
        log::info!("Exploit database already has {} entries, skipping seed", existing);
        return Ok(0);
    }

    log::info!("Seeding exploit database with common exploits...");

    // Common high-profile exploits
    let exploits = vec![
        // EternalBlue - MS17-010
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("42315".to_string()),
            metasploit_module: Some("exploit/windows/smb/ms17_010_eternalblue".to_string()),
            cve_ids: r#"["CVE-2017-0144", "CVE-2017-0145", "CVE-2017-0146", "CVE-2017-0147", "CVE-2017-0148"]"#.to_string(),
            title: "Microsoft Windows SMB Server (EternalBlue) - Remote Code Execution".to_string(),
            description: Some("EternalBlue exploit targeting SMBv1 vulnerability in Microsoft Windows. Used by WannaCry and NotPetya ransomware.".to_string()),
            platform: "windows".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Shadow Brokers / NSA".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/42315".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["smb", "ransomware", "worm", "critical"]"#.to_string(),
            published_date: Some("2017-04-14".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Log4Shell - CVE-2021-44228
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50592".to_string()),
            metasploit_module: Some("exploit/multi/http/log4shell_header_injection".to_string()),
            cve_ids: r#"["CVE-2021-44228"]"#.to_string(),
            title: "Apache Log4j 2 - Remote Code Execution (Log4Shell)".to_string(),
            description: Some("Critical RCE vulnerability in Apache Log4j 2 logging library via JNDI lookup injection.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Chen Zhaojun".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50592".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("java".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["log4j", "java", "jndi", "critical", "rce"]"#.to_string(),
            published_date: Some("2021-12-10".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // BlueKeep - CVE-2019-0708
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("47416".to_string()),
            metasploit_module: Some("exploit/windows/rdp/cve_2019_0708_bluekeep_rce".to_string()),
            cve_ids: r#"["CVE-2019-0708"]"#.to_string(),
            title: "Microsoft Windows Remote Desktop Services - BlueKeep RCE".to_string(),
            description: Some("Pre-authentication RCE in Windows Remote Desktop Services. Wormable vulnerability similar to EternalBlue.".to_string()),
            platform: "windows".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("zerosum0x0".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/47416".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "good".to_string(),
            tags: r#"["rdp", "worm", "critical", "pre-auth"]"#.to_string(),
            published_date: Some("2019-09-06".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Zerologon - CVE-2020-1472
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("49071".to_string()),
            metasploit_module: Some("exploit/windows/dcerpc/cve_2020_1472_zerologon".to_string()),
            cve_ids: r#"["CVE-2020-1472"]"#.to_string(),
            title: "Microsoft Netlogon - Zerologon Privilege Escalation".to_string(),
            description: Some("Critical vulnerability in Microsoft Netlogon Remote Protocol (MS-NRPC) allowing domain takeover.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "local".to_string(),
            author: Some("Secura / Tom Tervoort".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/49071".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["active-directory", "domain", "critical", "privilege-escalation"]"#.to_string(),
            published_date: Some("2020-09-11".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // PrintNightmare - CVE-2021-34527
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50076".to_string()),
            metasploit_module: Some("exploit/windows/dcerpc/cve_2021_34527_printnightmare".to_string()),
            cve_ids: r#"["CVE-2021-34527", "CVE-2021-1675"]"#.to_string(),
            title: "Windows Print Spooler - PrintNightmare RCE/LPE".to_string(),
            description: Some("Critical vulnerability in Windows Print Spooler allowing RCE and local privilege escalation.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("cube0x0".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50076".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["print-spooler", "critical", "rce", "lpe"]"#.to_string(),
            published_date: Some("2021-07-01".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // ProxyShell - CVE-2021-34473
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50171".to_string()),
            metasploit_module: Some("exploit/windows/http/exchange_proxyshell_rce".to_string()),
            cve_ids: r#"["CVE-2021-34473", "CVE-2021-34523", "CVE-2021-31207"]"#.to_string(),
            title: "Microsoft Exchange Server - ProxyShell RCE".to_string(),
            description: Some("Pre-authenticated RCE chain in Microsoft Exchange Server via ProxyShell vulnerabilities.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Orange Tsai".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50171".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["exchange", "critical", "pre-auth", "rce"]"#.to_string(),
            published_date: Some("2021-08-06".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Spring4Shell - CVE-2022-22965
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50808".to_string()),
            metasploit_module: Some("exploit/multi/http/spring_framework_rce_spring4shell".to_string()),
            cve_ids: r#"["CVE-2022-22965"]"#.to_string(),
            title: "Spring Framework - Spring4Shell RCE".to_string(),
            description: Some("Remote code execution in Spring Framework via data binding to Java 9+ running on Apache Tomcat.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Anonymous".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50808".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("java".to_string()),
            verified: 1,
            reliability: "good".to_string(),
            tags: r#"["spring", "java", "tomcat", "rce"]"#.to_string(),
            published_date: Some("2022-03-31".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Follina - CVE-2022-30190
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50926".to_string()),
            metasploit_module: None,
            cve_ids: r#"["CVE-2022-30190"]"#.to_string(),
            title: "Microsoft MSDT - Follina RCE".to_string(),
            description: Some("Remote code execution via Microsoft Support Diagnostic Tool through malicious Office documents.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("nao_sec".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50926".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["office", "msdt", "phishing", "rce"]"#.to_string(),
            published_date: Some("2022-05-30".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Apache Struts2 - CVE-2017-5638
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("41570".to_string()),
            metasploit_module: Some("exploit/multi/http/struts2_content_type_ognl".to_string()),
            cve_ids: r#"["CVE-2017-5638"]"#.to_string(),
            title: "Apache Struts 2 - Content-Type OGNL Injection RCE".to_string(),
            description: Some("Remote code execution via OGNL injection in Content-Type header. Used in Equifax breach.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Nike.Zheng".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/41570".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["struts", "java", "ognl", "critical"]"#.to_string(),
            published_date: Some("2017-03-07".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Drupalgeddon 2 - CVE-2018-7600
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("44449".to_string()),
            metasploit_module: Some("exploit/unix/webapp/drupal_drupalgeddon2".to_string()),
            cve_ids: r#"["CVE-2018-7600"]"#.to_string(),
            title: "Drupal - Drupalgeddon 2 RCE".to_string(),
            description: Some("Remote code execution in Drupal CMS via insecure form API rendering. Unauthenticated.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Jasper Mattsson".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/44449".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("php".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["drupal", "cms", "php", "critical"]"#.to_string(),
            published_date: Some("2018-04-13".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Shellshock - CVE-2014-6271
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("34765".to_string()),
            metasploit_module: Some("exploit/multi/http/apache_mod_cgi_bash_env_exec".to_string()),
            cve_ids: r#"["CVE-2014-6271", "CVE-2014-7169"]"#.to_string(),
            title: "GNU Bash - Shellshock Environment Variable Code Injection".to_string(),
            description: Some("Remote code execution via specially crafted environment variables in Bash. Affects CGI, SSH, DHCP.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Stephane Chazelas".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/34765".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("bash".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["bash", "cgi", "critical", "worm"]"#.to_string(),
            published_date: Some("2014-09-24".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Heartbleed - CVE-2014-0160
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("32745".to_string()),
            metasploit_module: Some("auxiliary/scanner/ssl/openssl_heartbleed".to_string()),
            cve_ids: r#"["CVE-2014-0160"]"#.to_string(),
            title: "OpenSSL TLS Heartbeat Extension - Heartbleed Memory Disclosure".to_string(),
            description: Some("Information disclosure vulnerability in OpenSSL allowing memory leak including private keys.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Neel Mehta".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/32745".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["openssl", "tls", "memory-leak", "critical"]"#.to_string(),
            published_date: Some("2014-04-07".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Dirty COW - CVE-2016-5195
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("40611".to_string()),
            metasploit_module: Some("exploit/linux/local/recvmmsg_priv_esc".to_string()),
            cve_ids: r#"["CVE-2016-5195"]"#.to_string(),
            title: "Linux Kernel - Dirty COW Local Privilege Escalation".to_string(),
            description: Some("Race condition in Linux kernel copy-on-write allowing privilege escalation. Widely exploited.".to_string()),
            platform: "linux".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "local".to_string(),
            author: Some("Phil Oester".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/40611".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("c".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["kernel", "privilege-escalation", "race-condition", "critical"]"#.to_string(),
            published_date: Some("2016-10-19".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Sudo Baron Samedit - CVE-2021-3156
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("49521".to_string()),
            metasploit_module: Some("exploit/linux/local/sudo_baron_samedit".to_string()),
            cve_ids: r#"["CVE-2021-3156"]"#.to_string(),
            title: "Sudo - Baron Samedit Heap-Based Buffer Overflow".to_string(),
            description: Some("Heap-based buffer overflow in sudo allowing local privilege escalation to root.".to_string()),
            platform: "linux".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "local".to_string(),
            author: Some("Qualys".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/49521".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("c".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["sudo", "privilege-escalation", "heap-overflow", "critical"]"#.to_string(),
            published_date: Some("2021-01-26".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // PwnKit - CVE-2021-4034
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50689".to_string()),
            metasploit_module: Some("exploit/linux/local/cve_2021_4034_pwnkit_lpe_pkexec".to_string()),
            cve_ids: r#"["CVE-2021-4034"]"#.to_string(),
            title: "Polkit pkexec - PwnKit Local Privilege Escalation".to_string(),
            description: Some("Memory corruption in polkit's pkexec allowing local privilege escalation. Present for 12+ years.".to_string()),
            platform: "linux".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "local".to_string(),
            author: Some("Qualys".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50689".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("c".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["polkit", "privilege-escalation", "suid", "critical"]"#.to_string(),
            published_date: Some("2022-01-25".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // SIGRed - CVE-2020-1350
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("48875".to_string()),
            metasploit_module: None,
            cve_ids: r#"["CVE-2020-1350"]"#.to_string(),
            title: "Windows DNS Server - SIGRed RCE".to_string(),
            description: Some("Wormable RCE in Windows DNS Server via malformed DNS responses. CVSS 10.0.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Check Point Research".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/48875".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "good".to_string(),
            tags: r#"["dns", "worm", "critical", "server"]"#.to_string(),
            published_date: Some("2020-07-14".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // SMBGhost - CVE-2020-0796
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("48267".to_string()),
            metasploit_module: Some("exploit/windows/smb/cve_2020_0796_smbghost".to_string()),
            cve_ids: r#"["CVE-2020-0796"]"#.to_string(),
            title: "Windows SMBv3 - SMBGhost RCE".to_string(),
            description: Some("Remote code execution in SMBv3 compression handling. Pre-auth, wormable.".to_string()),
            platform: "windows".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("chompie / ZecOps".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/48267".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "good".to_string(),
            tags: r#"["smb", "worm", "critical", "pre-auth"]"#.to_string(),
            published_date: Some("2020-03-12".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // ProxyLogon - CVE-2021-26855
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("49637".to_string()),
            metasploit_module: Some("exploit/windows/http/exchange_proxylogon_rce".to_string()),
            cve_ids: r#"["CVE-2021-26855", "CVE-2021-26857", "CVE-2021-26858", "CVE-2021-27065"]"#.to_string(),
            title: "Microsoft Exchange Server - ProxyLogon RCE".to_string(),
            description: Some("Pre-authenticated RCE chain in Microsoft Exchange via SSRF and arbitrary file write.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Orange Tsai / DEVCORE".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/49637".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["exchange", "critical", "pre-auth", "apt"]"#.to_string(),
            published_date: Some("2021-03-02".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Citrix ADC - CVE-2019-19781
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("47901".to_string()),
            metasploit_module: Some("exploit/linux/http/citrix_dir_traversal_rce".to_string()),
            cve_ids: r#"["CVE-2019-19781"]"#.to_string(),
            title: "Citrix ADC/Gateway - Directory Traversal RCE".to_string(),
            description: Some("Unauthenticated RCE via directory traversal in Citrix ADC and Gateway.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Mikhail Klyuchnikov".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/47901".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["citrix", "critical", "vpn", "ransomware"]"#.to_string(),
            published_date: Some("2020-01-11".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // VMware vCenter - CVE-2021-21972
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("49602".to_string()),
            metasploit_module: Some("exploit/multi/http/vmware_vcenter_uploadova_rce".to_string()),
            cve_ids: r#"["CVE-2021-21972"]"#.to_string(),
            title: "VMware vCenter Server - Unauthenticated RCE".to_string(),
            description: Some("Unauthenticated RCE in VMware vCenter Server vSphere Client plugin.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Mikhail Klyuchnikov".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/49602".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["vmware", "critical", "pre-auth", "virtualization"]"#.to_string(),
            published_date: Some("2021-02-24".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // F5 BIG-IP - CVE-2020-5902
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("48642".to_string()),
            metasploit_module: Some("exploit/linux/http/f5_bigip_tmui_rce".to_string()),
            cve_ids: r#"["CVE-2020-5902"]"#.to_string(),
            title: "F5 BIG-IP TMUI - Unauthenticated RCE".to_string(),
            description: Some("Unauthenticated RCE via Traffic Management User Interface in F5 BIG-IP.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Mikhail Klyuchnikov".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/48642".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["f5", "critical", "pre-auth", "network"]"#.to_string(),
            published_date: Some("2020-07-01".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Atlassian Confluence - CVE-2022-26134
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("50952".to_string()),
            metasploit_module: Some("exploit/multi/http/atlassian_confluence_namespace_ognl_injection".to_string()),
            cve_ids: r#"["CVE-2022-26134"]"#.to_string(),
            title: "Atlassian Confluence Server - OGNL Injection RCE".to_string(),
            description: Some("Unauthenticated RCE via OGNL injection in Atlassian Confluence Server.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Volexity".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/50952".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("java".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["confluence", "atlassian", "ognl", "critical"]"#.to_string(),
            published_date: Some("2022-06-02".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Fortinet FortiOS - CVE-2018-13379
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("47287".to_string()),
            metasploit_module: Some("auxiliary/scanner/http/fortios_ssl_vpn_traversal".to_string()),
            cve_ids: r#"["CVE-2018-13379"]"#.to_string(),
            title: "Fortinet FortiOS SSL VPN - Path Traversal".to_string(),
            description: Some("Pre-auth path traversal allowing credential disclosure in FortiOS SSL VPN.".to_string()),
            platform: "multiple".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Meh Chang / Orange Tsai".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/47287".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["fortinet", "vpn", "path-traversal", "ransomware"]"#.to_string(),
            published_date: Some("2019-08-09".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Pulse Secure - CVE-2019-11510
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("47297".to_string()),
            metasploit_module: Some("auxiliary/scanner/http/pulse_secure_file_disclosure".to_string()),
            cve_ids: r#"["CVE-2019-11510"]"#.to_string(),
            title: "Pulse Secure SSL VPN - Arbitrary File Read".to_string(),
            description: Some("Pre-auth arbitrary file read in Pulse Secure SSL VPN allowing credential disclosure.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Orange Tsai / Meh Chang".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/47297".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["pulse", "vpn", "file-read", "ransomware"]"#.to_string(),
            published_date: Some("2019-08-21".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // SolarWinds Orion - CVE-2020-10148
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("49259".to_string()),
            metasploit_module: Some("exploit/windows/http/solarwinds_orion_supernova".to_string()),
            cve_ids: r#"["CVE-2020-10148"]"#.to_string(),
            title: "SolarWinds Orion API - Authentication Bypass".to_string(),
            description: Some("Authentication bypass in SolarWinds Orion API leading to RCE. Related to SUNBURST.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("SolarWinds".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/49259".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "good".to_string(),
            tags: r#"["solarwinds", "apt", "supply-chain", "critical"]"#.to_string(),
            published_date: Some("2020-12-26".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // MOVEit Transfer - CVE-2023-34362
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: Some("51642".to_string()),
            metasploit_module: None,
            cve_ids: r#"["CVE-2023-34362"]"#.to_string(),
            title: "MOVEit Transfer - SQL Injection RCE".to_string(),
            description: Some("SQL injection leading to RCE in Progress MOVEit Transfer. Used by Cl0p ransomware.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Progress Software".to_string()),
            source_url: Some("https://www.exploit-db.com/exploits/51642".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("sql".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["moveit", "sqli", "ransomware", "critical"]"#.to_string(),
            published_date: Some("2023-06-01".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // Ivanti - CVE-2024-21887
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: None,
            metasploit_module: None,
            cve_ids: r#"["CVE-2024-21887", "CVE-2023-46805"]"#.to_string(),
            title: "Ivanti Connect Secure - Command Injection".to_string(),
            description: Some("Command injection in Ivanti Connect Secure and Policy Secure allowing unauthenticated RCE.".to_string()),
            platform: "linux".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Volexity".to_string()),
            source_url: Some("https://www.volexity.com/blog/2024/01/10/active-exploitation-of-two-zero-day-vulnerabilities-in-ivanti-connect-secure-vpn/".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["ivanti", "vpn", "command-injection", "zero-day"]"#.to_string(),
            published_date: Some("2024-01-10".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // ScreenConnect - CVE-2024-1709
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: None,
            metasploit_module: None,
            cve_ids: r#"["CVE-2024-1709", "CVE-2024-1708"]"#.to_string(),
            title: "ConnectWise ScreenConnect - Authentication Bypass".to_string(),
            description: Some("Authentication bypass in ScreenConnect allowing remote code execution. Actively exploited.".to_string()),
            platform: "windows".to_string(),
            architecture: "unknown".to_string(),
            exploit_type: "webapps".to_string(),
            author: Some("Huntress".to_string()),
            source_url: Some("https://www.huntress.com/blog/slashandgrab-screen-connect-post-exploitation-in-the-wild-cve-2024-1709-cve-2024-1708".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("python".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["screenconnect", "rmm", "auth-bypass", "critical"]"#.to_string(),
            published_date: Some("2024-02-19".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
        // XZ Utils Backdoor - CVE-2024-3094
        ExploitRecord {
            id: uuid::Uuid::new_v4().to_string(),
            exploit_db_id: None,
            metasploit_module: None,
            cve_ids: r#"["CVE-2024-3094"]"#.to_string(),
            title: "XZ Utils - Backdoor via liblzma".to_string(),
            description: Some("Supply chain attack introducing backdoor in XZ Utils affecting SSH authentication.".to_string()),
            platform: "linux".to_string(),
            architecture: "x64".to_string(),
            exploit_type: "remote".to_string(),
            author: Some("Jia Tan (malicious)".to_string()),
            source_url: Some("https://www.openwall.com/lists/oss-security/2024/03/29/4".to_string()),
            source: "exploit_db".to_string(),
            code: None,
            language: Some("c".to_string()),
            verified: 1,
            reliability: "excellent".to_string(),
            tags: r#"["xz", "supply-chain", "ssh", "backdoor", "critical"]"#.to_string(),
            published_date: Some("2024-03-29".to_string()),
            created_at: now.clone(),
            updated_at: now.clone(),
        },
    ];

    for exploit in &exploits {
        if let Err(e) = upsert_exploit(pool, exploit).await {
            log::warn!("Failed to seed exploit {}: {}", exploit.title, e);
        } else {
            count += 1;
        }
    }

    // Update sync status
    update_sync_status(pool, "seeded", count as i64, count as i64, None).await?;

    log::info!("Seeded {} exploits into database", count);
    Ok(count)
}
