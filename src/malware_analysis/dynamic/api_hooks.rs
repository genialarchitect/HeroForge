//! API Call Hooking and Analysis
//!
//! Provides patterns and analysis for Windows and Linux API calls:
//! - API categorization (process, file, network, crypto, etc.)
//! - Suspicious behavior detection
//! - MITRE ATT&CK technique mapping
//! - Severity classification

use super::types::*;
use super::RawApiCall;
use std::collections::HashMap;

/// API hook pattern analyzer
pub struct ApiHookAnalyzer {
    /// Windows API patterns
    windows_patterns: Vec<ApiPattern>,
    /// Linux syscall patterns
    linux_patterns: Vec<ApiPattern>,
    /// Severity rules
    severity_rules: Vec<SeverityRule>,
}

#[derive(Debug, Clone)]
struct ApiPattern {
    module: String,
    function: String,
    category: ApiCategory,
    description: String,
    base_severity: ApiSeverity,
    mitre_techniques: Vec<String>,
    argument_checks: Vec<ArgumentCheck>,
}

#[derive(Debug, Clone)]
struct ArgumentCheck {
    arg_name: String,
    pattern: String,
    severity_modifier: i8, // -2 to +2
}

#[derive(Debug, Clone)]
struct SeverityRule {
    condition: SeverityCondition,
    severity_delta: i8,
}

#[derive(Debug, Clone)]
enum SeverityCondition {
    FunctionContains(String),
    ArgumentContains(String, String),
    ModuleIs(String),
    CallSequence(Vec<String>),
}

impl ApiHookAnalyzer {
    pub fn new() -> Self {
        Self {
            windows_patterns: get_windows_api_patterns(),
            linux_patterns: get_linux_syscall_patterns(),
            severity_rules: get_severity_rules(),
        }
    }

    /// Analyze raw API calls
    pub fn analyze_api_calls(&self, raw_calls: &[RawApiCall]) -> Vec<ApiCallInfo> {
        let mut analyzed_calls = Vec::new();

        for (i, call) in raw_calls.iter().enumerate() {
            let pattern = self.find_pattern(&call.module, &call.function);
            let category = pattern.as_ref().map(|p| p.category.clone()).unwrap_or(ApiCategory::Other);
            let base_severity = pattern.as_ref().map(|p| p.base_severity.clone()).unwrap_or(ApiSeverity::Info);
            let mitre = pattern.as_ref().map(|p| p.mitre_techniques.clone()).unwrap_or_default();

            // Parse arguments
            let arguments: Vec<ApiArgument> = call.arguments.iter().map(|(name, arg_type, value)| {
                ApiArgument {
                    name: name.clone(),
                    arg_type: arg_type.clone(),
                    value: value.clone(),
                    is_pointer: arg_type.contains("*") || arg_type.contains("PTR") || arg_type.to_uppercase().contains("HANDLE"),
                    dereferenced_value: None,
                }
            }).collect();

            // Calculate final severity
            let severity = self.calculate_severity(call, &base_severity, &arguments);

            // Check if function appears to be hooked (simplified heuristic)
            let is_hooked = self.detect_hook_indicators(call);

            analyzed_calls.push(ApiCallInfo {
                id: uuid::Uuid::new_v4().to_string(),
                timestamp: call.timestamp,
                pid: call.pid,
                process_name: call.process_name.clone(),
                api_category: category,
                module: call.module.clone(),
                function: call.function.clone(),
                arguments,
                return_value: call.return_value.clone(),
                is_hooked,
                stack_trace: call.stack_trace.clone(),
                severity,
                mitre_techniques: mitre,
            });
        }

        analyzed_calls
    }

    fn find_pattern(&self, module: &str, function: &str) -> Option<&ApiPattern> {
        let module_lower = module.to_lowercase();
        let func_lower = function.to_lowercase();

        // Check Windows patterns
        for pattern in &self.windows_patterns {
            if (pattern.module == "*" || module_lower.contains(&pattern.module.to_lowercase()))
                && func_lower.contains(&pattern.function.to_lowercase())
            {
                return Some(pattern);
            }
        }

        // Check Linux patterns
        for pattern in &self.linux_patterns {
            if (pattern.module == "*" || module_lower.contains(&pattern.module.to_lowercase()))
                && func_lower.contains(&pattern.function.to_lowercase())
            {
                return Some(pattern);
            }
        }

        None
    }

    fn calculate_severity(
        &self,
        call: &RawApiCall,
        base: &ApiSeverity,
        arguments: &[ApiArgument],
    ) -> ApiSeverity {
        let mut severity_value: i8 = match base {
            ApiSeverity::Info => 0,
            ApiSeverity::Low => 1,
            ApiSeverity::Medium => 2,
            ApiSeverity::High => 3,
            ApiSeverity::Critical => 4,
        };

        // Apply severity rules
        for rule in &self.severity_rules {
            match &rule.condition {
                SeverityCondition::FunctionContains(pattern) => {
                    if call.function.to_lowercase().contains(&pattern.to_lowercase()) {
                        severity_value = (severity_value + rule.severity_delta).clamp(0, 4);
                    }
                }
                SeverityCondition::ArgumentContains(arg_name, pattern) => {
                    for arg in arguments {
                        if arg.name.to_lowercase().contains(&arg_name.to_lowercase())
                            && arg.value.to_lowercase().contains(&pattern.to_lowercase())
                        {
                            severity_value = (severity_value + rule.severity_delta).clamp(0, 4);
                        }
                    }
                }
                SeverityCondition::ModuleIs(module) => {
                    if call.module.to_lowercase() == module.to_lowercase() {
                        severity_value = (severity_value + rule.severity_delta).clamp(0, 4);
                    }
                }
                SeverityCondition::CallSequence(_) => {
                    // Sequence detection requires full call history - skip for now
                }
            }
        }

        match severity_value {
            0 => ApiSeverity::Info,
            1 => ApiSeverity::Low,
            2 => ApiSeverity::Medium,
            3 => ApiSeverity::High,
            _ => ApiSeverity::Critical,
        }
    }

    fn detect_hook_indicators(&self, call: &RawApiCall) -> bool {
        // Simple heuristics for hook detection
        // In real implementation, this would analyze the call stack and memory

        if let Some(ref stack) = call.stack_trace {
            // Check for unusual modules in call stack
            for frame in stack {
                let frame_lower = frame.to_lowercase();
                // Unknown or injected DLLs
                if !is_known_module(&frame_lower) {
                    return true;
                }
            }
        }

        false
    }

    /// Get API call statistics
    pub fn get_statistics(&self, calls: &[ApiCallInfo]) -> ApiStatistics {
        let mut category_counts: HashMap<ApiCategory, usize> = HashMap::new();
        let mut severity_counts: HashMap<ApiSeverity, usize> = HashMap::new();
        let mut module_counts: HashMap<String, usize> = HashMap::new();

        for call in calls {
            *category_counts.entry(call.api_category.clone()).or_insert(0) += 1;
            *severity_counts.entry(call.severity.clone()).or_insert(0) += 1;
            *module_counts.entry(call.module.clone()).or_insert(0) += 1;
        }

        let most_called: Vec<_> = {
            let mut func_counts: HashMap<String, usize> = HashMap::new();
            for call in calls {
                *func_counts.entry(call.function.clone()).or_insert(0) += 1;
            }
            let mut sorted: Vec<_> = func_counts.into_iter().collect();
            sorted.sort_by(|a, b| b.1.cmp(&a.1));
            sorted.into_iter().take(10).collect()
        };

        ApiStatistics {
            total_calls: calls.len(),
            category_distribution: category_counts,
            severity_distribution: severity_counts,
            module_distribution: module_counts,
            most_called_functions: most_called,
            hooked_calls: calls.iter().filter(|c| c.is_hooked).count(),
        }
    }
}

impl Default for ApiHookAnalyzer {
    fn default() -> Self {
        Self::new()
    }
}

#[derive(Debug, Clone)]
pub struct ApiStatistics {
    pub total_calls: usize,
    pub category_distribution: HashMap<ApiCategory, usize>,
    pub severity_distribution: HashMap<ApiSeverity, usize>,
    pub module_distribution: HashMap<String, usize>,
    pub most_called_functions: Vec<(String, usize)>,
    pub hooked_calls: usize,
}

// API Pattern Definitions

fn get_windows_api_patterns() -> Vec<ApiPattern> {
    vec![
        // Process APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "CreateProcess".to_string(),
            category: ApiCategory::Process,
            description: "Process creation".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1106".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "OpenProcess".to_string(),
            category: ApiCategory::Process,
            description: "Opens another process".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "TerminateProcess".to_string(),
            category: ApiCategory::Process,
            description: "Process termination".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1489".to_string()],
            argument_checks: vec![],
        },

        // Memory APIs - Injection indicators
        ApiPattern {
            module: "kernel32".to_string(),
            function: "VirtualAllocEx".to_string(),
            category: ApiCategory::Injection,
            description: "Remote memory allocation".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "WriteProcessMemory".to_string(),
            category: ApiCategory::Injection,
            description: "Write to remote process memory".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ntdll".to_string(),
            function: "NtWriteVirtualMemory".to_string(),
            category: ApiCategory::Injection,
            description: "Native API write to remote memory".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "CreateRemoteThread".to_string(),
            category: ApiCategory::Injection,
            description: "Remote thread creation".to_string(),
            base_severity: ApiSeverity::Critical,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ntdll".to_string(),
            function: "NtQueueApcThread".to_string(),
            category: ApiCategory::Injection,
            description: "APC injection".to_string(),
            base_severity: ApiSeverity::Critical,
            mitre_techniques: vec!["T1055.004".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ntdll".to_string(),
            function: "NtUnmapViewOfSection".to_string(),
            category: ApiCategory::Injection,
            description: "Section unmapping (hollowing)".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055.012".to_string()],
            argument_checks: vec![],
        },

        // Thread APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "SetThreadContext".to_string(),
            category: ApiCategory::Thread,
            description: "Thread context modification".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "ResumeThread".to_string(),
            category: ApiCategory::Thread,
            description: "Thread resume".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },

        // File APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "CreateFile".to_string(),
            category: ApiCategory::File,
            description: "File creation/opening".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "WriteFile".to_string(),
            category: ApiCategory::File,
            description: "File write".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "DeleteFile".to_string(),
            category: ApiCategory::File,
            description: "File deletion".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1070.004".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "MoveFile".to_string(),
            category: ApiCategory::File,
            description: "File move/rename".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },

        // Registry APIs
        ApiPattern {
            module: "advapi32".to_string(),
            function: "RegCreateKey".to_string(),
            category: ApiCategory::Registry,
            description: "Registry key creation".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1112".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "RegSetValue".to_string(),
            category: ApiCategory::Registry,
            description: "Registry value modification".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1112".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "RegDeleteKey".to_string(),
            category: ApiCategory::Registry,
            description: "Registry key deletion".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1112".to_string()],
            argument_checks: vec![],
        },

        // Network APIs
        ApiPattern {
            module: "ws2_32".to_string(),
            function: "connect".to_string(),
            category: ApiCategory::Network,
            description: "Network connection".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1071".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ws2_32".to_string(),
            function: "send".to_string(),
            category: ApiCategory::Network,
            description: "Network send".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ws2_32".to_string(),
            function: "recv".to_string(),
            category: ApiCategory::Network,
            description: "Network receive".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "wininet".to_string(),
            function: "InternetOpen".to_string(),
            category: ApiCategory::Network,
            description: "Internet session initialization".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1071".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "wininet".to_string(),
            function: "HttpOpenRequest".to_string(),
            category: ApiCategory::Network,
            description: "HTTP request creation".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1071.001".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "dnsapi".to_string(),
            function: "DnsQuery".to_string(),
            category: ApiCategory::Network,
            description: "DNS query".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec!["T1071.004".to_string()],
            argument_checks: vec![],
        },

        // Crypto APIs
        ApiPattern {
            module: "advapi32".to_string(),
            function: "CryptAcquireContext".to_string(),
            category: ApiCategory::Crypto,
            description: "Crypto context acquisition".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1486".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "CryptEncrypt".to_string(),
            category: ApiCategory::Crypto,
            description: "Data encryption".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1486".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "CryptGenKey".to_string(),
            category: ApiCategory::Crypto,
            description: "Cryptographic key generation".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1486".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "bcrypt".to_string(),
            function: "BCryptEncrypt".to_string(),
            category: ApiCategory::Crypto,
            description: "BCrypt encryption".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1486".to_string()],
            argument_checks: vec![],
        },

        // Anti-Debug APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "IsDebuggerPresent".to_string(),
            category: ApiCategory::AntiDebug,
            description: "Debugger detection check".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1622".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "CheckRemoteDebuggerPresent".to_string(),
            category: ApiCategory::AntiDebug,
            description: "Remote debugger detection".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1622".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "ntdll".to_string(),
            function: "NtQueryInformationProcess".to_string(),
            category: ApiCategory::AntiDebug,
            description: "Process information query (potential anti-debug)".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1622".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "OutputDebugString".to_string(),
            category: ApiCategory::AntiDebug,
            description: "Debug string output (timing attack)".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec!["T1622".to_string()],
            argument_checks: vec![],
        },

        // Anti-VM APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "GetSystemInfo".to_string(),
            category: ApiCategory::Discovery,
            description: "System information retrieval".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec!["T1082".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "GlobalMemoryStatusEx".to_string(),
            category: ApiCategory::AntiVm,
            description: "Memory status check (VM detection)".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1497".to_string()],
            argument_checks: vec![],
        },

        // Persistence APIs
        ApiPattern {
            module: "kernel32".to_string(),
            function: "CopyFile".to_string(),
            category: ApiCategory::Persistence,
            description: "File copy (potential persistence)".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1547".to_string()],
            argument_checks: vec![],
        },

        // Privilege Escalation
        ApiPattern {
            module: "advapi32".to_string(),
            function: "AdjustTokenPrivileges".to_string(),
            category: ApiCategory::Privilege,
            description: "Token privilege adjustment".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1134".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "OpenProcessToken".to_string(),
            category: ApiCategory::Privilege,
            description: "Process token access".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1134".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "advapi32".to_string(),
            function: "ImpersonateLoggedOnUser".to_string(),
            category: ApiCategory::Privilege,
            description: "User impersonation".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1134.001".to_string()],
            argument_checks: vec![],
        },

        // Execution
        ApiPattern {
            module: "shell32".to_string(),
            function: "ShellExecute".to_string(),
            category: ApiCategory::Execution,
            description: "Shell command execution".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1106".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "WinExec".to_string(),
            category: ApiCategory::Execution,
            description: "Windows program execution".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1106".to_string()],
            argument_checks: vec![],
        },

        // Hooking
        ApiPattern {
            module: "user32".to_string(),
            function: "SetWindowsHookEx".to_string(),
            category: ApiCategory::Hooking,
            description: "Windows hook installation".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1056.001".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "kernel32".to_string(),
            function: "GetAsyncKeyState".to_string(),
            category: ApiCategory::Hooking,
            description: "Key state monitoring (keylogging)".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1056.001".to_string()],
            argument_checks: vec![],
        },
    ]
}

fn get_linux_syscall_patterns() -> Vec<ApiPattern> {
    vec![
        // Process syscalls
        ApiPattern {
            module: "libc".to_string(),
            function: "fork".to_string(),
            category: ApiCategory::Process,
            description: "Process fork".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec!["T1106".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "execve".to_string(),
            category: ApiCategory::Execution,
            description: "Program execution".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1106".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "ptrace".to_string(),
            category: ApiCategory::AntiDebug,
            description: "Process trace (anti-debug or injection)".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1055.008".to_string(), "T1622".to_string()],
            argument_checks: vec![],
        },

        // File syscalls
        ApiPattern {
            module: "libc".to_string(),
            function: "open".to_string(),
            category: ApiCategory::File,
            description: "File open".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "unlink".to_string(),
            category: ApiCategory::File,
            description: "File deletion".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1070.004".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "chmod".to_string(),
            category: ApiCategory::File,
            description: "File permission change".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1222".to_string()],
            argument_checks: vec![],
        },

        // Network syscalls
        ApiPattern {
            module: "libc".to_string(),
            function: "socket".to_string(),
            category: ApiCategory::Network,
            description: "Socket creation".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "connect".to_string(),
            category: ApiCategory::Network,
            description: "Network connection".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1071".to_string()],
            argument_checks: vec![],
        },

        // Memory syscalls
        ApiPattern {
            module: "libc".to_string(),
            function: "mmap".to_string(),
            category: ApiCategory::Memory,
            description: "Memory mapping".to_string(),
            base_severity: ApiSeverity::Low,
            mitre_techniques: vec![],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "mprotect".to_string(),
            category: ApiCategory::Memory,
            description: "Memory protection change".to_string(),
            base_severity: ApiSeverity::Medium,
            mitre_techniques: vec!["T1055".to_string()],
            argument_checks: vec![],
        },

        // Privilege
        ApiPattern {
            module: "libc".to_string(),
            function: "setuid".to_string(),
            category: ApiCategory::Privilege,
            description: "User ID change".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1548.001".to_string()],
            argument_checks: vec![],
        },
        ApiPattern {
            module: "libc".to_string(),
            function: "setgid".to_string(),
            category: ApiCategory::Privilege,
            description: "Group ID change".to_string(),
            base_severity: ApiSeverity::High,
            mitre_techniques: vec!["T1548".to_string()],
            argument_checks: vec![],
        },
    ]
}

fn get_severity_rules() -> Vec<SeverityRule> {
    vec![
        // Increase severity for memory executable allocations
        SeverityRule {
            condition: SeverityCondition::ArgumentContains(
                "protect".to_string(),
                "EXECUTE".to_string(),
            ),
            severity_delta: 1,
        },
        // Increase severity for SYSTEM account operations
        SeverityRule {
            condition: SeverityCondition::ArgumentContains(
                "username".to_string(),
                "SYSTEM".to_string(),
            ),
            severity_delta: 1,
        },
        // Increase severity for startup folder operations
        SeverityRule {
            condition: SeverityCondition::ArgumentContains(
                "path".to_string(),
                "Startup".to_string(),
            ),
            severity_delta: 2,
        },
        // Increase severity for Run key operations
        SeverityRule {
            condition: SeverityCondition::ArgumentContains(
                "key".to_string(),
                "\\Run".to_string(),
            ),
            severity_delta: 2,
        },
    ]
}

fn is_known_module(module_path: &str) -> bool {
    let known_modules = [
        "kernel32", "ntdll", "user32", "advapi32", "ws2_32", "ole32",
        "gdi32", "shell32", "comctl32", "msvcrt", "ucrtbase", "kernelbase",
        "wininet", "winhttp", "crypt32", "bcrypt", "secur32", "netapi32",
        "rpcrt4", "shlwapi", "urlmon", "mswsock", "dnsapi", "iphlpapi",
        "version", "psapi", "wtsapi32", "userenv", "wldap32",
        // Linux
        "libc", "libpthread", "libdl", "libm", "libssl", "libcrypto",
        "libcurl", "libz", "librt",
    ];

    known_modules.iter().any(|m| module_path.contains(m))
}
